<!doctype html>
<html lang="vi" data-bs-theme="dark">

<head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>STool Dashboard</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Anton&family=Lobster&family=Oswald:wght@400;700&family=Pacifico&family=Roboto:ital,wght@0,400;0,700;1,400&display=swap"
            rel="stylesheet">
      <link rel="icon" type="image/png" href="{{ url_for('static', filename='icontray.png') }}">
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
      <style>
            :root {
                  --dark-bg: #1a1d21;
                  --card-bg: #2c303a;
                  --border-color: #444a59;
                  --text-color: #e6e6e6;
                  --primary-color: #0d6efd;
                  --hover-color: #3d4453;
            }

            body {
                  background-color: var(--dark-bg);
                  color: var(--text-color);
                  padding: 1rem;
                  font-family: 'Roboto', sans-serif;
            }

            .main-nav .nav-link {
                  font-weight: 500;
                  color: var(--text-color);
            }

            .main-nav .nav-link.active {
                  background-color: var(--primary-color) !important;
                  color: #fff !important;
            }

            .tab-content {
                  border: 1px solid var(--border-color);
                  border-top: none;
                  padding: 1rem;
                  border-radius: 0 0 0.375rem 0.375rem;
                  background-color: var(--card-bg);
            }

            .tool-card {
                  background-color: var(--card-bg);
                  border: 1px solid var(--border-color);
                  border-radius: 1.5rem;
                  transition: transform 0.25s cubic-bezier(.4, 2, .6, 1), box-shadow 0.25s, border-color 0.2s;
                  cursor: pointer;
                  height: 100%;
                  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.25);
                  position: relative;
                  overflow: visible;
            }

            .tool-card:hover {
                  transform: translateY(-12px) scale(1.03);
                  box-shadow: 0 8px 32px 0 rgba(0, 255, 255, 0.25), 0 16px 40px rgba(0, 0, 0, 0.45);
                  border-color: #00e0ff;
            }

            .tool-card::before {
                  content: '';
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  width: 80%;
                  height: 80%;
                  background: radial-gradient(circle, rgba(0, 224, 255, 0.18) 0%, rgba(0, 224, 255, 0) 80%);
                  opacity: 0;
                  transform: translate(-50%, -50%) scale(0.8);
                  border-radius: 50%;
                  pointer-events: none;
                  transition: opacity 0.3s, transform 0.3s;
                  z-index: 0;
            }

            .tool-card:hover::before {
                  opacity: 1;
                  transform: translate(-50%, -50%) scale(1.1);
            }

            .tool-card .card-icon {
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  width: 70px;
                  height: 70px;
                  margin: 0 auto 1rem auto;
                  border-radius: 50%;
                  background: linear-gradient(135deg, #00e0ff 0%, #3a7bd5 100%);
                  box-shadow: 0 4px 16px rgba(0, 224, 255, 0.18);
                  font-size: 2.5rem;
                  color: #fff;
                  position: relative;
                  z-index: 1;
            }

            .table {
                  --bs-table-bg: #2d2d2d;
                  --bs-table-border-color: #404040;
                  vertical-align: middle;
            }

            .table .badge {
                  background-color: #6c757d;
                  color: white;
            }

            .table thead th {
                  color: #ffffff !important;
                  background-color: #374151;
                  font-weight: bold;
            }

            .table tbody td {
                  color: #f8f9fa !important;
            }

            /* --- START: Fix for Password Column Width --- */
            #password-tool-pane .table th:nth-child(3),
            #password-tool-pane .table td:nth-child(3) {
                  width: 260px;
                  /* Set a fixed width */
                  max-width: 260px;
                  /* Set a max width to be safe */
            }

            /* --- END: Fix for Password Column Width --- */

            .password-cell {
                  display: flex;
                  align-items: center;
                  justify-content: space-between;
                  gap: 0.5rem;
            }

            .password-text {
                  display: block;
                  /* CRITICAL: Allows width and text-overflow to work correctly */
                  width: 100%;
                  /* Make the span fill the constrained parent cell */
                  white-space: nowrap;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  -webkit-text-security: disc;
                  transition: -webkit-text-security 0.2s;
            }

            .form-control,
            .form-select {
                  background-color: #374151;
                  border-color: #4b5563;
                  color: var(--text-color);
            }

            .modal-content {
                  background-color: var(--card-bg);
                  border-color: var(--border-color);
            }

            #telegram-tool-pane .sticky-top {
                  top: 0;
                  z-index: 1020;
                  background-color: var(--card-bg) !important;
                  padding: 0.25rem 0;
                  border-bottom: 1px solid var(--border-color);
                  margin-bottom: 1rem;
            }

            #telegram-tool-pane .main-tool-container .tab-content,
            #telegram-tool-pane .main-tool-container .nav-pills {
                  background: none;
                  border: none;
                  padding: 0;
            }

            #image-editor-tool-pane .nav-pills .nav-link,
            #telegram-tool-pane .nav-pills .nav-link {
                  color: var(--text-color);
            }

            #image-editor-tool-pane .nav-pills .nav-link.active,
            #telegram-tool-pane .nav-pills .nav-link.active {
                  background-color: var(--primary-color);
                  color: #fff;
            }

            #image-editor-tool-pane #ie-options-panel {
                  background-color: var(--card-bg);
                  padding: 1rem;
                  border-radius: 0.5rem;
                  border: 1px solid var(--border-color);
                  height: 100%;
            }


            #tg-session-tables-container .table-responsive {
                  max-height: 75vh;
                  overflow-y: auto;
            }

            .stat-card {
                  border: 1px solid #4b5563;
                  padding: 0.75rem 1.25rem;
                  min-width: 320px;
            }

            /* --- IMAGE EDITOR STYLES --- */
            #ie-uploaded-thumbnails {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                  gap: 0.5rem;
                  min-height: 90px;
                  border: 2px dashed var(--border-color);
                  border-radius: 0.375rem;
                  padding: 0.5rem;
                  background-color: #2d2d2d;
            }

            #ie-uploaded-thumbnails img {
                  width: 100%;
                  height: 80px;
                  object-fit: cover;
                  border-radius: 0.25rem;
                  cursor: grab;
                  transition: opacity 0.2s, transform 0.2s, box-shadow 0.2s;
            }

            #ie-uploaded-thumbnails img.dragging {
                  opacity: .4;
                  transform: scale(0.95);
                  box-shadow: 0 0 10px rgba(0, 224, 255, 0.5);
                  cursor: grabbing;
            }

            #ie-layout-templates {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                  gap: 0.5rem;
            }

            .ie-layout-box {
                  aspect-ratio: 1/1;
                  border: 2px solid var(--border-color);
                  background-color: #2d2d2d;
                  border-radius: 0.375rem;
                  cursor: pointer;
                  transition: border-color 0.2s;
                  display: flex;
                  gap: 2px;
                  padding: 2px;
            }

            .ie-layout-box:hover {
                  border-color: var(--primary-color);
            }

            .ie-layout-box.active {
                  border-color: #00e0ff;
                  border-width: 3px;
            }

            .ie-layout-box .cell {
                  background-color: #4b5563;
                  border-radius: 2px;
                  flex-grow: 1;
            }

            .ie-layout-box[data-layout^="layout_1"] {
                  flex-direction: row;
            }

            .ie-layout-box[data-layout="layout_2_h"] {
                  flex-direction: row;
            }

            .ie-layout-box[data-layout="layout_2_v"] {
                  flex-direction: column;
            }

            .ie-layout-box[data-layout="layout_3_v"] {
                  flex-direction: row;
            }

            .ie-layout-box[data-layout="layout_3_top_1"] {
                  flex-direction: column;
            }

            .ie-layout-box[data-layout="layout_3_top_1"] .row1 {
                  flex-basis: 50%;
                  display: flex;
            }

            .ie-layout-box[data-layout="layout_3_top_1"] .row2 {
                  flex-basis: 50%;
                  display: flex;
                  gap: 2px;
            }

            .ie-layout-box[data-layout="layout_3_left_1"] {
                  flex-direction: row;
            }

            .ie-layout-box[data-layout="layout_3_left_1"] .col1 {
                  flex-basis: 50%;
                  display: flex;
            }

            .ie-layout-box[data-layout="layout_3_left_1"] .col2 {
                  flex-basis: 50%;
                  display: flex;
                  flex-direction: column;
                  gap: 2px;
            }

            .ie-layout-box[data-layout="layout_4_2x2"] {
                  flex-wrap: wrap;
            }

            .ie-layout-box[data-layout="layout_4_2x2"] .cell {
                  flex-basis: calc(50% - 1px);
            }

            .ie-layout-box[data-layout="layout_4_left_1"] {
                  flex-direction: row;
            }

            .ie-layout-box[data-layout="layout_4_left_1"] .col1 {
                  flex-basis: 50%;
                  display: flex;
            }

            .ie-layout-box[data-layout="layout_4_left_1"] .col2 {
                  flex-basis: 50%;
                  display: flex;
                  flex-direction: column;
                  gap: 2px;
            }

            .ie-layout-box[data-layout="layout_5_2_3"] {
                  flex-direction: column;
            }

            .ie-layout-box[data-layout="layout_5_2_3"] .row1,
            .ie-layout-box[data-layout="layout_5_2_3"] .row2 {
                  display: flex;
                  flex-basis: 50%;
                  gap: 2px;
            }

            .ie-layout-box[data-layout="layout_5_left_1_4"] {
                  flex-direction: row;
            }

            .ie-layout-box[data-layout="layout_5_left_1_4"] .col1 {
                  flex-basis: 66.66%;
                  display: flex;
            }

            .ie-layout-box[data-layout="layout_5_left_1_4"] .col2 {
                  flex-basis: 33.33%;
                  display: flex;
                  flex-direction: column;
                  gap: 2px;
            }

            #ie-canvas-wrapper {
                  position: relative;
                  width: 100%;
                  height: 85vh;
                  /* Adjusted height for better layout */
                  background-color: #181a1e;
                  border-radius: 12px;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  overflow: hidden;
            }

            #ie-canvas {
                  cursor: default;
            }

            #ie-canvas-placeholder {
                  position: absolute;
            }

            .ie-editing-textarea {
                  position: absolute;
                  background-color: rgba(44, 48, 58, 0.9);
                  border: 1px dashed var(--primary-color);
                  color: var(--text-color);
                  z-index: 10;
                  resize: none;
                  /* remove overflow: hidden to allow scrollHeight to be calculated correctly */
                  padding: 0;
                  margin: 0;
                  line-height: 1.2;
                  outline: none;
                  white-space: pre-wrap;
                  word-wrap: break-word;
            }

            .ie-color-swatches span {
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  cursor: pointer;
                  border: 2px solid transparent;
                  transition: transform 0.2s;
                  display: inline-block;
            }

            .ie-color-swatches span:hover {
                  transform: scale(1.1);
            }

            .ie-color-swatches span.active {
                  border-color: #fff;
            }

            .ie-color-swatches span[data-color="rainbow"] {
                  background: linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet);
            }

            /* --- START: Code thêm cho Sidebar Telegram --- */
            #telegram-tool-pane .main-tool-container,
            #healthy-tool-pane .main-tool-container {
                  display: flex;
                  /* Kích hoạt Flexbox để xếp các mục con nằm ngang */
                  align-items: flex-start;
                  /* Canh các mục con lên trên cùng */
                  gap: 1.5rem;
                  /* Tạo khoảng cách 1.5rem giữa sidebar và nội dung */
            }

            #telegram-tool-pane .nav-pills,
            #healthy-tool-pane .nav-pills {
                  flex: 0 0 220px;
                  /* Đặt chiều rộng cố định cho sidebar là 220px */
                  border: 1px solid var(--border-color);
                  /* Thêm đường viền cho đẹp */
                  border-radius: 0.5rem;
                  /* Bo tròn các góc */
                  padding: 0.5rem !important;
                  /* Thêm đệm bên trong */
                  background-color: var(--card-bg) !important;
                  /* Đặt màu nền */
            }

            #telegram-tool-pane .nav-pills .nav-link,
            #healthy-tool-pane .nav-pills .nav-link {
                  margin-bottom: 0.25rem;
                  /* Khoảng cách giữa các nút */
                  text-align: left;
                  /* Căn chữ về bên trái */
            }

            #telegram-tool-pane .nav-pills .nav-link:last-child,
            #healthy-tool-pane .nav-pills .nav-link:last-child {
                  margin-bottom: 0;
                  /* Bỏ khoảng cách cho nút cuối cùng */
            }

            #telegram-tool-pane .tab-content,
            #healthy-tool-pane .tab-content {
                  flex-grow: 1;
                  /* Để nội dung chính tự động chiếm hết không gian còn lại */
                  padding: 0 !important;
                  /* Reset padding có sẵn */
                  border: none !important;
                  background: none !important;
            }

            /* --- END: Code thêm cho Sidebar Telegram --- */

            /* --- START: Code thêm cho Card chức năng Telegram --- */
            #tg-group-task-cards .card {
                  /* Tăng tốc và độ mượt của transition */
                  transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
                  cursor: pointer;
                  border: 2px solid var(--border-color);
                  background-color: var(--card-bg);
            }

            #tg-group-task-cards .card:hover {
                  transform: translateY(-10px);
                  /* Di chuyển nhẹ lên trên khi hover */
                  border-color: var(--primary-color);
                  /* Đổi màu viền khi hover */
                  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            }

            #tg-group-task-cards .card.card-selected {
                  border-color: #00e0ff;
                  /* Màu viền sáng để báo hiệu đã chọn */
                  transform: translateY(-10px) scale(1.03);
                  /* Làm card nổi bật hơn */
                  box-shadow: 0 0 16px rgba(0, 224, 255, 0.5),
                        0 0 24px rgba(0, 224, 255, 0.3);
                  /* Hiệu ứng tỏa sáng */
            }

            /* --- END: Code thêm cho Card chức năng Telegram --- */

            /* --- Floating Nav Card Styles --- */

            /* Reset the container and add some padding */
            .main-nav.nav-tabs {
                  border-bottom: none;
                  padding: 5px 0;
            }

            /* Base style for individual tab "cards" */
            .main-nav .nav-link {
                  border: 1px solid var(--border-color);
                  background-color: var(--card-bg);
                  border-radius: 10px;
                  /* More rounded corners */
                  margin: 0 5px;
                  /* Space between cards */
                  padding: 10px 20px;
                  font-weight: 500;
                  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
            }

            /* Override Bootstrap's default border for non-active tabs */
            .nav-tabs .nav-link {
                  margin-bottom: 0;
                  border-bottom-color: var(--border-color);
            }

            /* Hover effect for tab cards */
            .main-nav .nav-link:not(.active):hover {
                  transform: translateY(-4px);
                  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.35);
                  border-color: #00e0ff;
            }

            /* Style for the active/selected tab card */
            .main-nav .nav-link.active {
                  transform: translateY(-2px);
                  font-weight: bold;
                  box-shadow: 0 0 15px rgba(13, 110, 253, 0.5), 0 4px 10px rgba(13, 110, 253, 0.3);
                  /* Blue glow */
                  border-color: var(--primary-color);
            }

            /* --- Colored Nav Card Icon Styles --- */

            /* Align icon and text vertically */
            .main-nav .nav-link {
                  display: flex;
                  align-items: center;
            }

            /* Base style for the circular icon container */
            .nav-card-icon {
                  display: inline-flex;
                  align-items: center;
                  justify-content: center;
                  width: 30px;
                  height: 30px;
                  margin-right: 10px;
                  border-radius: 50%;
                  font-size: 16px;
                  color: #fff;
                  flex-shrink: 0;
                  /* Prevent icon from shrinking */
            }

            /* Specific colors for each nav card icon */
            #home-tab .nav-card-icon {
                  background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            }

            #notes-tool-tab .nav-card-icon {
                  background: linear-gradient(135deg, #66BB6A, #26A69A);
            }

            #password-tool-tab .nav-card-icon {
                  background: linear-gradient(135deg, #6f42c1, #AB47BC);
            }

            #facebook-tool-tab .nav-card-icon {
                  background: linear-gradient(135deg, #1877f2, #3b5998);
            }

            #telegram-tool-tab .nav-card-icon {
                  background: linear-gradient(135deg, #00e0ff, #3a7bd5);
            }

            #image-editor-tool-tab .nav-card-icon {
                  background: linear-gradient(135deg, #f953c6, #b91d73);
            }

            #healthy-tool-tab .nav-card-icon {
                  background: linear-gradient(135deg, #2ed573, #ffc107);
            }

            /* Notes Card View Styles */

            /* New Layout System with Animation */
            .notes-layout-container {
                  display: flex;
                  gap: 1rem;
            }

            #notes-list-wrapper {
                  flex-grow: 1;
                  width: 100%;
                  transition: width 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            #notes-detail-wrapper {
                  flex-shrink: 0;
                  width: 0;
                  transform: translateX(30px);
                  opacity: 0;
                  visibility: hidden;
                  transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            #notes-detail-wrapper.visible {
                  width: 66.666667%;
                  /* Panel now takes up 2/3 of the space */
                  transform: translateX(0);
                  opacity: 1;
                  visibility: visible;
            }

            #notes-list-wrapper.shrunk {
                  width: 33.333333%;
                  /* List now takes up 1/3 of the space */
            }

            /* Grid View: Cards are in a multi-column grid */
            #notes-container.notes-grid-view .note-card-wrapper {
                  flex: 0 0 33.333333%;
                  max-width: 33.333333%;
                  padding: 0 !important;
                  /* Remove all padding */
            }

            #notes-container.notes-grid-view .card {
                  height: 120px;
            }

            /* List View: Cards are in a single vertical list */
            #notes-container.notes-list-view .note-card-wrapper {
                  flex: 0 0 100%;
                  max-width: 100%;
                  padding: 0 !important;
                  /* Remove all padding */
            }

            #notes-container.notes-list-view .card {
                  height: 70px;
                  /* Giảm từ 100px xuống 70px */
            }

            /* Font size adjustments for list view */
            #notes-container.notes-list-view .card .card-title {
                  font-size: 1.14rem;
                  /* Tăng thêm 20% từ 0.95rem lên 1.14rem */
                  margin-bottom: 0.2rem;
                  /* Giảm khoảng cách giữa title và body */
            }

            #notes-container.notes-list-view .card .card-note-body {
                  font-size: 0.75rem;
                  /* Giảm kích thước font body */
                  -webkit-line-clamp: 1;
                  /* Chỉ hiển thị 1 dòng */
                  line-clamp: 1;
            }

            #notes-container.notes-list-view .card .card-body {
                  padding: 0.5rem;
                  /* Giảm padding của card body */
            }

            /* Compact notes container */
            #notes-container {
                  max-width: 100%;
                  margin: 0;
            }

            #notes-list-container {
                  transition: all 0.3s ease;
            }

            /* Responsive adjustments for notes */
            @media (max-width: 991.98px) {

                  #notes-list-container {
                        padding-left: 0.5rem;
                        padding-right: 0.5rem;
                        border: none;
                        min-height: auto;
                  }

                  .row.g-0 {
                        gap: 0.5rem !important;
                  }

                  #notes-container.list-view {
                        height: 50vh;
                  }
            }

            @media (max-width: 767.98px) {
                  .tab-content {
                        padding: 0.5rem;
                  }

                  #notes-container.list-view {
                        height: 45vh;
                  }
            }

            /* Notes List View Styles */

            #notes-container.list-view .note-list-item {
                  padding: 0.75rem;
                  border-bottom: 1px solid var(--border-color);
                  cursor: pointer;
                  transition: background-color 0.2s;
            }

            #notes-container.list-view .note-list-item:hover {
                  background-color: var(--hover-color);
            }

            #notes-container.list-view .note-list-item.active {
                  background-color: var(--primary-color);
                  color: white;
            }

            #notes-container.list-view .note-list-item.active .note-preview {
                  color: #e6e6e6 !important;
            }

            #notes-container.list-view .note-list-title {
                  font-weight: bold;
                  font-size: 0.95rem;
                  margin-bottom: 0.3rem;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
            }

            #notes-container.list-view .note-preview {
                  font-size: 0.8rem;
                  color: #9ca3af;
                  overflow: hidden;
                  display: -webkit-box;
                  -webkit-line-clamp: 1;
                  /* Giảm từ 2 xuống 1 dòng */
                  line-clamp: 1;
                  /* Standard property for compatibility */
                  -webkit-box-orient: vertical;
            }

            /* ================================================================== */
            /* START: REFACTORED NOTES CARD STYLES (GRID & LIST VIEW) */
            /* ================================================================== */

            /* --- Base styles for all note cards --- */
            #notes-container .card {
                  border-left: 4px solid var(--bs-card-border-color);
                  border-radius: 0;
                  cursor: pointer;
                  display: flex;
                  /* Required for child flex items */
                  flex-direction: column;
                  /* Stack content vertically */
                  width: 100%;
            }

            #notes-container .card-body {
                  display: flex;
                  flex-direction: column;
                  height: 100%;
                  /* Make body fill the card height */
                  padding: 0.75rem;
                  overflow: hidden;
            }

            /* Container rule: Use line-clamp for proper multi-line truncation */
            #notes-container .card-note-body {
                  flex-grow: 1;
                  margin-right: 8px;
                  overflow: hidden;
                  display: -webkit-box;
                  -webkit-line-clamp: 2;
                  /* Limit to 2 lines */
                  -webkit-box-orient: vertical;
                  word-break: break-word;
                  /* Ensure long words wrap */
            }

            #notes-container .card-body .mt-auto {
                  margin-top: auto !important;
                  /* Push status to the bottom */
            }

            /* --- Profile Highlight Animation --- */
            @keyframes profile-bounce {

                  0%,
                  100% {
                        transform: translateY(0);
                  }

                  25% {
                        transform: translateY(-10px);
                  }

                  50% {
                        transform: translateY(0);
                  }

                  75% {
                        transform: translateY(-5px);
                  }
            }

            .profile-highlight {
                  display: inline-block;
                  /* Ensure transform works correctly */
                  animation: profile-bounce 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            /* --- Grid View Specific Styles (Xem Mặc Định) --- */
            .notes-grid-view .col-lg-4,
            .notes-grid-view .col-md-6 {
                  /* Remove padding to make cards flush */
                  padding: 0 !important;
            }

            .notes-grid-view .card {
                  --note-card-height: 120px;
                  /* Default height for grid view */
                  height: var(--note-card-height);
                  transition: height 0.3s ease-in-out;
                  /* Add transition */
            }


            /* --- List View Specific Styles (Xem Danh Sách) --- */
            .notes-list-view .col-lg-4,
            .notes-list-view .col-md-6 {
                  /* In list view, each item is a full-width row */
                  flex: 0 0 100%;
                  max-width: 100%;
                  padding: 0 !important;
                  /* Only bottom padding for spacing */
            }

            .notes-list-view .card {
                  --note-card-height: 100px;
                  /* Default height for list view */
                  height: var(--note-card-height);
                  transition: height 0.3s ease-in-out;
                  /* Add transition */
            }

            /* --- Card Height Modifiers --- */
            #notes-container.h-minus-2 .card {
                  --note-card-height: 80px;
                  /* Shorter cards */
            }

            #notes-container.h-minus-4 .card {
                  --note-card-height: 65px;
                  /* Shortest cards */
            }

            #notes-container.h-minus-4 .card .card-note-body {
                  display: none;
                  /* Hide body completely on smallest size */
            }

            #notes-container.h-minus-4 .card .card-title {
                  font-size: 0.9rem;
                  /* Keep font size reasonable */
                  white-space: normal;
                  /* Allow title to wrap */
                  overflow: hidden;
                  /* Still hide overflow if it's too long */
                  text-overflow: ellipsis;
                  /* Add ellipsis for very long titles */
                  display: -webkit-box;
                  -webkit-line-clamp: 2;
                  /* Allow up to 2 lines for title */
                  -webkit-box-orient: vertical;
            }

            /* Content scaling for smaller cards */
            #notes-container.h-minus-2 .card .card-title {
                  font-size: 0.9rem;
            }

            #notes-container.h-minus-2 .card .card-note-body {
                  -webkit-line-clamp: 1;
                  /* Show only 1 line of preview */
                  line-clamp: 1;
                  font-size: 0.8rem;
            }

            /* ================================================================== */
            /* END: REFACTORED NOTES CARD STYLES */
            /* ================================================================== */

            /* Notes Search Bar Styles */
            .notes-search-container {
                  background-color: transparent;
                  border: none;
            }

            #notes-search-input {
                  background-color: var(--card-bg) !important;
                  border-color: var(--border-color) !important;
                  color: var(--text-color) !important;
            }

            #notes-search-input:focus {
                  background-color: var(--card-bg) !important;
                  border-color: var(--primary-color) !important;
                  color: var(--text-color) !important;
                  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
            }

            #notes-search-input::placeholder {
                  color: #9ca3af !important;
            }

            .input-group-text {
                  background-color: var(--card-bg) !important;
                  border-color: var(--border-color) !important;
                  color: var(--text-color) !important;
            }

            #notes-clear-search {
                  border-left: none !important;
                  background-color: var(--card-bg) !important;
                  border-color: var(--border-color) !important;
                  color: var(--text-color) !important;
                  transition: all 0.2s ease;
            }

            #notes-clear-search:hover {
                  background-color: var(--hover-color) !important;
                  border-color: var(--primary-color) !important;
                  color: #dc3545 !important;
            }

            /* Adjust search input width when panel is shrunk */
            .notes-search-container {
                  transition: transform 0.3s ease;
                  /* Only animate transform for smooth movement */
            }

            /* Grid view: Search bar centered */
            .notes-layout-container .notes-search-container {
                  margin: 0 auto;
                  /* Center the search bar */
                  transform: translateX(0);
                  /* Default position */
            }

            /* List view: Search bar moves to left when panel is shrunk */
            #notes-list-wrapper.shrunk .notes-search-container {
                  width: 100% !important;
                  /* Search takes full width of the shrunk panel */
                  margin: 0;
                  /* Remove center alignment */
                  transform: translateX(-1%);
                  /* Move left by a smaller amount to stay visible */
            }

            /* Notes Detail Panel Styles */
            #notes-detail-column {
                  /* This enables the smooth animation */
                  transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, visibility 0.3s;
            }

            .notes-detail-hidden {
                  /* The state when the panel is hidden */
                  opacity: 0;
                  transform: translateX(30px);
                  /* Increased distance for a clearer slide effect */
                  visibility: hidden;
                  /* Hide it completely */
                  pointer-events: none;
                  /* Prevent mouse interaction when hidden */
            }

            .notes-detail-visible {
                  /* The state when the panel is shown */
                  opacity: 1;
                  transform: translateX(0);
                  visibility: visible;
                  pointer-events: auto;
            }

            #notes-detail-panel {
                  background-color: var(--card-bg);
                  border: 1px solid var(--border-color);
                  height: 100%;
                  min-height: 600px;
                  /* Always visible in DOM */
            }

            #notes-detail-panel .card-header {
                  background-color: var(--hover-color);
                  border-bottom: 1px solid var(--border-color);
            }

            .note-card-active {
                  transform: scale(1.02);
                  box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3) !important;
                  border: 2px solid var(--primary-color) !important;
                  transition: all 0.3s ease;
            }

            .card {
                  transition: all 0.3s ease;
            }

            /* Perfect button alignment for note action buttons */
            .flex-shrink-0.btn-group-vertical {
                  display: flex !important;
                  flex-direction: column !important;
                  align-items: center !important;
                  justify-content: center !important;
                  gap: 2px !important;
            }

            .flex-shrink-0 .btn {
                  display: flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  width: 22px !important;
                  height: 22px !important;
                  padding: 0 !important;
                  border-radius: 4px !important;
                  position: relative !important;
                  overflow: hidden !important;
            }

            .flex-shrink-0 .btn i {
                  margin: 0 !important;
                  padding: 0 !important;
                  line-height: 1 !important;
                  font-size: 10px !important;
                  display: flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                  width: 100% !important;
                  height: 100% !important;
                  position: absolute !important;
                  top: 50% !important;
                  left: 50% !important;
                  transform: translate(-50%, -50%) !important;
            }

            /* Specific styling for edit and delete buttons */
            .btn-outline-secondary {
                  border: 1px solid #6c757d !important;
                  background-color: transparent !important;
                  transition: all 0.2s ease !important;
            }

            .btn-outline-secondary:hover {
                  background-color: #6c757d !important;
                  border-color: #6c757d !important;
                  transform: scale(1.05) !important;
            }

            .btn-outline-danger {
                  border: 1px solid #dc3545 !important;
                  background-color: transparent !important;
                  transition: all 0.2s ease !important;
            }

            .btn-outline-danger:hover {
                  background-color: #dc3545 !important;
                  border-color: #dc3545 !important;
                  transform: scale(1.05) !important;
            }

            /* Inline Editor Styles */
            #detail-editable-content {
                  outline: none;
                  padding: 0.5rem;
                  border-radius: 0.25rem;
                  transition: background-color 0.2s;
                  min-height: 150px;
                  /* Ensure a minimum height */
            }

            #detail-editable-content:hover,
            #detail-editable-content:focus {
                  background-color: var(--hover-color);
            }

            #detail-editable-content:empty:before {
                  content: attr(data-placeholder);
                  color: #6c757d;
            }

            #detail-editable-full {
                  outline: none;
                  padding: 0.5rem;
                  border-radius: 0.25rem;
                  transition: background-color 0.2s;
                  min-height: 150px;
                  /* Ensure a minimum height */
            }

            #detail-editable-full:hover,
            #detail-editable-full:focus {
                  background-color: var(--hover-color);
            }

            #detail-editable-full:empty:before {
                  content: attr(data-placeholder);
                  color: #6c757d;
            }

            /* --- START: Reset styles for any pasted content in notes editor --- */
            #detail-editable-full * {
                  background-color: transparent !important;
                  border: none !important;
            }

            /* --- END: Reset styles for pasted content --- */

            /* --- START: Fix for URL rendering bug in notes editor --- */
            #detail-editable-full a {
                  overflow-wrap: break-word;
                  /* Force long URLs to wrap to the next line */
                  word-wrap: break-word;
                  /* Legacy fallback for older browsers */
                  background-color: transparent !important;
                  /* Remove any unwanted background color */
                  color: #69b3ff;
                  /* Use a standard, readable link color */
                  text-decoration: underline;
                  /* Ensure links are clearly identifiable */
                  cursor: pointer;
                  /* Show pointer cursor on hover */
                  transition: color 0.2s ease, text-shadow 0.2s ease;
                  /* Smooth transition */
            }

            #detail-editable-full a:hover {
                  color: #00e0ff;
                  /* Brighter cyan on hover */
                  text-shadow: 0 0 8px rgba(0, 224, 255, 0.5);
                  /* Subtle glow effect */
            }

            .auto-seeding-time-input::-webkit-outer-spin-button,
            .auto-seeding-time-input::-webkit-inner-spin-button {
                  -webkit-appearance: none;
                  margin: 0;
            }

            .auto-seeding-time-input {
                  -moz-appearance: textfield;
            }

            /* --- END: Fix for URL rendering bug --- */
      </style>
      <!-- Custom Context Menu Styles -->
      <style>
            .custom-context-menu {
                  position: fixed;
                  z-index: 9999;
                  min-width: 200px;
                  background: #23272f;
                  color: #e6e6e6;
                  border-radius: 14px;
                  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.45);
                  padding: 8px 0;
                  display: none;
                  font-size: 1rem;
                  border: 1px solid #333a4a;
                  animation: fadeInMenu 0.15s;
            }

            @keyframes fadeInMenu {
                  from {
                        opacity: 0;
                        transform: scale(0.95);
                  }

                  to {
                        opacity: 1;
                        transform: scale(1);
                  }
            }

            .custom-context-menu .menu-item {
                  padding: 10px 22px;
                  cursor: pointer;
                  border: none;
                  background: none;
                  width: 100%;
                  text-align: left;
                  color: inherit;
                  border-radius: 8px;
                  transition: background 0.15s;
                  font-family: inherit;
            }

            .custom-context-menu .menu-item:hover {
                  background: #313846;
                  color: #00e0ff;
            }

            /* Add these new styles */
            .custom-context-menu .menu-item.has-submenu {
                  position: relative;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
            }

            .custom-context-menu .submenu {
                  position: absolute;
                  left: 100%;
                  top: -8px;
                  /* Align with parent item */
                  display: none;
                  min-width: 150px;
                  background: #2c3340;
                  /* Slightly different color for distinction */
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                  padding: 8px;
                  border: 1px solid #444a59;
                  animation: fadeInMenu 0.1s;
            }

            .custom-context-menu .menu-item.has-submenu:hover>.submenu {
                  display: block;
            }

            .custom-context-menu .submenu .menu-item {
                  padding: 8px 12px;
                  display: flex;
                  align-items: center;
            }

            .custom-context-menu .submenu .menu-item i.bi-check-circle-fill {
                  color: #00e0ff;
            }

            /* Profile span context menu specific styles */
            .context-menu-header {
                  padding: 8px 22px;
                  font-weight: 600;
                  color: #00e0ff;
                  border-bottom: 1px solid #333a4a;
                  margin-bottom: 8px;
                  font-size: 0.9rem;
            }

            .color-grid {
                  display: grid;
                  grid-template-columns: repeat(4, 1fr);
                  gap: 8px;
                  padding: 8px 22px;
                  margin-bottom: 8px;
            }

            .color-option {
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  cursor: pointer;
                  border: 2px solid transparent;
                  transition: all 0.2s ease;
                  position: relative;
            }

            .color-option:hover {
                  border-color: #ffffff;
                  transform: scale(1.1);
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }

            .menu-divider {
                  height: 1px;
                  background: #333a4a;
                  margin: 8px 0;
            }

            #profile-span-context-menu .submenu {
                  padding: 8px;
                  width: 170px;
                  /* Set a fixed width for the color palette */
            }

            #profile-span-context-menu .color-grid {
                  padding: 0;
                  margin: 0;
            }

            .has-profile {
                  color: #00e0ff !important;
                  /* CORRECTED: Cyan/Blue */
                  /* font-weight: bold; REMOVED */
                  border-bottom: 1px dashed #00e0ff;
                  /* CORRECTED: Cyan/Blue */
                  cursor: pointer;
                  transition: all 0.2s ease;
            }

            .has-profile:hover {
                  background-color: rgba(0, 224, 255, 0.15);
                  /* CORRECTED: Cyan/Blue glow */
                  text-shadow: 0 0 8px rgba(0, 224, 255, 0.5);
                  /* CORRECTED: Cyan/Blue glow */
            }
      </style>
      <style>
            #notes-context-menu {
                  display: none;
            }

            #notes-context-menu {
                  display: none;
            }

            #notes-context-menu .menu-item {
                  position: relative;
            }

            #notes-context-menu .color-palette {
                  display: none;
                  position: absolute;
                  left: 100%;
                  top: -8px;
                  background: #2c3340;
                  padding: 8px;
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                  width: 150px;
                  display: grid;
                  grid-template-columns: repeat(4, 1fr);
                  gap: 8px;
            }

            #notes-context-menu .menu-item:hover>.color-palette {
                  display: grid;
            }

            #notes-context-menu .color-palette span {
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  cursor: pointer;
                  border: 1px solid #555;
                  transition: transform 0.2s;
            }

            #notes-context-menu .color-palette span:hover {
                  transform: scale(1.15);
            }

            /* START: Styles for Password Badge Context Menu */
            #password-badge-context-menu .menu-item {
                  position: relative;
            }

            #password-badge-context-menu .color-palette {
                  display: none;
                  position: absolute;
                  left: 100%;
                  top: -8px;
                  background: #2c3340;
                  padding: 8px;
                  border-radius: 8px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                  width: 150px;
                  display: grid;
                  grid-template-columns: repeat(4, 1fr);
                  gap: 8px;
            }

            #password-badge-context-menu .menu-item:hover>.color-palette {
                  display: grid;
            }

            #password-badge-context-menu .color-palette span {
                  width: 24px;
                  height: 24px;
                  border-radius: 50%;
                  cursor: pointer;
                  border: 1px solid #555;
                  transition: transform 0.2s;
            }

            #password-badge-context-menu .color-palette span:hover {
                  transform: scale(1.15);
            }

            /* END: Styles for Password Badge Context Menu */

            /* --- Animation cho thẻ Ghi chú mới --- */
            @keyframes noteCardEnterAnimation {
                  0% {
                        opacity: 0;
                        transform: translateY(25px) scale(0.95);
                        box-shadow: 0 0 15px rgba(0, 224, 255, 0.4);
                  }

                  60% {
                        opacity: 1;
                        transform: translateY(0) scale(1.02);
                        box-shadow: 0 8px 25px rgba(0, 224, 255, 0.25);
                  }

                  100% {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                        box-shadow: none;
                  }
            }

            .note-card-enter .card {
                  animation: noteCardEnterAnimation 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            }

            #notes-container .card {
                  /* Transition mượt mà cho các thuộc tính sẽ thay đổi khi hover */
                  transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1),
                        box-shadow 0.2s cubic-bezier(0.25, 0.8, 0.25, 1),
                        border-color 0.2s ease-in-out;
            }

            #notes-container .card:hover {
                  /* Hiệu ứng dở card */
                  transform: translateY(-10px);
                  /* Hiệu ứng viền và bóng sáng giống hệt trang chủ */
                  border-color: #00e0ff;
                  /* <-- Thêm viền sáng */
                  box-shadow: 0 8px 32px 0 rgba(0, 255, 255, 0.2),
                        0 12px 30px rgba(0, 0, 0, 0.4);
            }

            .note-card-enter-active {
                  transform: translateY(-10px);
                  border-color: #00e0ff;
                  box-shadow: 0 8px 32px 0 rgba(0, 255, 255, 0.2), 0 12px 30px rgba(0, 0, 0, 0.4);
                  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                  /* <-- ADD THIS LINE */
            }
      </style>
      <style>
            #notes-title-input:empty:before {
                  content: attr(placeholder);
                  color: #6c757d;
                  pointer-events: none;
                  display: block;
            }
      </style>
      <script>
            document.addEventListener('DOMContentLoaded', function () {
                  const style = document.createElement('style');
                  style.id = 'dynamic-type-styles';
                  let css = ``;
                  {% for t in password_types %}
                  css += `.table .badge[data-type="{{ t.name }}"] { background-color: {{ t.color }} !important; }\n`;
                  {% endfor %}
                  style.innerHTML = css;
                  document.head.appendChild(style);
            });
      </script>
      <!-- GLOBAL DELETE CONFIRM MODAL (updated style) -->
      <style>
            #globalDeleteConfirmModal .modal-dialog {
                  margin-top: 20vh;
            }

            #globalDeleteConfirmModal .modal-header {
                  /* Match modal body background */
                  color: #fff;
                  border-bottom: none;
            }

            #globalDeleteConfirmModal .modal-content {
                  background: #23272f;
                  border-radius: 0.5rem;
                  border: none;
                  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.25);
            }

            #globalDeleteConfirmModal .modal-footer {
                  border-top: none;
            }

            /* Optimized width for Settings Dashboard modal */
            #utilitiesModal .modal-dialog {
                  max-width: 330px;
            }

            /* Reduce the font size for the toggle label to ensure it fits */
            #utilitiesModal .form-check-label {
                  font-size: 0.9rem;
            }
      </style>

      <!-- Dynamic Profile Styles -->
      <style id="dynamic-profile-styles">
            /* Dynamic profile colors will be injected here */
      </style>
</head>

<body>
      <!-- Dashboard Context Menu -->
      <div id="dashboard-context-menu" class="custom-context-menu">
            <div class="menu-item" onclick="console.log('Reload Dashboard'); location.reload()">Reload Dashboard</div>
            <div class="menu-item" id="context-open-settings">Setting Dashboard</div>
            <div class="menu-item" onclick="console.log('Toggle Dark Mode')">Toggle Dark Mode</div>
      </div>
      <!-- Telegram Context Menu -->
      <div id="telegram-context-menu" class="custom-context-menu">
            <div class="menu-item" onclick="console.log('Add Session')">Add Session</div>
            <div class="menu-item" onclick="console.log('Scrape Users')">Scrape Users</div>
            <div class="menu-item" onclick="console.log('Send Message')">Send Message</div>
            <div class="menu-item" id="tg-context-delete-session"><i class="bi bi-trash"></i> Xóa Session</div>
      </div>

      <!-- Notes Tab Context Menu -->
      <div id="notes-tab-context-menu" class="custom-context-menu">
            <div class="menu-item" onclick="addNewNoteFromContextMenu()">
                  <i class="bi bi-plus-lg"></i> Thêm Ghi Chú Mới
            </div>
            <div class="menu-item has-submenu">
                  <i class="bi bi-aspect-ratio me-2"></i> Chế độ xem
                  <i class="bi bi-chevron-right submenu-arrow"></i>
                  <div class="submenu">
                        <div class="menu-item" data-size-modifier="default">
                              <i class="bi bi-check-circle-fill me-2"></i>Mặc định
                        </div>
                        <div class="menu-item" data-size-modifier="h-minus-2">
                              <i class="bi bi-check-circle-fill me-2 d-none"></i>Thấp
                        </div>
                        <div class="menu-item" data-size-modifier="h-minus-4">
                              <i class="bi bi-check-circle-fill me-2 d-none"></i>Thấp nhất
                        </div>
                  </div>
            </div>
      </div>

      <!-- Note Card Context Menu -->
      <div id="note-card-context-menu" class="custom-context-menu">
            <div class="menu-item" id="context-mark-note">
                  <i class="bi bi-star-fill me-2"></i> Đánh Dấu / Bỏ Đánh Dấu
            </div>
      </div>

      <!-- Profile Span Context Menu -->
      <div id="profile-span-context-menu" class="custom-context-menu">
            <div class="menu-item has-submenu">
                  <i class="bi bi-palette-fill"></i> Đổi màu
                  <i class="bi bi-chevron-right submenu-arrow"></i>
                  <div class="submenu">
                        <div class="color-grid">
                              <div class="color-option" data-color="#00e0ff" style="background-color: #00e0ff;"
                                    title="Cyan"></div>
                              <div class="color-option" data-color="#ff4757" style="background-color: #ff4757;"
                                    title="Red"></div>
                              <div class="color-option" data-color="#2ed573" style="background-color: #2ed573;"
                                    title="Green"></div>
                              <div class="color-option" data-color="#ffa502" style="background-color: #ffa502;"
                                    title="Orange"></div>
                              <div class="color-option" data-color="#3742fa" style="background-color: #3742fa;"
                                    title="Blue"></div>
                              <div class="color-option" data-color="#f368e0" style="background-color: #f368e0;"
                                    title="Pink"></div>
                              <div class="color-option" data-color="#54a0ff" style="background-color: #54a0ff;"
                                    title="Sky Blue"></div>
                              <div class="color-option" data-color="#ffffff" style="background-color: #ffffff;"
                                    title="White"></div>
                        </div>
                  </div>
            </div>
            <div class="menu-item" id="context-delete-profile">
                  <i class="bi bi-trash-fill me-2"></i> Xóa
            </div>
      </div>

      <div class="container-fluid">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-0">
                  <ul class="nav nav-tabs main-nav mb-0" id="main-tab" role="tablist">
                        <li class="nav-item" role="presentation">
                              <button class="nav-link active" id="home-tab" data-bs-toggle="tab"
                                    data-bs-target="#home-tab-pane" type="button" role="tab">
                                    <span class="nav-card-icon"><i class="bi bi-house-door-fill"></i></span> Trang Chủ
                              </button>
                        </li>
                        <li class="nav-item" role="presentation">
                              <button class="nav-link" id="notes-tool-tab" data-bs-toggle="tab"
                                    data-bs-target="#notes-tool-pane" type="button" role="tab">
                                    <span class="nav-card-icon"><i class="bi bi-journal-richtext"></i></span> Ghi chú
                              </button>
                        </li>
                        <li class="nav-item" role="presentation">
                              <button class="nav-link" id="password-tool-tab" data-bs-toggle="tab"
                                    data-bs-target="#password-tool-pane" type="button" role="tab">
                                    <span class="nav-card-icon"><i class="bi bi-shield-lock-fill"></i></span> Quản Lý
                                    Mật Khẩu
                              </button>
                        </li>
                        <li class="nav-item" role="presentation">
                              <button class="nav-link" id="telegram-tool-tab" data-bs-toggle="tab"
                                    data-bs-target="#telegram-tool-pane" type="button" role="tab">
                                    <span class="nav-card-icon"><i class="bi bi-telegram"></i></span> Quản Lý Telegram
                              </button>
                        </li>
                        <li class="nav-item" role="presentation">
                              <button class="nav-link" id="image-editor-tool-tab" data-bs-toggle="tab"
                                    data-bs-target="#image-editor-tool-pane" type="button" role="tab">
                                    <span class="nav-card-icon"><i class="bi bi-image-alt"></i></span> Chỉnh Sửa Ảnh
                              </button>
                        </li>
                        <li class="nav-item" role="presentation">
                              <button class="nav-link" id="healthy-tool-tab" data-bs-toggle="tab"
                                    data-bs-target="#healthy-tool-pane" type="button" role="tab">
                                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #2ed573, #ffc107);"><i class="bi bi-heart-pulse-fill"></i></span> Healthy
                              </button>
                        </li>
                        <li class="nav-item" role="presentation">
                              <button class="nav-link" id="utilities-tool-tab" data-bs-toggle="modal"
                                    data-bs-target="#utilitiesModal" type="button">
                                    <span class="nav-card-icon"
                                          style="background: linear-gradient(135deg, #6c757d, #343a40);"><i
                                                class="bi bi-gear-wide-connected"></i></span> Setting Dashboard
                              </button>
                        </li>
                  </ul>
            </div>

            <div class="tab-content" id="main-tab-content">
                  <div class="tab-pane fade show active p-4" id="home-tab-pane" role="tabpanel">
                        <div class="row g-4">
                              <div class="col-lg-3 col-md-6 d-flex">
                                    <div class="card tool-card w-100"
                                          onclick="document.getElementById('notes-tool-tab').click()">
                                          <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="card-icon mb-3"
                                                      style="background: linear-gradient(135deg, #66BB6A 0%, #26A69A 100%); box-shadow: 0 4px 16px rgba(102, 187, 106, 0.25);">
                                                      <i class="bi bi-journal-richtext"></i>
                                                </div>
                                                <h5 class="card-title">Ghi Chú & Nhắc Việc</h5>
                                                <p class="card-text text-muted">Tạo ghi chú, đặt lịch và quản lý công
                                                      việc.</p>
                                          </div>
                                    </div>
                              </div>
                              <div class="col-lg-3 col-md-6 d-flex">
                                    <div class="card tool-card w-100"
                                          onclick="document.getElementById('password-tool-tab').click()">
                                          <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="card-icon mb-3"><i class="bi bi-shield-lock-fill"></i></div>
                                                <h5 class="card-title">Quản Lý Mật Khẩu</h5>
                                                <p class="card-text text-muted">Lưu trữ và quản lý tài khoản an toàn.
                                                </p>
                                          </div>
                                    </div>
                              </div>
                              <div class="col-lg-3 col-md-6 d-flex">
                                    <div class="card tool-card w-100"
                                          onclick="document.getElementById('telegram-tool-tab').click()">
                                          <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="card-icon mb-3"><i class="bi bi-telegram"></i></div>
                                                <h5 class="card-title">Quản Lý Telegram</h5>
                                                <p class="card-text text-muted">Tự động hóa các tác vụ cho Telegram.</p>
                                          </div>
                                    </div>
                              </div>
                              <div class="col-lg-3 col-md-6 d-flex">
                                    <div class="card tool-card w-100"
                                          onclick="document.getElementById('image-editor-tool-tab').click()">
                                          <div class="card-body text-center d-flex flex-column justify-content-center">
                                                <div class="card-icon mb-3"
                                                      style="background: linear-gradient(135deg, #f953c6 0%, #b91d73 100%); box-shadow: 0 4px 16px rgba(249, 83, 198, 0.25);">
                                                      <i class="bi bi-image-alt"></i>
                                                </div>
                                                <h5 class="card-title">Chỉnh Sửa Ảnh</h5>
                                                <p class="card-text text-muted">Ghép ảnh, thêm text, và các công cụ
                                                      khác.</p>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>

                  <div class="tab-pane fade" id="password-tool-pane" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
                              <h2 class="mb-0 me-3"><i class="bi bi-shield-alt me-2"></i>Trình Quản Lý Mật Khẩu</h2>
                              <form id="pwd-filter-form" method="GET" action="{{ url_for('main_dashboard') }}"
                                    class="d-flex gap-2 flex-grow-1" style="max-width: 500px;">
                                    <input type="hidden" name="tab" value="password">
                                    <select id="pwd-type-filter" name="type" class="form-select">
                                          <option value="">-- Lọc theo loại --</option>
                                          {% for t in password_types %}
                                          <option value="{{ t.name }}" {% if request.args.get('type')==t.name
                                                %}selected{% endif %}>{{ t.name }}</option>
                                          {% endfor %}
                                    </select>
                              </form>
                              <div class="d-flex gap-2 ms-md-auto">
                                    <div class="form-check form-switch d-flex align-items-center me-3">
                                          <input class="form-check-input" type="checkbox" role="switch"
                                                id="pwd-showAllToggle" style="cursor: pointer;">
                                          <label class="form-check-label ms-2" for="pwd-showAllToggle"
                                                style="cursor: pointer;">All Passwords</label>
                                    </div>
                                    <button class="btn btn-outline-info" data-bs-toggle="modal"
                                          data-bs-target="#pwd-manageTypesModal">
                                          <i class="bi bi-tags-fill"></i> Quản Lý Loại
                                    </button>
                                    <button class="btn btn-primary" data-bs-toggle="modal"
                                          data-bs-target="#pwd-addAccountModal">
                                          <i class="bi bi-plus-lg me-1"></i> Thêm Tài Khoản
                                    </button>
                              </div>
                        </div>
                        {% with messages = get_flashed_messages(with_categories=true) %}
                        {% for category, message in messages %}
                        {% if category.startswith('password_') %}
                        <div class="alert alert-{{ category.split('_')[1] }} alert-dismissible fade show border-0"
                              role="alert">{{ message }}<button type="button" class="btn-close"
                                    data-bs-dismiss="alert"></button></div>
                        {% endif %}
                        {% endfor %}
                        {% endwith %}
                        <div class="table-responsive">
                              <table class="table table-striped table-hover align-middle mb-0">
                                    <thead>
                                          <tr>
                                                <th>Loại</th>
                                                <th>Email/Tên Đăng Nhập</th>
                                                <th>Mật Khẩu</th>
                                                <th>Mã 2FA</th>
                                                <th>Ghi Chú</th>
                                                <th class="text-center">Hành Động</th>
                                          </tr>
                                    </thead>
                                    <tbody>
                                          {% for account in password_accounts %}
                                          <tr>
                                                <td>
                                                      <span class="badge" data-type="{{ account.type }}">{{ account.type
                                                            }}</span>
                                                </td>
                                                <td>{{ account.username }}</td>
                                                <td class="password-cell">
                                                      <span class="password-text me-2">{{ account.password }}</span>
                                                      <div class="btn-group btn-group-sm">
                                                            <button
                                                                  class="btn btn-outline-secondary pwd-toggle-visibility"
                                                                  type="button" title="Hiện/Ẩn mật khẩu">
                                                                  <i class="bi bi-eye-fill"></i>
                                                            </button>
                                                            <button class="btn btn-outline-secondary pwd-btn-copy"
                                                                  data-password="{{ account.password }}"
                                                                  title="Copy mật khẩu">
                                                                  <i class="bi bi-clipboard"></i>
                                                            </button>
                                                      </div>
                                                </td>
                                                <td>
                                                      {% if account.get('2fa') %}
                                                      <div class="d-flex align-items-center justify-content-between">
                                                            <span>{{ account.get('2fa') }}</span>
                                                            <button
                                                                  class="btn btn-sm btn-outline-secondary pwd-btn-copy ms-2"
                                                                  data-password="{{ account.get('2fa') }}"
                                                                  title="Copy mã 2FA">
                                                                  <i class="bi bi-clipboard"></i>
                                                            </button>
                                                      </div>
                                                      {% endif %}
                                                </td>
                                                <td>{{ account.notes }}</td>
                                                <td class="text-center">
                                                      <button class="btn btn-sm btn-warning pwd-edit-btn"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#pwd-editAccountModal"
                                                            data-id="{{ account.id }}" data-type="{{ account.type }}"
                                                            data-username="{{ account.username }}"
                                                            data-password="{{ account.password }}"
                                                            data-twofa="{{ account.get('2fa', '') }}"
                                                            data-notes="{{ account.notes }}"><i
                                                                  class="bi bi-pencil-fill"></i>
                                                      </button>
                                                      <form action="{{ url_for('password.delete_account', account_id=account.id) }}"
                                                            method="POST" class="d-inline needs-confirm-delete"
                                                            data-confirm-message="Bạn có chắc muốn xóa tài khoản mật khẩu này?">
                                                            <button type="submit" class="btn btn-sm btn-danger"><i
                                                                        class="bi bi-trash-fill"></i></button>
                                                      </form>
                                                </td>
                                          </tr>
                                          {% else %}<tr>
                                                <td colspan="6" class="text-center text-muted p-4">Không có tài khoản
                                                      nào.</td>
                                          </tr>
                                          {% endfor %}
                                    </tbody>
                              </table>
                        </div>
                  </div>

                  <div class="tab-pane fade" id="telegram-tool-pane" role="tabpanel">
                        <div class="sticky-top">
                              <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
                                    <div class="d-flex align-items-center gap-3 flex-wrap">
                                          <div class="stat-card bg-dark rounded">
                                                <div class="d-flex align-items-center">
                                                      <h6 class="mb-0 me-4">All Bots: <span id="tg-total-sessions-count"
                                                                  class="text-warning fw-bold">0</span></h6>
                                                      <h6 class="mb-0">📊 Status: <span id="tg-status-progress-text"
                                                                  class="text-info fw-bold">Idle</span></h6>
                                                </div>
                                                <hr class="my-1" style="border-top-color: #4b5563;">
                                                <div class="text-center small">
                                                      <span class="me-3 text-success">Success: <b
                                                                  id="tg-status-success-count">0</b></span>
                                                      <span class="text-danger">Failed: <b
                                                                  id="tg-status-failed-count">0</b></span>
                                                </div>
                                          </div>
                                          <div class="d-flex gap-2 align-items-end flex-wrap">
                                                <div>
                                                      <label for="tg-core-input"
                                                            class="form-label mb-0 small">Core</label>
                                                      <input type="number" class="form-control form-control-sm"
                                                            id="tg-core-input" value="5"
                                                            title="Số session chạy song song trong một đợt"
                                                            style="width: 70px;">
                                                </div>
                                                <div>
                                                      <label for="tg-delay-session-input"
                                                            class="form-label mb-0 small">Delay/Session (s)</label>
                                                      <input type="number" class="form-control form-control-sm"
                                                            id="tg-delay-session-input" value="10"
                                                            title="Khoảng cách (giây) giữa các session trong một đợt"
                                                            style="width: 70px;">
                                                </div>
                                                <div>
                                                      <label for="tg-delay-batch-input"
                                                            class="form-label mb-0 small">Delay/Đợt (s)</label>
                                                      <input type="number" class="form-control form-control-sm"
                                                            id="tg-delay-batch-input" value="600"
                                                            title="Khoảng cách (giây) giữa các đợt chạy"
                                                            style="width: 70px;">
                                                </div>
                                                <div class="border-start ps-2">
                                                      <div class="form-check form-switch mb-1">
                                                            <input class="form-check-input" type="checkbox"
                                                                  role="switch" id="tg-admin-reply-switch">
                                                            <label class="form-check-label small"
                                                                  for="tg-admin-reply-switch">Admin Trả Lời</label>
                                                      </div>
                                                      <input type="number" class="form-control form-control-sm"
                                                            id="tg-admin-delay-input" value="10"
                                                            title="Delay cho Admin trả lời (giây)" style="width: 70px;"
                                                            disabled>
                                                </div>
                                                <button class="btn btn-primary fw-bold" id="tg-runStopBtn"
                                                      data-task-running="false">
                                                      <i class="bi bi-play-fill"></i> Run
                                                </button>
                                          </div>
                                    </div>
                                    <div class="d-flex gap-2 align-items-end flex-wrap">
                                          <button class="btn btn-secondary" data-bs-toggle="modal"
                                                data-bs-target="#tg-proxyModal">
                                                <i class="bi bi-shield-shaded me-1"></i> Proxy
                                          </button>
                                          <button class="btn btn-success" data-bs-toggle="modal"
                                                data-bs-target="#tg-addSessionModal"><i class="bi bi-plus-lg"></i> Add
                                                Session</button>
                                          <button class="btn btn-info" id="tg-checkLiveBtn"><i
                                                      class="bi bi-broadcast"></i> Check Live</button>
                                          <select class="form-select" id="tg-group-session-select"
                                                style="width: 180px;"></select>
                                    </div>
                              </div>
                        </div>
                        <div class="main-tool-container">
                              <div class="nav flex-column nav-pills" id="tg-v-pills-tab" role="tablist">
                                    <button class="nav-link active" id="tg-v-pills-session-manager-tab"
                                          data-bs-toggle="pill" data-bs-target="#tg-v-pills-session-manager"
                                          type="button" role="tab">🤖 Session Manager</button>
                                    <button class="nav-link" id="tg-v-pills-group-tab" data-bs-toggle="pill"
                                          data-bs-target="#tg-v-pills-group" type="button" role="tab"><i
                                                class="bi bi-people-fill text-success me-2"></i>Group</button>
                                    <button class="nav-link" id="tg-v-pills-automatic-tab" data-bs-toggle="pill"
                                          data-bs-target="#tg-v-pills-automatic" type="button" role="tab">🔄
                                          Automatic</button>
                              </div>
                              <div class="tab-content" id="tg-v-pills-tabContent">
                                    <div class="tab-pane fade show active" id="tg-v-pills-session-manager"
                                          role="tabpanel">
                                          <div class="row" id="tg-session-tables-container">
                                                <div class="col-md-6 mb-4">
                                                      <div class="card" style="cursor: default;">
                                                            <div class="card-body p-2">
                                                                  <div class="table-responsive">
                                                                        <table class="table table-striped">
                                                                              <thead>
                                                                                    <tr>
                                                                                          <th style="width: 5%;"><input
                                                                                                      class="form-check-input tg-session-checkbox"
                                                                                                      type="checkbox"
                                                                                                      id="tg-selectAllCheckbox">
                                                                                          </th>
                                                                                          <th>STT</th>
                                                                                          <th>Phone</th>
                                                                                          <th
                                                                                                class="d-none d-md-table-cell">
                                                                                                Full Name</th>
                                                                                          <th
                                                                                                class="d-none d-md-table-cell">
                                                                                                Username</th>
                                                                                          <th>Live</th>
                                                                                          <th>Status</th>
                                                                                    </tr>
                                                                              </thead>
                                                                              <tbody id="tg-sessions-table-left-body">
                                                                                    <tr>
                                                                                          <td colspan="7"
                                                                                                class="text-center text-muted">
                                                                                                Vui lòng chọn một nhóm.
                                                                                          </td>
                                                                                    </tr>
                                                                              </tbody>
                                                                        </table>
                                                                  </div>
                                                            </div>
                                                      </div>
                                                </div>
                                                <div class="col-md-6 mb-4">
                                                      <div class="card" style="cursor: default;">
                                                            <div class="card-body p-2">
                                                                  <div class="table-responsive">
                                                                        <table class="table table-striped">
                                                                              <thead>
                                                                                    <tr>
                                                                                          <th style="width: 5%;"><input
                                                                                                      class="form-check-input tg-session-checkbox"
                                                                                                      type="checkbox"
                                                                                                      id="tg-selectAllCheckbox-right"
                                                                                                      disabled></th>
                                                                                          <th>STT</th>
                                                                                          <th>Phone</th>
                                                                                          <th
                                                                                                class="d-none d-md-table-cell">
                                                                                                Full Name</th>
                                                                                          <th
                                                                                                class="d-none d-md-table-cell">
                                                                                                Username</th>
                                                                                          <th>Live</th>
                                                                                          <th>Status</th>
                                                                                    </tr>
                                                                              </thead>
                                                                              <tbody id="tg-sessions-table-right-body">
                                                                              </tbody>
                                                                        </table>
                                                                  </div>
                                                            </div>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>
                                    <div class="tab-pane fade" id="tg-v-pills-group" role="tabpanel">
                                          <div class="row" id="tg-group-task-cards">
                                                <div class="col-xl-3 col-md-6 mb-4">
                                                      <div class="card h-100" data-task-id="joinGroup">
                                                            <div class="card-body text-center d-flex flex-column">
                                                                  <h5 class="card-title"><i
                                                                              class="bi bi-box-arrow-in-right me-2 text-primary"></i>Join
                                                                        Group/Channel</h5>
                                                                  <p class="card-text small">Cho các tài khoản đã chọn
                                                                        tham gia group.</p><button
                                                                        class="btn btn-primary mt-auto"
                                                                        onclick="tg_openConfigModal('joinGroup', event)">Cấu
                                                                        hình</button>
                                                            </div>
                                                      </div>
                                                </div>
                                                <div class="col-xl-3 col-md-6 mb-4">
                                                      <div class="card h-100" data-task-id="seedingGroup">
                                                            <div class="card-body text-center d-flex flex-column">
                                                                  <h5 class="card-title"><i
                                                                              class="bi bi-chat-dots-fill me-2 text-warning"></i>Seeding
                                                                        Group</h5>
                                                                  <p class="card-text small">Tự động tương tác, trò
                                                                        chuyện trong group.</p><button
                                                                        class="btn btn-warning mt-auto"
                                                                        onclick="tg_openConfigModal('seedingGroup', event)">Cấu
                                                                        hình</button>
                                                            </div>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>
                                    <div class="tab-pane fade" id="tg-v-pills-automatic" role="tabpanel">
                                          <div class="row">
                                                <div class="col-lg-6 col-md-8">
                                                      <div class="card">
                                                            <div class="card-header d-flex align-items-center">
                                                                  <h5 class="mb-0"><i
                                                                              class="bi-clock-history me-2"></i>Auto
                                                                        Seeding</h5>
                                                                  <div id="auto-seeding-status-badge-container"
                                                                        class="ms-3">
                                                                        <span class="badge bg-secondary">Đã tắt</span>
                                                                  </div>

                                                                  <div class="d-flex align-items-center ms-auto gap-4">
                                                                        <div class="form-check form-switch">
                                                                              <input class="form-check-input"
                                                                                    type="checkbox" role="switch"
                                                                                    id="auto-seeding-daily">
                                                                              <label class="form-check-label small"
                                                                                    for="auto-seeding-daily">Lặp lại mỗi
                                                                                    ngày</label>
                                                                        </div>
                                                                        <div class="form-check form-switch">
                                                                              <input class="form-check-input"
                                                                                    type="checkbox" role="switch"
                                                                                    id="auto-seeding-enabled"
                                                                                    style="transform: scale(1.3);">
                                                                              <label class="form-check-label"
                                                                                    for="auto-seeding-enabled">Bật</label>
                                                                        </div>
                                                                  </div>
                                                            </div>
                                                            <div class="card-body">
                                                                  <div class="row g-3 mb-3">
                                                                        <div class="col-auto">
                                                                              <label class="form-label">Thời gian
                                                                                    chạy:</label>
                                                                              <div class="input-group">
                                                                                    <input type="number"
                                                                                          class="form-control auto-seeding-time-input"
                                                                                          id="auto-seeding-hour"
                                                                                          placeholder="Giờ" min="1"
                                                                                          max="12" style="width: 70px;">
                                                                                    <span
                                                                                          class="input-group-text p-1">:</span>
                                                                                    <input type="number"
                                                                                          class="form-control auto-seeding-time-input"
                                                                                          id="auto-seeding-minute"
                                                                                          placeholder="Phút" min="0"
                                                                                          max="59" style="width: 77px;">
                                                                                    <select class="form-select"
                                                                                          id="auto-seeding-ampm"
                                                                                          style="width: 80px;">
                                                                                          <option value="AM">AM</option>
                                                                                          <option value="PM" selected>PM
                                                                                          </option>
                                                                                    </select>
                                                                              </div>
                                                                        </div>
                                                                        <div class="col-auto">
                                                                              <label class="form-label">Thời gian kết
                                                                                    thúc:</label>
                                                                              <div class="input-group">
                                                                                    <input type="number"
                                                                                          class="form-control auto-seeding-time-input"
                                                                                          id="auto-seeding-end-hour"
                                                                                          placeholder="Giờ" min="1"
                                                                                          max="12" style="width: 70px;">
                                                                                    <span
                                                                                          class="input-group-text p-1">:</span>
                                                                                    <input type="number"
                                                                                          class="form-control auto-seeding-time-input"
                                                                                          id="auto-seeding-end-minute"
                                                                                          placeholder="Phút" min="0"
                                                                                          max="59" style="width: 77px;">
                                                                                    <select class="form-select"
                                                                                          id="auto-seeding-end-ampm"
                                                                                          style="width: 80px;">
                                                                                          <option value="AM">AM</option>
                                                                                          <option value="PM" selected>PM
                                                                                          </option>
                                                                                    </select>
                                                                              </div>
                                                                        </div>
                                                                        <div class="col-auto ms-auto">
                                                                              <label for="auto-seeding-group-select"
                                                                                    class="form-label">Chọn
                                                                                    Nhóm:</label>
                                                                              <select id="auto-seeding-group-select"
                                                                                    class="form-select"
                                                                                    style="min-width: 200px;">
                                                                                    <option value="">-- Chọn nhóm để
                                                                                          chạy --</option>
                                                                              </select>
                                                                        </div>
                                                                  </div>
                                                                  <div class="d-flex justify-content-end">
                                                                        <button class="btn btn-primary"
                                                                              id="save-auto-seeding-btn"><i
                                                                                    class="bi bi-save me-1"></i> Lưu Cài
                                                                              Đặt</button>
                                                                  </div>
                                                            </div>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>

                  <div class="tab-pane fade p-3" id="image-editor-tool-pane" role="tabpanel">
                        <div class="row g-3">
                              <!-- Column 1: Main Tool Sidebar (Red Box) -->
                              <div class="col-lg-2">
                                    <div class="nav flex-column nav-pills w-100" id="ie-v-pills-tab" role="tablist"
                                          aria-orientation="vertical">
                                          <button class="nav-link active" id="ie-v-pills-collage-tab"
                                                data-bs-toggle="pill" data-bs-target="#ie-v-pills-collage" type="button"
                                                role="tab"><i class="bi bi-grid-fill me-2"></i>Ghép Ảnh</button>
                                          <button class="nav-link" id="ie-v-pills-text-tab" data-bs-toggle="pill"
                                                data-bs-target="#ie-v-pills-text" type="button" role="tab"><i
                                                      class="bi bi-pencil-square me-2"></i>Thêm Chữ</button>
                                    </div>
                              </div>

                              <!-- Column 2: Tool Options Panel (Blue Box) -->
                              <div class="col-lg-2 d-flex flex-column">
                                    <div id="ie-options-panel" class="flex-grow-1">
                                          <div class="tab-content w-100" id="ie-v-pills-tabContent">
                                                <div class="tab-pane fade show active" id="ie-v-pills-collage"
                                                      role="tabpanel">
                                                      <div class="d-grid mb-3">
                                                            <input class="d-none" type="file" id="ie-image-upload"
                                                                  multiple accept="image/*">
                                                            <button class="btn btn-primary" id="ie-image-upload-btn">
                                                                  <i class="bi bi-upload me-2"></i> Tải Ảnh Lên
                                                            </button>
                                                      </div>
                                                      <div class="mb-3">
                                                            <label class="form-label">Ảnh đã tải (<span
                                                                        id="ie-image-count">0</span>)</label>
                                                            <div id="ie-uploaded-thumbnails">
                                                                  <div
                                                                        class="text-muted d-flex align-items-center justify-content-center h-100 p-2 text-center small">
                                                                        Chưa có ảnh nào
                                                                  </div>
                                                            </div>
                                                      </div>
                                                      <div class="mb-3">
                                                            <label class="form-label">Chọn bố cục</label>
                                                            <div id="ie-layout-templates">
                                                                  <div
                                                                        class="text-muted d-flex align-items-center justify-content-center h-100 p-2 text-center small">
                                                                        Tải ảnh lên để xem bố cục
                                                                  </div>
                                                            </div>
                                                      </div>
                                                      <div class="mb-3">
                                                            <label class="form-label">Tùy chỉnh ảnh ghép</label>
                                                            <div class="row g-2">
                                                                  <div class="col-6">
                                                                        <label for="ie-space-input"
                                                                              class="form-label small">Khoảng
                                                                              cách</label>
                                                                        <input type="number" class="form-control"
                                                                              id="ie-space-input" value="10" min="0">
                                                                  </div>
                                                                  <div class="col-6">
                                                                        <label for="ie-color-input"
                                                                              class="form-label small">Màu nền</label>
                                                                        <input type="color"
                                                                              class="form-control form-control-color w-100"
                                                                              id="ie-color-input" value="#1a1d21"
                                                                              title="Chọn màu nền">
                                                                  </div>
                                                            </div>
                                                            <div class="d-flex flex-wrap gap-1 mt-2 ie-color-swatches"
                                                                  data-target-input="ie-color-input">
                                                                  <span data-color="#ffffff"
                                                                        style="background-color:#ffffff"></span>
                                                                  <span data-color="#dc3545"
                                                                        style="background-color:#dc3545"></span>
                                                                  <span data-color="#fd7e14"
                                                                        style="background-color:#fd7e14"></span>
                                                                  <span data-color="#ffc107"
                                                                        style="background-color:#ffc107"></span>
                                                                  <span data-color="#198754"
                                                                        style="background-color:#198754"></span>
                                                                  <span data-color="#0d6efd"
                                                                        style="background-color:#0d6efd"></span>
                                                                  <span data-color="#6f42c1"
                                                                        style="background-color:#6f42c1"></span>
                                                                  <span data-color="rainbow"></span>
                                                            </div>
                                                      </div>
                                                </div>
                                                <div class="tab-pane fade" id="ie-v-pills-text" role="tabpanel">
                                                      <div class="d-grid gap-2 mb-3">
                                                            <button id="ie-add-text-btn" class="btn btn-info"><i
                                                                        class="bi bi-fonts me-2"></i>Thêm Chữ</button>
                                                      </div>
                                                      <!-- Text properties toolbar (initially hidden) -->
                                                      <div id="ie-text-toolbar" class="d-none">
                                                            <h6>Tùy chỉnh chữ</h6>
                                                            <div class="mb-2">
                                                                  <label for="ie-font-select"
                                                                        class="form-label small">Font Chữ</label>
                                                                  <select class="form-select form-select-sm"
                                                                        id="ie-font-select">
                                                                        <!-- Fonts will be populated by JS -->
                                                                  </select>
                                                            </div>
                                                            <div class="row g-2 mb-2">
                                                                  <div class="col-7">
                                                                        <label for="ie-font-size-input"
                                                                              class="form-label small">Cỡ chữ</label>
                                                                        <input type="number"
                                                                              class="form-control form-control-sm"
                                                                              id="ie-font-size-input" value="50"
                                                                              min="1">
                                                                  </div>
                                                                  <div class="col-5">
                                                                        <label for="ie-color-text-input"
                                                                              class="form-label small">Màu chữ</label>
                                                                        <input type="color"
                                                                              class="form-control form-control-color form-control-sm w-100"
                                                                              id="ie-color-text-input" value="#FFFFFF">
                                                                  </div>
                                                            </div>
                                                            <div class="d-flex flex-wrap gap-1 mb-3 ie-color-swatches"
                                                                  data-target-input="ie-color-text-input">
                                                                  <span data-color="#FFFFFF"
                                                                        style="background-color:#FFFFFF"></span>
                                                                  <span data-color="#000000"
                                                                        style="background-color:#000000"></span>
                                                                  <span data-color="#dc3545"
                                                                        style="background-color:#dc3545"></span>
                                                                  <span data-color="#fd7e14"
                                                                        style="background-color:#fd7e14"></span>
                                                                  <span data-color="#ffc107"
                                                                        style="background-color:#ffc107"></span>
                                                                  <span data-color="#198754"
                                                                        style="background-color:#198754"></span>
                                                                  <span data-color="#0d6efd"
                                                                        style="background-color:#0d6efd"></span>
                                                                  <span data-color="#6f42c1"
                                                                        style="background-color:#6f42c1"></span>
                                                                  <span data-color="rainbow"></span>
                                                            </div>
                                                            <div class="mb-2">
                                                                  <label class="form-label small">Kiểu chữ</label>
                                                                  <div class="btn-group w-100 btn-group-sm"
                                                                        id="ie-text-style-btns">
                                                                        <button type="button"
                                                                              class="btn btn-outline-secondary"
                                                                              data-style="fontWeight" data-value="bold"
                                                                              title="In đậm"><i
                                                                                    class="bi bi-type-bold"></i></button>
                                                                        <button type="button"
                                                                              class="btn btn-outline-secondary"
                                                                              data-style="fontStyle" data-value="italic"
                                                                              title="In nghiêng"><i
                                                                                    class="bi bi-type-italic"></i></button>
                                                                        <button type="button"
                                                                              class="btn btn-outline-secondary"
                                                                              data-style="textDecoration"
                                                                              data-value="underline"
                                                                              title="Gạch chân"><i
                                                                                    class="bi bi-type-underline"></i></button>
                                                                  </div>
                                                            </div>
                                                            <div>
                                                                  <label class="form-label small">Căn chỉnh</label>
                                                                  <div class="btn-group w-100 btn-group-sm"
                                                                        id="ie-text-align-btns">
                                                                        <button type="button"
                                                                              class="btn btn-outline-secondary"
                                                                              data-align="left" title="Căn trái"><i
                                                                                    class="bi bi-text-left"></i></button>
                                                                        <button type="button"
                                                                              class="btn btn-outline-secondary"
                                                                              data-align="center" title="Căn giữa"><i
                                                                                    class="bi bi-text-center"></i></button>
                                                                        <button type="button"
                                                                              class="btn btn-outline-secondary"
                                                                              data-align="right" title="Căn phải"><i
                                                                                    class="bi bi-text-right"></i></button>
                                                                  </div>
                                                            </div>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>
                                    <div class="mt-auto pt-3">
                                          <div class="d-flex justify-content-between">
                                                <button class="btn btn-outline-danger" id="ie-reset-btn"
                                                      title="Xóa hết ảnh và làm lại">
                                                      <i class="bi bi-arrow-counterclockwise"></i> Reset
                                                </button>
                                                <button class="btn btn-success" id="ie-save-btn">
                                                      <i class="bi bi-download"></i> Lưu Ảnh
                                                </button>
                                          </div>
                                    </div>
                              </div>

                              <!-- Column 3: Canvas Preview -->
                              <div class="col-lg-8">
                                    <div id="ie-canvas-wrapper">
                                          <p id="ie-canvas-placeholder" class="text-muted">Kết quả sẽ hiển thị ở đây</p>
                                          <canvas id="ie-canvas" tabindex="0"></canvas>
                                          <!-- Textarea for editing will be dynamically added here -->
                                    </div>
                              </div>
                        </div>
                  </div>

                  <div class="tab-pane fade" id="healthy-tool-pane" role="tabpanel">
                        <div class="main-tool-container">
                              <div class="nav flex-column nav-pills" id="healthy-v-pills-tab" role="tablist">
                                    <button class="nav-link active" id="healthy-v-pills-kcal-tab"
                                          data-bs-toggle="pill" data-bs-target="#healthy-v-pills-kcal"
                                          type="button" role="tab"><i class="bi bi-calculator-fill me-2"></i>Kcal</button>
                              </div>
                              <div class="tab-content" id="healthy-v-pills-tabContent">
                                    <div class="tab-pane fade show active" id="healthy-v-pills-kcal" role="tabpanel">
                                          <div class="card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                      <h5 class="mb-0">Kcal Calculator</h5>
                                                      <div class="text-center fw-bold" id="kcal-totals-header">
                                                            <span class="me-3">Kcal: <span id="kcal-total-cal" class="text-warning">0</span></span>
                                                            <span class="me-3">P: <span id="kcal-total-p" class="text-danger">0</span>g</span>
                                                            <span class="me-3">F: <span id="kcal-total-f" class="text-info">0</span>g</span>
                                                            <span>C: <span id="kcal-total-c" class="text-success">0</span>g</span>
                                                      </div>
                                                      <button class="btn btn-sm btn-outline-secondary" id="kcal-reset-btn" title="Làm trống danh sách">
                                                            <i class="bi bi-arrow-counterclockwise"></i> Reset
                                                      </button>
                                                </div>
                                                <div class="card-body">
                                                      <div class="row g-4" id="kcal-container">
                                                            <div class="col-md-4">
                                                                  <div class="card h-100">
                                                                        <div class="card-header d-flex justify-content-between align-items-center">
                                                                              <h6 class="mb-0"><i class="bi bi-egg-fried me-2 text-warning"></i>Tinh Bột</h6>
                                                                              <button class="btn btn-sm btn-primary kcal-add-btn" data-bs-toggle="modal" data-bs-target="#kcal-add-food-modal" data-category="carbs">
                                                                                    <i class="bi bi-plus-lg"></i>
                                                                              </button>
                                                                        </div>
                                                                        <ul class="list-group list-group-flush" id="kcal-list-carbs">
                                                                        </ul>
                                                                  </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                  <div class="card h-100">
                                                                        <div class="card-header d-flex justify-content-between align-items-center">
                                                                              <h6 class="mb-0"><i class="bi bi-fish me-2 text-danger"></i>Thịt/Cá</h6>
                                                                              <button class="btn btn-sm btn-primary kcal-add-btn" data-bs-toggle="modal" data-bs-target="#kcal-add-food-modal" data-category="protein">
                                                                                    <i class="bi bi-plus-lg"></i>
                                                                              </button>
                                                                        </div>
                                                                        <ul class="list-group list-group-flush" id="kcal-list-protein">
                                                                        </ul>
                                                                  </div>
                                                            </div>
                                                            <div class="col-md-4">
                                                                  <div class="card h-100">
                                                                        <div class="card-header d-flex justify-content-between align-items-center">
                                                                              <h6 class="mb-0"><i class="bi bi-flower1 me-2 text-success"></i>Rau/Củ</h6>
                                                                              <button class="btn btn-sm btn-primary kcal-add-btn" data-bs-toggle="modal" data-bs-target="#kcal-add-food-modal" data-category="veggies">
                                                                                    <i class="bi bi-plus-lg"></i>
                                                                              </button>
                                                                        </div>
                                                                        <ul class="list-group list-group-flush" id="kcal-list-veggies">
                                                                        </ul>
                                                                  </div>
                                                            </div>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>

                  <div class="tab-pane fade" id="notes-tool-pane" role="tabpanel">
                        <div class="notes-layout-container">
                              <div id="notes-list-wrapper">
                                    <div class="d-flex justify-content-start align-items-center mb-2">
                                          <div class="position-relative notes-search-container" style="width: 50%;">
                                                <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3"
                                                      style="z-index: 10;"></i>
                                                <input type="text" class="form-control ps-5" id="notes-search-input"
                                                      spellcheck="false" placeholder="Tìm kiếm ghi chú..."
                                                      style="border-radius: 25px;">
                                          </div>
                                    </div>
                                    <div id="notes-container" class="row" spellcheck="false">
                                    </div>
                              </div>

                              <div id="notes-detail-wrapper">
                                    <div id="notes-detail-panel" class="card h-100">
                                          <div class="card-header">
                                          </div>
                                          <div class="card-body" id="notes-detail-content-wrapper">
                                                <div class="text-center text-muted p-3 h-100 d-flex flex-column justify-content-center align-items-center"
                                                      id="notes-detail-placeholder">
                                                      <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                                                      <h6 class="mt-2">Chọn ghi chú</h6>
                                                      <small>Click để xem</small>
                                                </div>
                                                <div id="notes-detail-content" class="d-none">
                                                </div>
                                          </div>
                                    </div>
                              </div>
                        </div>
                  </div>
            </div>
      </div>

      <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100">
            <div id="liveToast" class="toast" role="alert">
                  <div class="toast-header" id="toastHeader"><strong class="me-auto" id="toastTitle">Thông
                              báo</strong><button type="button" class="btn-close btn-close-white"
                              data-bs-dismiss="toast"></button></div>
                  <div class="toast-body" id="toastBody"></div>
            </div>
      </div>
      <div class="modal fade" id="pwd-addAccountModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <form action="{{ url_for('password.add_account') }}" method="POST">
                              <div class="modal-header">
                                    <h5 class="modal-title">Thêm Tài Khoản Mới</h5><button type="button"
                                          class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                    <div class="mb-3"><label class="form-label">Loại tài khoản</label><select
                                                class="form-select" name="type" required>{% for t in password_types %}
                                                <option value="{{t.name}}">{{t.name}}</option>{% endfor %}
                                          </select></div>
                                    <div class="mb-3"><label class="form-label">Email/Tên đăng nhập</label><input
                                                type="text" class="form-control" name="username" spellcheck="false"
                                                required autocomplete="off"></div>
                                    <div class="mb-3"><label class="form-label">Mật khẩu</label><input type="text"
                                                class="form-control" name="password" spellcheck="false" required
                                                autocomplete="new-password"></div>
                                    <div class="mb-3"><label class="form-label">Mã 2FA (nếu có)</label><input
                                                type="text" class="form-control" name="2fa" spellcheck="false"
                                                autocomplete="off"></div>
                                    <div class="mb-3"><label class="form-label">Ghi chú</label><textarea
                                                class="form-control" name="notes" spellcheck="false"
                                                rows="3"></textarea></div>
                              </div>
                              <div class="modal-footer"><button type="button" class="btn btn-secondary"
                                          data-bs-dismiss="modal">Đóng</button><button type="submit"
                                          class="btn btn-primary">Lưu</button></div>
                        </form>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="pwd-editAccountModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <form id="pwd-editForm" method="POST">
                              <div class="modal-header">
                                    <h5 class="modal-title">Sửa Tài Khoản</h5><button type="button"
                                          class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body"><input type="hidden" name="id" id="pwd-editId">
                                    <div class="mb-3"><label class="form-label">Loại tài khoản</label><select
                                                class="form-select" id="pwd-editType" name="type" required>{% for t in
                                                password_types %}<option value="{{t.name}}">{{t.name}}</option>{% endfor
                                                %}</select></div>
                                    <div class="mb-3"><label class="form-label">Email/Tên đăng nhập</label><input
                                                type="text" class="form-control" id="pwd-editUsername" name="username"
                                                spellcheck="false" required autocomplete="off"></div>
                                    <div class="mb-3"><label class="form-label">Mật khẩu</label><input type="text"
                                                class="form-control" id="pwd-editPassword" name="password"
                                                spellcheck="false" required autocomplete="new-password">
                                    </div>
                                    <div class="mb-3"><label class="form-label">Mã 2FA (nếu có)</label><input
                                                type="text" class="form-control" id="pwd-editTwofa" name="2fa"
                                                spellcheck="false" autocomplete="off"></div>
                                    <div class="mb-3"><label class="form-label">Ghi chú</label><textarea
                                                class="form-control" id="pwd-editNotes" name="notes" spellcheck="false"
                                                rows="3"></textarea></div>
                              </div>
                              <div class="modal-footer"><button type="button" class="btn btn-secondary"
                                          data-bs-dismiss="modal">Đóng</button><button type="submit"
                                          class="btn btn-primary">Lưu</button></div>
                        </form>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="pwd-manageTypesModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Quản Lý Loại Tài Khoản</h5><button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <div class="mb-4">
                                    <h5>Thêm loại mới</h5>
                                    <form action="{{ url_for('password.add_type') }}" method="POST"
                                          class="d-flex gap-2"><input type="text" name="new_type" class="form-control"
                                                placeholder="Tên loại mới (VD: Youtube)" spellcheck="false"
                                                required><button type="submit" class="btn btn-success">Thêm</button>
                                    </form>
                              </div>
                              <hr>
                              <div>
                                    <h5>Các loại hiện có</h5>
                                    <!-- Password types list (fix for linter error at 1484) -->
                                    <ul class="list-group">
                                          {% for type in password_types %}
                                          <li
                                                class="list-group-item d-flex justify-content-between align-items-center bg-transparent border-secondary">
                                                <span>
                                                      <span class="badge me-2"
                                                            style="background-color: {{ type.color }}; border: 1px solid #555;">&nbsp;</span>
                                                      {{ type.name }}
                                                </span>
                                                <form action="{{ url_for('password.delete_type') }}" method="POST"
                                                      class="needs-confirm-delete mb-0"
                                                      data-confirm-message="Xóa loại này sẽ không xóa các tài khoản đang dùng nó. Bạn có chắc?"
                                                      onsubmit="return confirm('Xóa loại này sẽ không xóa các tài khoản đang dùng nó. Bạn có chắc?');">
                                                      <input type="hidden" name="type_to_delete"
                                                            value="{{ type.name }}">
                                                      <button type="submit" class="btn btn-sm btn-outline-danger"><i
                                                                  class="bi bi-trash"></i></button>
                                                </form>
                                          </li>
                                          {% else %}
                                          <li class="list-group-item bg-transparent border-secondary">Chưa có loại nào.
                                          </li>
                                          {% endfor %}
                                    </ul>
                              </div>
                        </div>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="fb-addAccountModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <form action="{{ url_for('facebook.add_fb_account') }}" method="POST">
                              <div class="modal-header">
                                    <h5 class="modal-title">Thêm Tài Khoản Facebook</h5><button type="button"
                                          class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                    <div class="mb-3">
                                          <label class="form-label">Nickname</label>
                                          <input type="text" class="form-control" name="nickname"
                                                placeholder="VD: Nick chính, Nick clone 1..." required>
                                    </div>
                                    <div class="mb-3">
                                          <label class="form-label">URL Facebook</label>
                                          <input type="url" class="form-control" name="url"
                                                placeholder="https://www.facebook.com/your.profile" required>
                                    </div>
                                    <div class="mb-3">
                                          <label class="form-label">Ghi chú</label>
                                          <textarea class="form-control" name="notes" rows="3"></textarea>
                                    </div>
                              </div>
                              <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                          data-bs-dismiss="modal">Đóng</button>
                                    <button type="submit" class="btn btn-primary">Lưu</button>
                              </div>
                        </form>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="fb-editAccountModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <form id="fb-editForm" method="POST">
                              <div class="modal-header">
                                    <h5 class="modal-title">Sửa Tài Khoản Facebook</h5><button type="button"
                                          class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                              </div>
                              <div class="modal-body">
                                    <div class="mb-3">
                                          <label class="form-label">Nickname</label>
                                          <input type="text" class="form-control" id="fb-editNickname" name="nickname"
                                                required>
                                    </div>
                                    <div class="mb-3">
                                          <label class="form-label">URL Facebook</label>
                                          <input type="url" class="form-control" id="fb-editUrl" name="url"
                                                placeholder="https://www.facebook.com/your.profile" required>
                                    </div>
                                    <div class="mb-3">
                                          <label class="form-label">Ghi chú</label>
                                          <textarea class="form-control" id="fb-editNotes" name="notes"
                                                rows="3"></textarea>
                                    </div>
                              </div>
                              <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary"
                                          data-bs-dismiss="modal">Đóng</button>
                                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                              </div>
                        </form>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="tg-addSessionModal" tabindex="-1" data-bs-theme="dark">
            <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Add / Manage Session Groups</h5><button type="button"
                                    class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <h6><i class="bi bi-plus-circle-fill"></i> Thêm nhóm mới</h6>
                              <form id="tg-addSessionForm" class="border p-3 rounded mb-4">
                                    <div class="mb-3"><label class="form-label">Tên nhóm</label><input type="text"
                                                class="form-control" id="tg-groupName" name="name" spellcheck="false"
                                                required>
                                          <div class="form-text">Để tạo nhóm admin, đặt tên là <b>Adminsession</b></div>
                                    </div>
                                    <div class="mb-3"><label class="form-label">Chọn file .session</label><input
                                                class="form-control" type="file" id="tg-sessionFiles"
                                                name="session_files" multiple accept=".session"></div><button
                                          type="button" class="btn btn-primary w-100" id="tg-saveGroupBtn">Lưu
                                          lại</button>
                              </form>
                              <hr>
                              <h6><i class="bi bi-list-ul"></i> Các nhóm hiện có</h6>
                              <div id="tg-existing-groups-list" class="d-flex flex-column gap-2"
                                    style="max-height: 200px; overflow-y: auto;"></div>
                        </div>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="tg-joinGroupModal" tabindex="-1" data-bs-theme="dark">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title"><i class="bi bi-box-arrow-in-right me-2"></i>Cấu hình Join Group
                              </h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body"><label class="form-label"><strong>Danh sách
                                          link:</strong></label><textarea class="form-control" id="tg-joinGroupLinks"
                                    spellcheck="false" rows="8"></textarea></div>
                        <div class="modal-footer"><button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Đóng</button><button type="button" class="btn btn-primary"
                                    id="tg-saveJoinGroupConfigBtn">Lưu</button></div>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="tg-seedingGroupModal" tabindex="-1" data-bs-theme="dark">
            <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title"><i class="bi bi-chat-dots-fill me-2"></i>Cấu hình Seeding</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <div class="row">
                                    <div class="col-md-6">
                                          <div class="mb-3"><label class="form-label"><strong>Link
                                                            nhóm:</strong></label><textarea class="form-control"
                                                      id="tg-seedingGroupLinks" spellcheck="false" rows="5"></textarea>
                                          </div>
                                    </div>
                                    <div class="col-md-6">
                                          <div class="mb-3"><label class="form-label"><strong>Tin nhắn (Session thành
                                                            viên):</strong></label><textarea class="form-control"
                                                      id="tg-seedingGroupMessages" spellcheck="false"
                                                      rows="5"></textarea></div>
                                          <div class="mb-3"><label class="form-label"><strong>Tin nhắn
                                                            (Admin):</strong></label><textarea class="form-control"
                                                      id="tg-seedingAdminMessages" spellcheck="false"
                                                      rows="5"></textarea></div>
                                    </div>
                              </div>
                        </div>
                        <div class="modal-footer">
                              <div class="me-auto d-flex gap-2 align-items-center">
                                    <div class="form-check form-switch">
                                          <input class="form-check-input" type="checkbox" role="switch"
                                                id="tg-seedingSilentSwitch">
                                          <label class="form-check-label" for="tg-seedingSilentSwitch">Gửi không
                                                tiếng</label>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-info"
                                          id="tg-shuffleMessagesBtn"><i class="bi bi-shuffle"></i> Xáo trộn</button>
                                    <label for="tg-uploadAdminSession" class="btn btn-outline-primary btn-sm"><i
                                                class="bi bi-upload"></i> Upload Admin</label>
                                    <input type="file" id="tg-uploadAdminSession" name="admin_session_files"
                                          accept=".session" style="display: none;" multiple>
                                    <select class="form-select form-select-sm d-inline-block"
                                          id="tg-seedingAdminSessionSelect" style="width: auto;">
                                          <option value="">-- Không dùng Admin --</option>
                                    </select>
                              </div>
                              <div><button type="button" class="btn btn-secondary"
                                          data-bs-dismiss="modal">Đóng</button><button type="button"
                                          class="btn btn-warning" id="tg-saveSeedingGroupConfigBtn">Lưu</button></div>
                        </div>
                  </div>
            </div>
      </div>
      <div class="modal fade" id="tg-deleteDeadSessionsModal" tabindex="-1" data-bs-theme="dark">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Xác nhận xóa Session</h5><button type="button" class="btn-close"
                                    data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <p id="tg-deleteDeadSessionsModalBody"></p>
                        </div>
                        <div class="modal-footer"><button type="button" class="btn btn-secondary"
                                    data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger"
                                    id="tg-confirmDeleteDeadBtn">Xóa</button></div>
                  </div>
            </div>
      </div>

      <div class="modal fade" id="notes-addEditModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                        <form id="notes-addEditForm">
                              <div class="modal-header">
                                    <h5 class="modal-title" id="notes-modalTitle">Thêm Ghi Chú Mới</h5>
                                    <button type="button" class="btn-close btn-close-white"
                                          data-bs-dismiss="modal"></button>
                              </div>
                              <input type="hidden" id="notes-editId">
                              <div class="modal-body">
                                    <div class="mb-3">
                                          <label for="notes-title-input" class="form-label">Tiêu đề (tùy chọn)</label>
                                          <div id="notes-title-input" contenteditable="true" class="form-control"
                                                spellcheck="false" placeholder="Nhập tiêu đề ghi chú..."
                                                style="min-height: 40px;"></div>
                                    </div>
                                    <div class="mb-3">
                                          <div id="notes-content-editor" contenteditable="true" class="form-control"
                                                spellcheck="false" style="height: 200px; overflow-y: auto;"
                                                placeholder="Nhập nội dung ghi chú..."></div>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                          <input class="form-check-input" type="checkbox" role="switch"
                                                id="notes-enableAlarmCheck">
                                          <label class="form-check-label" for="notes-enableAlarmCheck">Đặt báo
                                                thức</label>
                                    </div>
                                    <div id="notes-alarm-container" class="d-none">
                                          <div class="btn-group w-100 mb-3" role="group">
                                                <input type="radio" class="btn-check" name="alarmType"
                                                      id="alarmTypeRelative" autocomplete="off">
                                                <label class="btn btn-outline-secondary" for="alarmTypeRelative">Sau một
                                                      khoảng</label>

                                                <input type="radio" class="btn-check" name="alarmType"
                                                      id="alarmTypeAbsolute" autocomplete="off" checked>
                                                <label class="btn btn-outline-secondary" for="alarmTypeAbsolute">Thời
                                                      gian cụ thể</label>
                                          </div>

                                          <div id="notes-alarm-absolute-panel">
                                                <input type="datetime-local" class="form-control" id="notes-dueTime">
                                          </div>

                                          <div id="notes-alarm-relative-panel" class="d-none">
                                                <div class="row g-2">
                                                      <div class="col">
                                                            <div class="input-group">
                                                                  <input type="number" class="form-control"
                                                                        id="relative-days" placeholder="0" min="0">
                                                                  <span class="input-group-text">Ngày</span>
                                                            </div>
                                                      </div>
                                                      <div class="col">
                                                            <div class="input-group">
                                                                  <input type="number" class="form-control"
                                                                        id="relative-hours" placeholder="0" min="0"
                                                                        max="23">
                                                                  <span class="input-group-text">Giờ</span>
                                                            </div>
                                                      </div>
                                                      <div class="col">
                                                            <div class="input-group">
                                                                  <input type="number" class="form-control"
                                                                        id="relative-minutes" placeholder="5" min="0"
                                                                        max="59">
                                                                  <span class="input-group-text">Phút</span>
                                                            </div>
                                                      </div>
                                                </div>
                                          </div>
                                    </div>
                              </div>
                              <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                                    <button type="submit" class="btn btn-primary">Lưu</button>
                              </div>
                        </form>
                  </div>
            </div>
      </div>

      <div class="modal fade" id="notes-notificationModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content border border-warning border-3 shadow-lg">
                        <div class="modal-header bg-warning text-dark">
                              <h5 class="modal-title fw-bold"><i class="bi bi-bell-fill me-2"></i>ĐẾN GIỜ RỒI!</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <h3 id="notes-notificationTitle" class="text-center mb-3"></h3>
                              <p id="notes-notificationContent" style="white-space: pre-wrap;"></p>
                              <input type="hidden" id="notes-notificationId">
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-warning" data-bs-dismiss="modal"
                                    id="notes-acknowledgeBtn">OK, Đã hiểu</button>
                        </div>
                  </div>
            </div>
      </div>

      <div id="notes-context-menu" class="custom-context-menu">
            <div class="menu-item" id="context-copy"><i class="bi bi-clipboard me-2"></i> Sao chép</div>
            <div class="menu-item" id="context-bold"><i class="bi bi-type-bold me-2"></i> In đậm</div>
            <div class="menu-item" id="context-color"><i class="bi bi-palette-fill me-2"></i> Đổi màu chữ
                  <div class="color-palette">
                        <span style="background-color: #FFFFFF;"></span>
                        <span style="background-color: #EF5350;"></span>
                        <span style="background-color: #EC407A;"></span>
                        <span style="background-color: #AB47BC;"></span>
                        <span style="background-color: #7E57C2;"></span>
                        <span style="background-color: #5C6BC0;"></span>
                        <span style="background-color: #42A5F5;"></span>
                        <span style="background-color: #26C6DA;"></span>
                        <span style="background-color: #26A69A;"></span>
                        <span style="background-color: #66BB6A;"></span>
                        <span style="background-color: #FFCA28;"></span>
                        <span style="background-color: #FF7043;"></span>
                  </div>
            </div>
            <div class="menu-item" id="context-link"><i class="bi bi-link-45deg me-2"></i> Gán Link</div>
            <div class="menu-item" id="context-profile"><i class="bi bi-person-badge me-2"></i> Profile</div>
      </div>

      <!-- START: New Context Menu for Password Badges -->
      <div id="password-badge-context-menu" class="custom-context-menu">
            <div class="menu-item">
                  <i class="bi bi-palette-fill me-2"></i> Đổi màu Badge
                  <div class="color-palette">
                        <span style="background-color: #6c757d;" data-color="#6c757d"></span>
                        <span style="background-color: #dc3545;" data-color="#dc3545"></span>
                        <span style="background-color: #fd7e14;" data-color="#fd7e14"></span>
                        <span style="background-color: #ffc107;" data-color="#ffc107"></span>
                        <span style="background-color: #198754;" data-color="#198754"></span>
                        <span style="background-color: #0dcaf0;" data-color="#0dcaf0"></span>
                        <span style="background-color: #0d6efd;" data-color="#0d6efd"></span>
                        <span style="background-color: #6f42c1;" data-color="#6f42c1"></span>
                        <span style="background-color: #d63384;" data-color="#d63384"></span>
                        <span style="background-color: #20c997;" data-color="#20c997"></span>
                        <span style="background-color: #adb5bd;" data-color="#adb5bd"></span>
                        <span style="background-color: #495057;" data-color="#495057"></span>
                  </div>
            </div>
      </div>
      <!-- END: New Context Menu for Password Badges -->

      <!-- Modal quản lý proxy -->
      <div class="modal fade" id="tg-proxyModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title"><i class="bi bi-shield-shaded me-1"></i>Quản Lý Proxy</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <p class="text-muted small">Nhập danh sách proxy theo định dạng `ip:port:user:pass` hoặc
                                    `ip:port`, mỗi proxy một dòng.</p>
                              <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" role="switch" id="tg-proxy-enabled">
                                    <label class="form-check-label" for="tg-proxy-enabled">Sử dụng Proxy cho các tác
                                          vụ</label>
                              </div>
                              <textarea class="form-control" id="tg-proxy-list" rows="10" spellcheck="false"
                                    placeholder="171.236.161.237:23270:user:pass..."></textarea>
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                              <button type="button" class="btn btn-primary" id="tg-save-proxy-btn">Lưu Proxy</button>
                        </div>
                  </div>
            </div>
      </div>

      <!-- UTILITIES MODAL -->
      <div class="modal fade" id="utilitiesModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title"><i class="bi bi-gear-wide-connected me-2"></i>Setting Dashboard
                              </h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body d-flex flex-column gap-2">
                              <div class="d-flex align-items-center justify-content-start gap-2 flex-nowrap">
                                    <div class="form-check form-switch">
                                          <input class="form-check-input" type="checkbox" role="switch"
                                                id="shutdown-toggle-switch" style="cursor: pointer;">
                                          <label class="form-check-label" for="shutdown-toggle-switch"
                                                style="cursor: pointer;" title="Bật/Tắt hẹn giờ">Hẹn giờ tắt máy</label>
                                    </div>
                                    <div class="d-flex gap-2 align-items-center" id="shutdown-inputs-container">
                                          <input type="number"
                                                class="form-control form-control-sm auto-seeding-time-input"
                                                id="shutdown-hours" placeholder="Giờ" min="0" disabled
                                                style="width: 60px;">
                                          <input type="number"
                                                class="form-control form-control-sm auto-seeding-time-input"
                                                id="shutdown-minutes" placeholder="Phút" min="0" max="59" disabled
                                                style="width: 60px;">
                                    </div>
                              </div>

                              <div class="d-flex align-items-center justify-content-start gap-2">
                                    <div class="form-check form-switch">
                                          <input class="form-check-input" type="checkbox" id="autoStartSwitch">
                                          <label class="form-check-label" for="autoStartSwitch">Tự động khởi động cùng
                                                Windows</label>
                                    </div>
                              </div>
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                              <button type="button" class="btn btn-primary" id="apply-shutdown-btn">Áp dụng</button>
                        </div>
                  </div>
            </div>
      </div>

      <!-- GLOBAL DELETE CONFIRM MODAL -->
      <div class="modal fade" id="globalDeleteConfirmModal" tabindex="-1">
            <div class="modal-dialog">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Xác nhận xóa</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <p id="globalDeleteConfirmText">Bạn có chắc muốn xóa?</p>
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                              <button type="button" class="btn btn-danger" id="globalDeleteConfirmBtn">Xóa</button>
                        </div>
                  </div>
            </div>
      </div>

      <!-- Notes Add Link Modal -->
      <div class="modal fade" id="notes-addLinkModal" tabindex="-1">
            <div class="modal-dialog modal-sm modal-dialog-centered">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Gán Link vào chữ</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <label for="notes-link-url" class="form-label">Nhập URL</label>
                              <input type="url" class="form-control" id="notes-link-url" placeholder="https://...">
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                              <button type="button" class="btn btn-primary" id="notes-save-link-btn">Lưu</button>
                        </div>
                  </div>
            </div>
      </div>

      <div class="modal fade" id="notes-addProfileModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Gán Profile</h5>
                              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <div class="row g-2 mb-3">
                                    <div class="col">
                                          <label for="notes-profile-id" class="form-label">ID</label>
                                          <div class="input-group">
                                                <input type="text" class="form-control" id="notes-profile-id"
                                                      placeholder="Nhập ID..." autocomplete="off">
                                                <button class="btn btn-outline-secondary" type="button"
                                                      id="notes-copy-profile-id-btn" title="Copy ID">
                                                      <i class="bi bi-clipboard"></i>
                                                </button>
                                          </div>
                                    </div>
                                    <div class="col">
                                          <label for="notes-profile-password" class="form-label">Password</label>
                                          <div class="input-group">
                                                <input type="text" class="form-control" id="notes-profile-password"
                                                      placeholder="Nhập Password..." autocomplete="new-password">
                                                <button class="btn btn-outline-secondary" type="button"
                                                      id="notes-copy-profile-password-btn" title="Copy Password">
                                                      <i class="bi bi-clipboard"></i>
                                                </button>
                                          </div>
                                    </div>
                              </div>
                              <div class="mb-3">
                                    <label for="notes-profile-content" class="form-label">Nội dung</label>
                                    <textarea class="form-control" id="notes-profile-content" rows="4"
                                          placeholder="Nhập nội dung chi tiết..."></textarea>
                              </div>
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-outline-danger me-auto"
                                    id="notes-delete-profile-btn">Xóa Profile</button>
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                              <button type="button" class="btn btn-primary" id="notes-save-profile-btn">Lưu</button>
                        </div>
                  </div>
            </div>
      </div>

      <div class="modal fade" id="kcal-add-food-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                        <div class="modal-header">
                              <h5 class="modal-title">Thêm Thực Phẩm</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                              <input type="hidden" id="kcal-food-category">
                              <div class="mb-3">
                                    <label for="kcal-food-name" class="form-label">Tên Thực Phẩm</label>
                                    <input type="text" class="form-control" id="kcal-food-name" required>
                              </div>
                              <div class="mb-3">
                                    <label for="kcal-food-calories" class="form-label">Số Kcal</label>
                                    <input type="number" class="form-control" id="kcal-food-calories" required min="0">
                              </div>
                              <div class="row g-3">
                                    <div class="col-md-4">
                                          <label for="kcal-food-protein" class="form-label">Protein (g)</label>
                                          <input type="number" class="form-control" id="kcal-food-protein" value="0" required min="0">
                                    </div>
                                    <div class="col-md-4">
                                          <label for="kcal-food-fat" class="form-label">Fat (g)</label>
                                          <input type="number" class="form-control" id="kcal-food-fat" value="0" required min="0">
                                    </div>
                                    <div class="col-md-4">
                                          <label for="kcal-food-carbs" class="form-label">Carb (g)</label>
                                          <input type="number" class="form-control" id="kcal-food-carbs" value="0" required min="0">
                                    </div>
                              </div>
                        </div>
                        <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                              <button type="button" class="btn btn-primary" id="kcal-save-food-btn">Lưu</button>
                        </div>
                  </div>
            </div>
      </div>


      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

      <script>
            document.addEventListener('DOMContentLoaded', function () {
                  // --- GLOBAL SCRIPT ---
                  const urlParams = new URLSearchParams(window.location.search);
                  const tab = urlParams.get('tab');
                  if (tab) {
                        const tabTrigger = document.querySelector(`button[data-bs-target="#${tab}-tool-pane"], button[data-bs-target="#${tab}-tab-pane"]`);
                        if (tabTrigger) new bootstrap.Tab(tabTrigger).show();
                  }
                  document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabEl => {
                        tabEl.addEventListener('shown.bs.tab', function (event) {
                              if (event.target.id.includes('-v-pills-')) return;
                              const newUrl = new URL(window.location);
                              const tabId = event.target.dataset.bsTarget.replace('#', '').replace('-tool-pane', '').replace('-tab-pane', '');
                              if (tabId === 'home') newUrl.searchParams.delete('tab');
                              else newUrl.searchParams.set('tab', tabId);
                              history.pushState({}, '', newUrl);
                        });
                  });
                  function showToast(m, t = 'success', title = 'Thông báo') {
                        const e = document.getElementById('liveToast'), h = document.getElementById('toastHeader'),
                              i = document.getElementById('toastTitle'), b = document.getElementById('toastBody');
                        if (!e) return;
                        b.textContent = m;
                        h.className = 'toast-header';
                        if (t === 'success') { h.classList.add('bg-success', 'text-white'); i.textContent = 'Thành công'; }
                        else if (t === 'error') { h.classList.add('bg-danger', 'text-white'); i.textContent = 'Lỗi'; }
                        else { h.classList.add('bg-info', 'text-white'); i.textContent = title; }
                        new bootstrap.Toast(e).show();
                  }

                  // --- PASSWORD MANAGER SCRIPT ---
                  (() => {
                        const pane = document.getElementById('password-tool-pane');
                        if (!pane) return;
                        const filterForm = document.getElementById('pwd-filter-form');
                        const typeFilter = document.getElementById('pwd-type-filter');
                        typeFilter.addEventListener('change', () => filterForm.submit());
                        pane.querySelectorAll('.pwd-toggle-visibility').forEach(button => {
                              button.addEventListener('click', function () {
                                    const passwordSpan = this.closest('.password-cell').querySelector('.password-text');
                                    const icon = this.querySelector('i');
                                    if (passwordSpan.style.webkitTextSecurity === 'disc') {
                                          passwordSpan.style.webkitTextSecurity = 'none';
                                          icon.classList.replace('bi-eye-fill', 'bi-eye-slash-fill');
                                    } else {
                                          passwordSpan.style.webkitTextSecurity = 'disc';
                                          icon.classList.replace('bi-eye-slash-fill', 'bi-eye-fill');
                                    }
                              });
                        });
                        pane.querySelectorAll('.pwd-btn-copy').forEach(button => {
                              button.addEventListener('click', function () {
                                    navigator.clipboard.writeText(this.dataset.password).then(() => {
                                          const originalIcon = this.innerHTML;
                                          this.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
                                          setTimeout(() => { this.innerHTML = originalIcon; }, 1500);
                                    });
                              });
                        });
                        const editModal = document.getElementById('pwd-editAccountModal');
                        editModal.addEventListener('show.bs.modal', function (event) {
                              const button = event.relatedTarget;
                              const form = document.getElementById('pwd-editForm');
                              form.action = `/password/update/${button.dataset.id}`;
                              document.getElementById('pwd-editType').value = button.dataset.type;
                              document.getElementById('pwd-editUsername').value = button.dataset.username;
                              document.getElementById('pwd-editPassword').value = button.dataset.password;
                              document.getElementById('pwd-editTwofa').value = button.dataset.twofa;
                              document.getElementById('pwd-editNotes').value = button.dataset.notes;
                        });

                        // START: New Password Badge Color Change Logic
                        const passwordBadgeMenu = document.getElementById('password-badge-context-menu');
                        const passwordTable = pane.querySelector('.table tbody');
                        let currentBadgeType = null;

                        passwordTable.addEventListener('contextmenu', function (e) {
                              const badge = e.target.closest('.badge[data-type]');
                              if (badge) {
                                    e.preventDefault();
                                    e.stopPropagation(); // Prevent the dashboard menu from opening
                                    currentBadgeType = badge.dataset.type;
                                    passwordBadgeMenu.style.top = `${e.clientY}px`;
                                    passwordBadgeMenu.style.left = `${e.clientX}px`;
                                    passwordBadgeMenu.style.display = 'block';
                              }
                        });

                        passwordBadgeMenu.addEventListener('click', async function (e) {
                              const colorSwatch = e.target.closest('.color-palette span');
                              if (colorSwatch && currentBadgeType) {
                                    const newColor = colorSwatch.dataset.color;

                                    try {
                                          const response = await fetch('/password/types/update_color', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ name: currentBadgeType, color: newColor })
                                          });
                                          const result = await response.json();
                                          if (!response.ok) throw new Error(result.error || 'Update failed');

                                          // Update color on the fly
                                          const dynamicStyle = document.getElementById('dynamic-type-styles');
                                          const rule = `.table .badge[data-type="${currentBadgeType}"] { background-color: ${newColor} !important; }`;

                                          // This is a simpler way to update styles: just add the new rule.
                                          // The browser will apply the latest rule if selectors are the same.
                                          dynamicStyle.sheet.insertRule(rule, dynamicStyle.sheet.cssRules.length);

                                    } catch (error) {
                                          showToast(`Lỗi: ${error.message}`, 'error');
                                    } finally {
                                          passwordBadgeMenu.style.display = 'none';
                                          currentBadgeType = null;
                                    }
                              }
                        });

                        document.addEventListener('click', function (e) {
                              if (!passwordBadgeMenu.contains(e.target) && !e.target.closest('.badge[data-type]')) {
                                    passwordBadgeMenu.style.display = 'none';
                              }
                        });
                        // END: New Password Badge Color Change Logic

                        // --- START: Show All Passwords Toggle Logic ---
                        const showAllToggle = pane.querySelector('#pwd-showAllToggle');
                        if (showAllToggle) {
                              showAllToggle.addEventListener('change', function () {
                                    const isChecked = this.checked;
                                    const passwordRows = pane.querySelectorAll('tbody tr');

                                    passwordRows.forEach(row => {
                                          const passwordSpan = row.querySelector('.password-text');
                                          const visibilityIcon = row.querySelector('.pwd-toggle-visibility i');

                                          if (passwordSpan && visibilityIcon) {
                                                if (isChecked) {
                                                      // Show password
                                                      passwordSpan.style.webkitTextSecurity = 'none';
                                                      visibilityIcon.classList.replace('bi-eye-fill', 'bi-eye-slash-fill');
                                                } else {
                                                      // Hide password
                                                      passwordSpan.style.webkitTextSecurity = 'disc';
                                                      visibilityIcon.classList.replace('bi-eye-slash-fill', 'bi-eye-fill');
                                                }
                                          }
                                    });
                              });
                        }
                        // --- END: Show All Passwords Toggle Logic ---
                  })();

                  // --- FACEBOOK MANAGER SCRIPT ---
                  (() => {
                        const pane = document.getElementById('facebook-tool-pane');
                        if (!pane) return;
                        const editModal = document.getElementById('fb-editAccountModal');
                        editModal.addEventListener('show.bs.modal', function (event) {
                              const button = event.relatedTarget;
                              const form = document.getElementById('fb-editForm');
                              form.action = `/facebook/update/${button.dataset.id}`;
                              document.getElementById('fb-editNickname').value = button.dataset.nickname;
                              document.getElementById('fb-editUrl').value = button.dataset.url;
                              document.getElementById('fb-editNotes').value = button.dataset.notes;
                        });
                  })();

                  // --- TELEGRAM MANAGER SCRIPT ---
                  (async () => {
                        const telegramPane = document.getElementById('telegram-tool-pane');
                        if (!telegramPane) return;

                        // --- START: REFACTORED SCRIPT BLOCK FOR AUTO-SAVING UI STATE ---

                        const adminSwitch = document.getElementById('tg-admin-reply-switch');
                        const adminDelayInput = document.getElementById('tg-admin-delay-input');
                        const mainTelegramTab = document.getElementById('telegram-tool-tab');
                        const globalSettingInputs = [
                              document.getElementById('tg-core-input'),
                              document.getElementById('tg-delay-session-input'),
                              document.getElementById('tg-delay-batch-input'),
                              adminSwitch,
                              adminDelayInput
                        ];

                        let autoSaveTimer = null;

                        // Function to load and populate the main control bar settings from the database.
                        async function loadTelegramGlobalSettings() {
                              try {
                                    const response = await fetch('/automatic/api/seeding/settings');
                                    if (!response.ok) return;
                                    const settings = await response.json();

                                    if (Object.keys(settings).length > 0) {
                                          document.getElementById('tg-core-input').value = settings.core || 5;
                                          document.getElementById('tg-delay-session-input').value = settings.delay_per_session || 10;
                                          document.getElementById('tg-delay-batch-input').value = settings.delay_between_batches || 600;
                                          adminSwitch.checked = settings.admin_enabled || false;
                                          adminDelayInput.value = settings.admin_delay || 10;
                                          adminDelayInput.disabled = !adminSwitch.checked;
                                    }
                              } catch (error) {
                                    console.error("Could not load global Telegram settings:", error);
                              }
                        }

                        // The auto-save function with debouncing.
                        function triggerAutoSave() {
                              clearTimeout(autoSaveTimer); // Reset the timer on every change
                              autoSaveTimer = setTimeout(async () => {
                                    const payload = {
                                          core: parseInt(document.getElementById('tg-core-input').value, 10),
                                          delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                                          delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                                          admin_enabled: document.getElementById('tg-admin-reply-switch').checked,
                                          admin_delay: parseInt(document.getElementById('tg-admin-delay-input').value, 10)
                                    };

                                    try {
                                          const response = await fetch('/telegram/api/global-settings', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                          });
                                          const result = await response.json();
                                          if (!response.ok) throw new Error(result.error || 'Server error');
                                          showToast('Cài đặt chung đã được tự động lưu.', 'success');
                                    } catch (error) {
                                          showToast(`Lỗi tự động lưu: ${error.message}`, 'error');
                                    }
                              }, 1500); // Wait 1.5 seconds after the last change before saving
                        }

                        // Attach event listeners for auto-saving
                        globalSettingInputs.forEach(input => {
                              if (input) {
                                    input.addEventListener('input', triggerAutoSave); // For text/number inputs
                                    input.addEventListener('change', triggerAutoSave); // For checkboxes/switches
                              }
                        });

                        // Event listener to show/hide the admin delay input when the toggle is clicked.
                        if (adminSwitch) {
                              adminSwitch.addEventListener('change', () => {
                                    adminDelayInput.disabled = !adminSwitch.checked;
                              });
                        }

                        // Event listener to load the settings whenever the main Telegram tab is switched to.
                        if (mainTelegramTab) {
                              mainTelegramTab.addEventListener('shown.bs.tab', loadTelegramGlobalSettings);
                        }

                        // Check if the Telegram tab is already active on initial page load.
                        if (mainTelegramTab && mainTelegramTab.classList.contains('active')) {
                              loadTelegramGlobalSettings();
                        }

                        // --- END: REFACTORED SCRIPT BLOCK FOR AUTO-SAVING UI STATE ---

                        let tg_pollingInterval = null, tg_currentTaskId = null, tg_lastCheckedCheckbox = null,
                              tg_currentTaskConfig = {}, tg_completedInTask = new Set(), tg_allGroups = [];

                        async function tg_handleRunStopClick(event) {
                              const button = event.currentTarget;
                              if (button.dataset.taskRunning === 'true') {
                                    if (!tg_currentTaskId) return;
                                    try {
                                          await fetch(`/telegram/api/stop-task/${tg_currentTaskId}`, { method: 'POST' });
                                    } catch (error) { showToast(`Lỗi khi dừng: ${error.message}`, 'error'); }
                              } else {
                                    const isGroupTaskSelected = tg_currentTaskConfig && tg_currentTaskConfig.task && ['seedingGroup', 'joinGroup'].includes(tg_currentTaskConfig.task);
                                    if (isGroupTaskSelected) {
                                          await tg_handleRunGroupTask();
                                    } else {
                                          await tg_handleCheckLive();
                                    }
                              }
                        }

                        async function tg_handleRunGroupTask() {
                              const selectedFilenames = Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:checked:not(#tg-selectAllCheckbox):not(#tg-selectAllCheckbox-right)')).map(cb => cb.closest('tr').dataset.filename);
                              let sessionsForTask = selectedFilenames;
                              if (sessionsForTask.length === 0 && tg_currentTaskConfig.task === 'seedingGroup' && tg_currentTaskConfig.session_filenames?.length > 0) {
                                    sessionsForTask = tg_currentTaskConfig.session_filenames;
                                    showToast('Không có session nào được chọn. Sử dụng danh sách đã lưu trong cấu hình.', 'info');
                              }
                              if (sessionsForTask.length === 0) return showToast('Vui lòng chọn hoặc lưu session trong cấu hình.', 'error');

                              const payload = {
                                    groupId: document.getElementById('tg-group-session-select').value,
                                    task: tg_currentTaskConfig.task,
                                    config: tg_currentTaskConfig,
                                    filenames: sessionsForTask,
                                    core: parseInt(document.getElementById('tg-core-input').value, 10),
                                    delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                                    delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                                    admin_enabled: document.getElementById('tg-admin-reply-switch').checked,
                                    admin_delay: parseInt(document.getElementById('tg-admin-delay-input').value, 10)
                              };

                              if (!payload.groupId) return showToast('Vui lòng chọn nhóm session.', 'error');

                              const taskDesc = telegramPane.querySelector('#tg-group-task-cards .card.card-selected .card-title')?.textContent.trim() || "tác vụ";
                              tg_startTaskUI(sessionsForTask.length, `Bắt đầu "${taskDesc}"...`);
                              try {
                                    const response = await fetch('/telegram/api/run-task', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                                    if (!response.ok) throw new Error((await response.json()).error || 'Lỗi server.');
                                    const { task_id } = await response.json();
                                    tg_currentTaskId = task_id;
                                    tg_setRunStopButtonState('running');
                                    tg_pollTaskStatus(tg_currentTaskId);
                              } catch (error) { showToast(`Lỗi: ${error.message}`, 'error'); tg_setRunStopButtonState('idle'); }
                        }

                        // START: Replacement for tg_handleCheckLive
                        async function tg_handleCheckLive() {
                              if (tg_pollingInterval) return showToast('Tác vụ khác đang chạy.', 'error');

                              const groupId = document.getElementById('tg-group-session-select').value;
                              if (!groupId) return showToast('Vui lòng chọn nhóm.', 'error');

                              const selectedFilenames = Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:checked:not(#tg-selectAllCheckbox):not(#tg-selectAllCheckbox-right)')).map(cb => cb.closest('tr').dataset.filename);
                              if (selectedFilenames.length === 0) return showToast('Vui lòng chọn ít nhất một session.', 'error');

                              // Deselect any group task cards to avoid confusion
                              telegramPane.querySelectorAll('#tg-group-task-cards .card').forEach(d => d.classList.remove('card-selected'));
                              tg_currentTaskConfig = {};

                              const payload = {
                                    groupId: groupId,
                                    task: "check-live", // Set the correct task name
                                    filenames: selectedFilenames,
                                    core: parseInt(document.getElementById('tg-core-input').value, 10),
                                    delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                                    delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                                    admin_enabled: false, // Not applicable for check-live
                                    admin_delay: 0      // Not applicable for check-live
                              };

                              tg_startTaskUI(selectedFilenames.length, `Bắt đầu Check Live...`);

                              try {
                                    // Call the correct, generic run-task endpoint
                                    const response = await fetch('/telegram/api/run-task', {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify(payload)
                                    });

                                    if (!response.ok) throw new Error((await response.json()).error || 'Lỗi server.');

                                    const { task_id } = await response.json();
                                    tg_currentTaskId = task_id;
                                    tg_setRunStopButtonState('running');
                                    tg_pollTaskStatus(tg_currentTaskId);

                              } catch (error) {
                                    showToast(`Lỗi: ${error.message}`, 'error');
                                    tg_setRunStopButtonState('idle');
                              }
                        }
                        // END: Replacement for tg_handleCheckLive

                        function tg_startTaskUI(total, msg) {
                              tg_completedInTask.clear();
                              showToast(msg, 'info');
                              document.getElementById('tg-status-success-count').textContent = '0';
                              document.getElementById('tg-status-failed-count').textContent = '0';
                              document.getElementById('tg-status-progress-text').textContent = `0/${total}`;
                              telegramPane.querySelectorAll('.tg-session-checkbox:checked').forEach(cb => {
                                    const row = cb.closest('tr');
                                    if (row) row.cells[6].innerHTML = `<span class="status-checking">Đang xử lý...</span>`;
                              });
                        }

                        function tg_setRunStopButtonState(state) {
                              const button = document.getElementById('tg-runStopBtn');
                              const statusText = document.getElementById('tg-status-progress-text');
                              if (state === 'running') {
                                    button.dataset.taskRunning = 'true';
                                    statusText.dataset.taskRunning = 'true';
                                    button.innerHTML = `<i class="bi bi-stop-fill"></i> Stop`;
                                    button.classList.replace('btn-primary', 'btn-danger');
                              } else {
                                    button.dataset.taskRunning = 'false';
                                    statusText.dataset.taskRunning = 'false';
                                    button.innerHTML = `<i class="bi bi-play-fill"></i> Run`;
                                    button.classList.replace('btn-danger', 'btn-primary');
                              }
                        }

                        function tg_pollTaskStatus(taskId) {
                              if (tg_pollingInterval) clearInterval(tg_pollingInterval);
                              tg_pollingInterval = setInterval(async () => {
                                    if (!tg_currentTaskId) { clearInterval(tg_pollingInterval); return; }
                                    try {
                                          const response = await fetch(`/telegram/api/task-status/${taskId}`);
                                          if (!response.ok) { clearInterval(tg_pollingInterval); tg_setRunStopButtonState('idle'); return; }
                                          const task = await response.json();
                                          tg_updateUiWithTaskProgress(task);
                                          if (task.status === 'completed' || task.status === 'stopped') {
                                                clearInterval(tg_pollingInterval);
                                                tg_pollingInterval = null; tg_currentTaskId = null;
                                                showToast(task.status === 'completed' ? 'Hoàn tất tác vụ!' : 'Tác vụ đã dừng.', 'success');
                                                document.getElementById('tg-status-progress-text').textContent = "Idle";
                                                tg_setRunStopButtonState('idle');
                                                tg_updateSessionCountDisplay();
                                          }
                                    } catch (error) { clearInterval(tg_pollingInterval); console.error('Lỗi khi polling:', error); tg_setRunStopButtonState('idle'); }
                              }, 1500);
                        }

                        function tg_updateUiWithTaskProgress(task) {
                              document.getElementById('tg-status-progress-text').textContent = `${task.processed}/${task.total}`;
                              document.getElementById('tg-status-success-count').textContent = task.success;
                              document.getElementById('tg-status-failed-count').textContent = task.failed;

                              // Update status for completed sessions in this poll
                              task.results.forEach(result => {
                                    const row = telegramPane.querySelector(`tr[data-filename="${result.filename}"]`);
                                    if (!row) return;

                                    tg_completedInTask.add(result.filename); // Mark this session as processed

                                    if (result.full_name) row.cells[3].textContent = result.full_name;
                                    if (result.username) row.cells[4].textContent = result.username;
                                    row.cells[5].innerHTML = result.is_live ? `<i class="bi bi-check-circle-fill text-success"></i>` : `<i class="bi bi-x-circle-fill text-danger"></i>`;
                                    row.cells[6].innerHTML = `<span class="${result.is_live ? 'text-success' : 'text-danger'}">${result.status_text}</span>`;
                              });

                              // Handle global task messages, including the new countdown logic
                              if (task.messages && task.messages.length > 0) {
                                    const latestMessage = task.messages[task.messages.length - 1];
                                    document.getElementById('tg-status-progress-text').textContent = latestMessage;

                                    // --- NEW COUNTDOWN LOGIC ---
                                    const countdownMatch = latestMessage.match(/Đang chờ đợt tiếp...\s*(\d+s)/);
                                    if (countdownMatch) {
                                          const countdownText = `Chờ: ${countdownMatch[1]}`;
                                          // Find all checked sessions that have NOT been processed yet
                                          telegramPane.querySelectorAll('.tg-session-checkbox:checked').forEach(cb => {
                                                const row = cb.closest('tr');
                                                if (row) {
                                                      const filename = row.dataset.filename;
                                                      if (filename && !tg_completedInTask.has(filename)) {
                                                            // This is a waiting session, so update its status cell
                                                            const statusCell = row.cells[6];
                                                            if (statusCell) {
                                                                  statusCell.innerHTML = `<span class="text-info">${countdownText}</span>`;
                                                            }
                                                      }
                                                }
                                          });
                                    }
                                    // --- END OF NEW LOGIC ---
                              }
                        }

                        async function tg_loadGroups() {
                              try {
                                    const r = await fetch('/telegram/api/groups');
                                    tg_allGroups = await r.json();
                                    const s = document.getElementById('tg-group-session-select');
                                    s.innerHTML = '<option selected disabled>-- Chọn nhóm --</option>';
                                    tg_allGroups.forEach(g => {
                                          if (g.name !== 'Adminsession') s.add(new Option(g.name, g.id));
                                    });
                                    const storedId = localStorage.getItem('tg_selectedGroupId');
                                    // Check if the stored ID exists and corresponds to a valid, non-admin group in the list
                                    if (storedId && tg_allGroups.some(g => g.id == storedId && g.name !== 'Adminsession')) {
                                          s.value = storedId;
                                          // CRITICAL FIX: Programmatically trigger the 'change' event to force session loading.
                                          // The 'await' is important as the event handler is async.
                                          await s.dispatchEvent(new Event('change'));
                                    }
                              } catch (e) { showToast('Không thể tải nhóm Telegram.', 'error'); }
                        }

                        async function tg_handleGroupSelect(e) {
                              tg_lastCheckedCheckbox = null;
                              const groupId = e.target.value;
                              localStorage.setItem('tg_selectedGroupId', groupId);
                              const leftBody = document.getElementById('tg-sessions-table-left-body');
                              const rightBody = document.getElementById('tg-sessions-table-right-body');
                              leftBody.innerHTML = `<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm"></div></td></tr>`;
                              rightBody.innerHTML = '';
                              try {
                                    const res = await fetch(`/telegram/api/groups/${groupId}/sessions`);
                                    tg_renderSessions(await res.json());
                              } catch (e) {
                                    leftBody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">Lỗi tải session</td></tr>`;
                              }
                        }

                        function tg_renderSessions(sessions) {
                              const leftBody = document.getElementById('tg-sessions-table-left-body'), rightBody = document.getElementById('tg-sessions-table-right-body');
                              leftBody.innerHTML = rightBody.innerHTML = '';
                              document.getElementById('tg-total-sessions-count').textContent = sessions.length;
                              const rowHtml = (s, i) => {
                                    const liveIcon = s.is_live === null ? '<i class="bi bi-question-circle-fill text-secondary"></i>' : (s.is_live ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>');
                                    const statusClass = s.is_live === null ? 'text-secondary' : (s.is_live ? 'text-success' : 'text-danger');
                                    return `<tr data-filename="${s.filename}" data-live="${s.is_live}"><td><input class="form-check-input tg-session-checkbox" type="checkbox"></td><td>${i + 1}</td><td>${s.phone}</td><td class="d-none d-md-table-cell" style="cursor: text;">${s.full_name || 'N/A'}</td><td class="d-none d-md-table-cell" style="cursor: text;">${s.username || ''}</td><td class="text-center">${liveIcon}</td><td><span class="${statusClass}">${s.status_text || 'Sẵn sàng'}</span></td></tr>`;
                              };
                              const mid = Math.ceil(sessions.length / 2);
                              leftBody.innerHTML = sessions.slice(0, mid).map((s, i) => rowHtml(s, i)).join('');
                              rightBody.innerHTML = sessions.slice(mid).map((s, i) => rowHtml(s, mid + i)).join('');
                              tg_updateSessionCountDisplay();
                        }

                        function tg_updateSessionCountDisplay() {
                              const statusEl = document.getElementById('tg-status-progress-text');
                              if (statusEl && statusEl.dataset.taskRunning !== 'true') {
                                    const selected = telegramPane.querySelectorAll('.tg-session-checkbox:checked').length;
                                    const total = telegramPane.querySelectorAll('.tg-session-checkbox').length;
                                    statusEl.textContent = selected > 0 ? `${selected}/${total} Selected` : 'Idle';
                              }
                        }

                        window.tg_openConfigModal = async (taskId, event) => {
                              if (event) event.stopPropagation();
                              await tg_selectCardAndLoadConfig(taskId);
                              const modalId = `tg-${taskId}Modal`;
                              const configModal = document.getElementById(modalId);
                              if (configModal) {
                                    if (taskId === 'joinGroup') tg_populateJoinGroupModal();
                                    if (taskId === 'seedingGroup') await tg_populateSeedingGroupModal();
                                    new bootstrap.Modal(configModal).show();
                              }
                        };

                        async function tg_selectCardAndLoadConfig(taskId) {
                              telegramPane.querySelectorAll('#tg-group-task-cards .card').forEach(d => d.classList.remove('card-selected'));
                              const card = telegramPane.querySelector(`#tg-group-task-cards .card[data-task-id="${taskId}"]`);
                              if (card) card.classList.add('card-selected');
                              localStorage.setItem('tg_lastSelectedTask', taskId);
                              try {
                                    const response = await fetch(`/telegram/api/config/${taskId}`);
                                    tg_currentTaskConfig = response.ok ? await response.json() : {};
                                    tg_currentTaskConfig.task = taskId;
                              } catch (error) { tg_currentTaskConfig = { task: taskId }; }
                        }

                        function tg_populateJoinGroupModal() { document.getElementById('tg-joinGroupLinks').value = (tg_currentTaskConfig?.links || []).join('\n'); }

                        async function tg_populateSeedingGroupModal() {
                              const { group_links, messages, admin_messages, admin_session_file } = tg_currentTaskConfig;
                              document.getElementById('tg-seedingGroupLinks').value = (group_links || []).join('\n');
                              document.getElementById('tg-seedingGroupMessages').value = (messages || []).join('\n');
                              document.getElementById('tg-seedingAdminMessages').value = (admin_messages || []).join('\n');

                              document.getElementById('tg-seedingSilentSwitch').checked = tg_currentTaskConfig?.send_silent || false;
                              const adminSelect = document.getElementById('tg-seedingAdminSessionSelect');
                              adminSelect.innerHTML = '<option value="">-- Đang tải... --</option>';
                              const adminGroup = tg_allGroups.find(g => g.name === 'Adminsession');
                              if (!adminGroup) { adminSelect.innerHTML = '<option value="">-- Không có nhóm Adminsession --</option>'; return; }
                              try {
                                    const res = await fetch(`/telegram/api/groups/${adminGroup.id}/sessions`);
                                    const adminSessions = await res.json();
                                    adminSelect.innerHTML = '<option value="">-- Không sử dụng Admin --</option>';
                                    adminSessions.forEach(s => adminSelect.add(new Option(s.phone || s.filename, s.filename)));
                                    if (admin_session_file) adminSelect.value = admin_session_file;
                              } catch (error) { adminSelect.innerHTML = '<option value="">-- Lỗi tải session --</option>'; }
                        }

                        async function tg_saveJoinGroupConfig() {
                              const links = document.getElementById('tg-joinGroupLinks').value.trim().split(/\r?\n/).filter(Boolean);
                              const configToSave = { links };
                              try {
                                    await fetch('/telegram/api/config/joinGroup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(configToSave) });
                                    tg_currentTaskConfig = { ...tg_currentTaskConfig, ...configToSave };
                                    bootstrap.Modal.getInstance(document.getElementById('tg-joinGroupModal')).hide();
                                    showToast('Đã lưu cấu hình Join Group!', 'success');
                              } catch (error) { showToast(`Lỗi: ${error.message}`, 'error'); }
                        }

                        async function tg_saveSeedingGroupConfig() {
                              const configToSave = {
                                    group_links: document.getElementById('tg-seedingGroupLinks').value.trim().split(/\r?\n/).filter(Boolean),
                                    messages: document.getElementById('tg-seedingGroupMessages').value.trim().split(/\r?\n/).filter(Boolean),
                                    admin_messages: document.getElementById('tg-seedingAdminMessages').value.trim().split(/\r?\n/).filter(Boolean),
                                    admin_session_file: document.getElementById('tg-seedingAdminSessionSelect').value,
                                    session_filenames: Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:checked:not(#tg-selectAllCheckbox):not(#tg-selectAllCheckbox-right)')).map(cb => cb.closest('tr').dataset.filename),
                                    send_silent: document.getElementById('tg-seedingSilentSwitch').checked
                              };
                              try {
                                    await fetch('/telegram/api/config/seedingGroup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(configToSave) });
                                    tg_currentTaskConfig = { ...tg_currentTaskConfig, ...configToSave };
                                    bootstrap.Modal.getInstance(document.getElementById('tg-seedingGroupModal')).hide();
                                    showToast('Đã lưu cấu hình Seeding Group!', 'success');
                              } catch (error) { showToast(`Lỗi: ${error.message}`, 'error'); }
                        }

                        async function tg_handleSaveGroup(event) {
                              event.preventDefault();
                              const form = document.getElementById('tg-addSessionForm');
                              const nameInput = document.getElementById('tg-groupName');
                              const filesInput = document.getElementById('tg-sessionFiles');
                              if (!nameInput.value.trim() || !filesInput.files.length) return showToast('Vui lòng nhập tên nhóm và chọn file.', 'error');
                              const formData = new FormData(form);
                              try {
                                    const r = await fetch('/telegram/api/groups', { method: 'POST', body: formData });
                                    const j = await r.json();
                                    if (!r.ok) throw new Error(j.error || 'Lỗi server.');
                                    showToast(j.message || 'Thành công!', 'success');
                                    bootstrap.Modal.getInstance(document.getElementById('tg-addSessionModal')).hide();
                                    form.reset();
                                    await tg_loadGroups();
                              } catch (e) { showToast(`Lỗi: ${e.message}`, 'error'); }
                        }

                        async function tg_handleUploadAdminSession() {
                              const files = this.files;
                              if (!files.length) return;
                              const formData = new FormData();
                              for (const file of files) formData.append('admin_session_files', file);
                              try {
                                    const response = await fetch('/telegram/api/upload-admin-sessions', { method: 'POST', body: formData });
                                    const result = await response.json();
                                    if (!response.ok) throw new Error(result.error);
                                    showToast(result.message, 'success');
                                    await tg_loadGroups();
                                    await tg_populateSeedingGroupModal();
                              } catch (error) { showToast(`Lỗi: ${error.message}`, 'error'); }
                        }

                        async function tg_resumeActiveTasks() {
                              try {
                                    const response = await fetch('/telegram/api/active-tasks');
                                    if (!response.ok) return;
                                    const activeTasks = await response.json();
                                    const taskIds = Object.keys(activeTasks);
                                    if (taskIds.length > 0) {
                                          const taskIdToResume = taskIds[0];
                                          const taskData = activeTasks[taskIdToResume];
                                          showToast(`Khôi phục trạng thái tác vụ: ${taskData.task_name}`, 'info');
                                          tg_currentTaskId = taskIdToResume;
                                          document.getElementById('tg-status-success-count').textContent = taskData.success;
                                          document.getElementById('tg-status-failed-count').textContent = taskData.failed;
                                          document.getElementById('tg-status-progress-text').textContent = `${taskData.processed}/${taskData.total}`;
                                          const groupSelect = document.getElementById('tg-group-session-select');
                                          // Set the group select dropdown to the group associated with the resumed task
                                          groupSelect.value = taskData.group_id;
                                          // CRITICAL FIX: Trigger the change event to load and display the sessions for that group.
                                          await groupSelect.dispatchEvent(new Event('change'));
                                          tg_setRunStopButtonState('running');
                                          tg_pollTaskStatus(taskIdToResume);
                                    }
                              } catch (error) { console.error("Lỗi khi khôi phục tác vụ:", error); }
                        }

                        document.getElementById('telegram-tool-tab').addEventListener('shown.bs.tab', async () => {
                              // The listener can be kept empty for now, or used for re-fetching logic later.
                              // For example, you could re-call tg_loadGroups() here if you want to refresh on every tab click.
                        });

                        document.getElementById('tg-runStopBtn').addEventListener('click', tg_handleRunStopClick);
                        document.getElementById('tg-checkLiveBtn').addEventListener('click', tg_handleCheckLive);
                        document.getElementById('tg-group-session-select').addEventListener('change', tg_handleGroupSelect);
                        document.getElementById('tg-saveGroupBtn').addEventListener('click', tg_handleSaveGroup);
                        document.getElementById('tg-saveJoinGroupConfigBtn').addEventListener('click', tg_saveJoinGroupConfig);
                        document.getElementById('tg-saveSeedingGroupConfigBtn').addEventListener('click', tg_saveSeedingGroupConfig);
                        document.getElementById('tg-uploadAdminSession').addEventListener('change', tg_handleUploadAdminSession);

                        // Delete Dead Sessions Function
                        window.tg_deleteDeadSessions = async () => {
                              // Determine current groupId
                              const groupSelect = document.getElementById('tg-group-session-select');
                              const groupId = groupSelect?.value || '';
                              if (!groupId) {
                                    alert('Vui lòng chọn nhóm.');
                                    return;
                              }

                              // Collect all "dead" sessions from BOTH left and right tables
                              const rows = [
                                    ...document.querySelectorAll('#tg-sessions-table-left-body tr[data-live="false"]'),
                                    ...document.querySelectorAll('#tg-sessions-table-right-body tr[data-live="false"]')
                              ];
                              const filenames = rows.map(r => r.dataset.filename).filter(Boolean);

                              if (filenames.length === 0) {
                                    alert('Không có session die để xóa.');
                                    return;
                              }

                              // Guard when a task is running
                              const runBtn = document.getElementById('tg-runStopBtn');
                              if (runBtn && runBtn.dataset.taskRunning === 'true') {
                                    alert('Đang chạy tác vụ, vui lòng dừng trước khi xóa.');
                                    return;
                              }

                              // Confirm
                              if (!confirm(`Xóa ${filenames.length} session die khỏi nhóm và khỏi đĩa?`)) {
                                    return;
                              }

                              try {
                                    // Call backend
                                    const res = await fetch('/telegram/api/sessions/delete', {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify({ group_id: groupId, filenames })
                                    });

                                    if (!res.ok) {
                                          const err = await res.json().catch(() => ({}));
                                          throw new Error(err.message || `HTTP ${res.status}`);
                                    }

                                    const { deleted = [], missing = [], failed = [] } = await res.json();

                                    // Update UI by reloading sessions
                                    const leftBody = document.getElementById('tg-sessions-table-left-body');
                                    const rightBody = document.getElementById('tg-sessions-table-right-body');
                                    leftBody.innerHTML = rightBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>';

                                    const sessionsRes = await fetch(`/telegram/api/groups/${groupId}/sessions`);
                                    tg_renderSessions(await sessionsRes.json());

                                    // Notify result
                                    if (failed.length > 0) {
                                          alert(`Không thể xóa ${failed.length} session.`);
                                    } else {
                                          console.log('Deleted sessions:', deleted);
                                    }

                              } catch (error) {
                                    alert(`Lỗi xóa session: ${error.message}`);
                              }
                        };

                        // Attach event handler for delete sessions context menu
                        document.getElementById('tg-context-delete-session')?.addEventListener('click', async () => {
                              hideAllContextMenus?.();
                              try {
                                    await tg_deleteDeadSessions();
                              } catch (e) {
                                    alert(`Lỗi xóa session: ${e.message}`);
                              }
                        });

                        // Immediately load groups and check for active tasks on page load.
                        (async () => {
                              await tg_loadGroups();
                              await tg_resumeActiveTasks();
                        })();

                        document.getElementById('tg-shuffleMessagesBtn').addEventListener('click', () => {
                              const memberTextarea = document.getElementById('tg-seedingGroupMessages');
                              const adminTextarea = document.getElementById('tg-seedingAdminMessages');
                              const shuffleTextarea = (textarea) => {
                                    let lines = textarea.value.split('\n').filter(line => line.trim() !== '');
                                    for (let i = lines.length - 1; i > 0; i--) {
                                          const j = Math.floor(Math.random() * (i + 1));
                                          [lines[i], lines[j]] = [lines[j], lines[i]];
                                    }
                                    textarea.value = lines.join('\n');
                              };
                              shuffleTextarea(memberTextarea);
                              shuffleTextarea(adminTextarea);
                              showToast('Đã xáo trộn tin nhắn!', 'success');
                        });

                        document.getElementById('tg-group-task-cards').addEventListener('click', e => {
                              const card = e.target.closest('.card[data-task-id]');
                              if (card && !e.target.closest('button')) {
                                    tg_selectCardAndLoadConfig(card.dataset.taskId);
                              }
                        });

                        document.getElementById('tg-session-tables-container').addEventListener('click', e => {
                              const checkbox = e.target;

                              // First, handle the specific "Select All" case
                              if (checkbox.id === 'tg-selectAllCheckbox') {
                                    const allSessionCheckboxes = telegramPane.querySelectorAll('.tg-session-checkbox:not(#tg-selectAllCheckbox)');
                                    allSessionCheckboxes.forEach(cb => {
                                          if (!cb.disabled) {
                                                cb.checked = checkbox.checked;
                                          }
                                    });
                                    const rightSelectAll = document.getElementById('tg-selectAllCheckbox-right');
                                    if (rightSelectAll) {
                                          rightSelectAll.checked = checkbox.checked;
                                    }
                                    tg_updateSessionCountDisplay();

                                    // THEN, handle clicks on individual session checkboxes
                              } else if (checkbox.classList.contains('tg-session-checkbox')) {
                                    if (e.shiftKey && tg_lastCheckedCheckbox) {
                                          const allCheckboxes = Array.from(telegramPane.querySelectorAll('.tg-session-checkbox:not(#tg-selectAllCheckbox):not(#tg-selectAllCheckbox-right)'));
                                          const start = allCheckboxes.indexOf(tg_lastCheckedCheckbox);
                                          const end = allCheckboxes.indexOf(checkbox);

                                          if (start !== -1 && end !== -1) {
                                                const lower = Math.min(start, end);
                                                const upper = Math.max(start, end);
                                                for (let i = lower; i <= upper; i++) {
                                                      allCheckboxes[i].checked = checkbox.checked;
                                                }
                                          }
                                    }
                                    tg_lastCheckedCheckbox = checkbox;
                                    tg_updateSessionCountDisplay();
                              }
                        });

                        document.getElementById('tg-addSessionModal').addEventListener('show.bs.modal', async () => {
                              const listEl = document.getElementById('tg-existing-groups-list');
                              listEl.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm"></div></div>`;
                              try {
                                    const r = await fetch('/telegram/api/groups');
                                    const groups = await r.json();
                                    listEl.innerHTML = groups.map(g => `<div class="d-flex justify-content-between align-items-center p-2 border-bottom"><span>${g.name}</span><button class="btn btn-sm btn-outline-danger tg-delete-group-btn" data-group-id="${g.id}"><i class="bi bi-trash-fill"></i></button></div>`).join('') || '<p class="text-muted text-center">Chưa có nhóm nào.</p>';
                              } catch (e) { listEl.innerHTML = `<div class="text-danger text-center">Lỗi tải nhóm.</div>`; }
                        });

                        document.getElementById('tg-existing-groups-list').addEventListener('click', async e => {
                              const deleteBtn = e.target.closest('.tg-delete-group-btn');
                              if (deleteBtn) {
                                    const groupId = deleteBtn.dataset.groupId;
                                    window.confirmDeleteAction(async () => {
                                          try {
                                                const res = await fetch(`/telegram/api/groups/${groupId}`, { method: 'DELETE' });
                                                if (!res.ok) throw new Error("Lỗi server");
                                                deleteBtn.closest('.d-flex').remove();
                                                await tg_loadGroups();
                                          } catch (err) { showToast('Lỗi xóa nhóm', 'error'); }
                                    }, 'Bạn có chắc muốn xóa nhóm này?');
                                    return;
                              }
                        });

                        const proxyModalEl = document.getElementById('tg-proxyModal');
                        const proxyTextarea = document.getElementById('tg-proxy-list');
                        const saveProxyBtn = document.getElementById('tg-save-proxy-btn');
                        const proxyEnableCheckbox = document.getElementById('tg-proxy-enabled');

                        if (proxyModalEl) {
                              proxyModalEl.addEventListener('show.bs.modal', async () => {
                                    try {
                                          const response = await fetch('/telegram/api/proxies');
                                          const config = await response.json();
                                          proxyTextarea.value = (config.proxies || []).join('\n');
                                          proxyEnableCheckbox.checked = config.enabled || false;
                                    } catch (error) {
                                          showToast('Lỗi tải cấu hình proxy.', 'error');
                                    }
                              });

                              saveProxyBtn.addEventListener('click', async () => {
                                    try {
                                          const payload = {
                                                enabled: proxyEnableCheckbox.checked,
                                                proxies: proxyTextarea.value
                                          };
                                          const response = await fetch('/telegram/api/proxies', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify(payload)
                                          });
                                          const result = await response.json();
                                          if (!response.ok) throw new Error(result.error || 'Lỗi server');
                                          showToast(result.message, 'success');
                                          bootstrap.Modal.getInstance(proxyModalEl).hide();
                                    } catch (error) {
                                          showToast(`Lỗi lưu proxy: ${error.message}`, 'error');
                                    }
                              });
                        }

                        // --- START: NEW FUNCTION TO ADD ---
                        function tg_makeCellEditable(cell, field, filename) {
                              const originalText = cell.textContent.trim();
                              const input = document.createElement('input');
                              input.type = 'text';
                              input.className = 'form-control form-control-sm';
                              input.value = originalText;
                              input.spellcheck = false;

                              cell.innerHTML = '';
                              cell.appendChild(input);
                              input.focus();
                              input.select();

                              const saveChanges = async () => {
                                    const newValue = input.value.trim();
                                    if (newValue === originalText) {
                                          cell.textContent = originalText;
                                          return;
                                    }

                                    const statusCell = cell.closest('tr').cells[6];
                                    const oldStatusHTML = statusCell.innerHTML;
                                    statusCell.innerHTML = `<span class="text-info">Updating...</span>`;
                                    showToast(`Updating ${field}...`, 'info');

                                    try {
                                          const groupId = document.getElementById('tg-group-session-select').value;
                                          const response = await fetch(`/telegram/api/update-session-info`, {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                      group_id: groupId,
                                                      filename: filename,
                                                      field: field,
                                                      value: newValue
                                                })
                                          });

                                          const result = await response.json();
                                          if (!response.ok) throw new Error(result.error || 'Unknown error');

                                          cell.textContent = result.updated_value;
                                          if (field === 'username' && result.updated_full_name) {
                                                cell.closest('tr').cells[3].textContent = result.updated_full_name;
                                          }
                                          statusCell.innerHTML = `<span class="text-success">Success!</span>`;
                                          showToast(result.message, 'success');

                                    } catch (error) {
                                          cell.textContent = originalText;
                                          statusCell.innerHTML = oldStatusHTML;
                                          showToast(`Error: ${error.message}`, 'error');
                                    }
                              };

                              input.addEventListener('blur', saveChanges);
                              input.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') {
                                          input.blur();
                                    } else if (e.key === 'Escape') {
                                          cell.textContent = originalText;
                                          input.removeEventListener('blur', saveChanges);
                                          input.blur();
                                    }
                              });
                        }
                        // --- END: NEW FUNCTION TO ADD ---

                        // --- START: NEW EVENT LISTENER TO ADD ---
                        document.getElementById('tg-session-tables-container').addEventListener('dblclick', (e) => {
                              const cell = e.target.closest('td');
                              if (!cell) return;

                              const tr = cell.closest('tr');
                              const filename = tr.dataset.filename;
                              if (!filename) return;

                              const cellIndex = cell.cellIndex;
                              let field = null;

                              if (cellIndex === 3) { // Full Name column
                                    field = 'full_name';
                              } else if (cellIndex === 4) { // Username column
                                    field = 'username';
                              }

                              if (field) {
                                    tg_makeCellEditable(cell, field, filename);
                              }
                        });
                        // --- END: NEW EVENT LISTENER TO ADD ---

                        // --- START: MODIFICATION FOR tg_renderSessions ---
                        function tg_renderSessions(sessions) {
                              const leftBody = document.getElementById('tg-sessions-table-left-body'), rightBody = document.getElementById('tg-sessions-table-right-body');
                              leftBody.innerHTML = rightBody.innerHTML = '';
                              document.getElementById('tg-total-sessions-count').textContent = sessions.length;
                              const rowHtml = (s, i) => {
                                    const liveIcon = s.is_live === null ? '<i class="bi bi-question-circle-fill text-secondary"></i>' : (s.is_live ? '<i class="bi bi-check-circle-fill text-success"></i>' : '<i class="bi bi-x-circle-fill text-danger"></i>');
                                    const statusClass = s.is_live === null ? 'text-secondary' : (s.is_live ? 'text-success' : 'text-danger');
                                    // MODIFY THE RETURN STATEMENT TO THE FOLLOWING:
                                    return `<tr data-filename="${s.filename}"><td><input class="form-check-input tg-session-checkbox" type="checkbox"></td><td>${i + 1}</td><td>${s.phone}</td><td class="d-none d-md-table-cell" style="cursor: text;">${s.full_name || 'N/A'}</td><td class="d-none d-md-table-cell" style="cursor: text;">${s.username || ''}</td><td class="text-center">${liveIcon}</td><td><span class="${statusClass}">${s.status_text || 'Sẵn sàng'}</span></td></tr>`;
                              };
                              const mid = Math.ceil(sessions.length / 2);
                              leftBody.innerHTML = sessions.slice(0, mid).map((s, i) => rowHtml(s, i)).join('');
                              rightBody.innerHTML = sessions.slice(mid).map((s, i) => rowHtml(s, mid + i)).join('');
                              tg_updateSessionCountDisplay();
                        }
                        // --- END: MODIFICATION FOR tg_renderSessions ---
                  })();

                  // --- IMAGE EDITOR SCRIPT ---
                  (() => {
                        const imageEditorPane = document.getElementById('image-editor-tool-pane');
                        if (!imageEditorPane) return;

                        // === DOM Elements ===
                        const uploadInput = document.getElementById('ie-image-upload');
                        const uploadBtn = document.getElementById('ie-image-upload-btn');
                        const thumbnailsContainer = document.getElementById('ie-uploaded-thumbnails');
                        const layoutContainer = document.getElementById('ie-layout-templates');
                        const saveBtn = document.getElementById('ie-save-btn');
                        const spaceInput = document.getElementById('ie-space-input');
                        const colorInput = document.getElementById('ie-color-input');
                        const imageCountSpan = document.getElementById('ie-image-count');
                        const resetBtn = document.getElementById('ie-reset-btn');
                        const addTextBtn = document.getElementById('ie-add-text-btn');
                        const canvasWrapper = document.getElementById('ie-canvas-wrapper');
                        const canvas = document.getElementById('ie-canvas');
                        const ctx = canvas.getContext('2d');
                        const placeholder = document.getElementById('ie-canvas-placeholder');
                        const textToolbar = document.getElementById('ie-text-toolbar');
                        const fontSelect = document.getElementById('ie-font-select');
                        const fontSizeInput = document.getElementById('ie-font-size-input');
                        const textColorInput = document.getElementById('ie-color-text-input');
                        const textAlignBtns = document.getElementById('ie-text-align-btns');
                        const textStyleBtns = document.getElementById('ie-text-style-btns');

                        // === State Variables ===
                        let ie_uploadedFilesInfo = []; // Stores {url, originalFilename}
                        let ie_sessionId = null;
                        let ie_draggedThumbnailIndex = null;
                        let textObjects = [];
                        let backgroundImage = null;
                        let selectedTextIndex = -1;
                        let isDragging = false;
                        let isResizing = false;
                        let dragOffsetX = 0, dragOffsetY = 0;
                        let activeResizeHandle = null;
                        const handleSize = 8;
                        // FIX: Add a state variable for rainbow border instead of relying on input value
                        let ie_isRainbowBorder = false;

                        const layoutsByCount = {
                              1: { 'layout_1_1': '<div class="cell"></div>' },
                              2: {
                                    'layout_2_h': '<div class="cell"></div><div class="cell"></div>',
                                    'layout_2_v': '<div class="cell"></div><div class="cell"></div>'
                              },
                              3: {
                                    'layout_3_top_1': '<div class="row1"><div class="cell"></div></div><div class="row2"><div class="cell"></div><div class="cell"></div></div>',
                                    'layout_3_left_1': '<div class="col1"><div class="cell"></div></div><div class="col2"><div class="cell"></div><div class="cell"></div></div>',
                                    'layout_3_v': '<div class="cell"></div><div class="cell"></div><div class="cell"></div>'
                              },
                              4: {
                                    'layout_4_2x2': '<div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>',
                                    'layout_4_left_1': '<div class="col1"><div class="cell"></div></div><div class="col2"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>'
                              },
                              5: {
                                    'layout_5_2_3': '<div class="row1"><div class="cell"></div><div class="cell"></div></div><div class="row2"><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>',
                                    'layout_5_left_1_4': '<div class="col1"><div class="cell"></div></div><div class="col2"><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div></div>'
                              }
                        };
                        const fonts = [
                              'Arial', 'Verdana', 'Georgia', 'Times New Roman', 'Courier New',
                              'Impact', 'Comic Sans MS', 'Trebuchet MS',
                              'Lobster', 'Pacifico', 'Anton', 'Oswald', 'Roboto'
                        ];

                        // === Main Functions ===
                        function init() {
                              populateFonts();
                              setupEventListeners();
                        }

                        function resetEditor() {
                              ie_uploadedFilesInfo = [];
                              ie_sessionId = null;
                              textObjects = [];
                              backgroundImage = null;
                              selectedTextIndex = -1;
                              // FIX: Reset rainbow border state
                              ie_isRainbowBorder = false;

                              ctx.clearRect(0, 0, canvas.width, canvas.height);
                              canvas.width = 0;
                              canvas.height = 0;
                              placeholder.classList.remove('d-none');

                              updateThumbnails();
                              updateLayoutTemplates(0);
                              updateToolbar();
                        }

                        function draw() {
                              if (!backgroundImage) {
                                    placeholder.classList.remove('d-none');
                                    return;
                              };
                              placeholder.classList.add('d-none');

                              // Fit canvas to background image aspect ratio
                              const wrapperRect = canvasWrapper.getBoundingClientRect();
                              const imgAspectRatio = backgroundImage.width / backgroundImage.height;
                              const wrapperAspectRatio = wrapperRect.width / wrapperRect.height;

                              if (imgAspectRatio > wrapperAspectRatio) {
                                    canvas.width = wrapperRect.width;
                                    canvas.height = wrapperRect.width / imgAspectRatio;
                              } else {
                                    canvas.height = wrapperRect.height;
                                    canvas.width = wrapperRect.height * imgAspectRatio;
                              }

                              ctx.clearRect(0, 0, canvas.width, canvas.height);
                              ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

                              // FIX: Check the state variable to draw rainbow border
                              if (ie_isRainbowBorder && parseInt(spaceInput.value, 10) > 0) {
                                    drawRainbowBorder();
                              }

                              textObjects.forEach((obj, index) => {
                                    drawTextObject(obj);
                              });

                              if (selectedTextIndex > -1 && textObjects[selectedTextIndex]) {
                                    drawBoundingBox(textObjects[selectedTextIndex]);
                              }
                        }

                        function drawTextObject(obj) {
                              const lines = obj.text.split('\n');
                              const fontStyle = obj.fontStyle || 'normal';
                              const fontWeight = obj.fontWeight || 'normal';
                              const font = `${fontStyle} ${fontWeight} ${obj.fontSize}px "${obj.font}"`;
                              ctx.font = font;

                              // Recalculate width/height for multiline text
                              let maxWidth = 0;
                              lines.forEach(line => {
                                    const lineWidth = ctx.measureText(line).width;
                                    if (lineWidth > maxWidth) {
                                          maxWidth = lineWidth;
                                    }
                              });
                              obj.width = maxWidth;
                              obj.height = lines.length * obj.fontSize * 1.2;

                              // Handle color / gradient
                              if (obj.color === 'rainbow') {
                                    const gradient = ctx.createLinearGradient(obj.x, obj.y, obj.x + obj.width, obj.y);
                                    gradient.addColorStop(0, "red");
                                    gradient.addColorStop(1 / 6, "orange");
                                    gradient.addColorStop(2 / 6, "yellow");
                                    gradient.addColorStop(3 / 6, "green");
                                    gradient.addColorStop(4 / 6, "blue");
                                    gradient.addColorStop(5 / 6, "indigo");
                                    gradient.addColorStop(1, "violet");
                                    ctx.fillStyle = gradient;
                              } else {
                                    ctx.fillStyle = obj.color;
                              }

                              ctx.textAlign = obj.textAlign || 'left';
                              ctx.textBaseline = 'top';

                              lines.forEach((line, i) => {
                                    let drawX = obj.x;
                                    if (ctx.textAlign === 'center') { drawX = obj.x + obj.width / 2; }
                                    if (ctx.textAlign === 'right') { drawX = obj.x + obj.width; }
                                    const drawY = obj.y + (i * obj.fontSize * 1.2);
                                    ctx.fillText(line, drawX, drawY);

                                    if (obj.textDecoration === 'underline') {
                                          const textWidth = ctx.measureText(line).width;
                                          let underlineX = obj.x;
                                          if (ctx.textAlign === 'center') { underlineX = obj.x + (obj.width - textWidth) / 2; }
                                          if (ctx.textAlign === 'right') { underlineX = obj.x + (obj.width - textWidth); }
                                          ctx.fillRect(underlineX, drawY + obj.fontSize * 1.1, textWidth, 2);
                                    }
                              });
                        }

                        function drawRainbowBorder() {
                              const borderThickness = parseInt(spaceInput.value, 10);
                              if (borderThickness <= 0) return;

                              ctx.save();
                              ctx.lineWidth = borderThickness;
                              const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                              const rainbowColors = ["red", "orange", "yellow", "green", "blue", "indigo", "violet"];
                              rainbowColors.forEach((color, index) => {
                                    gradient.addColorStop(index / (rainbowColors.length - 1), color);
                              });

                              ctx.strokeStyle = gradient;
                              ctx.strokeRect(borderThickness / 2, borderThickness / 2, canvas.width - borderThickness, canvas.height - borderThickness);
                              ctx.restore();
                        }


   
                     function drawBoundingBox(obj) {
                              ctx.strokeStyle = '#0d6efd';
                              ctx.lineWidth = 2;
                              ctx.setLineDash([6, 3]);
                              ctx.strokeRect(obj.x, obj.y, obj.width, obj.height);
                              ctx.setLineDash([]);

                              // Draw resize handles
                              const handles = getHandleRects(obj);
                              ctx.fillStyle = '#0d6efd';
                              for (const key in handles) {
                                    const handle = handles[key];
                                    ctx.fillRect(handle.x, handle.y, handle.w, handle.h);
                              }
                        }

                        // === Event Handlers ===
                        function setupEventListeners() {
                              uploadBtn.addEventListener('click', () => uploadInput.click());
                              uploadInput.addEventListener('change', handleImageUpload);
                              resetBtn.addEventListener('click', resetEditor);
                              addTextBtn.addEventListener('click', addText);
                              saveBtn.addEventListener('click', saveImage);

                              // Collage controls
                              spaceInput.addEventListener('change', generateCollageBackground);
                              // FIX: Handle native color picker input to disable rainbow mode
                              colorInput.addEventListener('input', () => {
                                    ie_isRainbowBorder = false;
                                    const rainbowSwatch = imageEditorPane.querySelector('.ie-color-swatches[data-target-input="ie-color-input"] span[data-color="rainbow"].active');
                                    if (rainbowSwatch) {
                                          rainbowSwatch.classList.remove('active');
                                    }
                                    generateCollageBackground();
                              });

                              // Text Toolbar controls
                              fontSelect.addEventListener('change', (e) => updateSelectedTextProperty('font', e.target.value));
                              fontSizeInput.addEventListener('change', (e) => updateSelectedTextProperty('fontSize', parseInt(e.target.value, 10)));
                              textColorInput.addEventListener('input', (e) => updateSelectedTextProperty('color', e.target.value));

                              // FIX: Correctly handle color swatches for both border and text
                              document.querySelectorAll('.ie-color-swatches').forEach(swatchGroup => {
                                    swatchGroup.addEventListener('click', (e) => {
                                          const swatch = e.target.closest('span[data-color]');
                                          if (swatch) {
                                                const targetInputId = swatchGroup.dataset.targetInput;
                                                const targetInput = document.getElementById(targetInputId);
                                                const color = swatch.dataset.color;

                                                if (targetInputId === 'ie-color-input') {
                                                      // Handle collage background color
                                                      if (color === 'rainbow') {
                                                            ie_isRainbowBorder = true;
                                                            // Set the color picker to black for visual feedback, as the generated background will be black
                                                            targetInput.value = '#000000';
                                                      } else {
                                                            ie_isRainbowBorder = false;
                                                            targetInput.value = color;
                                                      }
                                                      generateCollageBackground();
                                                } else {
                                                      // Handle text color (logic is unchanged)
                                                      if (color !== 'rainbow') {
                                                            targetInput.value = color;
                                                      }
                                                      updateSelectedTextProperty('color', color);
                                                }

                                                // Update active state for swatches
                                                swatchGroup.querySelector('.active')?.classList.remove('active');
                                                swatch.classList.add('active');
                                          }
                                    });
                              });

                              // Text Style & Align
                              textStyleBtns.addEventListener('click', handleTextStyleClick);
                              textAlignBtns.addEventListener('click', handleTextAlignClick);


                              // Canvas interaction
                              canvas.addEventListener('mousedown', handleMouseDown);
                              canvas.addEventListener('mousemove', handleMouseMove);
                              canvas.addEventListener('mouseup', handleMouseUp);
                              canvas.addEventListener('dblclick', handleDblClick);

                              // Keyboard interaction
                              canvas.addEventListener('keydown', handleKeyDown);

                              // Thumbnail Drag and Drop
                              thumbnailsContainer.addEventListener('dragstart', handleThumbnailDragStart);
                              thumbnailsContainer.addEventListener('dragend', handleThumbnailDragEnd);
                              thumbnailsContainer.addEventListener('dragover', e => e.preventDefault());
                              thumbnailsContainer.addEventListener('drop', handleThumbnailDrop);
                        }

                        async function handleImageUpload(e) {
                              const files = e.target.files;
                              if (files.length === 0) return;
                              const formData = new FormData();
                              for (const file of files) { formData.append('files', file); }
                              showToast('Đang tải ảnh lên...', 'info');
                              try {
                                    const response = await fetch('/image-editor/upload', { method: 'POST', body: formData });
                                    const data = await response.json();
                                    if (!response.ok) throw new Error(data.error || 'Lỗi không xác định');
                                    ie_sessionId = data.sessionId;
                                    ie_uploadedFilesInfo = data.files.map(url => ({ url: url, originalFilename: url.split('/').pop() }));
                                    updateThumbnails();
                                    showToast(`Đã tải lên ${ie_uploadedFilesInfo.length} ảnh.`, 'success');
                                    updateLayoutTemplates(ie_uploadedFilesInfo.length);
                              } catch (error) {
                                    showToast(error.message, 'error');
                                    resetEditor();
                              } finally {
                                    uploadInput.value = '';
                              }
                        }

                        async function generateCollageBackground() {
                              if (ie_uploadedFilesInfo.length === 0) return;
                              const selectedLayout = layoutContainer.querySelector('.ie-layout-box.active');
                              if (!selectedLayout) {
                                    showToast('Vui lòng chọn một bố cục.', 'error');
                                    return;
                              }
                              placeholder.classList.add('d-none');
                              showToast('Đang tạo ảnh nền...', 'info');

                              // FIX: Use the state variable to determine the background color for the server
                              const bgColorForServer = ie_isRainbowBorder ? '#000000' : colorInput.value;

                              const payload = {
                                    sessionId: ie_sessionId,
                                    images: ie_uploadedFilesInfo.map(info => info.url),
                                    layout: selectedLayout.dataset.layout,
                                    space: spaceInput.value,
                                    color: bgColorForServer,
                              };

                              try {
                                    const response = await fetch('/image-editor/create-collage', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                                    const data = await response.json();
                                    if (!response.ok) throw new Error(data.error || 'Lỗi không xác định');

                                    const img = new Image();
                                    img.crossOrigin = "anonymous"; // Important for canvas
                                    img.src = data.result_url + '?t=' + new Date().getTime();
                                    img.onload = () => {
                                          backgroundImage = img;
                                          textObjects = []; // Clear text when background changes
                                          selectedTextIndex = -1;
                                          updateToolbar();
                                          draw();
                                    };
                              } catch (error) {
                                    showToast(error.message, 'error');
                                    placeholder.classList.remove('d-none');
                              }
                        }

                        function addText() {
                              if (!backgroundImage) {
                                    showToast('Vui lòng tạo ảnh ghép trước.', 'error');
                                    return;
                              }
                              const newText = {
                                    text: 'Văn bản mẫu',
                                    x: canvas.width / 2 - 100,
                                    y: canvas.height / 2 - 25,
                                    font: 'Arial',
                                    fontSize: 50,
                                    color: '#FFFFFF',
                                    width: 0,
                                    height: 0,
                                    fontWeight: 'normal',
                                    fontStyle: 'normal',
                                    textDecoration: 'none',
                                    textAlign: 'left'
                              };
                              textObjects.push(newText);
                              selectedTextIndex = textObjects.length - 1;
                              updateToolbar();
                              draw();
                        }

                        function saveImage() {
                              if (!backgroundImage) {
                                    showToast('Không có ảnh để lưu.', 'error');
                                    return;
                              }
                              const previouslySelected = selectedTextIndex;
                              selectedTextIndex = -1;
                              draw();

                              const link = document.createElement('a');
                              link.download = `stool_collage_${Date.now()}.jpg`;
                              link.href = canvas.toDataURL('image/jpeg', 0.9);
                              link.click();

                              selectedTextIndex = previouslySelected;
                              if (selectedTextIndex > -1) draw();
                        }

                        function getMousePos(e) {
                              const rect = canvas.getBoundingClientRect();
                              return {
                                    x: e.clientX - rect.left,
                                    y: e.clientY - rect.top
                              };
                        }

                        function handleMouseDown(e) {
                              const pos = getMousePos(e);
                              let clickedOnSomething = false;

                              if (selectedTextIndex > -1 && textObjects[selectedTextIndex]) {
                                    const handles = getHandleRects(textObjects[selectedTextIndex]);
                                    for (const key in handles) {
                                          const handle = handles[key];
                                          if (pos.x >= handle.x && pos.x <= handle.x + handle.w &&
                                                pos.y >= handle.y && pos.y <= handle.y + handle.h) {
                                                isResizing = true;
                                                activeResizeHandle = key;
                                                clickedOnSomething = true;
                                                canvas.focus();
                                                break;
                                          }
                                    }
                              }

                              if (!isResizing) {
                                    for (let i = textObjects.length - 1; i >= 0; i--) {
                                          const obj = textObjects[i];
                                          if (pos.x >= obj.x && pos.x <= obj.x + obj.width &&
                                                pos.y >= obj.y && pos.y <= obj.y + obj.height) {
                                                selectedTextIndex = i;
                                                isDragging = true;
                                                dragOffsetX = pos.x - obj.x;
                                                dragOffsetY = pos.y - obj.y;
                                                clickedOnSomething = true;
                                                canvas.focus();
                                                break;
                                          }
                                    }
                              }

                              if (!clickedOnSomething) {
                                    selectedTextIndex = -1;
                              }

                              updateToolbar();
                              draw();
                        }

                        function handleMouseMove(e) {
                              const pos = getMousePos(e);

                              let onHandle = false;
                              if (selectedTextIndex > -1 && !isDragging) {
                                    const obj = textObjects[selectedTextIndex];
                                    if (obj) {
                                          const handles = getHandleRects(obj);
                                          for (const key in handles) {
                                                const handle = handles[key];
                                                if (pos.x >= handle.x && pos.x <= handle.x + handle.w &&
                                                      pos.y >= handle.y && pos.y <= handle.y + handle.h) {
                                                      canvas.style.cursor = `${key}-resize`;
                                                      onHandle = true;
                                                      break;
                                                }
                                          }
                                    }

                              }
                              if (!onHandle && !isDragging) {
                                    canvas.style.cursor = 'default';
                              } else if (isDragging) {
                                    canvas.style.cursor = 'move';
                              }

                              if (isDragging && selectedTextIndex > -1) {
                                    const obj = textObjects[selectedTextIndex];
                                    obj.x = pos.x - dragOffsetX;
                                    obj.y = pos.y - dragOffsetY;
                                    draw();
                              } else if (isResizing && selectedTextIndex > -1) {
                                    const obj = textObjects[selectedTextIndex];
                                    const oldWidth = obj.width;
                                    const oldHeight = obj.height;

                                    if (activeResizeHandle.includes('r')) obj.width = pos.x - obj.x;
                                    if (activeResizeHandle.includes('l')) {
                                          obj.width += obj.x - pos.x;
                                          obj.x = pos.x;
                                    }

                                    if (oldWidth > 0 && obj.width > 5) { // Prevent shrinking to zero
                                          const scale = obj.width / oldWidth;
                                          obj.fontSize *= scale;
                                    }

                                    draw();
                              }
                        }

                        function handleMouseUp() {
                              isDragging = false;
                              isResizing = false;
                              activeResizeHandle = null;
                              canvas.style.cursor = 'default';
                        }

                        function handleDblClick(e) {
                              const pos = getMousePos(e);
                              selectedTextIndex = -1;
                              draw();
                              for (let i = textObjects.length - 1; i >= 0; i--) {
                                    const obj = textObjects[i];
                                    if (pos.x >= obj.x && pos.x <= obj.x + obj.width &&
                                          pos.y >= obj.y && pos.y <= obj.y + obj.height) {
                                          createEditingTextarea(obj, i);
                                          return;
                                    }
                              }
                        }

                        function handleKeyDown(e) {
                              if ((e.key === 'Delete' || e.key === 'Backspace') && selectedTextIndex > -1) {
                                    if (document.activeElement.tagName.toLowerCase() !== 'textarea') {
                                          e.preventDefault();
                                          textObjects.splice(selectedTextIndex, 1);
                                          selectedTextIndex = -1;
                                          updateToolbar();
                                          draw();
                                    }
                              }
                        }

                        function createEditingTextarea(obj, index) {
                              const existingTextarea = document.querySelector('.ie-editing-textarea');
                              if (existingTextarea) existingTextarea.blur();

                              const textarea = document.createElement('textarea');
                              textarea.value = obj.text;
                              textarea.className = 'ie-editing-textarea';
                              textarea.spellcheck = false;

                              const canvasRect = canvas.getBoundingClientRect();

                              textarea.style.left = `${canvasRect.left + obj.x}px`;
                              textarea.style.top = `${canvasRect.top + obj.y}px`;
                              textarea.style.width = `${obj.width + 40}px`;
                              textarea.style.height = `auto`;
                              textarea.style.font = `${obj.fontStyle || 'normal'} ${obj.fontWeight || 'normal'} ${obj.fontSize}px "${obj.font}"`;
                              textarea.style.color = obj.color === 'rainbow' ? '#FFFFFF' : obj.color;

                              textarea.oninput = () => {
                                    textarea.style.height = 'auto';
                                    textarea.style.height = `${textarea.scrollHeight}px`;
                              };

                              textarea.onblur = () => {
                                    const newText = textarea.value;
                                    if (newText.trim()) {
                                          textObjects[index].text = newText;
                                    } else {
                                          textObjects.splice(index, 1);
                                    }
                                    selectedTextIndex = -1;
                                    updateToolbar();
                                    if (document.body.contains(textarea)) {
                                          document.body.removeChild(textarea);
                                    }
                                    draw();
                              };

                              textarea.addEventListener('keydown', (e) => { e.stopPropagation(); });

                              document.body.appendChild(textarea);
                              textarea.focus();
                              textarea.select();
                              textarea.dispatchEvent(new Event('input'));
                        }

                        function getHandleRects(obj) {
                              return {
                                    tl: { x: obj.x - handleSize / 2, y: obj.y - handleSize / 2, w: handleSize, h: handleSize },
                                    tr: { x: obj.x + obj.width - handleSize / 2, y: obj.y - handleSize / 2, w: handleSize, h: handleSize },
                                    bl: { x: obj.x - handleSize / 2, y: obj.y + obj.height - handleSize / 2, w: handleSize, h: handleSize },
                                    br: { x: obj.x + obj.width - handleSize / 2, y: obj.y + obj.height - handleSize / 2, w: handleSize, h: handleSize }
                              };
                        }

                        function updateToolbar() {
                              if (selectedTextIndex > -1 && textObjects[selectedTextIndex]) {
                                    textToolbar.classList.remove('d-none');
                                    const obj = textObjects[selectedTextIndex];
                                    fontSelect.value = obj.font;
                                    fontSizeInput.value = Math.round(obj.fontSize);
                                    textColorInput.value = obj.color === 'rainbow' ? '#ffffff' : obj.color;

                                    textStyleBtns.querySelectorAll('button').forEach(btn => {
                                          const style = btn.dataset.style;
                                          const value = btn.dataset.value;
                                          if (obj[style] === value) {
                                                btn.classList.add('active');
                                          } else {
                                                btn.classList.remove('active');
                                          }
                                    });
                                    textAlignBtns.querySelectorAll('button').forEach(btn => {
                                          if (obj.textAlign === btn.dataset.align) {
                                                btn.classList.add('active');
                                          } else {
                                                btn.classList.remove('active');
                                          }
                                    });

                              } else {
                                    textToolbar.classList.add('d-none');
                              }
                        }

                        function updateSelectedTextProperty(key, value) {
                              if (selectedTextIndex > -1) {
                                    const obj = textObjects[selectedTextIndex];
                                    if (!obj) return;

                                    if (key === 'fontWeight' || key === 'fontStyle' || key === 'textDecoration') {
                                          obj[key] = obj[key] === value ? 'normal' : value;
                                          if (key === 'textDecoration' && obj[key] === 'normal') obj[key] = 'none';
                                    } else {
                                          obj[key] = value;
                                    }

                                    draw();
                                    updateToolbar();
                              }
                        }

                        function handleTextStyleClick(e) {
                              const btn = e.target.closest('button');
                              if (btn) {
                                    updateSelectedTextProperty(btn.dataset.style, btn.dataset.value);
                              }
                        }
                        function handleTextAlignClick(e) {
                              const btn = e.target.closest('button');
                              if (btn) {
                                    updateSelectedTextProperty('textAlign', btn.dataset.align);
                              }
                        }

                        function updateThumbnails() {
                              thumbnailsContainer.innerHTML = '';
                              if (ie_uploadedFilesInfo.length === 0) {
                                    thumbnailsContainer.innerHTML = '<div class="text-muted d-flex align-items-center justify-content-center h-100 p-2 text-center small">Chưa có ảnh nào</div>';
                              } else {
                                    ie_uploadedFilesInfo.forEach((info, index) => {
                                          const img = document.createElement('img');
                                          img.src = info.url;
                                          img.draggable = true;
                                          img.dataset.index = index;
                                          thumbnailsContainer.appendChild(img);
                                    });
                              }
                              imageCountSpan.textContent = ie_uploadedFilesInfo.length;
                        }

                        function updateLayoutTemplates(count) {
                              layoutContainer.innerHTML = '';
                              const layouts = layoutsByCount[count];
                              if (!layouts) {
                                    layoutContainer.innerHTML = `<div class="text-warning text-center small">Không có bố cục cho ${count} ảnh.</div>`;
                                    return;
                              }
                              let isFirst = true;
                              for (const layoutId in layouts) {
                                    const box = document.createElement('div');
                                    box.className = 'ie-layout-box';
                                    box.dataset.layout = layoutId;
                                    box.innerHTML = layouts[layoutId];
                                    if (isFirst) { box.classList.add('active'); isFirst = false; }
                                    box.addEventListener('click', (e) => {
                                          layoutContainer.querySelector('.active')?.classList.remove('active');
                                          e.currentTarget.classList.add('active');
                                          generateCollageBackground();
                                    });
                                    layoutContainer.appendChild(box);
                              }
                              if (count > 0) { generateCollageBackground(); }
                        }

                        function populateFonts() {
                              const googleFonts = ['Lobster', 'Pacifico', 'Anton', 'Oswald', 'Roboto'];
                              const fontLink = document.createElement('link');
                              fontLink.href = `https://fonts.googleapis.com/css2?family=${googleFonts.map(f => f.replace(' ', '+')).join('&family=')}&display=swap`;
                              fontLink.rel = 'stylesheet';
                              document.head.appendChild(fontLink);

                              fontSelect.innerHTML = '';
                              fonts.forEach(font => {
                                    const option = document.createElement('option');
                                    option.value = font;
                                    option.textContent = font;
                                    option.style.fontFamily = font;
                                    fontSelect.appendChild(option);
                              });
                        }


                        function handleThumbnailDragStart(e) {
                              if (e.target.tagName === 'IMG') {
                                    ie_draggedThumbnailIndex = parseInt(e.target.dataset.index);
                                    e.target.classList.add('dragging');
                              }
                        }
                        function handleThumbnailDragEnd(e) {
                              if (e.target.tagName === 'IMG') { e.target.classList.remove('dragging'); }
                        }
                        function handleThumbnailDrop(e) {
                              e.preventDefault();
                              const target = e.target.closest('img');
                              if (target && target.tagName === 'IMG') {
                                    const fromIndex = ie_draggedThumbnailIndex;
                                    const toIndex = parseInt(target.dataset.index);
                                    if (fromIndex !== toIndex) {
                                          const [movedItem] = ie_uploadedFilesInfo.splice(fromIndex, 1);
                                          ie_uploadedFilesInfo.splice(toIndex, 0, movedItem);
                                          updateThumbnails();
                                          generateCollageBackground();
                                    }
                              }
                              ie_draggedThumbnailIndex = null;
                        }

                        init();
                  })();

                  // --- Custom Context Menu Logic ---
                  (function () {
                        // Get menu elements
                        const dashboardMenu = document.getElementById('dashboard-context-menu');
                        const telegramMenu = document.getElementById('telegram-context-menu');
                        const telegramPane = document.getElementById('telegram-tool-pane');
                        const mainTabContent = document.getElementById('main-tab-content');

                        // Helper: Hide all menus
                        function hideAllContextMenus() {
                              document.querySelectorAll('.custom-context-menu').forEach(menu => menu.style.display = 'none');
                        }

                        // Helper: Show menu at mouse position
                        function showMenu(menu, x, y) {
                              menu.style.display = 'block';
                              // Prevent menu from going off screen
                              const menuRect = menu.getBoundingClientRect();
                              const winW = window.innerWidth, winH = window.innerHeight;
                              if (x + menuRect.width > winW) x = winW - menuRect.width - 8;
                              if (y + menuRect.height > winH) y = winH - menuRect.height - 8;
                              menu.style.left = x + 'px';
                              menu.style.top = y + 'px';
                        }

                        // --- START: REPLACEMENT FOR ALL CONTEXT MENU LOGIC ---
                        document.addEventListener('click', function (e) {
                              // If the click is not on an element that is part of a context menu, hide all context menus.
                              if (!e.target.closest('.custom-context-menu')) {
                                    hideAllContextMenus();
                              }
                        }, true); // Use capture phase to catch the click early.

                        document.addEventListener('contextmenu', function (e) {
                              // By default, assume no specific menu is targeted.
                              let specificMenuHandled = false;

                              // Check for note card context menu
                              const noteCard = e.target.closest('.card[data-note-id]');
                              if (noteCard) {
                                    // This event is now handled inside createNoteCard, so we just stop propagation here
                                    specificMenuHandled = true;
                              }

                              // Check for telegram pane context menu
                              const telegramPane = document.getElementById('telegram-tool-pane');
                              const telegramMenu = document.getElementById('telegram-context-menu');
                              if (telegramPane && telegramPane.contains(e.target)) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    hideAllContextMenus();
                                    showMenu(telegramMenu, e.clientX, e.clientY);
                                    specificMenuHandled = true;
                              }

                              // Check for notes pane context menu
                              const notesPane = document.getElementById('notes-tool-pane');
                              if (notesPane && notesPane.contains(e.target) && !noteCard) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    hideAllContextMenus();
                                    const notesMenu = document.getElementById('notes-tab-context-menu');
                                    showMenu(notesMenu, e.clientX, e.clientY);
                                    specificMenuHandled = true;
                              }

                              // If no specific menu was handled, show the dashboard menu (if not inside a tab)
                              if (!specificMenuHandled && !e.target.closest('.tab-pane')) {
                                    e.preventDefault();
                                    hideAllContextMenus();
                                    const dashboardMenu = document.getElementById('dashboard-context-menu');
                                    showMenu(dashboardMenu, e.clientX, e.clientY);
                              }
                        });
                        // --- END: REPLACEMENT FOR ALL CONTEXT MENU LOGIC ---

                        // Hide menus on scroll
                        document.addEventListener('scroll', hideAllContextMenus, true);
                        window.addEventListener('resize', hideAllContextMenus);

                        // Hide menus when switching tabs
                        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tabBtn => {
                              tabBtn.addEventListener('shown.bs.tab', hideAllContextMenus);
                        });

                        // Prevent both menus from showing at once
                        dashboardMenu.addEventListener('contextmenu', e => e.preventDefault());
                        telegramMenu.addEventListener('contextmenu', e => e.preventDefault());
                        const notesTabMenu = document.getElementById('notes-tab-context-menu');
                        if (notesTabMenu) {
                              notesTabMenu.addEventListener('contextmenu', e => e.preventDefault());
                        }

                        // Add event listener for the new context menu item
                        const openSettingsBtn = document.getElementById('context-open-settings');
                        if (openSettingsBtn) {
                              openSettingsBtn.addEventListener('click', () => {
                                    toggleDashboardSettingsModal();
                                    hideAllContextMenus(); // Ensure menu closes after action
                              });
                        }
                  })();

                  // Global function for context menu
                  window.addNewNoteFromContextMenu = () => {
                        console.log('addNewNoteFromContextMenu called (global)');
                        // Ẩn menu chuột phải
                        const contextMenu = document.getElementById('notes-tab-context-menu');
                        if (contextMenu) contextMenu.style.display = 'none';

                        // Tìm modal element
                        const modalEl = document.getElementById('notes-addEditModal');
                        if (!modalEl) {
                              console.error('Modal element not found');
                              return;
                        }

                        // Chuẩn bị modal
                        if (window.prepareAddNoteModal) {
                              console.log('Calling prepareAddNoteModal');
                              window.prepareAddNoteModal();
                        } else {
                              console.log('prepareAddNoteModal not found, preparing manually');
                              // Reset form manually
                              const form = document.getElementById('notes-addEditForm');
                              if (form) form.reset();

                              const modalTitle = document.getElementById('notes-modalTitle');
                              if (modalTitle) modalTitle.textContent = 'Thêm Ghi Chú Mới';

                              const editIdInput = document.getElementById('notes-editId');
                              if (editIdInput) editIdInput.value = '';

                              const titleInput = document.getElementById('notes-title-input');
                              if (titleInput) titleInput.innerHTML = '';

                              const contentEditor = document.getElementById('notes-content-editor');
                              if (contentEditor) contentEditor.innerHTML = '';
                        }

                        // Hiển thị modal
                        console.log('Showing modal');
                        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                        modal.show();
                  };

                  // --- NOTES MANAGER SCRIPT ---
                  (() => {
                        const notesTab = document.getElementById('notes-tool-tab');
                        if (!notesTab) return;

                        // Element Selectors
                        const container = document.getElementById('notes-container');
                        const searchInput = document.getElementById('notes-search-input');
                        const modalEl = document.getElementById('notes-addEditModal');
                        const form = document.getElementById('notes-addEditForm');
                        const modalTitle = document.getElementById('notes-modalTitle');
                        const editIdInput = document.getElementById('notes-editId');
                        const titleInput = document.getElementById('notes-title-input');
                        const contentEditor = document.getElementById('notes-content-editor');

                        // Alarm UI Elements
                        const enableAlarmCheck = document.getElementById('notes-enableAlarmCheck');
                        const alarmContainer = document.getElementById('notes-alarm-container');
                        const dueTimeInput = document.getElementById('notes-dueTime');
                        const alarmTypeAbsoluteRadio = document.getElementById('alarmTypeAbsolute');
                        const alarmTypeRelativeRadio = document.getElementById('alarmTypeRelative');
                        const absolutePanel = document.getElementById('notes-alarm-absolute-panel');
                        const relativePanel = document.getElementById('notes-alarm-relative-panel');

                        // Notification Elements
                        const notificationModalEl = document.getElementById('notes-notificationModal');
                        const notificationModal = new bootstrap.Modal(notificationModalEl);
                        const notificationTitle = document.getElementById('notes-notificationTitle');
                        const notificationContent = document.getElementById('notes-notificationContent');
                        const notificationIdInput = document.getElementById('notes-notificationId');
                        const acknowledgeBtn = document.getElementById('notes-acknowledgeBtn');
                        let notificationSound = new Audio();

                        // Context Menu Elements
                        const contextMenu = document.getElementById('notes-context-menu');
                        const colorPalette = document.querySelector('#notes-context-menu .color-palette');
                        const contextCopy = document.getElementById('context-copy');
                        const contextLink = document.getElementById('context-link');
                        const addLinkModalEl = document.getElementById('notes-addLinkModal');
                        const addLinkModal = new bootstrap.Modal(addLinkModalEl);
                        const linkUrlInput = document.getElementById('notes-link-url');
                        const saveLinkBtn = document.getElementById('notes-save-link-btn');

                        const profileModalEl = document.getElementById('notes-addProfileModal');
                        const profileModal = new bootstrap.Modal(profileModalEl);
                        const profileIdInput = document.getElementById('notes-profile-id');
                        const profilePasswordInput = document.getElementById('notes-profile-password');
                        const profileContentInput = document.getElementById('notes-profile-content');
                        const saveProfileBtn = document.getElementById('notes-save-profile-btn');
                        const deleteProfileBtn = document.getElementById('notes-delete-profile-btn');
                        const contextProfile = document.getElementById('context-profile');

                        let currentProfileSpan = null; // To track the right-clicked profile span

                        let savedSelection = null; // To store the selected text range
                        let currentlyEditingProfileSpan = null;
                        let blockNextBlurSave = false;
                        let activeNoteId = null; // ID của ghi chú đang được xem/chỉnh sửa

                        if (contextLink) {
                              contextLink.addEventListener('click', () => {
                                    const selection = window.getSelection();
                                    if (selection.rangeCount > 0) {
                                          savedSelection = selection.getRangeAt(0).cloneRange();
                                          linkUrlInput.value = 'https://';

                                          // THIS IS THE FIX: Hide the context menu before showing the modal.
                                          contextMenu.style.display = 'none';

                                          addLinkModal.show();
                                    }
                              });
                        }

                        if (saveLinkBtn) {
                              saveLinkBtn.addEventListener('click', () => {
                                    const url = linkUrlInput.value.trim();
                                    if (url && savedSelection) {
                                          const selection = window.getSelection();
                                          selection.removeAllRanges();
                                          selection.addRange(savedSelection);
                                          document.execCommand('createLink', false, url);

                                          // Hide the modal first
                                          addLinkModal.hide();
                                          savedSelection = null;

                                          // CRITICAL FIX: Lấy ID của ghi chú đang được chỉnh sửa từ DOM
                                          setTimeout(() => {
                                                // Tìm ghi chú đang active hoặc từ biến global activeNoteId
                                                let noteId = activeNoteId;
                                                console.log('activeNoteId từ biến global:', activeNoteId);

                                                if (!noteId) {
                                                      const activeCard = document.querySelector('.note-card-active');
                                                      console.log('activeCard found:', activeCard);
                                                      noteId = activeCard ? activeCard.closest('.note-card-wrapper').dataset.noteId : null;
                                                      console.log('noteId từ DOM:', noteId);
                                                }

                                                if (noteId) {
                                                      console.log('Saving link for note:', noteId);
                                                      // Kiểm tra xem element detail-editable-full có tồn tại không
                                                      const editorEl = document.getElementById('detail-editable-full');
                                                      console.log('detail-editable-full element:', editorEl);
                                                      if (editorEl) {
                                                            console.log('Editor content:', editorEl.innerHTML);
                                                            // CRITICAL FIX: Force update data-initial-content để đảm bảo saveNoteChanges không bỏ qua
                                                            editorEl.setAttribute('data-initial-content', ''); // Set về empty để force save
                                                      }
                                                      saveNoteChanges(noteId);
                                                } else {
                                                      console.error('Không tìm thấy ID ghi chú để lưu link');
                                                      showToast('Lỗi: Không xác định được ghi chú để lưu!', 'error');
                                                }
                                          }, 0);
                                    }
                              });
                        }

                        if (addLinkModalEl) {
                              addLinkModalEl.addEventListener('shown.bs.modal', () => {
                                    linkUrlInput.focus();
                                    linkUrlInput.select();
                              });
                        }

                        // Note card context menu elements
                        const noteCardMenu = document.getElementById('note-card-context-menu');
                        const markNoteBtn = document.getElementById('context-mark-note');

                        if (markNoteBtn) {
                              markNoteBtn.addEventListener('click', async () => {
                                    const noteId = noteCardMenu.dataset.noteId;
                                    if (!noteId) return;

                                    try {
                                          const response = await fetch(`/notes/api/mark/${noteId}`, { method: 'POST' });
                                          if (!response.ok) throw new Error('Failed to toggle mark');
                                          await fetchAndRenderNotes(); // Refresh view
                                    } catch (error) {
                                          console.error('Error toggling note mark:', error);
                                          showToast('Lỗi khi đánh dấu ghi chú.', 'error');
                                    } finally {
                                          // ADD THIS LINE to ensure the menu always closes.
                                          noteCardMenu.style.display = 'none';
                                    }
                              });
                        }

                        // Profile span context menu elements
                        const profileSpanMenu = document.getElementById('profile-span-context-menu');

                        // Load saved profile colors on page load
                        if (typeof (Storage) !== "undefined") {
                              const savedColors = localStorage.getItem('profileColors');
                              if (savedColors) {
                                    window.profileColors = JSON.parse(savedColors);
                              } else {
                                    window.profileColors = {};
                              }
                        }

                        // Apply saved colors on load
                        function applySavedColors() {
                              if (window.profileColors) {
                                    Object.keys(window.profileColors).forEach(profileId => {
                                          const color = window.profileColors[profileId];
                                          const spans = document.querySelectorAll(`.has-profile[data-profile-id="${profileId}"]`);
                                          spans.forEach(span => {
                                                span.style.color = color;
                                          });
                                    });
                              }
                        }

                        // Profile span context menu event listener
                        if (profileSpanMenu) {
                              profileSpanMenu.addEventListener('click', (e) => {
                                    e.stopPropagation(); // Stop event from propagating further

                                    // Find the specific element that was clicked
                                    const colorSwatch = e.target.closest('.submenu .color-option');
                                    const deleteBtn = e.target.closest('#context-delete-profile');

                                    if (colorSwatch && currentProfileSpan) {
                                          // Logic for changing color
                                          const newColor = colorSwatch.dataset.color;
                                          localStorage.setItem('notes_profile_color', newColor);
                                          applySavedColors(); // This function already exists

                                          // Auto-save the note after color change
                                          if (activeNoteId) {
                                                setTimeout(() => saveNoteChanges(activeNoteId), 0);
                                          }

                                    } else if (deleteBtn && currentProfileSpan) {
                                          // NEW LOGIC: Delete the entire span element
                                          currentProfileSpan.parentNode.removeChild(currentProfileSpan);

                                          // Auto-save the note after deletion
                                          if (activeNoteId) {
                                                setTimeout(() => saveNoteChanges(activeNoteId), 0);
                                          }
                                    }

                                    // Hide menu after any action
                                    profileSpanMenu.style.display = 'none';
                                    currentProfileSpan = null;
                              });
                        }

                        // Global state for notes
                        window.notesData = [];
                        window.filteredNotes = [];

                        // Event Handlers
                        acknowledgeBtn.addEventListener('click', async () => {
                              const noteId = notificationIdInput.value;
                              if (noteId) {
                                    try {
                                          await fetch(`/notes/api/acknowledge-notification/${noteId}`, { method: 'POST' });
                                          if (document.getElementById('notes-tool-pane').classList.contains('active')) {
                                                fetchAndRenderNotes();
                                          }
                                    } catch (error) { console.error('Error acknowledging notification:', error); }
                              }
                        });

                        // Helper function to correctly serialize different node types.
                        // This is the core of the fix, ensuring that both element tags and text are preserved.
                        function getNodeHTML(node) {
                              if (!node) return '';
                              // For elements (like <a>, <span>, <b>), return their full HTML markup.
                              if (node.nodeType === Node.ELEMENT_NODE) {
                                    return node.outerHTML;
                              }
                              // For text nodes, return their text content.
                              if (node.nodeType === Node.TEXT_NODE) {
                                    return node.textContent;
                              }
                              // Ignore comments and other node types.
                              return '';
                        }

                        const saveNoteChanges = async (noteId, forceSave = false) => {
                              console.log(`%c[SAVE_NOTE_CHANGES] START: Fired for noteId: ${noteId} with forceSave: ${forceSave}`, 'color: #00e0ff; font-weight: bold;');
                              
                              const fullEditorEl = document.getElementById('detail-editable-full');
                              if (!fullEditorEl) {
                                    console.error('[SAVE_NOTE_CHANGES] ABORT: Editor element not found.');
                                    showToast('Lỗi: Không tìm thấy editor để lưu!', 'error');
                                    return;
                              }

                              const initialContent = fullEditorEl.getAttribute('data-initial-content');
                              const currentContent = fullEditorEl.innerHTML;
                              
                              console.log('[SAVE_NOTE_CHANGES] Initial Content:', initialContent);
                              console.log('[SAVE_NOTE_CHANGES] Current Content:', currentContent);

                              // If content hasn't changed AND we are not forcing a save, then exit.
                              if (!forceSave && currentContent === initialContent) {
                                    console.log('%c[SAVE_NOTE_CHANGES] ABORT: Content unchanged and not forced.', 'color: #ffca28;');
                                    return;
                              }

                              // Use a temporary div to parse the editor's content safely.
                              const tempDiv = document.createElement('div');
                              tempDiv.innerHTML = fullEditorEl.innerHTML;

                              let title_html = '';
                              let content_html = '';
                              const firstChild = tempDiv.firstChild;

                              if (firstChild) {
                                    // The first direct child node is considered the title.
                                    // The new getNodeHTML helper function correctly handles this.
                                    title_html = getNodeHTML(firstChild);

                                    // All subsequent siblings are part of the content.
                                    let currentNode = firstChild.nextSibling;
                                    while (currentNode) {
                                          // A special case: browsers often add a trailing <br> at the end of a contenteditable div. 
                                          // We should ignore it to avoid extra blank lines in the saved content.
                                          if (currentNode.nodeName === 'BR' && !currentNode.nextSibling) {
                                                break;
                                          }
                                          content_html += getNodeHTML(currentNode);
                                          currentNode = currentNode.nextSibling;
                                    }
                              } else {
                                    // Handle the case where the editor is completely empty.
                                    title_html = tempDiv.innerHTML;
                              }

                              const payload = {
                                    title_html: title_html.trim(),
                                    content_html: content_html.trim(),
                              };

                              showToast('Đang lưu...', 'info');
                              console.log('[SAVE_NOTE_CHANGES] API CALL: Sending payload:', payload);
                              try {
                                    const response = await fetch(`/notes/api/update/${noteId}`, {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify(payload)
                                    });
                                    if (!response.ok) throw new Error('Save failed');
                                    showToast('Đã lưu thay đổi!', 'success');
                                    console.log('%c[SAVE_NOTE_CHANGES] SUCCESS: API call successful.', 'color: #2ed573;');

                                    // Refresh the list to show the latest saved state from the server,
                                    // ensuring the UI is consistent with the database.
                                    await fetchAndRenderNotes();
                              } catch (error) {
                                    showToast('Lỗi khi lưu!', 'error');
                                    console.error('[SAVE_NOTE_CHANGES] ERROR: API call failed.', error);
                              }
                        };

                        // Add this new function to apply the saved size
                        function applySavedCardSize() {
                              const savedModifier = localStorage.getItem('notesCardSizeModifier') || 'default';

                              // Apply class to container
                              container.classList.remove('h-minus-2', 'h-minus-4'); // Only remove the ones we use
                              if (savedModifier !== 'default') {
                                    container.classList.add(savedModifier);
                              }

                              // Update context menu checkmarks
                              const notesTabMenu = document.getElementById('notes-tab-context-menu');
                              if (notesTabMenu) {
                                    const allChecks = notesTabMenu.querySelectorAll('.submenu .bi-check-circle-fill');
                                    allChecks.forEach(check => check.classList.add('d-none'));

                                    const activeCheck = notesTabMenu.querySelector(`.submenu [data-size-modifier="${savedModifier}"] i`);
                                    if (activeCheck) {
                                          activeCheck.classList.remove('d-none');
                                    }
                              }
                        }

                        // Add this new event listener
                        const notesTabMenu = document.getElementById('notes-tab-context-menu');
                        if (notesTabMenu) {
                              notesTabMenu.addEventListener('click', (e) => {
                                    const sizeItem = e.target.closest('.submenu .menu-item[data-size-modifier]');
                                    if (sizeItem) {
                                          const modifier = sizeItem.dataset.sizeModifier;

                                          // Save the setting
                                          localStorage.setItem('notesCardSizeModifier', modifier);

                                          // Apply the changes immediately
                                          applySavedCardSize();

                                          // Hide the context menu after selection
                                          notesTabMenu.style.display = 'none';
                                    }
                              });
                        }

                        function formatTimeAgo(isoString) {
                              if (!isoString) return '';
                              const seconds = Math.round((new Date() - new Date(isoString)) / 1000);
                              if (seconds < 60) return "vài giây trước";
                              const intervals = { năm: 31536000, tháng: 2592000, ngày: 86400, giờ: 3600, phút: 60 };
                              for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                                    const value = Math.floor(seconds / secondsInUnit);
                                    if (value >= 1) return `${value} ${unit} trước`;
                              }
                              return "vài giây trước";
                        }

                        async function fetchAndRenderNotes() {
                              try {
                                    console.log('Fetching notes...');
                                    const response = await fetch('/notes/api/get');
                                    console.log('Response status:', response.status);
                                    const notes = await response.json();
                                    console.log('Notes received:', notes.length, notes);
                                    window.notesData = notes;
                                    window.filteredNotes = notes;

                                    const currentActiveNote = document.querySelector('.note-card-active');
                                    const currentActiveNoteId = currentActiveNote ? currentActiveNote.closest('.note-card-wrapper').dataset.noteId : null;

                                    const searchInput = document.getElementById('notes-search-input');
                                    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

                                    renderNotes(searchTerm ? notes.filter(note => ((note.title_html || '').toLowerCase().includes(searchTerm) || (note.content_html || '').toLowerCase().includes(searchTerm))) : notes, searchTerm);

                                    if (currentActiveNoteId) {
                                          const noteToReactivate = notes.find(n => n.id === currentActiveNoteId);
                                          if (noteToReactivate) {
                                                showNoteDetail(noteToReactivate);
                                          } else {
                                                closeDetailPanel();
                                          }
                                    }
                              } catch (error) {
                                    console.error('Error fetching notes:', error);
                              }
                        }

                        function renderNotes(notesToRender, searchTerm = '') {
                              container.innerHTML = '';

                              if (notesToRender.length === 0) {
                                    container.innerHTML = `<div class="col-12 text-center text-muted p-5"><h6>Không tìm thấy ghi chú nào.</h6></div>`;
                              } else {
                                    notesToRender.forEach(note => container.appendChild(createNoteCard(note, searchTerm)));
                              }
                        }

                        function createNoteCard(note, searchTerm = '') {
                              const col = document.createElement('div');
                              col.className = 'note-card-wrapper d-flex';
                              col.dataset.noteId = note.id;

                              let borderColor = 'var(--bs-card-border-color)';
                              let statusHTML = '<small class="text-muted">&nbsp;</small>';

                              if (note.status === 'notified') {
                                    borderColor = '#28a745';
                                    statusHTML = `<small class="text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Đã báo</small>`;
                              } else if (note.due_time) {
                                    borderColor = '#ffc107';
                                    statusHTML = `<small class="text-warning fw-bold"><i class="bi bi-alarm-fill"></i> <span id="countdown-${note.id}" data-due-time="${note.due_time}">...</span></small>`;
                              }

                              const markedIconHTML = note.is_marked ? `<i class="bi bi-star-fill text-warning me-2" title="Đã đánh dấu"></i>` : '';

                              let noteTitleHTML = note.title_html || "Ghi chú không có tiêu đề";
                              let noteBodyHTML = note.content_html || '...';

                              if (searchTerm) {
                                    // This regex finds the opening of a 'has-profile' span that also matches the searched ID,
                                    // and injects the 'profile-highlight' class into it.
                                    const regex = new RegExp(`(<span class="has-profile"[^>]*data-profile-id="${searchTerm}"[^>]*?)>`, 'i');

                                    noteTitleHTML = noteTitleHTML.replace(regex, `$1 class="has-profile profile-highlight">`);
                                    noteBodyHTML = noteBodyHTML.replace(regex, `$1 class="has-profile profile-highlight">`);
                              }

                              col.innerHTML = `
                            <div class="card h-100 w-100 m-0" spellcheck="false" data-note-id="${note.id}" style="border-left-color: ${borderColor};">
                                <div class="card-body d-flex flex-column">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 class="card-title mb-0 text-truncate" spellcheck="false">${noteTitleHTML}</h5>
                                        <div class="d-flex align-items-center flex-shrink-0 ms-2">
                                            ${markedIconHTML}
                                            <small class="text-muted" title="${new Date(note.modified_at).toLocaleString('vi-VN')}">${formatTimeAgo(note.modified_at)}</small>
                                        </div>
                                    </div>
                                    <div class="card-text text-muted flex-grow-1 card-note-body mb-2" spellcheck="false">${noteBodyHTML}</div>
                                    <div class="mt-auto d-flex justify-content-between align-items-center">
                                        ${statusHTML}
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${note.id}')" style="width: 22px; height: 22px; padding: 0; display: flex; align-items: center; justify-content: center;"><i class="bi bi-trash-fill" style="font-size: 10px;"></i></button>
                                    </div>
                                </div>
                            </div>`;

                              const cardElement = col.querySelector('.card');

                              cardElement.addEventListener('click', (e) => {
                                    if (e.target.closest('button')) return;
                                    openDetailPanel();
                                    showNoteDetail(note);
                              });

                              // Add right-click listener for the context menu
                              cardElement.addEventListener('contextmenu', (e) => {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    document.querySelectorAll('.custom-context-menu').forEach(m => m.style.display = 'none');

                                    const menu = document.getElementById('note-card-context-menu');
                                    const markBtn = document.getElementById('context-mark-note');

                                    // --- THIS IS THE FIX for dynamic text ---
                                    if (note.is_marked) {
                                          markBtn.innerHTML = '<i class="bi bi-star me-2"></i> Bỏ Đánh Dấu';
                                    } else {
                                          markBtn.innerHTML = '<i class="bi bi-star-fill me-2"></i> Đánh Dấu';
                                    }

                                    menu.dataset.noteId = note.id;
                                    menu.style.top = `${e.clientY}px`;
                                    menu.style.left = `${e.clientX}px`;
                                    menu.style.display = 'block';
                              });

                              // --- START: Force Disable Spellcheck via JS ---
                              // This is the definitive fix, bypassing potential browser cache issues.
                              const titleEl = col.querySelector('.card-title');
                              const bodyEl = col.querySelector('.card-note-body');
                              if (titleEl) {
                                    titleEl.spellcheck = false;
                              }
                              if (bodyEl) {
                                    bodyEl.spellcheck = false;
                              }
                              // --- END: Force Disable Spellcheck via JS ---

                              return col;
                        }

                        function updateCountdown(elementId, dueTimeString) {
                              const elem = document.getElementById(elementId);
                              if (!elem) return;

                              const distance = new Date(dueTimeString).getTime() - new Date().getTime();
                              if (distance < 0) {
                                    elem.textContent = "Đã đến giờ!";
                                    return;
                              }

                              const days = Math.floor(distance / 86400000);
                              const hours = Math.floor((distance % 86400000) / 3600000);
                              const minutes = Math.floor((distance % 3600000) / 60000);
                              const seconds = Math.floor((distance % 60000) / 1000);

                              let result = "Còn ";
                              if (days > 0) result += `${days} ngày `;
                              if (hours > 0 || days > 0) result += `${hours} giờ `;
                              result += `${minutes} phút ${seconds} giây`;
                              elem.textContent = result;
                        }

                        setInterval(() => {
                              document.querySelectorAll('[id^="countdown-"]').forEach(span => {
                                    if (span.dataset.dueTime) updateCountdown(span.id, span.dataset.dueTime);
                              });
                        }, 1000);

                        function openDetailPanel() {
                              document.getElementById('notes-list-wrapper').classList.add('shrunk');
                              document.getElementById('notes-detail-wrapper').classList.add('visible');
                              container.classList.remove('notes-grid-view');
                              container.classList.add('notes-list-view');
                              applySavedCardSize(); // Apply saved size when switching to list view
                        }

                        window.closeDetailPanel = function () {
                              document.getElementById('notes-list-wrapper').classList.remove('shrunk');
                              document.getElementById('notes-detail-wrapper').classList.remove('visible');
                              container.classList.remove('notes-list-view');
                              container.classList.add('notes-grid-view');
                              document.querySelector('.note-card-active')?.classList.remove('note-card-active');
                              activeNoteId = null;
                              resetDetailPanel();
                        };

                        function resetDetailPanel() {
                              const detailHeader = document.querySelector('#notes-detail-panel .card-header');
                              const detailContent = document.getElementById('notes-detail-content');
                              const detailPlaceholder = document.getElementById('notes-detail-placeholder');

                              detailHeader.innerHTML = `
                          <div class="d-flex justify-content-between align-items-center w-100">
                              <h6 class="mb-0">Chi tiết</h6>
                              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#notes-addEditModal" onclick="prepareAddNoteModal()" title="Thêm ghi chú mới">
                                  <i class="bi bi-plus-lg"></i>
                              </button>
                          </div>`;
                              detailContent.classList.add('d-none');
                              detailPlaceholder.classList.remove('d-none');
                        }

                        function initializeProfileInteractions() {
                              const editor = document.getElementById('detail-editable-full');
                              if (!editor) return;

                              // First, destroy any existing popovers to prevent duplicates
                              editor.querySelectorAll('.has-profile').forEach(span => {
                                    const popoverInstance = bootstrap.Popover.getInstance(span);
                                    if (popoverInstance) {
                                          popoverInstance.dispose();
                                    }
                              });

                              // Re-initialize all profile spans
                              editor.querySelectorAll('.has-profile').forEach(span => {
                                    // 1. Initialize Bootstrap Popover for hover effect
                                    new bootstrap.Popover(span, {
                                          trigger: 'hover',
                                          placement: 'top',
                                          html: true,
                                          content: `<b>ID:</b> ${span.dataset.profileId || ''}<br><b>Pass:</b> ${span.dataset.profilePassword || ''}`,
                                          customClass: 'bg-dark text-white'
                                    });

                                    // 2. Add click event listener to open the edit modal
                                    span.addEventListener('click', (e) => {
                                          e.preventDefault();
                                          e.stopPropagation();

                                          currentlyEditingProfileSpan = span;
                                          profileIdInput.value = span.dataset.profileId || '';
                                          profilePasswordInput.value = span.dataset.profilePassword || '';
                                          profileContentInput.value = span.dataset.profileContent || '';
                                          deleteProfileBtn.classList.remove('d-none'); // Show delete button
                                          blockNextBlurSave = true;
                                          profileModal.show();
                                    });
                              });
                        }

                        function showNoteDetail(note) {
                              activeNoteId = note.id;
                              const detailHeader = document.querySelector('#notes-detail-panel .card-header');
                              const detailContent = document.getElementById('notes-detail-content');
                              const detailPlaceholder = document.getElementById('notes-detail-placeholder');

                              document.querySelectorAll('#notes-container .card').forEach(card => card.classList.remove('note-card-active'));
                              const clickedCard = document.querySelector(`[data-note-id="${note.id}"] .card`);
                              if (clickedCard) clickedCard.classList.add('note-card-active');

                              let statusHTML = '';
                              if (note.due_time && note.status !== 'notified') {
                                    statusHTML = `<small class="text-warning fw-bold d-flex align-items-center gap-1"><i class="bi bi-alarm-fill"></i><span id="detail-countdown-${note.id}" data-due-time="${note.due_time}">...</span></small>`;
                              }

                              // --- START OF CORRECTED BLOCK ---
                              detailHeader.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="header-status-container d-flex align-items-center gap-3">
                                <small class="text-muted" title="Ngày tạo/sửa"><i class="bi bi-clock-history me-1"></i>${formatTimeAgo(note.modified_at)}</small>
                                ${statusHTML}
                            </div>
                            <div class="d-flex align-items-center" style="gap: 0.5rem;">
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#notes-addEditModal" onclick="prepareAddNoteModal()" title="Thêm ghi chú mới"><i class="bi bi-plus-lg"></i></button>
                                <button class="btn btn-sm btn-outline-info" onclick="prepareEditNoteModal('${note.id}')" title="Sửa báo thức"><i class="bi bi-alarm-fill"></i></button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${note.id}')" title="Xóa ghi chú"><i class="bi bi-trash-fill"></i></button>
                                <button class="btn-close btn-close-white" onclick="closeDetailPanel()" title="Đóng chi tiết" style="font-size: 0.8rem;"></button>
                            </div>
                        </div>`;
                              // --- END OF CORRECTED BLOCK ---

                              detailContent.innerHTML = `<div id="detail-editable-full" contenteditable="true" spellcheck="false" data-placeholder="Dòng đầu là tiêu đề..."></div>`;
                              const fullEditorEl = document.getElementById('detail-editable-full');
                              fullEditorEl.innerHTML = (note.title_html || '') + (note.content_html || '');

                              fullEditorEl.addEventListener('click', (e) => {
                                    const link = e.target.closest('a');
                                    if (link && link.href) {
                                          e.preventDefault();
                                          e.stopPropagation();
                                          window.open(link.href, '_blank', 'noopener,noreferrer');
                                    }
                              });

                              fullEditorEl.addEventListener('contextmenu', e => {
                                    e.preventDefault();
                                    e.stopPropagation();

                                    // Hide all menus first to prevent overlap
                                    document.querySelectorAll('.custom-context-menu').forEach(m => m.style.display = 'none');

                                    const clickedProfileSpan = e.target.closest('.has-profile');

                                    if (clickedProfileSpan) {
                                          // If a profile span was right-clicked, show the dedicated profile menu.
                                          currentProfileSpan = clickedProfileSpan; // Store reference to the clicked span
                                          const menuToShow = document.getElementById('profile-span-context-menu');
                                          menuToShow.style.top = `${e.clientY}px`;
                                          menuToShow.style.left = `${e.clientX}px`;
                                          menuToShow.style.display = 'block';
                                    } else if (window.getSelection().toString().length > 0) {
                                          // Otherwise, if normal text is selected, show the regular text formatting menu.
                                          const menuToShow = document.getElementById('notes-context-menu');
                                          menuToShow.style.top = `${e.clientY}px`;
                                          menuToShow.style.left = `${e.clientX}px`;
                                          menuToShow.style.display = 'block';
                                    }
                              });

                              const saveHandler = () => {
                                    console.log('[BLUR_HANDLER] Blur event triggered.');
                                    // CRITICAL FIX: Check the flag to prevent saving when blur is caused by an external action like a modal closing.
                                    if (blockNextBlurSave) {
                                          blockNextBlurSave = false; // Reset flag for the next time
                                          console.log('%c[BLUR_HANDLER] ABORT: Save blocked by flag.', 'color: #ff4757;');
                                          return;
                                    }
                                    saveNoteChanges(note.id);
                              };

                              fullEditorEl.addEventListener('focus', () => {
                                    console.log('[FOCUS_HANDLER] Editor focused. Setting initial content.');
                                    fullEditorEl.setAttribute('data-initial-content', fullEditorEl.innerHTML)
                              });
                              fullEditorEl.addEventListener('blur', saveHandler);

                              fullEditorEl.addEventListener('keydown', (e) => {
                                    // This handler specifically targets the "sticky style" issue.
                                    // It triggers only when the user presses the space key.
                                    if (e.key === ' ') {
                                          const selection = window.getSelection();
                                          if (!selection || selection.rangeCount === 0 || !selection.isCollapsed) {
                                                return;
                                          }

                                          const range = selection.getRangeAt(0);
                                          const parentSpan = selection.anchorNode.parentNode;

                                          // Check three conditions:
                                          // 1. The cursor's direct parent is a .has-profile span.
                                          // 2. The cursor is at the very end of the text within that span.
                                          // 3. The node is a text node (nodeType === 3).
                                          if (parentSpan && parentSpan.classList.contains('has-profile') && selection.anchorNode.nodeType === 3 && selection.anchorOffset === parentSpan.textContent.length) {
                                                // Prevent the default space insertion, which would happen inside the span.
                                                e.preventDefault();

                                                // Create an invisible, zero-width space character to act as a "breaker" node.
                                                const zeroWidthSpace = document.createTextNode('\u200B');

                                                // Insert the breaker node immediately *after* the span.
                                                parentSpan.parentNode.insertBefore(zeroWidthSpace, parentSpan.nextSibling);

                                                // Create the actual space character the user intended to type.
                                                const spaceNode = document.createTextNode(' ');

                                                // Insert the space *after* the breaker node.
                                                zeroWidthSpace.parentNode.insertBefore(spaceNode, zeroWidthSpace.nextSibling);

                                                // Move the cursor to the end of the newly created space node.
                                                range.setStartAfter(spaceNode);
                                                range.collapse(true);
                                                selection.removeAllRanges();
                                                selection.addRange(range);
                                          }
                                    }
                              });

                              // --- START: New 'paste' event listener for auto-linking URLs ---
                              fullEditorEl.addEventListener('paste', (e) => {
                                    // Prevent the default browser paste action.
                                    e.preventDefault();

                                    // Get the pasted content as plain text from the clipboard.
                                    const plainText = (e.clipboardData || window.clipboardData).getData('text');
                                    if (!plainText) {
                                          return;
                                    }

                                    // A robust regular expression to find URLs in the pasted text.
                                    // This handles http, https, ftp, and file protocols, as well as various URL structures.
                                    const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;

                                    // Check if the pasted text contains any URLs.
                                    if (urlRegex.test(plainText)) {
                                          // If URLs are found, replace them with HTML anchor tags.
                                          // The '$&' in the replacement string inserts the entire matched URL.
                                          const processedHtml = plainText.replace(urlRegex, (url) => {
                                                // Create a styled and secure link.
                                                return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #69b3ff; text-decoration: underline;">${url}</a>`;
                                          });

                                          // Insert the processed HTML into the editor. This preserves non-URL text and correctly formats links.
                                          document.execCommand('insertHTML', false, processedHtml);
                                    } else {
                                          // If no URLs are found, simply insert the content as plain text.
                                          document.execCommand('insertText', false, plainText);
                                    }

                                    // CRITICAL: After pasting, immediately trigger a save to persist the new content.
                                    // This fixes the issue where the content might not be saved if the user doesn't blur the editor afterwards.
                                    setTimeout(() => {
                                          if (activeNoteId) {
                                                console.log("Forcing save after paste for note:", activeNoteId);
                                                saveNoteChanges(activeNoteId);
                                          }
                                    }, 100); // A small delay to ensure the DOM has updated.
                              });
                              // --- END: New 'paste' event listener ---

                              initializeProfileInteractions();
                              applySavedColors();

                              // --- START: New Profile Highlight Logic for Detail View ---
                              // This code block applies the highlight effect only when a search term is active.
                              const currentSearchTerm = searchInput.value.trim().toLowerCase();
                              if (currentSearchTerm) {
                                    // We only search within the newly rendered editor element `fullEditorEl`.
                                    const matchingSpans = fullEditorEl.querySelectorAll(`.has-profile[data-profile-id="${currentSearchTerm}" i]`);

                                    matchingSpans.forEach(span => {
                                          span.classList.add('profile-highlight');
                                          // Remove the class after the animation finishes to allow it to be re-triggered later.
                                          setTimeout(() => {
                                                span.classList.remove('profile-highlight');
                                          }, 600); // Duration should match the CSS animation.
                                    });

                                    // Scroll the first matched span in the editor into view.
                                    if (matchingSpans.length > 0) {
                                          matchingSpans[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    }
                              }
                              // --- END: New Profile Highlight Logic for Detail View ---

                              detailPlaceholder.classList.add('d-none');
                              detailContent.classList.remove('d-none');
                              updateCountdown(`detail-countdown-${note.id}`, note.due_time);
                        }

                        window.prepareAddNoteModal = () => {
                              form.reset();
                              modalTitle.textContent = 'Thêm Ghi Chú Mới';
                              editIdInput.value = '';
                              titleInput.innerHTML = '';
                              contentEditor.innerHTML = '';
                              enableAlarmCheck.checked = false;
                              alarmContainer.classList.add('d-none');
                              alarmTypeRelativeRadio.checked = true;
                              absolutePanel.classList.add('d-none');
                              relativePanel.classList.remove('d-none');
                        };

                        window.prepareEditNoteModal = (id) => {
                              const note = window.notesData.find(n => n.id === id);
                              if (!note) return;

                              prepareAddNoteModal();
                              modalTitle.textContent = 'Sửa Báo Thức & Ghi Chú';
                              editIdInput.value = id;
                              titleInput.innerHTML = note.title_html || '';
                              contentEditor.innerHTML = note.content_html || '';

                              if (note.due_time) {
                                    enableAlarmCheck.checked = true;
                                    alarmContainer.classList.remove('d-none');
                                    const date = new Date(note.due_time);
                                    date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                                    dueTimeInput.value = date.toISOString().slice(0, 16);
                                    alarmTypeAbsoluteRadio.checked = true;
                                    absolutePanel.classList.remove('d-none');
                                    relativePanel.classList.add('d-none');
                              }
                              notesModal.show();
                        };

                        window.deleteNote = (id) => {
                              window.confirmDeleteAction(async () => {
                                    try {
                                          const response = await fetch(`/notes/api/delete/${id}`, { method: 'POST' });
                                          if (!response.ok) {
                                                throw new Error('Server failed to delete the note.');
                                          }

                                          // Check if the deleted note was the one being viewed in the detail panel.
                                          if (id === activeNoteId) {
                                                // Reset the panel to its placeholder state instead of calling closeDetailPanel().
                                                // This keeps the user in the current list view.
                                                resetDetailPanel();
                                                activeNoteId = null; // Clear the active ID since the note is gone.
                                          }

                                          // Always refresh the note list to show the deletion.
                                          await fetchAndRenderNotes();
                                          showToast('Đã xóa ghi chú.', 'success');

                                    } catch (error) {
                                          console.error("Error deleting note:", error);
                                          showToast('Lỗi khi xóa ghi chú.', 'error');
                                    }
                              }, 'Bạn có chắc muốn xóa ghi chú này?');
                        };

                        form.addEventListener('submit', async (e) => {
                              e.preventDefault();
                              console.log('Save button clicked. Form submission initiated.');

                              const id = editIdInput.value;
                              const url = id ? `/notes/api/update/${id}` : '/notes/api/add';

                              let due_time = null;
                              if (enableAlarmCheck.checked) {
                                    if (alarmTypeAbsoluteRadio.checked) {
                                          if (dueTimeInput.value) {
                                                due_time = new Date(dueTimeInput.value).toISOString();
                                          }
                                    } else {
                                          const days = parseInt(document.getElementById('relative-days').value) || 0;
                                          const hours = parseInt(document.getElementById('relative-hours').value) || 0;
                                          const minutes = parseInt(document.getElementById('relative-minutes').value) || 0;
                                          const totalMinutes = (days * 1440) + (hours * 60) + minutes;
                                          if (totalMinutes > 0) {
                                                const now = new Date();
                                                now.setMinutes(now.getMinutes() + totalMinutes);
                                                due_time = now.toISOString();
                                          }
                                    }
                              }

                              const payload = {
                                    title_html: titleInput.innerHTML.trim(),
                                    content_html: contentEditor.innerHTML.trim(),
                                    due_time: due_time
                              };

                              if (!payload.title_html && !payload.content_html) {
                                    alert('Tiêu đề hoặc Nội dung không được để trống.');
                                    return;
                              }

                              console.log('Sending payload to server:', payload);

                              try {
                                    const response = await fetch(url, {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify(payload)
                                    });

                                    if (!response.ok) {
                                          const errorData = await response.json();
                                          throw new Error(errorData.error || 'Server responded with an error');
                                    }

                                    console.log('Server response OK. Hiding modal and refreshing notes.');
                                    const modalInstance = bootstrap.Modal.getInstance(modalEl);
                                    if (modalInstance) {
                                          modalInstance.hide();
                                    }
                                    await fetchAndRenderNotes();
                                    showToast('Đã lưu ghi chú thành công!', 'success');

                              } catch (error) {
                                    console.error('Failed to save note:', error);
                                    alert('Lỗi khi lưu ghi chú: ' + error.message);
                              }
                        });

                        enableAlarmCheck.addEventListener('change', function () {
                              alarmContainer.classList.toggle('d-none', !this.checked);
                        });

                        [alarmTypeAbsoluteRadio, alarmTypeRelativeRadio].forEach(radio => {
                              radio.addEventListener('change', () => {
                                    absolutePanel.classList.toggle('d-none', !alarmTypeAbsoluteRadio.checked);
                                    relativePanel.classList.toggle('d-none', alarmTypeAbsoluteRadio.checked);
                              });
                        });

                        [contentEditor, titleInput].forEach(editor => {
                              editor.addEventListener('contextmenu', e => {
                                    e.preventDefault(); e.stopPropagation();
                                    if (window.getSelection().toString().length > 0) {
                                          contextMenu.style.top = `${e.clientY}px`;
                                          contextMenu.style.left = `${e.clientX}px`;
                                          contextMenu.style.display = 'block';
                                    }
                              });
                        });

                        contextMenu.addEventListener('mousedown', e => e.preventDefault());
                        document.getElementById('context-copy').addEventListener('click', () => document.execCommand('copy'));
                        document.getElementById('context-bold').addEventListener('click', () => document.execCommand('bold'));

                        colorPalette.addEventListener('click', e => {
                              if (e.target.tagName === 'SPAN') {
                                    const newColor = e.target.style.backgroundColor;
                                    document.execCommand('styleWithCSS', false, true);
                                    document.execCommand('foreColor', false, newColor);
                                    document.execCommand('styleWithCSS', false, false);
                                    contextMenu.style.display = 'none';
                              }
                        });

                        // Profile context menu and modal event listeners
                        if (contextProfile) {
                              contextProfile.addEventListener('click', () => {
                                    const selection = window.getSelection();
                                    if (selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                                          savedSelection = selection.getRangeAt(0).cloneRange();

                                          // Prepare modal for new profile
                                          currentlyEditingProfileSpan = null;
                                          profileIdInput.value = '';
                                          profilePasswordInput.value = '';
                                          profileContentInput.value = '';
                                          deleteProfileBtn.classList.add('d-none'); // Hide delete button for new profiles

                                          contextMenu.style.display = 'none';
                                          profileModal.show();
                                    } else {
                                          alert('Vui lòng bôi đen đoạn chữ cần gán Profile.');
                                    }
                              });
                        }

                        saveProfileBtn.addEventListener('click', () => {
                              console.log('[PROFILE_SAVE_BTN] Clicked.');
                              const id = profileIdInput.value.trim();
                              const password = profilePasswordInput.value.trim();
                              const content = profileContentInput.value.trim();

                              if (currentlyEditingProfileSpan) { // Editing existing profile
                                    currentlyEditingProfileSpan.dataset.profileId = id;
                                    currentlyEditingProfileSpan.dataset.profilePassword = password;
                                    currentlyEditingProfileSpan.dataset.profileContent = content;
                              } else if (savedSelection) { // Creating new profile
                                    const newSpan = document.createElement('span');
                                    newSpan.className = 'has-profile';
                                    newSpan.dataset.profileId = id;
                                    newSpan.dataset.profilePassword = password;
                                    newSpan.dataset.profileContent = content;
                                    newSpan.appendChild(savedSelection.extractContents());
                                    savedSelection.insertNode(newSpan);
                              }

                              // SET THE FLAG HERE to block the imminent blur event
                              blockNextBlurSave = true;
                              console.log('[PROFILE_SAVE_BTN] Set blockNextBlurSave = true.');
                              
                              profileModal.hide();

                              setTimeout(() => {
                                    if (activeNoteId) {
                                          console.log('[PROFILE_SAVE_BTN] Calling saveNoteChanges from setTimeout.');
                                          // Call with the new 'forceSave = true' parameter
                                          saveNoteChanges(activeNoteId, true);
                                    }
                              }, 0);
                        });

                        deleteProfileBtn.addEventListener('click', () => {
                              if (currentlyEditingProfileSpan) {
                                    // Unwrap the span, replacing it with its own text content
                                    const parent = currentlyEditingProfileSpan.parentNode;
                                    while (currentlyEditingProfileSpan.firstChild) {
                                          parent.insertBefore(currentlyEditingProfileSpan.firstChild, currentlyEditingProfileSpan);
                                    }
                                    parent.removeChild(currentlyEditingProfileSpan);

                                    profileModal.hide();

                                    // Auto-save the note after modification
                                    const activeNoteId = document.querySelector('.note-card-active')?.closest('.note-card-wrapper')?.dataset.noteId;
                                    if (activeNoteId) {
                                          saveNoteChanges(activeNoteId);
                                    }
                              }
                        });

                        // Helper function for copy-to-clipboard feedback
                        const copyFeedback = (button) => {
                              const originalIcon = button.innerHTML;
                              button.innerHTML = '<i class="bi bi-check-lg text-success"></i>';
                              setTimeout(() => {
                                    button.innerHTML = originalIcon;
                              }, 1500);
                        };

                        // Event listener for copying the Profile ID
                        document.getElementById('notes-copy-profile-id-btn').addEventListener('click', function () {
                              const idToCopy = profileIdInput.value;
                              if (idToCopy) {
                                    navigator.clipboard.writeText(idToCopy).then(() => {
                                          copyFeedback(this);
                                    }).catch(err => {
                                          console.error('Failed to copy ID: ', err);
                                          alert('Lỗi khi sao chép ID.');
                                    });
                              }
                        });

                        // Event listener for copying the Profile Password
                        document.getElementById('notes-copy-profile-password-btn').addEventListener('click', function () {
                              const passwordToCopy = profilePasswordInput.value;
                              if (passwordToCopy) {
                                    navigator.clipboard.writeText(passwordToCopy).then(() => {
                                          copyFeedback(this);
                                    }).catch(err => {
                                          console.error('Failed to copy password: ', err);
                                          alert('Lỗi khi sao chép mật khẩu.');
                                    });
                              }
                        });

                        // --- Notification Polling ---
                        setInterval(async () => {
                              try {
                                    const response = await fetch('/notes/api/check-notifications');
                                    const notification = await response.json();
                                    if (notification) {
                                          notificationTitle.textContent = notification.title;
                                          notificationContent.innerHTML = notification.notes || 'Không có nội dung chi tiết.';
                                          notificationIdInput.value = notification.id;
                                          notificationSound.src = notification.sound_url;
                                          notificationSound.play().catch(e => console.log("User interaction needed to play sound."));
                                          notificationModal.show();
                                          if (document.getElementById('notes-tool-pane').classList.contains('active')) {
                                                fetchAndRenderNotes();
                                          }
                                    }
                              } catch (error) {
                                    console.error("Error polling for notifications:", error);
                              }
                        }, 10000); // Check every 10 seconds

                        // Thay thế listener cũ bằng listener này
                        titleInput.addEventListener('contextmenu', e => {
                              e.preventDefault();
                              e.stopPropagation();
                              const selection = window.getSelection();
                              // Chỉ hiển thị menu nếu có đoạn text được bôi đen
                              if (selection.toString().length > 0) {
                                    // Đây là logic đúng, giống hệt với của ô Nội dung
                                    contextMenu.style.top = `${e.clientY}px`;
                                    contextMenu.style.left = `${e.clientX}px`;
                                    contextMenu.style.display = 'block';
                              }
                        });

                        // --- Search Functionality ---
                        if (searchInput) {
                              searchInput.addEventListener('input', (e) => {
                                    const searchTerm = e.target.value.toLowerCase().trim();
                                    const notesToShow = searchTerm
                                          ? window.notesData.filter(note => {
                                                const titleLower = (note.title_html || '').toLowerCase();
                                                const contentLower = (note.content_html || '').toLowerCase();
                                                const searchLower = searchTerm.toLowerCase();

                                                // Check 1: Search in visible title
                                                if (titleLower.includes(searchLower)) return true;

                                                // Check 2: Search in visible content (plain text)
                                                const tempDiv = document.createElement('div');
                                                tempDiv.innerHTML = note.content_html || '';
                                                if (tempDiv.textContent.toLowerCase().includes(searchLower)) return true;

                                                // Check 3: Search for the profile ID attribute directly in the HTML string
                                                // This is crucial for finding IDs that are not part of the visible text.
                                                const profileIdSearchString = `data-profile-id="${searchLower}"`.toLowerCase();
                                                if (contentLower.includes(profileIdSearchString)) return true;

                                                return false;
                                          })
                                          : window.notesData;

                                    window.filteredNotes = notesToShow;
                                    renderNotes(notesToShow, searchTerm);
                              });
                        }

                        async function initializeNotesView() {
                              // Requirement 1: Set default to list view
                              const container = document.getElementById('notes-container');
                              container.classList.add('notes-list-view');
                              container.classList.remove('notes-grid-view');

                              // Close detail panel if it's open, ensuring a clean list view
                              if (document.getElementById('notes-detail-wrapper').classList.contains('visible')) {
                                    window.closeDetailPanel();
                              }

                              // Await fetching and rendering to ensure data and elements are ready
                              await fetchAndRenderNotes();

                              // Apply card size settings
                              applySavedCardSize();

                              // Animate the cards after they have been rendered
                              setTimeout(() => {
                                    const cards = container.querySelectorAll('.card');
                                    cards.forEach(card => {
                                          card.classList.add('note-card-enter-active');
                                          setTimeout(() => card.classList.remove('note-card-enter-active'), 400);
                                    });
                              }, 50);

                              // NEW LOGIC: Automatically select and show the first note
                              if (window.filteredNotes && window.filteredNotes.length > 0) {
                                    const firstNote = window.filteredNotes[0];

                                    // Open the detail panel layout
                                    openDetailPanel();

                                    // Populate the panel with the first note's details
                                    showNoteDetail(firstNote);
                              }
                        }

                        // Requirement 3: Handle tab switching AND initial load
                        // The event listener callback is now async to handle the await inside initializeNotesView
                        notesTab.addEventListener('shown.bs.tab', async () => await initializeNotesView());

                        // Always fetch notes on initial page load, regardless of which tab is active.
                        initializeNotesView();

                  })();

                  (function () {
                        let formToDelete = null;
                        let callbackToDelete = null;
                        document.addEventListener('submit', function (e) {
                              const form = e.target;
                              if (form.classList.contains('needs-confirm-delete')) {
                                    e.preventDefault();
                                    formToDelete = form;
                                    callbackToDelete = null;
                                    const msg = form.getAttribute('data-confirm-message') || 'Bạn có chắc muốn xóa?';
                                    document.getElementById('globalDeleteConfirmText').textContent = msg;
                                    new bootstrap.Modal(document.getElementById('globalDeleteConfirmModal')).show();
                              }
                        });

                        // ADD Enter key functionality to global delete confirmation modal
                        document.getElementById('globalDeleteConfirmModal').addEventListener('keyup', function (e) {
                              if (e.key === 'Enter' && this.classList.contains('show')) {
                                    document.getElementById('globalDeleteConfirmBtn').click();
                              }
                        });

                        window.confirmDeleteAction = function (callback, message) {
                              formToDelete = null;
                              callbackToDelete = callback;
                              document.getElementById('globalDeleteConfirmText').textContent = message || 'Bạn có chắc muốn xóa?';
                              new bootstrap.Modal(document.getElementById('globalDeleteConfirmModal')).show();
                        };
                        document.getElementById('globalDeleteConfirmBtn').onclick = function () {
                              if (formToDelete) formToDelete.submit();
                              if (callbackToDelete) callbackToDelete();
                              bootstrap.Modal.getInstance(document.getElementById('globalDeleteConfirmModal')).hide();
                        };
                  })();

                  function toggleDashboardSettingsModal() {
                        const modalElement = document.getElementById('utilitiesModal');
                        if (modalElement) {
                              const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
                              modal.toggle();
                        }
                  }

                  // --- UTILITIES SCRIPT ---
                  (() => {
                        const utilitiesModalEl = document.getElementById('utilitiesModal');
                        if (!utilitiesModalEl) return;

                        let shutdownCountdownInterval = null;

                        const autoStartSwitch = document.getElementById('autoStartSwitch');

                        const applyBtn = document.getElementById('apply-shutdown-btn');
                        const hoursInput = document.getElementById('shutdown-hours');
                        const minutesInput = document.getElementById('shutdown-minutes');
                        const shutdownToggle = document.getElementById('shutdown-toggle-switch');
                        const inputsContainer = document.getElementById('shutdown-inputs-container');

                        // This function correctly toggles the disabled state of the inputs.
                        const setInputsState = (enabled) => {
                              hoursInput.disabled = !enabled;
                              minutesInput.disabled = !enabled;
                              inputsContainer.style.opacity = enabled ? '1' : '0.5';
                              // No need to toggle pointer-events on the container if the inputs themselves are disabled.
                        };

                        // Add the change listener to the toggle switch
                        shutdownToggle.addEventListener('change', function () {
                              setInputsState(this.checked);
                        });

                        // Set the initial state every time the modal is about to be shown.
                        utilitiesModalEl.addEventListener('show.bs.modal', async () => {
                              // Stop any previous countdown when the modal is opened
                              if (shutdownCountdownInterval) clearInterval(shutdownCountdownInterval);

                              // --- Restore Auto-Start switch state (existing logic) ---
                              try {
                                    const response = await fetch('/dashboard/api/settings');
                                    const settings = await response.json();
                                    autoStartSwitch.checked = settings.auto_start;
                              } catch (error) {
                                    console.error("Lỗi khi tải cài đặt dashboard:", error);
                              }

                              // --- NEW: Restore Shutdown Timer state ---
                              const savedDeadline = localStorage.getItem('shutdownDeadline');
                              if (savedDeadline && parseInt(savedDeadline) > Date.now()) {
                                    shutdownToggle.checked = true;
                                    setInputsState(true);

                                    const updateCountdownDisplay = () => {
                                          const now = Date.now();
                                          const remainingSeconds = Math.round((parseInt(savedDeadline) - now) / 1000);

                                          if (remainingSeconds <= 0) {
                                                // Timer expired, clear interval and reset UI
                                                clearInterval(shutdownCountdownInterval);
                                                localStorage.removeItem('shutdownDeadline');
                                                shutdownToggle.checked = false;
                                                setInputsState(false);
                                                hoursInput.value = '';
                                                minutesInput.value = '';
                                          } else {
                                                // Update input fields with remaining time
                                                hoursInput.value = Math.floor(remainingSeconds / 3600);
                                                minutesInput.value = Math.floor((remainingSeconds % 3600) / 60);
                                          }
                                    };

                                    updateCountdownDisplay(); // Run once immediately
                                    shutdownCountdownInterval = setInterval(updateCountdownDisplay, 1000); // Update every second

                              } else {
                                    // No active timer, reset to default state
                                    localStorage.removeItem('shutdownDeadline'); // Clean up expired timer
                                    shutdownToggle.checked = false;
                                    setInputsState(false);
                                    hoursInput.value = '';
                                    minutesInput.value = '';
                              }
                        });

                        utilitiesModalEl.addEventListener('hide.bs.modal', () => {
                              // Clear the interval when the modal is hidden to save resources
                              if (shutdownCountdownInterval) {
                                    clearInterval(shutdownCountdownInterval);
                                    shutdownCountdownInterval = null;
                              }
                        });

                        // When the auto-start switch is toggled, save the new state to the backend
                        if (autoStartSwitch) {
                              autoStartSwitch.addEventListener('change', async () => {
                                    try {
                                          const response = await fetch('/dashboard/api/settings', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ auto_start: autoStartSwitch.checked })
                                          });
                                          if (response.ok) {
                                                showToast("Đã lưu cài đặt tự khởi động.", "success");
                                          } else {
                                                throw new Error("Lỗi server.");
                                          }
                                    } catch (error) {
                                          console.error("Lỗi khi lưu cài đặt:", error);
                                          showToast("Không thể lưu cài đặt. Vui lòng thử lại.", "error");
                                          // Revert the switch state on failure
                                          autoStartSwitch.checked = !autoStartSwitch.checked;
                                    }
                              });
                        }

                        // The click handler for the "Apply" button.
                        applyBtn.addEventListener('click', async () => {
                              const isScheduling = shutdownToggle.checked;
                              const modalInstance = bootstrap.Modal.getInstance(utilitiesModalEl);

                              if (isScheduling) {
                                    // Logic to SCHEDULE shutdown
                                    const hours = parseInt(hoursInput.value) || 0;
                                    const minutes = parseInt(minutesInput.value) || 0;
                                    const totalSeconds = (hours * 3600) + (minutes * 60);

                                    if (totalSeconds <= 0) {
                                          showToast('Vui lòng nhập một khoảng thời gian hợp lệ.', 'error');
                                          return; // Stop execution
                                    }

                                    try {
                                          const response = await fetch('/utilities/shutdown', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({ seconds: totalSeconds })
                                          });
                                          const result = await response.json();
                                          if (!response.ok) throw new Error(result.error || 'Lỗi không xác định');
                                          showToast(result.message, 'success');
                                          modalInstance.hide();
                                          const deadline = Date.now() + (totalSeconds * 1000);
                                          localStorage.setItem('shutdownDeadline', deadline);
                                    } catch (error) {
                                          showToast(`Lỗi: ${error.message}`, 'error');
                                    }

                              } else {
                                    // Logic to CANCEL shutdown
                                    try {
                                          const response = await fetch('/utilities/cancel-shutdown', { method: 'POST' });
                                          const result = await response.json();
                                          if (!response.ok) throw new Error(result.error || 'Lỗi không xác định');
                                          showToast(result.message, 'success');
                                          modalInstance.hide();
                                          localStorage.removeItem('shutdownDeadline');
                                    } catch (error) {
                                          showToast(`Lỗi: ${error.message}`, 'error');
                                    }
                              }
                        });
                  })();

                  // --- Auto Seeding Logic (Simple) ---
                  const autoSeedingTabBtn = document.getElementById('tg-v-pills-automatic-tab');
                  if (autoSeedingTabBtn) {
                        const enabledSwitch = document.getElementById('auto-seeding-enabled');
                        // New time inputs
                        const hourInput = document.getElementById('auto-seeding-hour');
                        const minuteInput = document.getElementById('auto-seeding-minute');
                        const ampmSelect = document.getElementById('auto-seeding-ampm');
                        // ---
                        const dailySwitch = document.getElementById('auto-seeding-daily');
                        const groupSelect = document.getElementById('auto-seeding-group-select');
                        const saveBtn = document.getElementById('save-auto-seeding-btn');
                        const statusText = document.getElementById('auto-seeding-status');

                        function populateAutoSeedingForm(settings) {
                              // Target all UI elements
                              const enabledSwitch = document.getElementById('auto-seeding-enabled');
                              const dailySwitch = document.getElementById('auto-seeding-daily');
                              const groupSelect = document.getElementById('auto-seeding-group-select');
                              const hourInput = document.getElementById('auto-seeding-hour');
                              const minuteInput = document.getElementById('auto-seeding-minute');
                              const ampmSelect = document.getElementById('auto-seeding-ampm');
                              const endHourInput = document.getElementById('auto-seeding-end-hour');
                              const endMinuteInput = document.getElementById('auto-seeding-end-minute');
                              const endAmpmSelect = document.getElementById('auto-seeding-end-ampm');

                              enabledSwitch.checked = settings.is_enabled || false;
                              dailySwitch.checked = settings.run_daily || false;

                              // Helper function to parse 24h time and set UI
                              const setTimeControls = (timeString, hInput, mInput, ampmSel) => {
                                    if (timeString && timeString.includes(':')) {
                                          const [h24, m] = timeString.split(':').map(Number);
                                          const isPM = h24 >= 12;
                                          let h12 = h24 % 12;
                                          if (h12 === 0) h12 = 12; // Convert 0 or 12 to 12 for 12-hour format
                                          hInput.value = h12;
                                          mInput.value = m.toString().padStart(2, '0');
                                          ampmSel.value = isPM ? 'PM' : 'AM';
                                    } else {
                                          hInput.value = '';
                                          mInput.value = '';
                                          ampmSel.value = 'AM'; // Default to AM
                                    }
                              };

                              // Set start time
                              setTimeControls(settings.run_time, hourInput, minuteInput, ampmSelect);
                              // Set end time
                              setTimeControls(settings.end_run_time, endHourInput, endMinuteInput, endAmpmSelect);

                              // Set selected group
                              if (settings.target_session_group_id) {
                                    // Ensure the option exists before setting it
                                    if (groupSelect.querySelector(`option[value="${settings.target_session_group_id}"]`)) {
                                          groupSelect.value = settings.target_session_group_id;
                                    }
                              } else {
                                    groupSelect.value = ""; // Reset if no group is saved
                              }

                              // Populate Core, Delay, and Admin settings
                              document.getElementById('tg-core-input').value = settings.core || 5;
                              document.getElementById('tg-delay-session-input').value = settings.delay_per_session || 10;
                              document.getElementById('tg-delay-batch-input').value = settings.delay_between_batches || 600;
                              const adminSwitch = document.getElementById('tg-admin-reply-switch');
                              const adminDelayInput = document.getElementById('tg-admin-delay-input');
                              adminSwitch.checked = settings.admin_enabled || false;
                              adminDelayInput.value = settings.admin_delay || 10;
                              adminDelayInput.disabled = !adminSwitch.checked;

                              // Finally, update the status badge
                              updateAutoSeedingStatusText();
                        }

                        async function loadAutoSeedingSettings() {
                              try {
                                    await populateAutoSeedingGroupSelect(); // Ensure groups are loaded first
                                    const response = await fetch('/automatic/api/seeding/settings');
                                    if (!response.ok) throw new Error('Failed to load settings');
                                    const settings = await response.json();
                                    populateAutoSeedingForm(settings); // Use the helper to populate the form
                              } catch (error) {
                                    showToast(`Lỗi tải cài đặt: ${error.message}`, 'error');
                              }
                        }

                        // FIX: This function now fetches groups directly to avoid timing issues.
                        async function populateAutoSeedingGroupSelect() {
                              try {
                                    const response = await fetch('/telegram/api/groups');
                                    if (!response.ok) throw new Error('Failed to fetch groups');
                                    const groups = await response.json();

                                    groupSelect.innerHTML = '<option value="">-- Chọn nhóm để chạy --</option>';
                                    const nonAdminGroups = groups.filter(g => g.name !== 'Adminsession');

                                    nonAdminGroups.forEach(g => {
                                          groupSelect.add(new Option(g.name, g.id));
                                    });
                                    // Auto-select if only one group exists
                                    if (nonAdminGroups.length === 1) {
                                          groupSelect.value = nonAdminGroups[0].id;
                                    }

                              } catch (error) {
                                    groupSelect.innerHTML = '<option value="">-- Lỗi tải nhóm --</option>';
                                    console.error("Error populating group select:", error);
                              }
                        }

                        function updateAutoSeedingStatusText() {
                              const statusContainer = document.getElementById('auto-seeding-status-badge-container');
                              if (!statusContainer) return;

                              const settings = {
                                    is_enabled: enabledSwitch.checked,
                                    h: hourInput.value,
                                    m: minuteInput.value,
                                    group_id: groupSelect.value,
                              };

                              let text = 'Đã tắt';
                              let badgeClass = 'bg-secondary';

                              if (settings.is_enabled) {
                                    if (!settings.h || !settings.m || !settings.group_id) {
                                          text = 'Chờ cấu hình';
                                          badgeClass = 'bg-warning text-dark';
                                    } else {
                                          text = 'Đã bật & sẵn sàng';
                                          badgeClass = 'bg-success';
                                    }
                              }

                              statusContainer.innerHTML = `<span class="badge ${badgeClass}">${text}</span>`;
                        }

                        async function saveAutoSeedingSettings() {
                              // Helper function to get time from UI and convert to 24h format
                              const getTimeFromUI = (hInput, mInput, ampmSel) => {
                                    const h12 = parseInt(hInput.value, 10);
                                    const m = parseInt(mInput.value, 10);
                                    const ampm = ampmSel.value;
                                    if (isNaN(h12) || h12 < 1 || h12 > 12 || isNaN(m) || m < 0 || m > 59) return null;
                                    let h24 = h12;
                                    if (ampm === 'PM' && h12 < 12) h24 += 12;
                                    if (ampm === 'AM' && h12 === 12) h24 = 0;
                                    return `${h24.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                              };

                              const run_time_24h = getTimeFromUI(document.getElementById('auto-seeding-hour'), document.getElementById('auto-seeding-minute'), document.getElementById('auto-seeding-ampm'));
                              const end_run_time_24h = getTimeFromUI(document.getElementById('auto-seeding-end-hour'), document.getElementById('auto-seeding-end-minute'), document.getElementById('auto-seeding-end-ampm'));
                              const groupIdValue = document.getElementById('auto-seeding-group-select').value;
                              const parsedGroupId = parseInt(groupIdValue, 10);
                              const targetGroupId = (groupIdValue && !isNaN(parsedGroupId)) ? parsedGroupId : null;

                              if (!run_time_24h) return showToast('Thời gian bắt đầu không hợp lệ.', 'error');
                              if (!end_run_time_24h) return showToast('Thời gian kết thúc không hợp lệ.', 'error');
                              if (targetGroupId === null) return showToast('Vui lòng chọn nhóm session.', 'error');

                              const payload = {
                                    // Existing settings
                                    is_enabled: document.getElementById('auto-seeding-enabled').checked,
                                    run_time: run_time_24h,
                                    end_run_time: end_run_time_24h,
                                    run_daily: document.getElementById('auto-seeding-daily').checked,
                                    target_session_group_id: targetGroupId,
                                    task_name: 'seedingGroup',
                                    // New settings to be saved
                                    core: parseInt(document.getElementById('tg-core-input').value, 10),
                                    delay_per_session: parseInt(document.getElementById('tg-delay-session-input').value, 10),
                                    delay_between_batches: parseInt(document.getElementById('tg-delay-batch-input').value, 10),
                                    admin_enabled: document.getElementById('tg-admin-reply-switch').checked,
                                    admin_delay: parseInt(document.getElementById('tg-admin-delay-input').value, 10)
                              };

                              try {
                                    const response = await fetch('/automatic/api/seeding/settings', {
                                          method: 'POST',
                                          headers: { 'Content-Type': 'application/json' },
                                          body: JSON.stringify(payload)
                                    });
                                    const savedSettings = await response.json(); // The response now contains the full settings object
                                    if (!response.ok) throw new Error(savedSettings.error || 'Server error');

                                    showToast('Đã lưu cài đặt thành công!', 'success');

                                    // Use the returned data directly to populate the form, instead of making another GET request.
                                    populateAutoSeedingForm(savedSettings);

                              } catch (error) {
                                    showToast(`Lỗi lưu cài đặt: ${error.message}`, 'error');
                                    console.error("Save settings error details:", error);
                              }
                        }

                        // When the "Automatic" tab is shown, load its settings.
                        autoSeedingTabBtn.addEventListener('shown.bs.tab', loadAutoSeedingSettings);

                        // Save button listener
                        saveBtn.addEventListener('click', saveAutoSeedingSettings);

                        // Add listeners to update status text immediately on UI change
                        [enabledSwitch, hourInput, minuteInput, ampmSelect, document.getElementById('auto-seeding-end-hour'), document.getElementById('auto-seeding-end-minute'), document.getElementById('auto-seeding-end-ampm'), dailySwitch, groupSelect].forEach(el => {
                              el.addEventListener('change', updateAutoSeedingStatusText);
                        });
                  }
                  // --- End of Auto Seeding Logic ---

                  // --- Clean up legacy Buff View icons ---
                  document.addEventListener('DOMContentLoaded', function () {
                        const seedingModal = document.getElementById('tg-seedingGroupModal');
                        if (seedingModal) {
                              // Define the allowed reaction icons (same as template)
                              const allowedIcons = ['❤️', '👍', '👏', '🔥', '🎉'];

                              // Function to clean up reaction checkboxes
                              function cleanupReactionIcons() {
                                    const reactionCheckboxes = seedingModal.querySelectorAll('.tg-reaction-checkbox');
                                    reactionCheckboxes.forEach(checkbox => {
                                          const iconValue = checkbox.value;
                                          // If this icon is not in our allowed list, remove its container
                                          if (!allowedIcons.includes(iconValue)) {
                                                const label = checkbox.closest('label');
                                                if (label) {
                                                      label.remove();
                                                }
                                          }
                                    });
                              }

                              // Clean up on modal show
                              seedingModal.addEventListener('shown.bs.modal', cleanupReactionIcons);

                              // Also clean up immediately if modal is already visible
                              if (seedingModal.classList.contains('show')) {
                                    cleanupReactionIcons();
                              }
                        }
                  });
                  // --- End of Buff View cleanup ---

                  // --- HEALTHY/KCAL SCRIPT ---
                  (() => {
                        const healthyPane = document.getElementById('healthy-tool-pane');
                        if (!healthyPane) return;

                        // Modal elements
                        const addFoodModalEl = document.getElementById('kcal-add-food-modal');
                        const saveFoodBtn = document.getElementById('kcal-save-food-btn');

                        // Main container and lists
                        const kcalContainer = document.getElementById('kcal-container');
                        const carbList = document.getElementById('kcal-list-carbs');
                        const proteinList = document.getElementById('kcal-list-protein');
                        const veggiesList = document.getElementById('kcal-list-veggies');
                        const resetBtn = document.getElementById('kcal-reset-btn');

                        // Header total display elements
                        const totalCalEl = document.getElementById('kcal-total-cal');
                        const totalPEl = document.getElementById('kcal-total-p');
                        const totalFEl = document.getElementById('kcal-total-f');
                        const totalCEl = document.getElementById('kcal-total-c');

                        // --- Core Logic Functions ---

                        /**
                         * Updates the main header with the grand total of all nutrients from all food items.
                         */
                        function updateHeaderTotals() {
                              let total = { p: 0, f: 0, c: 0, kcal: 0 };
                              
                              // Select all food items from all lists
                              const allFoodItems = kcalContainer.querySelectorAll('.list-group-item');

                              allFoodItems.forEach(item => {
                                    const weight = parseFloat(item.querySelector('.kcal-weight-input').value) || 0;
                                    const base = {
                                          p: parseFloat(item.dataset.baseP) || 0,
                                          f: parseFloat(item.dataset.baseF) || 0,
                                          c: parseFloat(item.dataset.baseC) || 0,
                                          kcal: parseFloat(item.dataset.baseKcal) || 0,
                                    };

                                    // Calculate nutrients based on current weight (assuming base is per 100g)
                                    const multiplier = weight / 100;
                                    total.p += base.p * multiplier;
                                    total.f += base.f * multiplier;
                                    total.c += base.c * multiplier;
                                    total.kcal += base.kcal * multiplier;
                              });

                              // Update the DOM
                              totalCalEl.textContent = Math.round(total.kcal);
                              totalPEl.textContent = total.p.toFixed(1);
                              totalFEl.textContent = total.f.toFixed(1);
                              totalCEl.textContent = total.c.toFixed(1);
                        }
                        
                        /**
                         * Updates the displayed nutrient values for a single food item when its weight changes.
                         * @param {HTMLInputElement} weightInput The weight input element that triggered the change.
                         */
                        function updateItemDisplay(weightInput) {
                              const item = weightInput.closest('.list-group-item');
                              if (!item) return;

                              const weight = parseFloat(weightInput.value) || 0;
                              const multiplier = weight / 100;

                              const base = {
                                    p: parseFloat(item.dataset.baseP) || 0,
                                    f: parseFloat(item.dataset.baseF) || 0,
                                    c: parseFloat(item.dataset.baseC) || 0,
                                    kcal: parseFloat(item.dataset.baseKcal) || 0,
                              };

                              // Update the badges for this specific item
                              item.querySelector('.kcal-val-p').textContent = `P: ${(base.p * multiplier).toFixed(1)}`;
                              item.querySelector('.kcal-val-f').textContent = `F: ${(base.f * multiplier).toFixed(1)}`;
                              item.querySelector('.kcal-val-c').textContent = `C: ${(base.c * multiplier).toFixed(1)}`;
                              item.querySelector('.kcal-val-kcal').textContent = `${Math.round(base.kcal * multiplier)} Kcal`;
                        }


                        // --- Event Listeners ---

                        // Prepare modal with category and clear old values
                        addFoodModalEl.addEventListener('show.bs.modal', function (event) {
                              const button = event.relatedTarget;
                              const category = button.dataset.category;
                              
                              addFoodModalEl.querySelector('#kcal-food-category').value = category;
                              addFoodModalEl.querySelector('#kcal-food-name').value = '';
                              addFoodModalEl.querySelector('#kcal-food-calories').value = '';
                              addFoodModalEl.querySelector('#kcal-food-protein').value = '0';
                              addFoodModalEl.querySelector('#kcal-food-fat').value = '0';
                              addFoodModalEl.querySelector('#kcal-food-carbs').value = '0';
                              
                              setTimeout(() => addFoodModalEl.querySelector('#kcal-food-name').focus(), 500);
                        });

                        // Handle saving the new food item from the modal
                        saveFoodBtn.addEventListener('click', function() {
                              const category = addFoodModalEl.querySelector('#kcal-food-category').value;
                              const name = addFoodModalEl.querySelector('#kcal-food-name').value.trim();
                              const calories = addFoodModalEl.querySelector('#kcal-food-calories').value;
                              const protein = addFoodModalEl.querySelector('#kcal-food-protein').value;
                              const fat = addFoodModalEl.querySelector('#kcal-food-fat').value;
                              const carbs = addFoodModalEl.querySelector('#kcal-food-carbs').value;
                              
                              if (!name || !calories) {
                                    alert('Vui lòng nhập Tên Thực Phẩm và Số Kcal.');
                                    return;
                              }

                              const targetList = document.getElementById(`kcal-list-${category}`);
                              if (targetList) {
                                    const li = document.createElement('li');
                                    li.className = 'list-group-item';
                                    // Store base values (per 100g) in data attributes
                                    li.dataset.baseKcal = calories;
                                    li.dataset.baseP = protein;
                                    li.dataset.baseF = fat;
                                    li.dataset.baseC = carbs;

                                    li.innerHTML = `
                                          <div class="d-flex justify-content-between align-items-center">
                                                <div class="me-2 text-truncate" style="flex-basis: 40%;">
                                                      <strong class="food-name">${name}</strong>
                                                </div>
                                                <div class="d-flex align-items-center gap-2 text-nowrap">
                                                      <span class="badge rounded-pill text-bg-danger kcal-val-p">P: ${protein}</span>
                                                      <span class="badge rounded-pill text-bg-info kcal-val-f">F: ${fat}</span>
                                                      <span class="badge rounded-pill text-bg-success kcal-val-c">C: ${carbs}</span>
                                                      <span class="badge rounded-pill text-bg-primary kcal-val-kcal">${calories} Kcal</span>
                                                </div>
                                                <div class="d-flex align-items-center ms-2" style="flex-basis: 20%;">
                                                      <input type="number" class="form-control form-control-sm kcal-weight-input" value="100" min="0" style="width: 70px;">
                                                      <span class="ms-1 small">g</span>
                                                      <button class="btn btn-sm btn-outline-danger p-0 px-1 ms-2" title="Xóa">
                                                            <i class="bi bi-x-lg"></i>
                                                      </button>
                                                </div>
                                          </div>
                                    `;
                                    targetList.appendChild(li);
                              }

                              bootstrap.Modal.getInstance(addFoodModalEl).hide();
                              updateHeaderTotals(); // Update grand total after adding
                        });
                        
                        // Use event delegation for delete buttons and weight inputs
                        kcalContainer.addEventListener('click', function(e) {
                              const deleteBtn = e.target.closest('.btn-outline-danger');
                              if (deleteBtn) {
                                    deleteBtn.closest('.list-group-item').remove();
                                    updateHeaderTotals(); // Update grand total after deleting
                              }
                        });

                        kcalContainer.addEventListener('input', function(e) {
                              const weightInput = e.target.closest('.kcal-weight-input');
                              if (weightInput) {
                                    updateItemDisplay(weightInput); // Update the item's own display
                                    updateHeaderTotals(); // Update the grand total
                              }
                        });

                        // Reset button functionality
                        resetBtn.addEventListener('click', function() {
                              // New confirmation message reflecting the updated action.
                              if (confirm('Bạn có chắc muốn reset tất cả trọng lượng (gram) về mặc định (100g) không?')) {
                                    
                                    // Select all weight input fields within the Kcal container.
                                    const allWeightInputs = kcalContainer.querySelectorAll('.kcal-weight-input');

                                    // Loop through each input field.
                                    allWeightInputs.forEach(input => {
                                          // Set its value back to the default of 100.
                                          input.value = 100;
                                          
                                          // Trigger an update for the individual item's display to reflect the new weight.
                                          updateItemDisplay(input); 
                                    });

                                    // After resetting all items, recalculate and update the main header totals.
                                    updateHeaderTotals();
                              }
                        });

                  })();

            });
      </script>

      <!-- Stagewise Toolbar Integration -->
      <script type="module" src="{{ url_for('static', filename='js/stagewise-init.js') }}"></script>

</body>

</html>