<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-0" style="margin-top: -1%;">
        {# --- Main Navigation Tabs --- #}
        <ul class="nav nav-tabs main-nav mb-0" id="main-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path == url_for('home') %}active{% endif %}" id="home-tab-link" data-tab-id="home" href="{{ url_for('home') }}">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #0da5aa 100%);"><i class="bi bi-house-door-fill"></i></span>
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path == url_for('notes') %}active{% endif %}" id="notes-tab-link" data-tab-id="notes" href="{{ url_for('notes') }}">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #07c160 0%, #00a854 100%);"><i class="bi bi-journal-richtext"></i></span> Ghi Chú
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path == url_for('mxh.mxh_page') %}active{% endif %}" id="mxh-tab-link" data-tab-id="mxh" href="{{ url_for('mxh.mxh_page') }}">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="bi bi-share-fill"></i></span> MXH
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path.startswith('/image') %}active{% endif %}" id="image-tab-link" data-tab-id="image"
                   href="{{ url_for('image.index') }}"
                   onclick="return handleImageNavClick(event);">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="bi bi-image-fill"></i></span> Image
                </a>
            </li>
        </ul>

        {# --- Global Hamburger Menu (Content changes dynamically) --- #}
        <ul class="navbar-nav ms-auto">
             <li class="nav-item dropdown hamburger-menu" id="global-hamburger-menu">
                <a class="nav-link p-1" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-list" style="font-size: 1.5rem;"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" id="hamburger-dropdown-content">
                    {# Content will be populated by JavaScript #}
                    <li><span class="dropdown-item text-muted">Đang tải...</span></li>
                </ul>
            </li>
        </ul>
    </div>
</div>

<style>
/* Hamburger menu position fix - Aligned to the right */
.hamburger-menu {
    position: relative;
}

.hamburger-menu .dropdown-menu {
    position: absolute !important;
    top: 100%;
    right: 0;
    left: auto;
    margin-top: 0.125rem;
    display: none;
    min-width: 200px;
    z-index: 1050;
}

/* Smooth dropdown animation */
@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.hamburger-menu .dropdown-menu.show {
    display: block;
    animation: fadeInDown 0.2s ease-out;
}

/* Dropdown item hover effect */
.hamburger-menu .dropdown-item {
    transition: all 0.15s ease;
}

.hamburger-menu .dropdown-item:hover,
.hamburger-menu .dropdown-item:focus {
    background-color: rgba(var(--bs-primary-rgb), 0.15);
    color: var(--bs-primary);
    transform: translateX(3px);
}

/* Ensure icon alignment */
.hamburger-menu .nav-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem !important;
    line-height: 1;
}

.hamburger-menu .nav-link i {
    vertical-align: middle;
}

/* Ensure main nav items don't overlap */
.main-nav {
    flex-grow: 1; /* Allow tabs to take available space */
    margin-right: 1rem; /* Add some space before the hamburger */
}
</style>

<script>
// Logic for the single, dynamic hamburger menu
(function() {
    const hamburgerMenu = document.getElementById('global-hamburger-menu');
    if (!hamburgerMenu) return;

    const menuLink = hamburgerMenu.querySelector('.nav-link');
    const dropdownMenu = hamburgerMenu.querySelector('.dropdown-menu');
    const dropdownContentUl = document.getElementById('hamburger-dropdown-content');
    let bsDropdownInstance = null; // Store Bootstrap instance

    let autoHideTimeout;
    let mouseLeaveTimeout;
    let isMouseOverMenu = false;
    let isMouseOverDropdown = false;

    // --- Dynamic Content Generation ---
    const getMenuItemsForTab = (tabId) => {
        let items = `
            <li>
                <a class="dropdown-item" href="{{ url_for('settings.settings_page') }}">
                    <i class="bi bi-gear-wide-connected me-2"></i>Cài Đặt Chung
                </a>
            </li>
            <li><hr class="dropdown-divider"></li>
        `;

        // Add tab-specific items
        switch (tabId) {
            case 'notes':
                items += `<li><a class="dropdown-item" href="#"><i class="bi bi-journal-gear me-2"></i>Cài đặt Ghi chú</a></li>`; // Placeholder
                break;
            case 'mxh':
                items += `<li><a class="dropdown-item" href="#"><i class="bi bi-share-gear me-2"></i>Cài đặt MXH</a></li>`; // Placeholder
                break;
            case 'image':
                 items += `<li><a class="dropdown-item" href="#"><i class="bi bi-image-gear me-2"></i>Cài đặt Image</a></li>`; // Placeholder
                break;
             case 'home':
                 // No specific settings for home yet, maybe add later
                 // items += `<li><a class="dropdown-item" href="#"><i class="bi bi-house-gear me-2"></i>Cài đặt Trang chủ</a></li>`;
                 break;
            default:
                 // Default case if no tab is active or unknown
                 break;
        }

        // Removed reload option from all tabs


        return items;
    };

    const updateDropdownContent = () => {
        const activeTabLink = document.querySelector('#main-tab .nav-link.active');
        const activeTabId = activeTabLink ? activeTabLink.dataset.tabId : 'home'; // Default to home if none active
        dropdownContentUl.innerHTML = getMenuItemsForTab(activeTabId);
    };

    // --- Bootstrap Dropdown Interaction ---
    const ensureBsInstance = () => {
        if (!bsDropdownInstance) {
            bsDropdownInstance = new bootstrap.Dropdown(menuLink);
        }
        return bsDropdownInstance;
    }

    const showDropdown = () => {
        const instance = ensureBsInstance();
        // Update content *before* showing
        updateDropdownContent();
        if (!dropdownMenu.classList.contains('show')) {
            instance.show();
        }
    };

    const hideDropdown = () => {
        const instance = ensureBsInstance();
        if (dropdownMenu.classList.contains('show')) {
            instance.hide();
        }
    };

    // --- Hover Logic ---
    hamburgerMenu.addEventListener('mouseenter', () => {
        clearTimeout(autoHideTimeout);
        clearTimeout(mouseLeaveTimeout);
        isMouseOverMenu = true;
        showDropdown();

        autoHideTimeout = setTimeout(() => {
            if (!isMouseOverDropdown) {
                hideDropdown();
            }
        }, 2000);
    });

    hamburgerMenu.addEventListener('mouseleave', () => {
        isMouseOverMenu = false;
        mouseLeaveTimeout = setTimeout(() => {
            if (!isMouseOverDropdown) {
                clearTimeout(autoHideTimeout);
                hideDropdown();
            }
        }, 300);
    });

    dropdownMenu.addEventListener('mouseenter', () => {
        clearTimeout(autoHideTimeout);
        clearTimeout(mouseLeaveTimeout);
        isMouseOverDropdown = true;
        // Ensure it stays shown
        if (!dropdownMenu.classList.contains('show')) {
           showDropdown();
        }
    });

    dropdownMenu.addEventListener('mouseleave', () => {
        isMouseOverDropdown = false;
        setTimeout(() => {
            if (!isMouseOverMenu && !isMouseOverDropdown) {
                 hideDropdown();
            }
        }, 100);
    });

    // Close dropdown when an item is clicked
    dropdownMenu.addEventListener('click', (e) => {
        if (e.target.closest('.dropdown-item')) { // Use closest to handle clicks on icons inside items
            hideDropdown();
        }
    });

    // Bootstrap event listener to clear state if closed externally
    hamburgerMenu.addEventListener('hidden.bs.dropdown', () => {
        isMouseOverMenu = false;
        isMouseOverDropdown = false;
        clearTimeout(autoHideTimeout);
        clearTimeout(mouseLeaveTimeout);
    });

     // Initial content update on load (based on potentially pre-active tab)
     updateDropdownContent();

     // Update content when tabs change (for cases where hover isn't involved immediately)
     document.querySelectorAll('#main-tab .nav-link').forEach(tabLink => {
        tabLink.addEventListener('shown.bs.tab', updateDropdownContent);
     });

})();

// Handle Image Nav Click (Keep this function if needed)
function handleImageNavClick(event) {
    if (window.location.pathname.startsWith('/image')) {
        event.preventDefault();
        console.log('Already on image page, prevented reload');
        return false;
    }
    return true;
}
</script>
