<div class="container-fluid">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-0" style="margin-top: -1%;">
        <ul class="nav nav-tabs main-nav mb-0" id="main-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path == url_for('home') %}active{% endif %}" href="{{ url_for('home') }}">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #667eea 0%, #0da5aa 100%);"><i class="bi bi-house-door-fill"></i></span> 
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path == url_for('notes') %}active{% endif %}" href="{{ url_for('notes') }}">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #07c160 0%, #00a854 100%);"><i class="bi bi-journal-richtext"></i></span> Ghi Ch√∫
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path == url_for('mxh.mxh_page') %}active{% endif %}" href="{{ url_for('mxh.mxh_page') }}">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);"><i class="bi bi-share-fill"></i></span> MXH
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link {% if request.path.startswith('/image') %}active{% endif %}" 
                   href="{{ url_for('image.index') }}"
                   onclick="return handleImageNavClick(event);">
                    <span class="nav-card-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);"><i class="bi bi-image-fill"></i></span> Image
                </a>
            </li>
        </ul>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item dropdown" id="hamburger-menu">
                <a class="nav-link" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-list" style="font-size: 1.5rem;"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" id="dynamic-menu">
                    {# Menu content will be populated by JavaScript based on current page #}
                </ul>
            </li>
        </ul>
    </div>
</div>

<style>
/* Hamburger menu position fix - Keep in place, just show dropdown */
.hamburger-menu {
    position: relative;
    /* Removed padding-left */
}

/* Ensure dropdown appears correctly */
.hamburger-menu .dropdown-menu {
    position: absolute !important; /* Force absolute positioning */
    top: 100%;
    right: 0;
    left: auto; /* Ensure it aligns to the right */
    margin-top: 0.125rem;
    display: none;
    min-width: 200px;
    z-index: 1050; /* Ensure it's above other elements */
}


/* Smooth dropdown animation */
@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Show dropdown with animation when .show class is added */
.hamburger-menu .dropdown-menu.show {
    display: block;
    animation: fadeInDown 0.2s ease-out; /* Faster animation */
}

/* Dropdown item hover effect */
.hamburger-menu .dropdown-item {
    transition: all 0.15s ease; /* Faster transition */
}

.hamburger-menu .dropdown-item:hover,
.hamburger-menu .dropdown-item:focus { /* Add focus state */
    background-color: rgba(var(--bs-primary-rgb), 0.15); /* Lighter hover */
    color: var(--bs-primary);
    transform: translateX(3px); /* Smaller movement */
}

/* Ensure icon alignment */
.hamburger-menu .nav-link {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.25rem !important; /* Smaller padding for icon */
    line-height: 1;
}

.hamburger-menu .nav-link i {
    vertical-align: middle;
}

/* Style main nav items to align with hamburger */
.main-nav .nav-item {
    display: flex;
    align-items: center;
}
</style>

<script>
// Enhanced hover menu behavior - Applied to all hamburger menus
(function() {
    const hamburgerMenus = document.querySelectorAll('.hamburger-menu');
    if (!hamburgerMenus.length) return;

    hamburgerMenus.forEach(hamburgerMenu => {
        const menuLink = hamburgerMenu.querySelector('.nav-link');
        const dropdownMenu = hamburgerMenu.querySelector('.dropdown-menu');
        let bsDropdownInstance = null; // Store Bootstrap instance

        let autoHideTimeout;
        let mouseLeaveTimeout;
        let isMouseOverMenu = false;
        let isMouseOverDropdown = false;

        // Function to show dropdown using Bootstrap API
        const showDropdown = () => {
             if (!bsDropdownInstance) {
                bsDropdownInstance = new bootstrap.Dropdown(menuLink, {
                    // Options if needed
                });
            }
             // Use Bootstrap's show method if not already shown
             // Check _isShown property (internal, might change) or check for 'show' class
            if (!dropdownMenu.classList.contains('show')) {
                 bsDropdownInstance.show();
            }
        };

        // Function to hide dropdown using Bootstrap API
        const hideDropdown = () => {
             if (bsDropdownInstance) {
                 // Use Bootstrap's hide method if shown
                 if (dropdownMenu.classList.contains('show')) {
                    bsDropdownInstance.hide();
                 }
            }
        };

        // Show dropdown when hovering icon
        hamburgerMenu.addEventListener('mouseenter', () => {
            clearTimeout(autoHideTimeout);
            clearTimeout(mouseLeaveTimeout);
            isMouseOverMenu = true;
            showDropdown(); // Use Bootstrap's show

            // Auto-hide after 2 seconds if user doesn't move to dropdown
            autoHideTimeout = setTimeout(() => {
                if (!isMouseOverDropdown) {
                    hideDropdown(); // Use Bootstrap's hide
                }
            }, 2000);
        });

        // When mouse leaves hamburger icon
        hamburgerMenu.addEventListener('mouseleave', () => {
            isMouseOverMenu = false;

            // Give user time to move mouse to dropdown (300ms grace period)
            mouseLeaveTimeout = setTimeout(() => {
                if (!isMouseOverDropdown) {
                    clearTimeout(autoHideTimeout);
                    hideDropdown(); // Use Bootstrap's hide
                }
            }, 300); // Reduced grace period
        });

        // When mouse enters dropdown menu
        dropdownMenu.addEventListener('mouseenter', () => {
            clearTimeout(autoHideTimeout);
            clearTimeout(mouseLeaveTimeout); // Cancel hide action
            isMouseOverDropdown = true;
             // Ensure it stays shown (Bootstrap might try to hide it on focus loss)
             if (!dropdownMenu.classList.contains('show')) {
                showDropdown();
             }
        });

        // When mouse leaves dropdown menu
        dropdownMenu.addEventListener('mouseleave', () => {
            isMouseOverDropdown = false;
            // Small delay before potentially hiding
            setTimeout(() => {
                // Only hide if not back on menu icon
                if (!isMouseOverMenu && !isMouseOverDropdown) {
                     hideDropdown(); // Use Bootstrap's hide
                }
            }, 100);
        });

         // Close dropdown when an item is clicked
        dropdownMenu.addEventListener('click', (e) => {
            if (e.target.classList.contains('dropdown-item')) {
                hideDropdown();
            }
        });

         // Bootstrap event listener to clear state if closed externally
         hamburgerMenu.addEventListener('hidden.bs.dropdown', () => {
            isMouseOverMenu = false;
            isMouseOverDropdown = false;
            clearTimeout(autoHideTimeout);
            clearTimeout(mouseLeaveTimeout);
         });
    });
})();
</script>
