{% extends "layouts/base.html" %}

{% block content %}
<div class="container-fluid" style="padding: 0.5rem 1rem;">
    <!-- Action Buttons and Groups - All in one row -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <!-- WeChat Groups on the left -->
        <div class="d-flex gap-2 align-items-center flex-wrap" id="mxh-groups-nav">
            <!-- Groups will be rendered here by JavaScript -->
        </div>
        
        <!-- Action buttons on the right -->
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <button class="btn btn-sm btn-success" onclick="testTelegramMenu(event)">
                <i class="bi bi-bug me-1"></i> Test Telegram Menu
            </button>
            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#mxh-view-mode-modal">
                <i class="bi bi-grid-3x3-gap me-1"></i> Ch·∫ø ƒê·ªô Xem
            </button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#mxh-addAccountModal">
                <i class="bi bi-plus-lg me-1"></i> Th√™m T√†i Kho·∫£n
            </button>
        </div>
    </div>
    
    <div id="mxh-accounts-container">
        <!-- MXH accounts will be rendered here -->
        <div class="card">
            <div class="card-body text-center text-muted">
                <i class="bi bi-share-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                <h5 class="mt-3">ƒêang t·∫£i...</h5>
            </div>
        </div>
    </div>
</div>

<!-- MXH View Mode Modal -->
<div class="modal fade" id="mxh-view-mode-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-grid-3x3-gap me-2"></i>Ch·∫ø ƒê·ªô Xem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="mxh-cards-per-row" class="form-label">S·ªë Cards M·ªói H√†ng</label>
                    <input type="number" class="form-control" id="mxh-cards-per-row" placeholder="Nh·∫≠p s·ªë cards m·ªói h√†ng..." min="1" max="20" value="12">
                    <div class="form-text">Nh·∫≠p s·ªë t·ª´ 1 ƒë·∫øn 20. V√≠ d·ª•: 12 = 12 cards m·ªói h√†ng</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="mxh-apply-view-mode-btn">√Åp D·ª•ng</button>
            </div>
        </div>
    </div>
</div>

<!-- MXH Add Account Modal -->
<div class="modal fade" id="mxh-addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Th√™m T√†i Kho·∫£n MXH</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label for="mxh-username" class="form-label mb-1">T√™n ng∆∞·ªùi d√πng</label>
                    <input type="text" class="form-control form-control-sm" id="mxh-username" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng..." required>
                </div>
                <div class="mb-2">
                    <label for="mxh-platform" class="form-label mb-1">N·ªÅn t·∫£ng</label>
                    <select class="form-select form-select-sm" id="mxh-platform" required>
                        <option value="">Ch·ªçn n·ªÅn t·∫£ng...</option>
                        <option value="facebook">Facebook</option>
                        <option value="instagram">Instagram</option>
                        <option value="twitter">Twitter</option>
                        <option value="zalo">Zalo</option>
                        <option value="wechat">WeChat</option>
                        <option value="telegram">Telegram</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                    <div class="form-text small">Card s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c ƒë∆∞a v√†o nh√≥m theo n·ªÅn t·∫£ng ƒë√£ ch·ªçn</div>
                </div>
                <div class="mb-2">
                    <label for="mxh-url" class="form-label mb-1">URL (t√πy ch·ªçn)</label>
                    <input type="url" class="form-control form-control-sm" id="mxh-url" placeholder="https://...">
                </div>
                <div class="mb-2">
                    <label class="form-label mb-1">Ng√†y T·∫°o</label>
                    <div class="row g-1">
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm" id="mxh-day" placeholder="Ng√†y" min="1" max="31" required>
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm" id="mxh-month" placeholder="Th√°ng" min="1" max="12" required>
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm" id="mxh-year" placeholder="NƒÉm" min="2000" max="2030" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary btn-sm" id="mxh-save-account-btn">T·∫°o Card</button>
            </div>
        </div>
    </div>
</div>

<!-- WeChat Context Menu -->
<!-- Unified Context Menu for All Platforms -->
<div id="unified-context-menu" class="custom-context-menu" style="display: none;">
    <!-- Th√¥ng tin -->
    <div class="menu-item" data-action="edit">
        <i class="bi bi-pencil-square me-2"></i> Th√¥ng tin
    </div>
    
    <!-- Tr·∫°ng Th√°i (with submenu) -->
    <div class="menu-item has-submenu" id="status-submenu-item">
        <i class="bi bi-circle-fill me-2"></i> Tr·∫°ng Th√°i
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="status-submenu">
            <div class="menu-item status-normal" data-action="status-available">
                <i class="bi bi-check-circle-fill me-2 text-success"></i> Available
            </div>
            <div class="menu-item status-normal" data-action="status-die">
                <i class="bi bi-x-circle-fill me-2 text-danger"></i> Die
            </div>
            <div class="menu-item status-normal" data-action="status-disabled">
                <i class="bi bi-slash-circle me-2 text-warning"></i> V√¥ hi·ªáu h√≥a
            </div>
            <!-- Rescue options (shown when disabled) -->
            <div class="menu-item status-rescue" data-action="rescue-success" style="display: none;">
                <i class="bi bi-heart-fill me-2 text-success"></i> ƒê∆∞·ª£c C·ª©u
            </div>
            <div class="menu-item status-rescue" data-action="rescue-failed" style="display: none;">
                <i class="bi bi-heartbreak-fill me-2 text-danger"></i> C·ª©u Th·∫•t B·∫°i
            </div>
        </div>
    </div>
    
    <!-- Th√¥ng b√°o -->
    <div class="menu-item" id="unified-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Th√¥ng b√°o
    </div>
    
    <!-- WeChat specific: ƒê√£ Qu√©t -->
    <div class="menu-item wechat-only" data-action="mark-scanned" style="display: none;">
        <i class="bi bi-check-circle-fill me-2"></i> ƒê√£ Qu√©t
    </div>
    
    <!-- Copy SƒêT -->
    <div class="menu-item" data-action="copy-phone" id="copy-phone-item" style="display: none;">
        <i class="bi bi-copy me-2"></i> Copy SƒêT
    </div>
    
    <!-- Copy Email -->
    <div class="menu-item" data-action="copy-email" id="copy-email-item" style="display: none;">
        <i class="bi bi-envelope me-2"></i> Copy Email
    </div>
    
    <!-- WeChat specific: Reset l∆∞·ª£t qu√©t -->
    <div class="menu-item wechat-only" data-action="reset-scan" style="display: none;">
        <i class="bi bi-arrow-clockwise me-2"></i> Reset l∆∞·ª£t qu√©t
    </div>
    
    <!-- ƒê·ªïi s·ªë hi·ªáu -->
    <div class="menu-item" data-action="change-number">
        <i class="bi bi-123 me-2"></i> ƒê·ªïi s·ªë hi·ªáu
    </div>
    
    <!-- X√≥a Card -->
    <div class="menu-item" data-action="delete" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> X√≥a Card
    </div>
</div>

<!-- Legacy menus (keep for backward compatibility, will be removed later) -->
<div id="wechat-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" data-action="edit">
        <i class="bi bi-pencil-square me-2"></i> Ch·ªânh s·ª≠a th√¥ng tin
    </div>
    <div class="menu-item" data-action="mark-scanned">
        <i class="bi bi-check-circle-fill me-2"></i> ƒê√£ Qu√©t
    </div>
    <div class="menu-item" id="wechat-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Th√¥ng b√°o
    </div>
    <div class="menu-item" data-action="copy-phone" id="copy-phone-item-old" style="display: none;">
        <i class="bi bi-copy me-2"></i> Copy SƒêT
    </div>
    <div class="menu-item" data-action="reset-scan">
        <i class="bi bi-arrow-clockwise me-2"></i> Reset l∆∞·ª£t qu√©t
    </div>
    <div class="menu-item" data-action="change-number">
        <i class="bi bi-123 me-2"></i> ƒê·ªïi s·ªë hi·ªáu
    </div>
    <div class="menu-item" data-action="toggle-status" id="toggle-status-item">
        <i class="bi bi-x-circle-fill me-2"></i> V√¥ hi·ªáu h√≥a
    </div>
    <div class="menu-item has-submenu" id="rescue-options-item" style="display: none;">
        <i class="bi bi-heart-pulse me-2"></i> C·ª©u t√†i kho·∫£n
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="rescue-submenu">
            <div class="menu-item" data-action="rescue-success">
                <i class="bi bi-check-circle-fill me-2 text-success"></i> C·ª©u th√†nh c√¥ng
            </div>
            <div class="menu-item" data-action="rescue-failed">
                <i class="bi bi-x-circle-fill me-2 text-danger"></i> C·ª©u th·∫•t b·∫°i
            </div>
        </div>
    </div>
    <div class="menu-item" data-action="delete" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> X√≥a Card
    </div>
</div>

<!-- Telegram Context Menu -->
<div id="telegram-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" id="telegram-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Th√¥ng b√°o
    </div>
    <div class="menu-item" data-action="copy-phone-telegram">
        <i class="bi bi-telephone-fill me-2"></i> Copy SƒêT
    </div>
    <div class="menu-item" data-action="edit-generic">
        <i class="bi bi-pencil-square me-2"></i> Ch·ªânh s·ª≠a th√¥ng tin
    </div>
    <div class="menu-item" data-action="delete-generic" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> X√≥a Card
    </div>
</div>

<!-- Generic Platform Context Menu -->
<div id="generic-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" id="generic-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Th√¥ng b√°o
    </div>
    <div class="menu-item" data-action="edit-generic">
        <i class="bi bi-pencil-square me-2"></i> Ch·ªânh s·ª≠a th√¥ng tin
    </div>
    <div class="menu-item" data-action="delete-generic" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> X√≥a Card
    </div>
</div>

<!-- WeChat Account Modal -->
<div class="modal fade" id="wechat-account-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-wechat me-2"></i>Th√¥ng Tin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="wechat-card-name" class="form-label mb-1">S·ªë Card</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-card-name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="wechat-status" class="form-label mb-1">Tr·∫°ng Th√°i</label>
                        <select class="form-select form-select-sm" id="wechat-status" required>
                            <option value="available">Available</option>
                            <option value="disabled">Die</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="wechat-username" class="form-label mb-1">T√™n Ng∆∞·ªùi D√πng</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-username" required>
                    </div>
                    <div class="col-md-6">
                        <label for="wechat-phone" class="form-label mb-1">S·ªë ƒêi·ªán Tho·∫°i</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label mb-1">Ng√†y T·∫°o</label>
                    <div class="row g-1">
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm" id="wechat-day" placeholder="Ng√†y" min="1" max="31" required>
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm" id="wechat-month" placeholder="Th√°ng" min="1" max="12" required>
                        </div>
                        <div class="col-4">
                            <input type="number" class="form-control form-control-sm" id="wechat-year" placeholder="NƒÉm" min="2020" max="2030" required>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="wechat-apply-btn">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Generic Account Edit Modal -->
<div class="modal fade" id="generic-account-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Th√¥ng Tin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="generic-username" class="form-label mb-1">T√™n ƒëƒÉng nh·∫≠p</label>
                        <input type="text" class="form-control form-control-sm" id="generic-username" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p...">
                    </div>
                    <div class="col-md-6">
                        <label for="generic-password" class="form-label mb-1">M·∫≠t kh·∫©u</label>
                        <input type="password" class="form-control form-control-sm" id="generic-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
                    </div>
                </div>
                <div class="mb-2">
                    <label for="generic-display-name" class="form-label mb-1">T√™n ng∆∞·ªùi d√πng</label>
                    <input type="text" class="form-control form-control-sm" id="generic-display-name" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng...">
                </div>
                <div class="mb-2">
                    <label for="generic-phone" class="form-label mb-1">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" class="form-control form-control-sm" id="generic-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
                </div>
                <div class="mb-2">
                    <label for="generic-url" class="form-label mb-1">URL</label>
                    <input type="url" class="form-control form-control-sm" id="generic-url" placeholder="Nh·∫≠p URL...">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary btn-sm" id="generic-apply-btn">√Åp d·ª•ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Card Number Modal -->
<div class="modal fade" id="change-card-number-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-123 me-2"></i>ƒê·ªïi S·ªë Hi·ªáu Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-card-number" class="form-label">S·ªë hi·ªáu m·ªõi</label>
                    <input type="number" class="form-control" id="new-card-number" placeholder="Nh·∫≠p s·ªë hi·ªáu m·ªõi..." min="1" required>
                    <div class="form-text">Nh·∫≠p s·ªë hi·ªáu m·ªõi cho card n√†y</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="apply-card-number-btn">√Åp D·ª•ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Notice Modal -->
<div class="modal fade" id="noticeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-bell-fill me-2"></i>ƒê·∫∑t Th√¥ng B√°o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="noticeTitle" class="form-label">Ch·ªØ t√πy ch·ªçn</label>
                    <input type="text" class="form-control" id="noticeTitle" placeholder="Reg" value="Reg">
                </div>
                <div class="mb-3">
                    <label for="noticeDays" class="form-label">S·ªë ng√†y</label>
                    <input type="number" class="form-control" id="noticeDays" min="1" step="1" value="7">
                </div>
                <div class="mb-3">
                    <label for="noticeNote" class="form-label">N·ªôi dung</label>
                    <textarea class="form-control" id="noticeNote" rows="3" placeholder="Ghi ch√∫..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="submitNotice()">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="delete-card-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2 text-warning"></i>X√°c Nh·∫≠n X√≥a Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a card n√†y kh√¥ng?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>L∆∞u √Ω:</strong> H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. T·∫•t c·∫£ d·ªØ li·ªáu c·ªßa card s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy B·ªè</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">X√°c Nh·∫≠n X√≥a</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== MXH REAL-TIME CONFIGURATION =====
const MXH_CONFIG = {
    AUTO_REFRESH_INTERVAL: 3000, // 3 seconds - fast real-time updates
    DEBOUNCE_DELAY: 500, // Debounce for inline editing
    RENDER_BATCH_SIZE: 50, // Cards to render per batch (for smooth rendering)
    ENABLE_AUTO_REFRESH: true
};

// MXH Global State
let mxhGroups = [];
let mxhAccounts = [];
let currentContextAccountId = null;
let autoRefreshTimer = null;
let isRendering = false;
let pendingUpdates = false;

// ===== PERFORMANCE OPTIMIZATION UTILITIES =====
// Debounce function - prevents excessive API calls
function debounce(func, delay) {
    let timeoutId;
    return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// Throttle function - ensures function runs at most once per interval
function throttle(func, interval) {
    let lastCall = 0;
    return function(...args) {
        const now = Date.now();
        if (now - lastCall >= interval) {
            lastCall = now;
            func.apply(this, args);
        }
    };
}

// Flip card function
function flipCard(element, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const card = element.closest('.mxh-card');
    if (card) {
        card.classList.toggle('flipped');
    }
}

// ===== REAL-TIME DATA LOADING WITH SMART UPDATES =====
// Load MXH data from API with optimized rendering
async function loadMXHData(forceRender = true) {
    try {
        // Parallel loading for speed
        const [groupsResponse, accountsResponse] = await Promise.all([
            fetch('/mxh/api/groups'),
            fetch('/mxh/api/accounts')
        ]);
        
        if (groupsResponse.ok) {
            mxhGroups = await groupsResponse.json();
        }
        
        if (accountsResponse.ok) {
            const newAccounts = await accountsResponse.json();
            
            // Debug: log first account with notice
            const accWithNotice = newAccounts.find(a => a.notice && a.notice.enabled);
            if (accWithNotice) {
                console.log('üîî Account with notice found:', accWithNotice.id, accWithNotice.notice);
            }
            
            // Smart update: only render if data actually changed
            const dataChanged = JSON.stringify(newAccounts) !== JSON.stringify(mxhAccounts);
            mxhAccounts = newAccounts;
            
            console.log('loadMXHData:', { forceRender, dataChanged, totalAccounts: newAccounts.length });
            
            if (forceRender || dataChanged) {
                renderGroupsNav(); // Render groups navigation first
                if (!isRendering) {
                    renderMXHAccounts();
                } else {
                    pendingUpdates = true;
                }
            }
        }
    } catch (error) {
        console.error('Error loading MXH data:', error);
        document.getElementById('mxh-accounts-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                L·ªói k·∫øt n·ªëi API! ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i...
            </div>
        `;
    }
}

// ===== AUTO-REFRESH SYSTEM =====
function startAutoRefresh() {
    if (!MXH_CONFIG.ENABLE_AUTO_REFRESH) return;
    
    stopAutoRefresh(); // Clear any existing timer
    
    autoRefreshTimer = setInterval(async () => {
        await loadMXHData(false); // Don't force render, only if data changed
    }, MXH_CONFIG.AUTO_REFRESH_INTERVAL);
    
    console.log('‚úÖ MXH Auto-refresh enabled (every', MXH_CONFIG.AUTO_REFRESH_INTERVAL / 1000, 'seconds)');
}

function stopAutoRefresh() {
    if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
    }
}

// Pause auto-refresh when user is interacting (context menu open, modal open, etc.)
let interactionPaused = false;
function pauseAutoRefresh() {
    interactionPaused = true;
}

function resumeAutoRefresh() {
    interactionPaused = false;
}

// Ensure platform group exists
async function ensurePlatformGroup(platform) {
    const existingGroup = mxhGroups.find(g => g.name.toLowerCase() === platform.toLowerCase());
    if (existingGroup) {
        return existingGroup.id;
    }
    
    try {
        const response = await fetch('/mxh/api/groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name: platform.charAt(0).toUpperCase() + platform.slice(1),
                color: getPlatformColor(platform)
            })
        });
        
        if (response.ok) {
            const newGroup = await response.json();
            mxhGroups.push(newGroup);
            return newGroup.id;
        } else {
            throw new Error('Failed to create group');
        }
    } catch (error) {
        console.error('Error creating platform group:', error);
        throw error;
    }
}

// Get platform color
function getPlatformColor(platform) {
    const colors = {
        'facebook': '#1877f2',
        'instagram': '#e4405f',
        'twitter': '#1da1f2',
        'zalo': '#0068ff',
        'wechat': '#07c160',
        'telegram': '#0088cc',
        'whatsapp': '#25d366'
    };
    return colors[platform] || '#6c757d';
}

// Get next card number (per platform/group)
async function getNextCardNumber(groupId) {
    // Get all accounts in the same group
    const groupAccounts = mxhAccounts.filter(acc => acc.group_id === groupId);
    const numbers = groupAccounts.map(acc => parseInt(acc.card_name)).filter(n => !isNaN(n));
    
    if (numbers.length === 0) return 1;
    
    // Find first available number starting from 1
    for (let i = 1; i <= numbers.length + 1; i++) {
        if (!numbers.includes(i)) {
            return i;
        }
    }
    return Math.max(...numbers) + 1;
}

// Toggle group visibility
function toggleGroupCards(event, cardsContainerId, toggleButtonId, groupId) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const cardsContainer = document.getElementById(cardsContainerId);
    const toggleButton = document.getElementById(toggleButtonId);
    
    // Find the eye icon element
    const eyeIcon = toggleButton.querySelector('.bi-eye-fill, .bi-eye-slash-fill');
    
    if (cardsContainer.style.display === 'none') {
        // Show cards
        cardsContainer.style.display = 'flex';
        if (eyeIcon) {
            eyeIcon.classList.remove('bi-eye-slash-fill');
            eyeIcon.classList.add('bi-eye-fill');
        }
        localStorage.setItem(`group_${groupId}_visible`, 'true');
    } else {
        // Hide cards
        cardsContainer.style.display = 'none';
        if (eyeIcon) {
            eyeIcon.classList.remove('bi-eye-fill');
            eyeIcon.classList.add('bi-eye-slash-fill');
        }
        localStorage.setItem(`group_${groupId}_visible`, 'false');
    }
}

// ===== RENDER GROUP NAVIGATION =====
function renderGroupsNav() {
    const groupsNavContainer = document.getElementById('mxh-groups-nav');
    if (!groupsNavContainer) return;
    
    let html = '';
    
    // Get unique groups from accounts
    const uniqueGroupIds = [...new Set(mxhAccounts.map(acc => acc.group_id).filter(id => id))];
    
    uniqueGroupIds.forEach(groupId => {
        const group = mxhGroups.find(g => g.id == groupId);
        if (group) {
            const toggleButtonId = `toggle-${groupId}`;
            const cardsContainerId = `cards-${groupId}`;
            const isVisible = localStorage.getItem(`group_${groupId}_visible`) !== 'false';
            
            html += `
                <button class="btn btn-sm btn-outline-light" id="${toggleButtonId}" 
                        onclick="toggleGroupCards(event, '${cardsContainerId}', '${toggleButtonId}', '${groupId}')"
                        style="border-color: ${group.color};">
                    <i class="bi ${group.icon || 'bi-people-fill'}" style="color: ${group.color};"></i>
                    ${group.name}
                    <i class="bi ${isVisible ? 'bi-eye-fill' : 'bi-eye-slash-fill'} ms-1"></i>
                </button>
            `;
        }
    });
    
    groupsNavContainer.innerHTML = html;
}

// ===== DATETIME NORMALIZATION HELPERS =====
// C·∫Øt microseconds v·ªÅ 3 ch·ªØ s·ªë v√† th√™m 'Z' n·∫øu thi·∫øu timezone
function normalizeISOForJS(iso) {
    if (!iso) return null;
    let s = String(iso).trim();
    // thay ' ' -> 'T' n·∫øu c√≥
    s = s.replace(' ', 'T');
    // N·∫øu c√≥ 'Z' th√¨ ok; n·∫øu c√≥ +00:00 th√¨ v·∫´n ok
    if (!/[zZ]|[+\-]\d{2}:\d{2}$/.test(s)) s += 'Z';
    // Chu·∫©n ho√° ph·∫ßn .xxxxx... v·ªÅ 3 ch·ªØ s·ªë
    s = s.replace(/(\.\d{3})\d+/, '$1'); // gi·ªØ .mmm
    return s;
}

function ensureNoticeParsed(notice) {
    let n = (typeof notice === 'string') ? (()=>{ try{return JSON.parse(notice)}catch{return {}} })() : (notice || {});
    if (n && n.start_at) n.start_at = normalizeISOForJS(n.start_at);
    return n;
}

// ===== OPTIMIZED RENDERING WITH SCROLL PRESERVATION =====
// Render MXH Accounts with performance optimizations and scroll position preservation
function renderMXHAccounts() {
    if (isRendering) {
        pendingUpdates = true;
        return;
    }
    
    isRendering = true;
    const container = document.getElementById('mxh-accounts-container');
    
    // üíæ SAVE SCROLL POSITION BEFORE RENDER
    const scrollY = window.scrollY || window.pageYOffset;
    const scrollX = window.scrollX || window.pageXOffset;
    
    if (mxhAccounts.length === 0) {
        container.innerHTML = `
            <div class="card">
                <div class="card-body text-center text-muted">
                    <i class="bi bi-share-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                    <h5 class="mt-3">Ch∆∞a c√≥ t√†i kho·∫£n MXH n√†o</h5>
                    <p>Nh·∫•n "Th√™m T√†i Kho·∫£n MXH" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                </div>
            </div>
        `;
        isRendering = false;
        return;
    }

    // Group accounts by group_id
    const accountsByGroup = {};
    mxhAccounts.forEach(account => {
        const groupId = account.group_id || 'no-group';
        if (!accountsByGroup[groupId]) {
            accountsByGroup[groupId] = [];
        }
        accountsByGroup[groupId].push(account);
    });

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();
    const tempDiv = document.createElement('div');
    let html = '';
    
    Object.keys(accountsByGroup).forEach(groupId => {
        const accounts = accountsByGroup[groupId];
        const group = mxhGroups.find(g => g.id == groupId);
        
        // Sort by card_name numerically
        accounts.sort((a, b) => {
            const numA = parseInt(a.card_name) || 0;
            const numB = parseInt(b.card_name) || 0;
            return numA === numB ? (b.id - a.id) : (numA - numB);
        });
        
        if (group) {
            const cardsContainerId = `cards-${groupId}`;
            
            // Just render cards container without header
            html += `
                <div class="mb-4">
                    <div class="row g-2" id="${cardsContainerId}" style="display: none;">
            `;
            
            accounts.forEach(account => {
                const now = new Date(); // D√πng chung cho m·ªçi platform
                const isDisabled = account.status === 'disabled';
                let isAnniversary = false;
                
                // Secondary account variables
                let isSecondaryAnniversary = false;
                let secondaryAccountAgeDisplay = '';
                let secondaryAgeColor = '#fff';
                let secondaryScanCountdown = '';
                let secondaryBorderStyle = '';
                
                // Calculate secondary border style
                if (account.secondary_status === 'disabled') {
                    secondaryBorderStyle = 'border-left: 4px solid #dc3545;';
                }
                
                // Calculate age for WeChat primary with color
                let accountAgeDisplay = '';
                let ageColor = '#fff';
                let scanCountdown = '';
                
                if (account.platform === 'wechat' && account.wechat_created_year) {
                    const createdDate = new Date(account.wechat_created_year, account.wechat_created_month - 1, account.wechat_created_day);
                    const diffDays = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));

                    if (diffDays >= 365) {
                        const years = Math.floor(diffDays / 365);
                        const months = Math.floor((diffDays % 365) / 30);
                        accountAgeDisplay = `${years}nƒÉm ${months}th`;
                        ageColor = '#07c160';
                        isAnniversary = true;
                    } else if (diffDays >= 30) {
                        const months = Math.floor(diffDays / 30);
                        accountAgeDisplay = `${months}th ${diffDays % 30}d`;
                    } else {
                        accountAgeDisplay = `${diffDays}d`;
                    }
                    
                    // Calculate scan countdown
                    if (account.wechat_last_scan_date) {
                        const lastScanDate = new Date(account.wechat_last_scan_date);
                        const daysSinceScan = Math.floor((now - lastScanDate) / (1000 * 60 * 60 * 24));
                        const remainingDays = 30 - daysSinceScan;
                        const remainingScans = 3 - (account.wechat_scan_count || 0);
                        if ((account.wechat_scan_count || 0) >= 3) {
                            scanCountdown = 'ƒê√£ H·∫øt L∆∞·ª£t';
                        } else if (remainingDays > 0) {
                            scanCountdown = `C√≤n ${remainingDays} ng√†y`;
                        } else {
                            scanCountdown = `ƒê·ªß ƒëi·ªÅu ki·ªán L∆∞·ª£t: ${remainingScans}`;
                        }
                    } else {
                        if (diffDays < 90) {
                            scanCountdown = `C√≤n ${90 - diffDays} ng√†y`;
                        } else {
                            const remainingScans = 3 - (account.wechat_scan_count || 0);
                            scanCountdown = `ƒê·ªß ƒëi·ªÅu ki·ªán L∆∞·ª£t: ${remainingScans}`;
                        }
                    }
                    
                    // Calculate secondary account age if exists
                    if (account.secondary_wechat_created_year) {
                        const secondaryCreatedDate = new Date(account.secondary_wechat_created_year, account.secondary_wechat_created_month - 1, account.secondary_wechat_created_day);
                        const secondaryDiffDays = Math.ceil((now - secondaryCreatedDate) / (1000 * 60 * 60 * 24));

                        if (secondaryDiffDays >= 365) {
                            const years = Math.floor(secondaryDiffDays / 365);
                            const months = Math.floor((secondaryDiffDays % 365) / 30);
                            secondaryAccountAgeDisplay = `${years}nƒÉm ${months}th`;
                            secondaryAgeColor = '#07c160';
                            isSecondaryAnniversary = true;
                        } else if (secondaryDiffDays >= 30) {
                            const months = Math.floor(secondaryDiffDays / 30);
                            secondaryAccountAgeDisplay = `${months}th ${secondaryDiffDays % 30}d`;
                        } else {
                            secondaryAccountAgeDisplay = `${secondaryDiffDays}d`;
                        }
                        
                        // Calculate secondary scan countdown
                        if (account.secondary_wechat_last_scan_date) {
                            const lastScanDate = new Date(account.secondary_wechat_last_scan_date);
                            const daysSinceScan = Math.floor((now - lastScanDate) / (1000 * 60 * 60 * 24));
                            const remainingDays = 30 - daysSinceScan;
                            const remainingScans = 3 - (account.secondary_wechat_scan_count || 0);
                            if ((account.secondary_wechat_scan_count || 0) >= 3) {
                                secondaryScanCountdown = 'ƒê√£ H·∫øt L∆∞·ª£t';
                            } else if (remainingDays > 0) {
                                secondaryScanCountdown = `C√≤n ${remainingDays} ng√†y`;
                            } else {
                                secondaryScanCountdown = `ƒê·ªß ƒëi·ªÅu ki·ªán L∆∞·ª£t: ${remainingScans}`;
                            }
                        } else {
                            if (secondaryDiffDays < 90) {
                                secondaryScanCountdown = `C√≤n ${90 - secondaryDiffDays} ng√†y`;
                            } else {
                                const remainingScans = 3 - (account.secondary_wechat_scan_count || 0);
                                secondaryScanCountdown = `ƒê·ªß ƒëi·ªÅu ki·ªán L∆∞·ª£t: ${remainingScans}`;
                            }
                        }
                        
                        // Check if secondary account has Hong Kong number (+852)
                        // Only blink if: 1 year old AND NOT Hong Kong number
                        if (isSecondaryAnniversary) {
                            const secondaryPhone = (account.secondary_phone || '').replace(/[\s+]/g, ''); // Remove spaces and +
                            const isHongKongNumber = secondaryPhone.startsWith('852');
                            
                            // Only blink if NOT Hong Kong number
                            if (!isHongKongNumber) {
                                secondaryBorderStyle = 'border-left: 4px solid #ffc107; animation: blink 1s infinite;';
                            } else {
                                secondaryBorderStyle = 'border-left: 4px solid #07c160;'; // Green for HK number, no blink
                            }
                        }
                    }
                }
                
                const contextMenuFunction = account.platform === 'wechat' ? 'showWeChatContextMenu' : 'showGenericContextMenu';
                
                // Notice countdown logic
                let noticeHtml = '';
                let extraClass = '';
                let tipHtml = '';
                const n = ensureNoticeParsed(account.notice);
                
                // Debug log
                if (account.id === noticeTargetId) {
                    console.log('Notice debug for account', account.id, ':', n);
                }
                
                if (n.enabled && n.start_at && n.days > 0) {
                    const start = new Date(n.start_at);
                    const end = new Date(start.getTime() + n.days * 86400000);
                    const remainMs = end - now;
                    const remainDays = Math.ceil(remainMs / 86400000);
                    
                    if (remainDays > 0) {
                        // Format display: days (d) or months (m)
                        let timeDisplay;
                        if (remainDays >= 30) {
                            const remainMonths = Math.floor(remainDays / 30);
                            timeDisplay = `${remainMonths}m`;
                        } else {
                            timeDisplay = `${remainDays}d`;
                        }
                        noticeHtml = `<div class="notice-line">${escapeHtml(n.title)}: ${timeDisplay}</div>`;
                    } else {
                        noticeHtml = `<div class="notice-line expired">${escapeHtml(n.title)}: ƒë√£ ƒë·∫øn h·∫°n</div>`;
                        extraClass = 'notice-expired-blink';
                    }
                    
                    // Tooltip also uses short format
                    let tooltipTime;
                    if (n.days >= 30) {
                        const months = Math.floor(n.days / 30);
                        tooltipTime = `${months}m`;
                    } else {
                        tooltipTime = `${n.days}d`;
                    }
                    tipHtml = `<div class="notice-tooltip"><div class="notice-tooltip-title">${escapeHtml(n.title)} ‚Äì ${tooltipTime}</div><div class="notice-tooltip-note">${escapeHtml(n.note || '')}</div></div>`;
                }
                
                // Determine account status and styling
                let statusClass = 'account-status-available';
                let statusIcon = '';
                let accountStatus = account.status || 'active';
                
                if (accountStatus === 'die') {
                    statusClass = 'account-status-die';
                    statusIcon = '<i class="bi bi-x-circle-fill status-icon" style="color: #dc3545;"></i>';
                } else if (accountStatus === 'disabled') {
                    statusClass = 'account-status-disabled';
                    statusIcon = '<i class="bi bi-slash-circle status-icon" style="color: #ff8c00;"></i>';
                }
                
                // Border styling based on status
                let borderStyle = '';
                if (isDisabled) {
                    borderStyle = 'border-left: 4px solid #dc3545;';
                } else if (isAnniversary) {
                    // Check if primary account has Hong Kong number (+852)
                    // Only blink if: 1 year old AND NOT Hong Kong number
                    const primaryPhone = (account.phone || '').replace(/[\s+]/g, ''); // Remove spaces and +
                    const isHongKongNumber = primaryPhone.startsWith('852');
                    
                    if (!isHongKongNumber) {
                        // Not Hong Kong number - blink to remind to change
                        borderStyle = 'border-left: 4px solid #ffc107; animation: blink 1s infinite;';
                    } else {
                        // Hong Kong number - green border, no blink
                        borderStyle = 'border-left: 4px solid #07c160;';
                    }
                }
                
                const hasSecondaryAccount = account.secondary_username && account.secondary_username.trim() !== '';
                
                html += `
                    <div class="col" style="padding: 2px;">
                        <div class="mxh-card-container ${extraClass}">
                            <div class="mxh-card-inner">
                                <div class="mxh-card-front" oncontextmenu="handleCardContextMenu(event, ${account.id}, '${account.platform}'); return false;">
                                    <div class="card tool-card mxh-card" style="${borderStyle}">
                                        <div class="card-body">
                                            <div class="d-flex align-items-center justify-content-between mb-1">
                                                <h6 class="card-title mb-0" style="font-size: 1.26rem; font-weight: 600;">${account.card_name}</h6>
                                                <div class="d-flex align-items-center gap-1">
                                                    ${hasSecondaryAccount ? `<i class="bi bi-people-fill text-info" title="C√≥ t√†i kho·∫£n ph·ª•" style="font-size: 0.8rem;"></i>` : ''}
                                                    ${accountAgeDisplay ? `<small onclick="flipCard(this, event)" style="color: ${ageColor}; font-size: 0.7rem; font-weight: 500; cursor: pointer;">${accountAgeDisplay}</small>` : ''}
                                                </div>
                                            </div>
                                            
                                            ${noticeHtml}
                                            ${tipHtml}
                                            
                                            <div class="text-center mb-1">
                                                <small 
                                                    class="${statusClass} editable-field" 
                                                    contenteditable="true" 
                                                    data-account-id="${account.id}" 
                                                    data-field="username" 
                                                    data-is-secondary="false"
                                                    style="font-size: 0.84rem; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: inline-block;"
                                                    onmouseenter="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                                                    onmouseleave="this.style.backgroundColor='transparent'"
                                                    onclick="event.stopPropagation()"
                                                >${account.username || 'Click ƒë·ªÉ nh·∫≠p'}${statusIcon}</small>
                                                <small 
                                                    class="text-muted editable-field" 
                                                    contenteditable="true" 
                                                    data-account-id="${account.id}" 
                                                    data-field="phone" 
                                                    data-is-secondary="false"
                                                    style="font-size: 0.84rem; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                    onmouseenter="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                                                    onmouseleave="this.style.backgroundColor='transparent'"
                                                    onclick="event.stopPropagation()"
                                                >üìû ${account.phone || 'Click ƒë·ªÉ nh·∫≠p'}</small>
                                            </div>
                                            
                                            ${account.platform === 'wechat' ? `
                                                <div class="mt-auto">
                                                    ${isDisabled ? 
                                                        `<div class="d-flex align-items-center justify-content-between">
                                                            <small class="text-danger" style="font-size: 0.77rem;">Ng√†y: ${account.die_date ? Math.ceil((new Date() - new Date(account.die_date)) / (1000 * 60 * 60 * 24)) : 0}</small>
                                                            <small style="font-size: 0.77rem;">L∆∞·ª£t c·ª©u: <span class="text-danger">${account.rescue_count || 0}</span>-<span class="text-success">${account.rescue_success_count || 0}</span></small>
                                                        </div>` :
                                                        `<div class="text-center">
                                                            ${scanCountdown ? `<small class="${scanCountdown.includes('C√≤n') ? 'text-warning' : (scanCountdown === 'ƒê√£ H·∫øt L∆∞·ª£t' ? 'text-danger' : 'text-info')}" style="font-size: 0.7rem;">${scanCountdown === 'ƒê√£ H·∫øt L∆∞·ª£t' ? '‚ùå' : ''} ${scanCountdown}</small>` : ''}
                                                            ${(account.wechat_scan_count || 0) > 0 ? ` <small class="text-secondary" style="font-size: 0.7rem;">L∆∞·ª£t: ${account.wechat_scan_count}</small>` : ''}
                                                        </div>`
                                                    }
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mxh-card-back" oncontextmenu="showWeChatContextMenu(event, ${account.id}, true); return false;">
                                    <div class="card tool-card mxh-card" style="${secondaryBorderStyle}">
                                        <div class="card-body">
                                            ${hasSecondaryAccount ? `
                                                <div class="d-flex align-items-center justify-content-between mb-1">
                                                    <h6 class="card-title mb-0" style="font-size: 1.26rem; font-weight: 600;">${account.secondary_card_name || account.card_name} <small style="font-size: 0.7rem;">Ph·ª•</small></h6>
                                                    ${secondaryAccountAgeDisplay ? `<small style="color: ${secondaryAgeColor}; font-size: 0.7rem; font-weight: 500;">${secondaryAccountAgeDisplay}</small>` : ''}
                                                </div>
                                                
                                                <div class="text-center mb-1">
                                                    <small 
                                                        class="text-white editable-field" 
                                                        contenteditable="true" 
                                                        data-account-id="${account.id}" 
                                                        data-field="username" 
                                                        data-is-secondary="true"
                                                        style="font-size: 0.84rem; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: block;"
                                                        onmouseenter="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                                                        onmouseleave="this.style.backgroundColor='transparent'"
                                                        onclick="event.stopPropagation()"
                                                    >${account.secondary_username || 'Click ƒë·ªÉ nh·∫≠p'}</small>
                                                    <small 
                                                        class="text-muted editable-field" 
                                                        contenteditable="true" 
                                                        data-account-id="${account.id}" 
                                                        data-field="phone" 
                                                        data-is-secondary="true"
                                                        style="font-size: 0.84rem; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                                        onmouseenter="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                                                        onmouseleave="this.style.backgroundColor='transparent'"
                                                        onclick="event.stopPropagation()"
                                                    >üìû ${account.secondary_phone || 'Click ƒë·ªÉ nh·∫≠p'}</small>
                                                </div>
                                                
                                                ${account.platform === 'wechat' ? `
                                                    <div class="mt-auto">
                                                        ${(account.secondary_status === 'disabled') ? 
                                                            `<div class="d-flex align-items-center justify-content-between">
                                                                <small class="text-danger" style="font-size: 0.77rem;">Ng√†y: ${account.secondary_die_date ? Math.ceil((new Date() - new Date(account.secondary_die_date)) / (1000 * 60 * 60 * 24)) : 0}</small>
                                                                <small style="font-size: 0.77rem;">L∆∞·ª£t c·ª©u: <span class="text-danger">${account.secondary_rescue_count || 0}</span>-<span class="text-success">${account.secondary_rescue_success_count || 0}</span></small>
                                                            </div>` :
                                                            `<div class="text-center">
                                                                ${secondaryScanCountdown ? `<small class="${secondaryScanCountdown.includes('C√≤n') ? 'text-warning' : (secondaryScanCountdown === 'ƒê√£ H·∫øt L∆∞·ª£t' ? 'text-danger' : 'text-info')}" style="font-size: 0.7rem;">${secondaryScanCountdown === 'ƒê√£ H·∫øt L∆∞·ª£t' ? '‚ùå' : ''} ${secondaryScanCountdown}</small>` : ''}
                                                                ${(account.secondary_wechat_scan_count || 0) > 0 ? ` <small class="text-secondary" style="font-size: 0.7rem;">L∆∞·ª£t: ${account.secondary_wechat_scan_count}</small>` : ''}
                                                            </div>`
                                                        }
                                                    </div>
                                                ` : ''}
                                            ` : `
                                                <div class="d-flex flex-column align-items-center justify-content-center h-100">
                                                    <h6 class="text-muted mb-3">T√†i Kho·∫£n Ph·ª•</h6>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="event.preventDefault(); event.stopPropagation(); openWeChatModal(${account.id}, true);">
                                                        <i class="bi bi-plus-lg me-1"></i> Th√™m
                                                    </button>
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        }
    });
    
    tempDiv.innerHTML = html;
    container.innerHTML = '';
    container.appendChild(tempDiv);
    
    // Enable tooltip on hover for notice with smart positioning
    requestAnimationFrame(() => {
        document.querySelectorAll('.mxh-card-container').forEach(card => {
            const tip = card.querySelector('.notice-tooltip');
            if (tip) {
                card.addEventListener('mouseenter', () => {
                    // Smart positioning: check if card is near left or right edge
                    const rect = card.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    
                    // Remove previous positioning classes
                    tip.classList.remove('tooltip-left', 'tooltip-right');
                    
                    // If card is on the left third of screen, show tooltip on right
                    if (rect.left < viewportWidth / 3) {
                        tip.classList.add('tooltip-right');
                    }
                    // If card is on the right third of screen, show tooltip on left
                    else if (rect.right > (viewportWidth * 2) / 3) {
                        tip.classList.add('tooltip-left');
                    }
                    // Default: show on right (original behavior)
                    
                    tip.classList.add('show');
                });
                card.addEventListener('mouseleave', () => tip.classList.remove('show'));
            }
        });
    });
    
    // Restore visibility states efficiently
    requestAnimationFrame(() => {
        Object.keys(accountsByGroup).forEach(groupId => {
            const isVisible = localStorage.getItem(`group_${groupId}_visible`) !== 'false';
            const cardsContainerId = `cards-${groupId}`;
            const toggleButtonId = `toggle-${groupId}`;
            const cardsContainer = document.getElementById(cardsContainerId);
            const toggleButton = document.getElementById(toggleButtonId);
            
            if (cardsContainer && toggleButton) {
                const eyeIcon = toggleButton.querySelector('.bi-eye-fill, .bi-eye-slash-fill');
                
                if (isVisible) {
                    // Show cards
                    cardsContainer.style.display = 'flex';
                    if (eyeIcon) {
                        eyeIcon.classList.remove('bi-eye-slash-fill');
                        eyeIcon.classList.add('bi-eye-fill');
                    }
                } else {
                    // Hide cards
                    cardsContainer.style.display = 'none';
                    if (eyeIcon) {
                        eyeIcon.classList.remove('bi-eye-fill');
                        eyeIcon.classList.add('bi-eye-slash-fill');
                    }
                }
            }
        });
        
        // üîÑ RESTORE SCROLL POSITION AFTER RENDER
        window.scrollTo(scrollX, scrollY);
        
        // Setup inline editing after render
        setupEditableFields();
        
        isRendering = false;
        
        // Process pending updates if any
        if (pendingUpdates) {
            pendingUpdates = false;
            setTimeout(() => renderMXHAccounts(), 100);
        }
    });
}

// Context Menu Functions with auto-refresh pause
function showWeChatContextMenu(event, accountId, isSecondary = false) {
    event.preventDefault();
    event.stopPropagation();
    currentContextAccountId = accountId;
    pauseAutoRefresh();
    
    const contextMenu = document.getElementById('wechat-context-menu');
    contextMenu.dataset.isSecondary = isSecondary;
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    
    const account = mxhAccounts.find(acc => acc.id === accountId);
    if (account) {
        const toggleStatusItem = document.getElementById('toggle-status-item');
        const rescueItem = document.getElementById('rescue-options-item');
        const copyPhoneItem = document.getElementById('copy-phone-item');
        
        const statusToCheck = isSecondary ? account.secondary_status : account.status;
        const phoneToCopy = isSecondary ? account.secondary_phone : account.phone;
        
        if (statusToCheck === 'disabled') {
            toggleStatusItem.style.display = 'none';
            rescueItem.style.display = 'block';
        } else {
            toggleStatusItem.style.display = 'block';
            toggleStatusItem.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i> V√¥ hi·ªáu h√≥a';
            rescueItem.style.display = 'none';
        }
        
        copyPhoneItem.style.display = phoneToCopy ? 'block' : 'none';
        
        // Configure notice toggle
        configureNoticeToggleFor('wechat-context-menu', account);
    }
    
    setTimeout(() => {
        document.addEventListener('click', hideWeChatContextMenu, { once: true });
    }, 100);
}

function configureNoticeToggleFor(menuId, account) {
    const el = document.querySelector(`#${menuId} [id$="-notice-toggle"]`);
    if (!el) return;
    const hasNotice = !!(account.notice && account.notice.enabled);
    // set action + icon + text
    el.dataset.action = hasNotice ? 'clear-notice' : 'set-notice';
    el.innerHTML = hasNotice
        ? '<i class="bi bi-bell-slash-fill me-2"></i> H·ªßy th√¥ng b√°o'
        : '<i class="bi bi-bell-fill me-2"></i> Th√¥ng b√°o';
}

function hideWeChatContextMenu() {
    document.getElementById('wechat-context-menu').style.display = 'none';
    resumeAutoRefresh();
}

function showGenericContextMenu(event, accountId) {
    event.preventDefault();
    currentContextAccountId = accountId;
    pauseAutoRefresh();
    
    const contextMenu = document.getElementById('generic-context-menu');
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    
    const account = mxhAccounts.find(acc => acc.id === accountId);
    if (account) {
        // Configure notice toggle
        configureNoticeToggleFor('generic-context-menu', account);
    }
    
    setTimeout(() => {
        document.addEventListener('click', hideGenericContextMenu, { once: true });
    }, 100);
}

function hideGenericContextMenu() {
    document.getElementById('generic-context-menu').style.display = 'none';
    resumeAutoRefresh();
}

// ===== UNIFIED CONTEXT MENU (New) =====
function showUnifiedContextMenu(event, accountId, platform, isSecondary = false) {
    event.preventDefault();
    event.stopPropagation();
    currentContextAccountId = accountId;
    currentEditingIsSecondary = isSecondary;
    pauseAutoRefresh();
    
    const contextMenu = document.getElementById('unified-context-menu');
    const account = mxhAccounts.find(acc => acc.id === accountId);
    
    if (!account) return;
    
    // Show/hide WeChat-specific items
    const wechatOnlyItems = contextMenu.querySelectorAll('.wechat-only');
    wechatOnlyItems.forEach(item => {
        item.style.display = platform === 'wechat' ? 'block' : 'none';
    });
    
    // Show/hide phone item if phone exists
    const copyPhoneItem = contextMenu.querySelector('#copy-phone-item');
    const phone = isSecondary ? account.secondary_phone : account.phone;
    if (copyPhoneItem) {
        copyPhoneItem.style.display = phone ? 'block' : 'none';
    }
    
    // Show/hide email item if email exists (for Telegram, etc.)
    const copyEmailItem = contextMenu.querySelector('#copy-email-item');
    if (copyEmailItem) {
        // Add logic to show email if account has email field
        copyEmailItem.style.display = account.email ? 'block' : 'none';
    }
    
    // Configure notice toggle
    const noticeToggle = contextMenu.querySelector('#unified-notice-toggle');
    if (noticeToggle && account.notice) {
        const hasNotice = !!(account.notice.enabled);
        noticeToggle.dataset.action = hasNotice ? 'clear-notice' : 'set-notice';
        noticeToggle.innerHTML = hasNotice
            ? '<i class="bi bi-bell-slash-fill me-2"></i> H·ªßy th√¥ng b√°o'
            : '<i class="bi bi-bell-fill me-2"></i> Th√¥ng b√°o';
    }
    
    // Configure status submenu based on current status
    const currentStatus = isSecondary ? account.secondary_status : account.status;
    const statusNormalItems = contextMenu.querySelectorAll('.status-normal');
    const statusRescueItems = contextMenu.querySelectorAll('.status-rescue');
    
    if (currentStatus === 'disabled') {
        // Hide normal options, show rescue options
        statusNormalItems.forEach(item => item.style.display = 'none');
        statusRescueItems.forEach(item => item.style.display = 'block');
    } else {
        // Show normal options, hide rescue options
        statusNormalItems.forEach(item => item.style.display = 'block');
        statusRescueItems.forEach(item => item.style.display = 'none');
    }
    
    // Position and show menu
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    
    setTimeout(() => {
        document.addEventListener('click', hideUnifiedContextMenu, { once: true });
    }, 100);
}

function hideUnifiedContextMenu() {
    document.getElementById('unified-context-menu').style.display = 'none';
    resumeAutoRefresh();
}

// Handle Card Context Menu - Use Unified Menu
window.handleCardContextMenu = function(event, accountId, platform) {
    event.preventDefault();
    event.stopPropagation();
    console.log('Context menu for platform:', platform, 'account:', accountId);
    
    // Use unified context menu for all platforms
    showUnifiedContextMenu(event, accountId, platform, false);
}

window.showTelegramContextMenu = function(event, accountId) {
    event.preventDefault();
    event.stopPropagation(); // CRITICAL: Stop event from bubbling to dashboard menu
    currentContextAccountId = accountId;
    pauseAutoRefresh();
    
    console.log('Telegram context menu opened for account:', accountId);
    
    // Hide all other context menus first
    document.getElementById('wechat-context-menu').style.display = 'none';
    document.getElementById('generic-context-menu').style.display = 'none';
    
    const contextMenu = document.getElementById('telegram-context-menu');
    if (!contextMenu) {
        console.error('Telegram context menu element not found!');
        return;
    }
    
    contextMenu.style.display = 'block';
    contextMenu.style.left = event.pageX + 'px';
    contextMenu.style.top = event.pageY + 'px';
    
    const account = mxhAccounts.find(acc => acc.id === accountId);
    if (account) {
        // Configure notice toggle
        configureNoticeToggleFor('telegram-context-menu', account);
    }
    
    setTimeout(() => {
        document.addEventListener('click', hideTelegramContextMenu, { once: true });
    }, 100);
}

function hideTelegramContextMenu() {
    const contextMenu = document.getElementById('telegram-context-menu');
    if (contextMenu) {
        contextMenu.style.display = 'none';
    }
    resumeAutoRefresh();
}

// WeChat Context Actions with instant feedback
async function editCurrentContextAccount(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    const contextMenu = document.getElementById('wechat-context-menu');
    const isSecondary = contextMenu.dataset.isSecondary === 'true';
    openWeChatModal(currentContextAccountId, isSecondary);
    hideWeChatContextMenu();
}

async function markAccountAsScanned(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    const contextMenu = document.getElementById('wechat-context-menu');
    const isSecondary = contextMenu.dataset.isSecondary === 'true';
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        const scanCountKey = isSecondary ? 'secondary_wechat_scan_count' : 'wechat_scan_count';
        const lastScanKey = isSecondary ? 'secondary_wechat_last_scan_date' : 'wechat_last_scan_date';
        mxhAccounts[accountIndex][scanCountKey] = (mxhAccounts[accountIndex][scanCountKey] || 0) + 1;
        mxhAccounts[accountIndex][lastScanKey] = new Date().toISOString();
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/scan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_secondary: isSecondary })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ ƒë√°nh d·∫•u qu√©t!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
    hideWeChatContextMenu();
}

// Notice modal functions
let noticeTargetId = null;
function openNoticeModal(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    noticeTargetId = currentContextAccountId;
    document.getElementById('noticeTitle').value = 'Reg';
    document.getElementById('noticeDays').value = 5;
    document.getElementById('noticeNote').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('noticeModal'));
    modal.show();
    
    hideWeChatContextMenu();
    hideGenericContextMenu();
    hideTelegramContextMenu();
}

async function submitNotice() {
    const title = document.getElementById('noticeTitle').value.trim();
    const days = parseInt(document.getElementById('noticeDays').value, 10) || 0;
    const note = document.getElementById('noticeNote').value.trim();
    
    if (!noticeTargetId || !title || days <= 0) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'error');
        return;
    }
    
    try {
        // Pause auto-refresh to prevent race condition
        stopAutoRefresh();
        
        const response = await fetch(`/mxh/api/accounts/${noticeTargetId}/notice`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, days, note })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ ƒë·∫∑t th√¥ng b√°o!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('noticeModal'));
            modal.hide();
            
            // Update local data immediately to trigger render
            const account = mxhAccounts.find(a => a.id === noticeTargetId);
            if (account) {
                account.notice = {
                    enabled: true,
                    title: title,
                    days: days,
                    note: note,
                    start_at: new Date().toISOString()
                };
                console.log('‚úÖ Updated local notice for account', noticeTargetId, account.notice);
            }
            
            // Force re-render with updated data
            renderMXHAccounts();
            
            // Resume auto-refresh after render
            setTimeout(() => startAutoRefresh(), 100);
        } else {
            showToast('L·ªói khi ƒë·∫∑t th√¥ng b√°o!', 'error');
            startAutoRefresh(); // Resume even on error
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        startAutoRefresh(); // Resume even on error
    }
    noticeTargetId = null;
}

async function clearNotice(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    try {
        // Pause auto-refresh to prevent race condition
        stopAutoRefresh();
        
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/notice`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ t·∫Øt th√¥ng b√°o!', 'success');
            
            // Update local data immediately to trigger render
            const account = mxhAccounts.find(a => a.id === currentContextAccountId);
            if (account) {
                account.notice = {
                    enabled: false,
                    title: '',
                    days: 0,
                    note: '',
                    start_at: null
                };
                console.log('‚úÖ Cleared local notice for account', currentContextAccountId);
            }
            
            // Force re-render with updated data
            renderMXHAccounts();
            
            // Resume auto-refresh after render
            setTimeout(() => startAutoRefresh(), 100);
        } else {
            showToast('L·ªói khi x√≥a th√¥ng b√°o!', 'error');
            startAutoRefresh(); // Resume even on error
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        startAutoRefresh(); // Resume even on error
    }
    
    hideWeChatContextMenu();
    hideGenericContextMenu();
    hideTelegramContextMenu();
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

function copyPhoneNumber(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    const contextMenu = document.getElementById('wechat-context-menu');
    const isSecondary = contextMenu.dataset.isSecondary === 'true';
    
    const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
    if (account) {
        const phone = isSecondary ? account.secondary_phone : account.phone;
        if (phone) {
            navigator.clipboard.writeText(phone);
            showToast('ƒê√£ copy SƒêT!', 'success');
        }
    }
    hideWeChatContextMenu();
}

function copyEmail(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
    if (account && account.email) {
        navigator.clipboard.writeText(account.email);
        showToast('ƒê√£ copy Email!', 'success');
    }
    hideUnifiedContextMenu();
}

async function resetScanCount(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    const contextMenu = document.getElementById('wechat-context-menu');
    const isSecondary = contextMenu.dataset.isSecondary === 'true';
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        const scanCountKey = isSecondary ? 'secondary_wechat_scan_count' : 'wechat_scan_count';
        const lastScanKey = isSecondary ? 'secondary_wechat_last_scan_date' : 'wechat_last_scan_date';
        mxhAccounts[accountIndex][scanCountKey] = 0;
        mxhAccounts[accountIndex][lastScanKey] = null;
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/scan`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ reset: true, is_secondary: isSecondary })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ reset l∆∞·ª£t qu√©t!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
    hideWeChatContextMenu();
}

function changeCardNumber(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    const modal = new bootstrap.Modal(document.getElementById('change-card-number-modal'));
    modal.show();
    hideWeChatContextMenu();
}

async function toggleAccountStatus(event, accountId = null, isSecondary = null) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // If called from card click (with accountId parameter)
    if (accountId !== null) {
        currentContextAccountId = accountId;
    }
    
    if (!currentContextAccountId) return;
    
    // If isSecondary not provided, get from context menu
    if (isSecondary === null) {
        const contextMenu = document.getElementById('wechat-context-menu');
        isSecondary = contextMenu.dataset.isSecondary === 'true';
    }
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        const statusKey = isSecondary ? 'secondary_status' : 'status';
        const currentStatus = mxhAccounts[accountIndex][statusKey];
        mxhAccounts[accountIndex][statusKey] = currentStatus === 'disabled' ? 'active' : 'disabled';
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/toggle-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_secondary: isSecondary })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ thay ƒë·ªïi tr·∫°ng th√°i!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
    
    // Only hide context menu if it exists and is visible
    const contextMenu = document.getElementById('wechat-context-menu');
    if (contextMenu && contextMenu.style.display === 'block') {
        hideWeChatContextMenu();
    }
}

// ===== UPDATE ACCOUNT STATUS (Unified Menu) =====
async function updateAccountStatus(newStatus) {
    if (!currentContextAccountId) return;
    
    const isSecondary = currentEditingIsSecondary || false;
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        const statusKey = isSecondary ? 'secondary_status' : 'status';
        mxhAccounts[accountIndex][statusKey] = newStatus;
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                status: newStatus,
                is_secondary: isSecondary 
            })
        });
        
        if (response.ok) {
            const statusText = newStatus === 'active' ? 'Available' : 
                              newStatus === 'die' ? 'Die' : 'V√¥ hi·ªáu h√≥a';
            showToast(`‚úÖ ƒê√£ ƒë·ªïi sang ${statusText}!`, 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
}

// ===== RESCUE ACCOUNT (Unified Menu) =====
async function rescueAccountUnified(result) {
    if (!currentContextAccountId) return;
    
    const isSecondary = currentEditingIsSecondary || false;
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        if (result === 'success') {
            // C·ª©u th√†nh c√¥ng - chuy·ªÉn v·ªÅ active
            const statusKey = isSecondary ? 'secondary_status' : 'status';
            const dieKey = isSecondary ? 'secondary_die_date' : 'die_date';
            const rescueSuccessKey = isSecondary ? 'secondary_rescue_success_count' : 'rescue_success_count';
            
            mxhAccounts[accountIndex][statusKey] = 'active';
            mxhAccounts[accountIndex][dieKey] = null;
            mxhAccounts[accountIndex][rescueSuccessKey] = (mxhAccounts[accountIndex][rescueSuccessKey] || 0) + 1;
        } else {
            // C·ª©u th·∫•t b·∫°i - gi·ªØ disabled, tƒÉng rescue_count
            const rescueKey = isSecondary ? 'secondary_rescue_count' : 'rescue_count';
            mxhAccounts[accountIndex][rescueKey] = (mxhAccounts[accountIndex][rescueKey] || 0) + 1;
        }
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/rescue`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                result: result,
                is_secondary: isSecondary 
            })
        });
        
        if (response.ok) {
            const message = result === 'success' ? '‚úÖ ƒê√£ c·ª©u th√†nh c√¥ng!' : 'üìù ƒê√£ ghi nh·∫≠n c·ª©u th·∫•t b·∫°i!';
            showToast(message, 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
}

async function rescueAccount(result, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    const contextMenu = document.getElementById('wechat-context-menu');
    const isSecondary = contextMenu.dataset.isSecondary === 'true';
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        if (result === 'success') {
            const statusKey = isSecondary ? 'secondary_status' : 'status';
            const dieDateKey = isSecondary ? 'secondary_die_date' : 'die_date';
            const rescueSuccessKey = isSecondary ? 'secondary_rescue_success_count' : 'rescue_success_count';
            mxhAccounts[accountIndex][statusKey] = 'active';
            mxhAccounts[accountIndex][dieDateKey] = null;
            mxhAccounts[accountIndex][rescueSuccessKey] = (mxhAccounts[accountIndex][rescueSuccessKey] || 0) + 1;
        } else {
            const rescueCountKey = isSecondary ? 'secondary_rescue_count' : 'rescue_count';
            mxhAccounts[accountIndex][rescueCountKey] = (mxhAccounts[accountIndex][rescueCountKey] || 0) + 1;
        }
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/rescue`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ result: result, is_secondary: isSecondary })
        });
        
        if (response.ok) {
            showToast(result === 'success' ? '‚úÖ C·ª©u th√†nh c√¥ng!' : '‚úÖ ƒê√£ ghi nh·∫≠n!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
    hideWeChatContextMenu();
}

function showDeleteConfirm(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    const modal = new bootstrap.Modal(document.getElementById('delete-card-modal'));
    modal.show();
    hideWeChatContextMenu();
}

// Generic Account Actions
function editGenericAccount(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
    if (!account) return;
    
    document.getElementById('generic-username').value = account.login_username || '';
    document.getElementById('generic-password').value = account.login_password || '';
    document.getElementById('generic-display-name').value = account.username || '';
    document.getElementById('generic-phone').value = account.phone || '';
    document.getElementById('generic-url').value = account.url || '';
    
    const modal = new bootstrap.Modal(document.getElementById('generic-account-modal'));
    modal.show();
    hideGenericContextMenu();
}

function showGenericDeleteConfirm(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a card n√†y?')) {
        deleteAccount(currentContextAccountId);
    }
    hideGenericContextMenu();
}

async function deleteAccount(accountId) {
    // Instant local update - remove from array
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
    if (accountIndex !== -1) {
        mxhAccounts.splice(accountIndex, 1);
    }
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${accountId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ x√≥a card!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
}

// Telegram Context Menu Actions
async function copyTelegramPhone(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    if (!currentContextAccountId) return;
    
    const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
    if (!account || !account.phone) {
        showToast('‚ö†Ô∏è Kh√¥ng c√≥ s·ªë ƒëi·ªán tho·∫°i!', 'warning');
        hideTelegramContextMenu();
        return;
    }
    
    try {
        await navigator.clipboard.writeText(account.phone);
        showToast('üìã ƒê√£ copy s·ªë ƒëi·ªán tho·∫°i!', 'success');
    } catch (error) {
        // Fallback method
        const textArea = document.createElement('textarea');
        textArea.value = account.phone;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('üìã ƒê√£ copy s·ªë ƒëi·ªán tho·∫°i!', 'success');
    }
    
    hideTelegramContextMenu();
}

// Modal Button Handlers with instant updates
document.getElementById('mxh-save-account-btn').addEventListener('click', async () => {
    const username = document.getElementById('mxh-username').value;
    const platform = document.getElementById('mxh-platform').value;
    const url = document.getElementById('mxh-url').value;
    const day = document.getElementById('mxh-day').value;
    const month = document.getElementById('mxh-month').value;
    const year = document.getElementById('mxh-year').value;
    
    if (!username || !platform || !day || !month || !year) {
        showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!', 'error');
        return;
    }
    
    try {
        const groupId = await ensurePlatformGroup(platform);
        const cardNumber = await getNextCardNumber(groupId);
        
        const response = await fetch('/mxh/api/accounts', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                card_name: cardNumber.toString(),
                group_id: groupId,
                platform: platform,
                username: username,
                url: url,
                wechat_created_day: day,
                wechat_created_month: month,
                wechat_created_year: year
            })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ t·∫°o card!', 'success');
            
            // Clear and close
            document.getElementById('mxh-username').value = '';
            document.getElementById('mxh-platform').value = '';
            document.getElementById('mxh-url').value = '';
            document.getElementById('mxh-day').value = '';
            document.getElementById('mxh-month').value = '';
            document.getElementById('mxh-year').value = '';
            
            bootstrap.Modal.getInstance(document.getElementById('mxh-addAccountModal')).hide();
            
            // Reload to get new account
            await loadMXHData(false);
        } else {
            const error = await response.json();
            showToast(error.error || 'L·ªói!', 'error');
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
    }
});

document.getElementById('wechat-apply-btn').addEventListener('click', async () => {
    if (!currentContextAccountId) return;
    
    const selectedStatus = document.getElementById('wechat-status').value;
    const data = {
        card_name: document.getElementById('wechat-card-name').value,
        username: document.getElementById('wechat-username').value,
        phone: document.getElementById('wechat-phone').value,
        wechat_created_day: parseInt(document.getElementById('wechat-day').value),
        wechat_created_month: parseInt(document.getElementById('wechat-month').value),
        wechat_created_year: parseInt(document.getElementById('wechat-year').value),
        status: selectedStatus,
        is_secondary: currentEditingIsSecondary
    };
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        if (currentEditingIsSecondary) {
            mxhAccounts[accountIndex].secondary_card_name = data.card_name;
            mxhAccounts[accountIndex].secondary_username = data.username;
            mxhAccounts[accountIndex].secondary_phone = data.phone;
            mxhAccounts[accountIndex].secondary_wechat_created_day = data.wechat_created_day;
            mxhAccounts[accountIndex].secondary_wechat_created_month = data.wechat_created_month;
            mxhAccounts[accountIndex].secondary_wechat_created_year = data.wechat_created_year;
            mxhAccounts[accountIndex].secondary_status = data.status;
        } else {
            mxhAccounts[accountIndex].card_name = data.card_name;
            mxhAccounts[accountIndex].username = data.username;
            mxhAccounts[accountIndex].phone = data.phone;
            mxhAccounts[accountIndex].wechat_created_day = data.wechat_created_day;
            mxhAccounts[accountIndex].wechat_created_month = data.wechat_created_month;
            mxhAccounts[accountIndex].wechat_created_year = data.wechat_created_year;
            mxhAccounts[accountIndex].status = data.status;
        }
    }
    
    bootstrap.Modal.getInstance(document.getElementById('wechat-account-modal')).hide();
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t!', 'success');
        } else {
            const error = await response.json();
            showToast(error.error || 'L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
});

document.getElementById('generic-apply-btn').addEventListener('click', async () => {
    if (!currentContextAccountId) return;
    
    const data = {
        login_username: document.getElementById('generic-username').value,
        login_password: document.getElementById('generic-password').value,
        username: document.getElementById('generic-display-name').value,
        phone: document.getElementById('generic-phone').value,
        url: document.getElementById('generic-url').value
    };
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        Object.keys(data).forEach(key => {
            if (data[key] !== undefined && data[key] !== null) {
                mxhAccounts[accountIndex][key] = data[key];
            }
        });
    }
    
    bootstrap.Modal.getInstance(document.getElementById('generic-account-modal')).hide();
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
});

document.getElementById('apply-card-number-btn').addEventListener('click', async () => {
    if (!currentContextAccountId) return;
    
    const newNumber = document.getElementById('new-card-number').value;
    if (!newNumber) return;
    
    // Instant local update
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
    if (accountIndex !== -1) {
        mxhAccounts[accountIndex].card_name = newNumber;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('change-card-number-modal')).hide();
    renderMXHAccounts();
    
    try {
        const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ card_name: newNumber })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ ƒë·ªïi s·ªë hi·ªáu!', 'success');
        } else {
            showToast('L·ªói!', 'error');
            await loadMXHData(false);
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false);
    }
});

document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
    if (!currentContextAccountId) return;
    await deleteAccount(currentContextAccountId);
    bootstrap.Modal.getInstance(document.getElementById('delete-card-modal')).hide();
});

document.getElementById('mxh-apply-view-mode-btn').addEventListener('click', () => {
    const cardsPerRow = document.getElementById('mxh-cards-per-row').value;
    localStorage.setItem('mxh_cards_per_row', cardsPerRow);
    
    const style = document.getElementById('mxh-dynamic-style') || document.createElement('style');
    style.id = 'mxh-dynamic-style';
    style.innerHTML = `
        #mxh-accounts-container .row > .col {
            flex: 0 0 calc(100% / ${cardsPerRow});
            max-width: calc(100% / ${cardsPerRow});
        }
    `;
    if (!document.getElementById('mxh-dynamic-style')) {
        document.head.appendChild(style);
    }
    
    showToast(`ƒê√£ √°p d·ª•ng ${cardsPerRow} cards/h√†ng!`, 'success');
    bootstrap.Modal.getInstance(document.getElementById('mxh-view-mode-modal')).hide();
});

// Initialize cards per row setting
(function initializeCardsPerRow() {
    const savedCardsPerRow = localStorage.getItem('mxh_cards_per_row') || 12;
    const cardsPerRowInput = document.getElementById('mxh-cards-per-row');
    if (cardsPerRowInput) {
        cardsPerRowInput.value = savedCardsPerRow;
    }
    const style = document.createElement('style');
    style.id = 'mxh-dynamic-style';
    style.innerHTML = `
        #mxh-accounts-container .row > .col {
            flex: 0 0 calc(100% / ${savedCardsPerRow});
            max-width: calc(100% / ${savedCardsPerRow});
        }
    `;
    document.head.appendChild(style);
})();

// Initialize - Load data and start auto-refresh
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ MXH Tab Initializing...');
    
    // Initial load
    await loadMXHData(true);
    
    // Start auto-refresh
    startAutoRefresh();
    
    // Pause auto-refresh when modal is opened
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('show.bs.modal', () => {
            pauseAutoRefresh();
        });
        modal.addEventListener('hide.bs.modal', () => {
            resumeAutoRefresh();
        });
    });
    
    // Handle page visibility changes (pause when tab not visible)
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            stopAutoRefresh();
            console.log('‚è∏Ô∏è MXH Auto-refresh paused (tab hidden)');
        } else {
            startAutoRefresh();
            loadMXHData(true); // Immediate refresh when tab becomes visible
            console.log('‚ñ∂Ô∏è MXH Auto-refresh resumed (tab visible)');
        }
    });
    
    console.log('‚úÖ MXH Tab Ready - Real-time mode enabled!');
    
    // Event delegation for WeChat context menu
    document.getElementById('wechat-context-menu').addEventListener('click', (e) => {
        const menuItem = e.target.closest('.menu-item');
        if (!menuItem) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const action = menuItem.dataset.action;
        if (!action) return;
        
        switch(action) {
            case 'edit':
                editCurrentContextAccount(e);
                break;
            case 'mark-scanned':
                markAccountAsScanned(e);
                break;
            case 'set-notice':
                openNoticeModal(e);
                break;
            case 'clear-notice':
                clearNotice(e);
                break;
            case 'copy-phone':
                copyPhoneNumber(e);
                break;
            case 'reset-scan':
                resetScanCount(e);
                break;
            case 'change-number':
                changeCardNumber(e);
                break;
            case 'toggle-status':
                toggleAccountStatus(e);
                break;
            case 'rescue-success':
                rescueAccount('success', e);
                break;
            case 'rescue-failed':
                rescueAccount('failed', e);
                break;
            case 'delete':
                showDeleteConfirm(e);
                break;
        }
    });
    
    // Event delegation for Generic context menu
    document.getElementById('generic-context-menu').addEventListener('click', (e) => {
        const menuItem = e.target.closest('.menu-item');
        if (!menuItem) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const action = menuItem.dataset.action;
        if (!action) return;
        
        switch(action) {
            case 'set-notice':
                openNoticeModal(e);
                break;
            case 'clear-notice':
                clearNotice(e);
                break;
            case 'edit-generic':
                openGenericModal(e);
                break;
            case 'delete-generic':
                showDeleteConfirm(e);
                break;
        }
    });
    
    // Event delegation for Telegram context menu
    document.getElementById('telegram-context-menu').addEventListener('click', (e) => {
        const menuItem = e.target.closest('.menu-item');
        if (!menuItem) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const action = menuItem.dataset.action;
        if (!action) return;
        
        switch(action) {
            case 'set-notice':
                openNoticeModal(e);
                break;
            case 'clear-notice':
                clearNotice(e);
                break;
            case 'copy-phone-telegram':
                copyTelegramPhone(e);
                break;
            case 'edit-generic':
                openGenericModal(e);
                break;
            case 'delete-generic':
                showDeleteConfirm(e);
                break;
        }
    });
    
    // ===== UNIFIED CONTEXT MENU EVENT LISTENER =====
    document.getElementById('unified-context-menu').addEventListener('click', async (e) => {
        const menuItem = e.target.closest('.menu-item');
        if (!menuItem) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        const action = menuItem.dataset.action;
        if (!action) return;
        
        console.log('Unified menu action:', action);
        
        switch(action) {
            case 'edit':
                editCurrentContextAccount(e);
                break;
            case 'status-available':
                await updateAccountStatus('active');
                break;
            case 'status-die':
                await updateAccountStatus('die');
                break;
            case 'status-disabled':
                await updateAccountStatus('disabled');
                break;
            case 'rescue-success':
                await rescueAccountUnified('success');
                break;
            case 'rescue-failed':
                await rescueAccountUnified('failed');
                break;
            case 'mark-scanned':
                markAccountAsScanned(e);
                break;
            case 'set-notice':
                openNoticeModal(e);
                break;
            case 'clear-notice':
                clearNotice(e);
                break;
            case 'copy-phone':
                copyPhoneNumber(e);
                break;
            case 'copy-email':
                copyEmail(e);
                break;
            case 'reset-scan':
                resetScanCount(e);
                break;
            case 'change-number':
                changeCardNumber(e);
                break;
            case 'delete':
                showDeleteConfirm(e);
                break;
        }
        
        // Hide menu after action
        hideUnifiedContextMenu();
    });
});

// Flip Card Function - Click on account age to flip
window.flipCard = function(element, event) {
    event.stopPropagation();
    event.preventDefault();
    
    // Find the card container (traverse up the DOM)
    const cardContainer = element.closest('.mxh-card-container');
    if (cardContainer) {
        cardContainer.classList.toggle('flipped');
    }
};

// Test function for Telegram context menu
window.testTelegramMenu = function(event) {
    event.preventDefault();
    console.log('=== TESTING TELEGRAM MENU ===');
    
    // Check if menu element exists
    const menu = document.getElementById('telegram-context-menu');
    console.log('Menu element found:', !!menu);
    
    // Check if function exists
    console.log('showTelegramContextMenu function:', typeof window.showTelegramContextMenu);
    console.log('handleCardContextMenu function:', typeof window.handleCardContextMenu);
    
    // Try to show menu at mouse position
    if (menu && typeof window.showTelegramContextMenu === 'function') {
        window.showTelegramContextMenu(event, 121); // Test with known Telegram ID
        console.log('‚úÖ Menu should be visible now!');
    } else {
        console.error('‚ùå Menu or function not available!');
    }
};

// Open WeChat Modal Function
let currentEditingIsSecondary = false;
window.openWeChatModal = function(accountId, isSecondary = false) {
    const account = mxhAccounts.find(acc => acc.id === accountId);
    if (!account) return;
    
    currentContextAccountId = accountId;
    currentEditingIsSecondary = isSecondary;
    
    const modalTitle = document.querySelector('#wechat-account-modal .modal-title');
    
    if (isSecondary) {
        document.getElementById('wechat-card-name').value = account.secondary_card_name || account.card_name;
        document.getElementById('wechat-username').value = account.secondary_username || '';
        document.getElementById('wechat-phone').value = account.secondary_phone || '';
        document.getElementById('wechat-day').value = account.secondary_wechat_created_day || new Date().getDate();
        document.getElementById('wechat-month').value = account.secondary_wechat_created_month || new Date().getMonth() + 1;
        document.getElementById('wechat-year').value = account.secondary_wechat_created_year || new Date().getFullYear();
        
        let secondaryStatus = account.secondary_status || 'available';
        document.getElementById('wechat-status').value = secondaryStatus;
        
        if (modalTitle) modalTitle.innerHTML = '<i class="bi bi-wechat me-2"></i>T√†i Kho·∫£n Ph·ª•';
    } else {
        document.getElementById('wechat-card-name').value = account.card_name || '';
        document.getElementById('wechat-username').value = account.username || '';
        document.getElementById('wechat-phone').value = account.phone || '';
        document.getElementById('wechat-day').value = account.wechat_created_day || 1;
        document.getElementById('wechat-month').value = account.wechat_created_month || 1;
        document.getElementById('wechat-year').value = account.wechat_created_year || 2024;
        
        let primaryStatus = 'available';
        if (account.status === 'disabled') {
            primaryStatus = 'disabled';
        } else if (account.muted_until && new Date(account.muted_until) > new Date()) {
            primaryStatus = 'muted';
        }
        document.getElementById('wechat-status').value = primaryStatus;
        
        if (modalTitle) modalTitle.innerHTML = '<i class="bi bi-wechat me-2"></i>T√†i Kho·∫£n Ch√≠nh';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('wechat-account-modal'));
    modal.show();
};

// ===== INLINE EDITING FUNCTIONS WITH INSTANT UPDATES =====
// Quick update field (instant local update, debounced API call)
async function quickUpdateField(accountId, field, value, isSecondary) {
    try {
        // INSTANT LOCAL UPDATE - Update UI immediately
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
        if (accountIndex !== -1) {
            const fieldKey = isSecondary ? `secondary_${field}` : field;
            mxhAccounts[accountIndex][fieldKey] = value;
        }
        
        // API call in background
        const response = await fetch(`/mxh/api/accounts/${accountId}/quick-update`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                field: field,
                value: value,
                is_secondary: isSecondary
            })
        });
        
        if (response.ok) {
            showToast(`‚úÖ ƒê√£ l∆∞u ${field === 'username' ? 't√™n' : 'SƒêT'}!`, 'success');
            return true;
        } else {
            // Revert on error
            const error = await response.json();
            showToast(error.error || 'L·ªói khi c·∫≠p nh·∫≠t!', 'error');
            await loadMXHData(false); // Reload to get correct data
            return false;
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false); // Reload to get correct data
        return false;
    }
}

// Setup contenteditable fields
function setupEditableFields() {
    const editableFields = document.querySelectorAll('.editable-field');
    
    editableFields.forEach(field => {
        // Store original value
        field.dataset.originalValue = field.textContent.trim();
        
        // Handle Enter key - save and blur
        field.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                field.blur();
            }
        });
        
        // Handle Escape key - cancel and restore
        field.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                field.textContent = field.dataset.originalValue;
                field.blur();
            }
        });
        
        // Handle blur - save changes
        field.addEventListener('blur', async (e) => {
            let newValue = e.target.textContent.trim();
            const accountId = parseInt(e.target.dataset.accountId);
            const fieldName = e.target.dataset.field;
            const isSecondary = e.target.dataset.isSecondary === 'true';
            
            // Remove emoji prefix for phone
            if (fieldName === 'phone') {
                newValue = newValue.replace(/^üìû\s*/, '').trim();
            }
            
            // Skip if no change or placeholder text
            if (newValue === field.dataset.originalValue || 
                newValue === 'Click ƒë·ªÉ nh·∫≠p' || 
                newValue === '') {
                if (fieldName === 'phone') {
                    e.target.textContent = field.dataset.originalValue ? `üìû ${field.dataset.originalValue}` : 'üìû Click ƒë·ªÉ nh·∫≠p';
                } else {
                    e.target.textContent = field.dataset.originalValue || 'Click ƒë·ªÉ nh·∫≠p';
                }
                return;
            }
            
            // Save to backend
            const success = await quickUpdateField(accountId, fieldName, newValue, isSecondary);
            
            if (success) {
                field.dataset.originalValue = newValue;
                // Update display with emoji if phone
                if (fieldName === 'phone') {
                    e.target.textContent = `üìû ${newValue}`;
                }
            } else {
                // Restore original value on failure
                if (fieldName === 'phone') {
                    e.target.textContent = field.dataset.originalValue ? `üìû ${field.dataset.originalValue}` : 'üìû Click ƒë·ªÉ nh·∫≠p';
                } else {
                    e.target.textContent = field.dataset.originalValue || 'Click ƒë·ªÉ nh·∫≠p';
                }
            }
        });
        
        // Select all text on focus
        field.addEventListener('focus', (e) => {
            // Remove emoji prefix for easier editing
            if (e.target.dataset.field === 'phone') {
                const phone = e.target.textContent.replace(/^üìû\s*/, '').replace('Click ƒë·ªÉ nh·∫≠p', '').trim();
                e.target.textContent = phone;
            } else if (e.target.textContent.trim() === 'Click ƒë·ªÉ nh·∫≠p') {
                e.target.textContent = '';
            }
            
            // Select all text
            setTimeout(() => {
                const range = document.createRange();
                range.selectNodeContents(e.target);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            }, 0);
        });
    });
}

// Toggle account status (click on status to change) - INSTANT UPDATE NO RELOAD
window.toggleAccountStatus = async function(event, accountId, isSecondary) {
    event.stopPropagation();
    event.preventDefault();
    
    // Find the account and update locally FIRST (instant UI update)
    const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
    if (accountIndex === -1) return;
    
    const statusKey = isSecondary ? 'secondary_status' : 'status';
    const dieDateKey = isSecondary ? 'secondary_die_date' : 'die_date';
    const currentStatus = mxhAccounts[accountIndex][statusKey];
    
    // Toggle status locally
    const newStatus = currentStatus === 'disabled' ? 'active' : 'disabled';
    mxhAccounts[accountIndex][statusKey] = newStatus;
    
    // Update die_date
    if (newStatus === 'disabled') {
        mxhAccounts[accountIndex][dieDateKey] = new Date().toISOString();
    } else {
        mxhAccounts[accountIndex][dieDateKey] = null;
    }
    
    // Re-render immediately (no API call wait)
    renderMXHAccounts();
    
    // Then update backend in background
    try {
        const response = await fetch(`/mxh/api/accounts/${accountId}/toggle-status`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_secondary: isSecondary })
        });
        
        if (response.ok) {
            showToast('‚úÖ ƒê√£ thay ƒë·ªïi tr·∫°ng th√°i!', 'success');
        } else {
            // Revert on error
            const error = await response.json();
            showToast(error.error || 'L·ªói khi thay ƒë·ªïi tr·∫°ng th√°i!', 'error');
            await loadMXHData(false); // Reload to get correct data
        }
    } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi!', 'error');
        await loadMXHData(false); // Reload to get correct data
    }
};

</script>
{% endblock %}

