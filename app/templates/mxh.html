{% extends "layouts/base.html" %}

{% block title %}Quản lý MXH{% endblock %}

{% block head %}
    {{ super() }}
    <!-- MXH CSS (đặt SAU Bootstrap để override) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mxh.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid" style="padding: 0.5rem 1rem;">
    <!-- Action Buttons and Groups - All in one row -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <!-- WeChat Groups on the left -->
        <div class="d-flex gap-2 align-items-center flex-wrap" id="mxh-groups-nav">
            <!-- Groups will be rendered here by JavaScript -->
        </div>

        <!-- Action buttons on the right -->
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#mxh-view-mode-modal">
                <i class="bi bi-grid-3x3-gap me-1"></i> Chế Độ Xem
            </button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#mxh-addAccountModal">
                <i class="bi bi-plus-lg me-1"></i> Thêm Tài Khoản
            </button>
        </div>
    </div>

    <div id="mxh-accounts-container" style="--cardsPerRow: 6;">
        <!-- MXH accounts will be rendered here -->
        <div class="card">
            <div class="card-body text-center text-muted">
                <i class="bi bi-share-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                <h5 class="mt-3">Đang tải...</h5>
            </div>
        </div>
    </div>
</div>

<!-- MXH View Mode Modal -->
<div class="modal fade" id="mxh-view-mode-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-grid-3x3-gap me-2"></i>Chế Độ Xem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label for="mxh-cards-per-row" class="form-label">Số Cards Mỗi Hàng</label>
          <input type="number" class="form-control" id="mxh-cards-per-row" min="1" max="50" value="6">
          <div class="form-text">Ví dụ: 6 = 6 cards trên một hàng.</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
        <button type="button" class="btn btn-primary" id="mxh-apply-view-mode-btn">Áp dụng</button>
      </div>
    </div>
  </div>
</div>

<!-- MXH Add Account Modal -->
<div class="modal fade" id="mxh-addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Thêm Tài Khoản MXH</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="mxh-add-card-form">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label for="mxh-username" class="form-label mb-1">Tên Người Dùng</label>
                            <input type="text" class="form-control form-control-sm" id="mxh-username"
                                placeholder="Nhập tên người dùng...">
                        </div>
                        <div class="col-md-6">
                            <label for="mxh-platform" class="form-label mb-1">Nền Tảng</label>
                            <select class="form-select form-select-sm" id="mxh-platform" required>
                                <option value="">Chọn nền tảng...</option>
                                <option value="facebook">Facebook</option>
                                <option value="instagram">Instagram</option>
                                <option value="twitter">Twitter</option>
                                <option value="zalo">Zalo</option>
                                <option value="wechat">WeChat</option>
                                <option value="telegram">Telegram</option>
                                <option value="whatsapp">WhatsApp</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label for="mxh-password" class="form-label mb-1">Mật Khẩu</label>
                            <input type="text" class="form-control form-control-sm" id="mxh-password"
                                placeholder="Nhập mật khẩu...">
                        </div>
                        <div class="col-md-6">
                            <label for="mxh-phone" class="form-label mb-1">Số Điện Thoại</label>
                            <input type="text" class="form-control form-control-sm" id="mxh-phone"
                                placeholder="Nhập số điện thoại...">
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label for="mxh-url" class="form-label mb-1">URL (tùy chọn)</label>
                            <input type="url" class="form-control form-control-sm" id="mxh-url" placeholder="https://...">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label mb-1">Ngày Tạo</label>
                            <div class="row g-0">
                                <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto"
                                        id="mxh-day" placeholder="Ngày" min="1" max="31" maxlength="2" style="width:56px" required></div>
                                <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto"
                                        id="mxh-month" placeholder="Tháng" min="1" max="12" maxlength="2" style="width:56px" required>
                                </div>
                                <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto"
                                        id="mxh-year" placeholder="Năm" min="2020" max="2030" maxlength="4" style="width:76px" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary btn-sm" id="mxh-save-account-btn">Tạo Card</button>
            </div>
        </div>
    </div>
</div>

<!-- Unified Context Menu for All Platforms -->
<div id="unified-context-menu" class="custom-context-menu" style="display: none;">
    <!-- Tài khoản (with dynamic submenu) -->
    <div class="menu-item has-submenu" id="accounts-submenu-item">
        <i class="bi bi-person-badge me-2"></i> Tài khoản
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="accounts-submenu">
            <!-- Dynamic content will be generated here -->
        </div>
    </div>

    <!-- Thông tin -->
    <div class="menu-item" data-action="edit">
        <i class="bi bi-pencil-square me-2"></i> Thông tin
    </div>

    <!-- Trạng Thái (with submenu) -->
    <div class="menu-item has-submenu" id="status-submenu-item">
        <i class="bi bi-circle-fill me-2"></i> Trạng Thái
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="status-submenu">
            <div class="menu-item status-normal" data-action="status-available">
                <i class="bi bi-check-circle-fill me-2 text-success"></i> Available
            </div>
            <div class="menu-item status-normal" data-action="status-die">
                <i class="bi bi-x-circle-fill me-2 text-danger"></i> Die
            </div>
            <div class="menu-item status-normal" data-action="status-disabled">
                <i class="bi bi-slash-circle me-2 text-warning"></i> Vô hiệu hóa
            </div>
            <!-- Rescue options (shown when disabled) -->
            <div class="menu-item status-rescue" data-action="rescue-success" style="display: none;">
                <i class="bi bi-heart-fill me-2 text-success"></i> Được Cứu
            </div>
            <div class="menu-item status-rescue" data-action="rescue-failed" style="display: none;">
                <i class="bi bi-heartbreak-fill me-2 text-danger"></i> Cứu Thất Bại
            </div>
        </div>
    </div>

    <!-- Copy SĐT -->
    <div class="menu-item" data-action="copy-phone" id="copy-phone-item" style="display: none;">
        <i class="bi bi-copy me-2"></i> Copy SĐT
    </div>

    <!-- Thông báo -->
    <div class="menu-item" id="unified-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Thông báo
    </div>

    <!-- Copy Email -->
    <div class="menu-item" data-action="copy-email" id="copy-email-item" style="display: none;">
        <i class="bi bi-envelope me-2"></i> Copy Email
    </div>

    <!-- WeChat specific: Quét submenu -->
    <div class="menu-item has-submenu wechat-only" id="scan-options-item" style="display: none;">
        <i class="bi bi-qr-code me-2"></i> Quét
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="scan-submenu">
            <div class="menu-item" data-action="mark-scanned">
                <i class="bi bi-check-circle-fill me-2"></i> Đã Quét
            </div>
            <div class="menu-item" data-action="reset-scan">
                <i class="bi bi-arrow-clockwise me-2"></i> Reset lượt quét
            </div>
        </div>
    </div>

    <!-- Đổi số hiệu -->
    <div class="menu-item" data-action="change-number">
        <i class="bi bi-123 me-2"></i> Đổi số hiệu
    </div>

    <!-- Xóa Card -->
    <div class="menu-item" data-action="delete" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> Xóa Card
    </div>
</div>

<!-- WeChat Account Modal -->
<div class="modal fade" id="wechat-account-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-wechat me-2"></i>Thông Tin</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-auto">
                        <label class="form-label mb-1">Số Card</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-card-name" maxlength="3" style="width: 60px;" required>
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">Ngày Tạo</label>
                        <div class="row g-0">
                            <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto" id="wechat-day" placeholder="Ngày" min="1" max="31" maxlength="2" style="width:56px" required></div>
                            <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto" id="wechat-month" placeholder="Tháng" min="1" max="12" maxlength="2" style="width:56px" required></div>
                            <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto" id="wechat-year" placeholder="Năm" min="2020" max="2030" maxlength="4" style="width:76px" required></div>
                        </div>
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">Trạng Thái</label>
                        <select class="form-select form-select-sm" id="wechat-status" style="width: 120px;" required>
                            <option value="active">Available</option>
                            <option value="disabled">Vô hiệu hóa</option>
                            <option value="die">Die</option>
                            <option value="muted">Muted</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label class="form-label mb-1">Tên Người Dùng</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-username" required>
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">Số Điện Thoại</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-phone" placeholder="Nhập số điện thoại..." maxlength="13" style="width: 150px;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger btn-sm" id="wechat-reset-btn">Reset</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="wechat-apply-btn">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Notice Modal -->
<div class="modal fade" id="noticeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-bell-fill me-2"></i>Đặt Thông Báo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-8">
                        <label for="noticeTitle" class="form-label">Tiêu đề</label>
                        <input type="text" class="form-control" id="noticeTitle" placeholder="Ví dụ: Sắp hết hạn">
                    </div>
                    <div class="col-4">
                        <label for="noticeDatetime" class="form-label">Thời gian</label>
                        <input type="datetime-local" class="form-control" id="noticeDatetime">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="noticeContent" class="form-label">Nội dung</label>
                    <textarea class="form-control" id="noticeContent" rows="3"
                        placeholder="Nội dung chi tiết..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger me-auto" id="clearNoticeBtn">Xóa Thông Báo</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="submitNoticeBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác Nhận Xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa card này không?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/mxh.js') }}"></script>
{% endblock %}