{% extends "layouts/base.html" %}

{% block content %}
<div class="container-fluid" style="padding: 0.5rem 1rem;">
    <!-- Action Buttons and Groups - All in one row -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <!-- WeChat Groups on the left -->
        <div class="d-flex gap-2 align-items-center flex-wrap" id="mxh-groups-nav">
            <!-- Groups will be rendered here by JavaScript -->
        </div>

        <!-- Action buttons on the right -->
        <div class="d-flex gap-2 align-items-center flex-wrap">
            <button class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#mxh-view-mode-modal">
                <i class="bi bi-grid-3x3-gap me-1"></i> Chế Độ Xem
            </button>
            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#mxh-addAccountModal">
                <i class="bi bi-plus-lg me-1"></i> Thêm Tài Khoản
            </button>
        </div>
    </div>

    <div id="mxh-accounts-container">
        <!-- MXH accounts will be rendered here -->
        <div class="card">
            <div class="card-body text-center text-muted">
                <i class="bi bi-share-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                <h5 class="mt-3">Đang tải...</h5>
            </div>
        </div>
    </div>
</div>

<!-- MXH View Mode Modal -->
<div class="modal fade" id="mxh-view-mode-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-grid-3x3-gap me-2"></i>Chế Độ Xem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="mxh-cards-per-row" class="form-label">Số Cards Mỗi Hàng</label>
                    <input type="number" class="form-control" id="mxh-cards-per-row"
                        placeholder="Nhập số cards mỗi hàng..." min="1" max="20" value="12">
                    <div class="form-text">Nhập số từ 1 đến 20. Ví dụ: 12 = 12 cards mỗi hàng</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="mxh-apply-view-mode-btn">Áp Dụng</button>
            </div>
        </div>
    </div>
</div>

<!-- MXH Add Account Modal -->
<div class="modal fade" id="mxh-addAccountModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-lg me-2"></i>Thêm Tài Khoản MXH</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="mxh-username" class="form-label mb-1">Tên Người Dùng</label>
                        <input type="text" class="form-control form-control-sm" id="mxh-username"
                            placeholder="Nhập tên người dùng...">
                    </div>
                    <div class="col-md-6">
                        <label for="mxh-platform" class="form-label mb-1">Nền Tảng</label>
                        <select class="form-select form-select-sm" id="mxh-platform" required>
                            <option value="">Chọn nền tảng...</option>
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter</option>
                            <option value="zalo">Zalo</option>
                            <option value="wechat">WeChat</option>
                            <option value="telegram">Telegram</option>
                            <option value="whatsapp">WhatsApp</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="mxh-password" class="form-label mb-1">Mật Khẩu</label>
                        <input type="text" class="form-control form-control-sm" id="mxh-password"
                            placeholder="Nhập mật khẩu...">
                    </div>
                    <div class="col-md-6">
                        <label for="mxh-phone" class="form-label mb-1">Số Điện Thoại</label>
                        <input type="text" class="form-control form-control-sm" id="mxh-phone"
                            placeholder="Nhập số điện thoại...">
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label for="mxh-url" class="form-label mb-1">URL (tùy chọn)</label>
                        <input type="url" class="form-control form-control-sm" id="mxh-url" placeholder="https://...">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Ngày Tạo</label>
                        <div class="row g-0">
                            <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto"
                                    id="mxh-day" placeholder="Ngày" min="1" max="31" maxlength="2" style="width:56px" required></div>
                            <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto"
                                    id="mxh-month" placeholder="Tháng" min="1" max="12" maxlength="2" style="width:56px" required>
                            </div>
                            <div class="col-auto"><input type="number" class="form-control form-control-sm w-auto"
                                    id="mxh-year" placeholder="Năm" min="2020" max="2030" maxlength="4" style="width:76px" required>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary btn-sm" id="mxh-save-account-btn">Tạo Card</button>
            </div>
        </div>
    </div>
</div>

<!-- WeChat Context Menu -->
<!-- Unified Context Menu for All Platforms -->
<div id="unified-context-menu" class="custom-context-menu" style="display: none;">
    <!-- Tài khoản (with dynamic submenu) -->
    <div class="menu-item has-submenu" id="accounts-submenu-item">
        <i class="bi bi-person-badge me-2"></i> Tài khoản
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="accounts-submenu">
            <!-- Dynamic content will be generated here -->
        </div>
    </div>

    <!-- Thông tin -->
    <div class="menu-item" data-action="edit">
        <i class="bi bi-pencil-square me-2"></i> Thông tin
    </div>

    <!-- Trạng Thái (with submenu) -->
    <div class="menu-item has-submenu" id="status-submenu-item">
        <i class="bi bi-circle-fill me-2"></i> Trạng Thái
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="status-submenu">
            <div class="menu-item status-normal" data-action="status-available">
                <i class="bi bi-check-circle-fill me-2 text-success"></i> Available
            </div>
            <div class="menu-item status-normal" data-action="status-die">
                <i class="bi bi-x-circle-fill me-2 text-danger"></i> Die
            </div>
            <div class="menu-item status-normal" data-action="status-disabled">
                <i class="bi bi-slash-circle me-2 text-warning"></i> Vô hiệu hóa
            </div>
            <!-- Rescue options (shown when disabled) -->
            <div class="menu-item status-rescue" data-action="rescue-success" style="display: none;">
                <i class="bi bi-heart-fill me-2 text-success"></i> Được Cứu
            </div>
            <div class="menu-item status-rescue" data-action="rescue-failed" style="display: none;">
                <i class="bi bi-heartbreak-fill me-2 text-danger"></i> Cứu Thất Bại
            </div>
        </div>
    </div>

    <!-- Copy SĐT -->
    <div class="menu-item" data-action="copy-phone" id="copy-phone-item" style="display: none;">
        <i class="bi bi-copy me-2"></i> Copy SĐT
    </div>

    <!-- Thông báo -->
    <div class="menu-item" id="unified-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Thông báo
    </div>

    <!-- Copy Email -->
    <div class="menu-item" data-action="copy-email" id="copy-email-item" style="display: none;">
        <i class="bi bi-envelope me-2"></i> Copy Email
    </div>

    <!-- WeChat specific: Quét submenu -->
    <div class="menu-item has-submenu wechat-only" id="scan-options-item" style="display: none;">
        <i class="bi bi-qr-code me-2"></i> Quét
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="scan-submenu">
            <div class="menu-item" data-action="mark-scanned">
                <i class="bi bi-check-circle-fill me-2"></i> Đã Quét
            </div>
            <div class="menu-item" data-action="reset-scan">
                <i class="bi bi-arrow-clockwise me-2"></i> Reset lượt quét
            </div>
        </div>
    </div>

    <!-- Đổi số hiệu -->
    <div class="menu-item" data-action="change-number">
        <i class="bi bi-123 me-2"></i> Đổi số hiệu
    </div>

    <!-- Xóa Card -->
    <div class="menu-item" data-action="delete" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> Xóa Card
    </div>
</div>

<!-- Legacy menus (keep for backward compatibility, will be removed later) -->
<div id="wechat-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" data-action="edit">
        <i class="bi bi-pencil-square me-2"></i> Chỉnh sửa thông tin
    </div>
    <div class="menu-item" data-action="mark-scanned">
        <i class="bi bi-check-circle-fill me-2"></i> Đã Quét
    </div>
    <div class="menu-item" id="wechat-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Thông báo
    </div>
    <div class="menu-item" data-action="copy-phone" id="copy-phone-item-old" style="display: none;">
        <i class="bi bi-copy me-2"></i> Copy SĐT
    </div>
    <div class="menu-item" data-action="reset-scan">
        <i class="bi bi-arrow-clockwise me-2"></i> Reset lượt quét
    </div>
    <div class="menu-item" data-action="change-number">
        <i class="bi bi-123 me-2"></i> Đổi số hiệu
    </div>
    <div class="menu-item" data-action="toggle-status" id="toggle-status-item">
        <i class="bi bi-x-circle-fill me-2"></i> Vô hiệu hóa
    </div>
    <div class="menu-item has-submenu" id="rescue-options-item" style="display: none;">
        <i class="bi bi-heart-pulse me-2"></i> Cứu tài khoản
        <i class="bi bi-chevron-right ms-auto"></i>
        <div class="submenu" id="rescue-submenu">
            <div class="menu-item" data-action="rescue-success">
                <i class="bi bi-check-circle-fill me-2 text-success"></i> Cứu thành công
            </div>
            <div class="menu-item" data-action="rescue-failed">
                <i class="bi bi-x-circle-fill me-2 text-danger"></i> Cứu thất bại
            </div>
        </div>
    </div>
    <div class="menu-item" data-action="delete" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> Xóa Card
    </div>
</div>

<!-- Telegram Context Menu -->
<div id="telegram-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" id="telegram-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Thông báo
    </div>
    <div class="menu-item" data-action="copy-phone-telegram">
        <i class="bi bi-telephone-fill me-2"></i> Copy SĐT
    </div>
    <div class="menu-item" data-action="edit-generic">
        <i class="bi bi-pencil-square me-2"></i> Chỉnh sửa thông tin
    </div>
    <div class="menu-item" data-action="delete-generic" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> Xóa Card
    </div>
</div>

<!-- Generic Platform Context Menu -->
<div id="generic-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" id="generic-notice-toggle" data-action="set-notice">
        <i class="bi bi-bell-fill me-2"></i> Thông báo
    </div>
    <div class="menu-item" data-action="edit-generic">
        <i class="bi bi-pencil-square me-2"></i> Chỉnh sửa thông tin
    </div>
    <div class="menu-item" data-action="delete-generic" style="color: #dc3545;">
        <i class="bi bi-trash-fill me-2"></i> Xóa Card
    </div>
</div>

<!-- MXH Background Context Menu -->
<div id="mxh-background-context-menu" class="custom-context-menu" style="display: none;">
    <div class="menu-item" data-action="view-mode">
        <i class="bi bi-grid-3x3-gap me-2"></i> Chế Độ Xem
    </div>
    <div class="menu-item" data-action="add-account">
        <i class="bi bi-plus-lg me-2"></i> + Thêm Tài Khoản MXH
    </div>
</div>

<!-- WeChat Account Modal -->
<div class="modal fade" id="wechat-account-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-wechat me-2"></i>Thông Tin Tài Khoản WeChat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-2">
                    <div class="col-3">
                        <label class="form-label mb-1">Số Card</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-card-name" maxlength="3" required>
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">Ngày Tạo</label>
                        <div class="d-flex gap-1">
                            <input type="number" class="form-control form-control-sm" id="wechat-day" placeholder="19" min="1" max="31" maxlength="2" style="width:50px" required>
                            <input type="number" class="form-control form-control-sm" id="wechat-month" placeholder="10" min="1" max="12" maxlength="2" style="width:50px" required>
                            <input type="number" class="form-control form-control-sm" id="wechat-year" placeholder="2025" min="2020" max="2030" maxlength="4" style="width:70px" required>
                        </div>
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-1">Trạng Thái</label>
                        <select class="form-select form-select-sm" id="wechat-status" required>
                            <option value="active">Available</option>
                            <option value="disabled">Vô hiệu hóa</option>
                            <option value="die">Die</option>
                            <option value="muted">Muted</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label class="form-label mb-1">Tên Người Dùng</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-username" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label mb-1">Số Điện Thoại</label>
                        <input type="text" class="form-control form-control-sm" id="wechat-phone" placeholder="Nhập số điện thoại..." maxlength="13">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger btn-sm" id="wechat-reset-btn">Reset</button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="wechat-apply-btn">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Generic Account Edit Modal -->
<div class="modal fade" id="generic-account-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="generic-account-edit-form">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Thông Tin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-2">
                        <div class="col-md-6">
                            <label for="generic-username" class="form-label mb-1">Tên đăng nhập</label>
                            <input type="text" class="form-control form-control-sm" id="generic-username"
                                placeholder="Nhập tên đăng nhập...">
                        </div>
                        <div class="col-md-6">
                            <label for="generic-password" class="form-label mb-1">Mật khẩu</label>
                            <input type="password" class="form-control form-control-sm" id="generic-password"
                                placeholder="Nhập mật khẩu...">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="generic-display-name" class="form-label mb-1">Tên người dùng</label>
                        <input type="text" class="form-control form-control-sm" id="generic-display-name"
                            placeholder="Nhập tên người dùng...">
                    </div>
                    <div class="mb-2">
                        <label for="generic-phone" class="form-label mb-1">Số điện thoại</label>
                        <input type="text" class="form-control form-control-sm" id="generic-phone"
                            placeholder="Nhập số điện thoại...">
                    </div>
                    <div class="mb-2">
                        <label for="generic-url" class="form-label mb-1">URL</label>
                        <input type="url" class="form-control form-control-sm" id="generic-url" placeholder="Nhập URL...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger btn-sm" id="generic-reset-btn">Reset</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary btn-sm" id="generic-apply-btn">Áp dụng</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Change Card Number Modal -->
<div class="modal fade" id="change-card-number-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-123 me-2"></i>Đổi Số Hiệu Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="new-card-number" class="form-label">Số hiệu mới</label>
                    <input type="number" class="form-control" id="new-card-number" placeholder="Nhập số hiệu mới..."
                        min="1" required>
                    <div class="form-text">Nhập số hiệu mới cho card này</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="apply-card-number-btn">Áp Dụng</button>
            </div>
        </div>
    </div>
</div>

<!-- Notice Modal -->
<div class="modal fade" id="noticeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-bell-fill me-2"></i>Đặt Thông Báo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-8">
                        <label for="noticeTitle" class="form-label">Tiêu Đề</label>
                        <input type="text" class="form-control" id="noticeTitle" placeholder="Câm" value="Câm">
                    </div>
                    <div class="col-4">
                        <label for="noticeDays" class="form-label">Số ngày</label>
                        <input type="number" class="form-control" id="noticeDays" min="1" step="1" value="30">
                    </div>
                </div>
                <div class="mb-3">
                    <textarea class="form-control" id="noticeNote" rows="3" placeholder="Ghi chú..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="submitNotice()">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="delete-card-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2 text-warning"></i>Xác Nhận Xóa Card
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa card này không?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Lưu ý:</strong> Hành động này không thể hoàn tác. Tất cả dữ liệu của card sẽ bị xóa vĩnh
                    viễn.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy Bỏ</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Xác Nhận Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Card Confirmation Modal -->
<div class="modal fade" id="reset-card-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-arrow-clockwise me-2 text-danger"></i>Xác Nhận Reset Card</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn reset card này không?</p>
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <strong>Lưu ý:</strong> Hành động này sẽ xóa tất cả thông tin và lịch sử của card:
                    <ul class="mb-0 mt-2">
                        <li>Thông tin tài khoản chính và phụ</li>
                        <li>Lịch sử quét QR</li>
                        <li>Trạng thái vô hiệu hóa</li>
                        <li>Lịch sử vi phạm và cứu tài khoản</li>
                        <li>Tất cả dữ liệu khác</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-reset-btn">Apply</button>
            </div>
        </div>
    </div>
</div>

<style>
/* ========================================
   FLIP CARD 3D CSS
   ======================================== */

/* Card wrapper với perspective */
.mxh-card-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 140px;
    perspective: 1200px;
}

/* Card inner - container cho 2 mặt */
.mxh-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    min-height: 140px;
    transform-style: preserve-3d;
    transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
}

/* Khi flipped */
.mxh-card-wrapper.flipped .mxh-card-inner {
    transform: rotateY(180deg);
}

/* Card face - front & back */
.mxh-card-face {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* Front face */
.mxh-card-face.front {
    transform: rotateY(0deg);
    z-index: 2;
}

/* Back face */
.mxh-card-face.back {
    transform: rotateY(180deg);
    z-index: 1;
}

/* Click vào số card để flip */
.card-number {
    cursor: pointer;
    transition: color 0.2s;
}

.card-number:hover {
    color: #00e0ff !important;
}

/* ========================================
   CONTEXT MENU SUBMENU
   ======================================== */

.mxh-context-menu {
    position: fixed;
    z-index: 10000;
    background: #2c3340;
    border: 1px solid #444a59;
    border-radius: 8px;
    padding: 4px;
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

.mxh-menu-item {
    padding: 8px 12px;
    color: #e6e6e6;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
    position: relative;
    white-space: nowrap;
}

.mxh-menu-item:hover {
    background: rgba(0, 224, 255, 0.15);
    color: #00e0ff;
}

.mxh-menu-item.has-submenu > span::after {
    content: '▶';
    float: right;
    margin-left: 12px;
    font-size: 0.8em;
    opacity: 0.6;
}

.mxh-submenu {
    position: absolute;
    left: calc(100% - 2px); /* Overlap để giữ hover */
    top: -4px;
    margin-left: 0;
    display: none;
    background: #2c3340;
    border: 1px solid #444a59;
    border-radius: 8px;
    padding: 4px;
    min-width: 200px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 10001;
}

.mxh-menu-item.has-submenu:hover > .mxh-submenu,
.mxh-submenu:hover {
    display: block !important;
}

.mxh-submenu .mxh-menu-item {
    padding: 6px 10px;
    font-size: 0.9em;
}

/* ========================================
   BORDER COLORS (Viền Card)
   ======================================== */

.mxh-border-red {
    border: 2px solid #ff4d4f !important;
    box-shadow: 0 0 0 1px rgba(255, 77, 79, 0.3), 0 0 12px rgba(255, 77, 79, 0.4) !important;
}

.mxh-border-orange {
    border: 2px solid #ffa500 !important;
    box-shadow: 0 0 0 1px rgba(255, 165, 0, 0.3), 0 0 12px rgba(255, 165, 0, 0.4) !important;
}

.mxh-border-green {
    border: 2px solid #07c160 !important;
    box-shadow: 0 0 0 1px rgba(7, 193, 96, 0.3), 0 0 12px rgba(7, 193, 96, 0.4) !important;
}

.mxh-border-white {
    border: 2px solid #ffffff !important;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3), 0 0 12px rgba(255, 255, 255, 0.4) !important;
}
</style>

<script>
    // ===== MXH REAL-TIME CONFIGURATION =====
    const MXH_CONFIG = {
        AUTO_REFRESH_INTERVAL: 15000, // Changed from 3000 to 15000ms (15 seconds)
        DEBOUNCE_DELAY: 500, // Debounce for inline editing
        RENDER_BATCH_SIZE: 50, // Cards to render per batch (for smooth rendering)
        ENABLE_AUTO_REFRESH: true // Changed from false to true
    };

    // MXH Global State
    let mxhGroups = [];
    let mxhAccounts = [];
    let currentContextAccountId = null;
    let currentContextCardId = null; // NEW: For card-based context menu
    let autoRefreshTimer = null;
    let isRendering = false;
    let pendingUpdates = false;
    let activeGroupId = null;
    let lastUpdateTime = null; // NEW: Store the timestamp of the last successful data load // null = show all groups, otherwise show specific group only
    
    // NEW: Card States Management (cardId => { activeAccountId, isFlipped })
    const cardStates = new Map();
    
    function getCardState(cardId) {
        if (!cardStates.has(cardId)) {
            cardStates.set(cardId, { activeAccountId: null, isFlipped: false });
        }
        return cardStates.get(cardId);
    }
    
    function setCardState(cardId, updates) {
        const state = getCardState(cardId);
        Object.assign(state, updates);
    }

    // ===== PERFORMANCE OPTIMIZATION UTILITIES =====
    // Debounce function - prevents excessive API calls
    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // Throttle function - ensures function runs at most once per interval
    function throttle(func, interval) {
        let lastCall = 0;
        return function (...args) {
            const now = Date.now();
            if (now - lastCall >= interval) {
                lastCall = now;
                func.apply(this, args);
            }
        };
    }


    // ===== REAL-TIME DATA LOADING WITH SMART UPDATES =====
    // Load MXH data from API with optimized rendering
    async function loadMXHData(forceRender = true) {
        try {
            // Check lastUpdateTime for delta polling
            const accountsUrl = lastUpdateTime 
                ? `/mxh/api/accounts?last_updated_at=${lastUpdateTime}` 
                : '/mxh/api/accounts';
                
            // Parallel loading for speed
            const [groupsResponse, accountsResponse] = await Promise.all([
                fetch('/mxh/api/groups'),
                fetch(accountsUrl) // Use the dynamic URL
            ]);

            if (groupsResponse.ok) {
                mxhGroups = await groupsResponse.json();
            }

            if (accountsResponse.ok) {
                const newAccountsDelta = await accountsResponse.json();
                
                let dataChanged = false;

                if (newAccountsDelta.length > 0) {
                    dataChanged = true;
                    // MERGE LOGIC: Replace/Update existing accounts with delta
                    const accountMap = new Map(mxhAccounts.map(acc => [acc.id, acc]));
                    
                    newAccountsDelta.forEach(deltaAcc => {
                        accountMap.set(deltaAcc.id, deltaAcc);
                    });
                    
                    mxhAccounts = Array.from(accountMap.values());
                    
                    // Update lastUpdateTime with the latest timestamp from the delta
                    // Use the *current* time if the delta is empty or the updated_at field is missing
                    const latestTimestamp = newAccountsDelta.reduce((latest, acc) => {
                        return (acc.updated_at && acc.updated_at > latest) ? acc.updated_at : latest;
                    }, lastUpdateTime || new Date(0).toISOString());
                    
                    lastUpdateTime = latestTimestamp;
                }

                // Debug: log first account with notice
                const accWithNotice = mxhAccounts.find(a => a.notice && a.notice.enabled);
                if (accWithNotice) {
                    // Debug disabled
                }

                // console.log('loadMXHData:', { forceRender, dataChanged, totalAccounts: mxhAccounts.length });

                if (forceRender || dataChanged) {
                    renderGroupsNav(); // Render groups navigation first
                    if (!isRendering) {
                        renderMXHAccounts();
                    } else {
                        pendingUpdates = true;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading MXH data:', error);
            document.getElementById('mxh-accounts-container').innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Lỗi kết nối API! Đang thử kết nối lại...
            </div>
        `;
        }
    }

    // ===== AUTO-REFRESH SYSTEM =====
    function startAutoRefresh() {
        if (!MXH_CONFIG.ENABLE_AUTO_REFRESH) return;

        stopAutoRefresh(); // Clear any existing timer

        autoRefreshTimer = setInterval(async () => {
            await loadMXHData(false); // Don't force render, only if data changed
        }, MXH_CONFIG.AUTO_REFRESH_INTERVAL);

        // console.log('✅ MXH Auto-refresh enabled (every', MXH_CONFIG.AUTO_REFRESH_INTERVAL / 1000, 'seconds)');
    }

    function stopAutoRefresh() {
        if (autoRefreshTimer) {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = null;
        }
    }

    // Pause auto-refresh when user is interacting (context menu open, modal open, etc.)
    let interactionPaused = false;
    function pauseAutoRefresh() {
        interactionPaused = true;
    }

    function resumeAutoRefresh() {
        interactionPaused = false;
    }

    // Ensure platform group exists
    async function ensurePlatformGroup(platform) {
        const existingGroup = mxhGroups.find(g => g.name.toLowerCase() === platform.toLowerCase());
        if (existingGroup) {
            return existingGroup.id;
        }

        try {
            const response = await fetch('/mxh/api/groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: platform.charAt(0).toUpperCase() + platform.slice(1),
                    color: getPlatformColor(platform)
                })
            });

            if (response.ok) {
                const newGroup = await response.json();
                mxhGroups.push(newGroup);
                return newGroup.id;
            } else {
                throw new Error('Failed to create group');
            }
        } catch (error) {
            console.error('Error creating platform group:', error);
            throw error;
        }
    }

    // Get platform color
    function getPlatformColor(platform) {
        const colors = {
            'facebook': '#1877f2',
            'instagram': '#e4405f',
            'twitter': '#1da1f2',
            'zalo': '#0068ff',
            'wechat': '#07c160',
            'telegram': '#0088cc',
            'whatsapp': '#25d366'
        };
        return colors[platform] || '#6c757d';
    }

    function getPlatformIconClass(platform) {
        const p = String(platform || '').toLowerCase();
        return ({
            wechat: 'bi-wechat',
            telegram: 'bi-telegram',
            facebook: 'bi-facebook',
            instagram: 'bi-instagram',
            zalo: 'bi-chat-dots-fill',   // không có icon Zalo -> dùng chat
            twitter: 'bi-twitter',
            whatsapp: 'bi-whatsapp'
        }[p]) || 'bi-person-badge';
    }

    // Global flip card function
    window.flipCard = function (el, event) {
        if (event) { event.preventDefault(); event.stopPropagation(); }
        const wrap = el.closest('.mxh-card-container');
        if (wrap) wrap.classList.toggle('flipped');
    };

    // Get next card number (per platform/group)
    async function getNextCardNumber(groupId) {
        // Get all accounts in the same group
        const groupAccounts = mxhAccounts.filter(acc => acc.group_id === groupId);
        const numbers = groupAccounts.map(acc => parseInt(acc.card_name)).filter(n => !isNaN(n));

        if (numbers.length === 0) return 1;

        // Find first available number starting from 1
        for (let i = 1; i <= numbers.length + 1; i++) {
            if (!numbers.includes(i)) {
                return i;
            }
        }
        return Math.max(...numbers) + 1;
    }

    // Toggle group visibility
    // ===== RENDER GROUP NAVIGATION WITH BADGES =====
    function renderGroupsNav() {
        const groupsNavContainer = document.getElementById('mxh-groups-nav');
        if (!groupsNavContainer) return;

        let html = '';

        // Get unique groups from accounts
        const uniqueGroupIds = [...new Set(mxhAccounts.map(acc => acc.group_id).filter(id => id))];

        uniqueGroupIds.forEach(groupId => {
            const group = mxhGroups.find(g => g.id == groupId);
            if (group) {
                // Calculate badge count for this group
                const badgeCount = calculateGroupBadge(groupId);
                const isActive = activeGroupId === groupId;

                html += `
                <button class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-light'}" 
                        onclick="selectGroup('${groupId}')"
                        style="position: relative; ${isActive ? '' : 'border-color: ' + group.color + ';'}">
                    <i class="bi ${group.icon || 'bi-people-fill'}" style="color: ${isActive ? '#fff' : group.color};"></i>
                    ${group.name}
                    ${badgeCount > 0 ? `<span class="group-badge" style="background-color: ${group.color};">${badgeCount}</span>` : ''}
                </button>
            `;
            }
        });

        // Add "All" button
        const isAllActive = activeGroupId === null;
        html = `
        <button class="btn btn-sm ${isAllActive ? 'btn-primary' : 'btn-outline-secondary'}" 
                onclick="selectGroup(null)">
            <i class="bi bi-grid-3x3-gap"></i> Tất Cả
        </button>
    ` + html;

        groupsNavContainer.innerHTML = html;

        // Update main MXH nav badge
        updateMainNavBadge();
    }

    // Calculate badge count for a specific group (only count cards with blink animation)
    function calculateGroupBadge(groupId) {
        const now = new Date();
        let count = 0;

        mxhAccounts.forEach(account => {
            if (account.group_id != groupId) return;

            // Check if notice countdown finished (causes blink)
            if (account.notice) {
                const noticeObj = ensureNoticeParsed(account.notice);
                if (noticeObj && noticeObj.enabled && noticeObj.start_at && noticeObj.days) {
                    const startDate = new Date(noticeObj.start_at);
                    const endDate = new Date(startDate.getTime() + noticeObj.days * 24 * 60 * 60 * 1000);
                    if (now >= endDate) {
                        count++; // Notice expired = blink
                    }
                }
            }

            // WeChat: Check if account is 1 year old AND NOT Hong Kong number (causes blink)
            if (account.platform === 'wechat' && account.wechat_created_year) {
                const createdDate = new Date(account.wechat_created_year, account.wechat_created_month - 1, account.wechat_created_day);
                const diffDays = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));
                if (diffDays >= 365) {
                    // Check if Hong Kong number
                    const primaryPhone = (account.phone || '').replace(/[\s+]/g, '');
                    const isHongKongNumber = primaryPhone.startsWith('852');
                    if (!isHongKongNumber) {
                        count++; // 1 year old + NOT HK number = blink
                    }
                }
            }

            // Check secondary account for WeChat (only if blinks)
            if (account.platform === 'wechat' && account.secondary_wechat_created_year) {
                const secCreatedDate = new Date(account.secondary_wechat_created_year, account.secondary_wechat_created_month - 1, account.secondary_wechat_created_day);
                const secDiffDays = Math.ceil((now - secCreatedDate) / (1000 * 60 * 60 * 24));
                if (secDiffDays >= 365) {
                    // Check if Hong Kong number
                    const secondaryPhone = (account.secondary_phone || '').replace(/[\s+]/g, '');
                    const isHongKongNumber = secondaryPhone.startsWith('852');
                    if (!isHongKongNumber) {
                        count++; // 1 year old + NOT HK number = blink
                    }
                }
            }
        });


        return count;
    }

    // Update badge dots on main MXH nav tab
    function updateMainNavBadge() {
        const mxhNavLink = document.querySelector('a[href*="mxh"]');
        if (!mxhNavLink) return;

        // Remove existing badge container
        const existingBadge = mxhNavLink.querySelector('.nav-badge-container');
        if (existingBadge) existingBadge.remove();

        // Get unique groups that have badges
        const uniqueGroupIds = [...new Set(mxhAccounts.map(acc => acc.group_id).filter(id => id))];
        const groupsWithBadges = [];

        uniqueGroupIds.forEach(groupId => {
            const badgeCount = calculateGroupBadge(groupId);
            if (badgeCount > 0) {
                const group = mxhGroups.find(g => g.id == groupId);
                if (group) {
                    groupsWithBadges.push(group);
                }
            }
        });

        // Create badge dots
        if (groupsWithBadges.length > 0) {
            const badgeContainer = document.createElement('div');
            badgeContainer.className = 'nav-badge-container';

            groupsWithBadges.slice(0, 3).forEach(group => { // Max 3 dots
                const dot = document.createElement('div');
                dot.className = 'nav-badge-dot';
                dot.style.backgroundColor = group.color;
                badgeContainer.appendChild(dot);
            });

            mxhNavLink.appendChild(badgeContainer);
        }
    }

    // Select a specific group (or null for all)
    function selectGroup(groupId) {
        activeGroupId = groupId === 'null' ? null : groupId;
        renderGroupsNav();
        renderMXHAccounts();
    }

    // ===== DATETIME NORMALIZATION HELPERS =====
    // Cắt microseconds về 3 chữ số và thêm 'Z' nếu thiếu timezone
    function normalizeISOForJS(iso) {
        if (!iso) return null;
        let s = String(iso).trim();
        // thay ' ' -> 'T' nếu có
        s = s.replace(' ', 'T');
        // Nếu có 'Z' thì ok; nếu có +00:00 thì vẫn ok
        if (!/[zZ]|[+\-]\d{2}:\d{2}$/.test(s)) s += 'Z';
        // Chuẩn hoá phần .xxxxx... về 3 chữ số
        s = s.replace(/(\.\d{3})\d+/, '$1'); // giữ .mmm
        return s;
    }

    function ensureNoticeParsed(notice) {
        let n = (typeof notice === 'string') ? (() => { try { return JSON.parse(notice) } catch { return {} } })() : (notice || {});
        if (n && n.start_at) n.start_at = normalizeISOForJS(n.start_at);
        return n;
    }

    // ===== CARD FACE RENDERING =====
    // Render individual card face with all account details
    function renderCardFace(account, allAccounts, side) {
        const cardId = account.card_id;
        const accountIndex = allAccounts.findIndex(acc => acc.id === account.id) + 1;
        const totalAccounts = allAccounts.length;
        const platform = account.platform || 'unknown';
        const iconClass = getPlatformIconClass(platform);
        const borderClass = getAccountBorderClass(account);
        const now = new Date();

        // === MXH OLD LOGIC: Calculate age and scan countdown ===
        let accountAgeDisplay = '';
        let ageColor = '#fff';
        let scanCountdown = '';

        if (platform === 'wechat' && account.wechat_created_year) {
            const createdDate = new Date(account.wechat_created_year, (account.wechat_created_month || 1) - 1, account.wechat_created_day || 1);
            const diffDays = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));

            if (diffDays >= 365) {
                const years = Math.floor(diffDays / 365);
                const months = Math.floor((diffDays % 365) / 30);
                accountAgeDisplay = `${years}năm ${months}th`;
                ageColor = '#07c160';
            } else if (diffDays >= 30) {
                const months = Math.floor(diffDays / 30);
                accountAgeDisplay = `${months}th ${diffDays % 30}d`;
            } else {
                accountAgeDisplay = `${diffDays}d`;
            }

            // Calculate scan countdown với QR icon (MXH OLD logic)
            const currentScanCount = account.wechat_scan_count || 0;
            const maxScans = 3;

            if (currentScanCount >= maxScans) {
                // Đã hết lượt - QR đỏ
                scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #dc3545;"></i>${maxScans}/${maxScans}`;
            } else if (account.wechat_last_scan_date) {
                // Có lịch sử quét - kiểm tra thời gian
                const lastScanDate = new Date(account.wechat_last_scan_date);
                const daysSinceScan = Math.floor((now - lastScanDate) / (1000 * 60 * 60 * 24));
                const remainingDays = 30 - daysSinceScan;

                if (remainingDays > 0) {
                    // Còn thời gian chờ - hiển thị countdown
                    const hoursSinceScan = Math.floor((now - lastScanDate) / (1000 * 60 * 60));
                    const remainingHours = (30 * 24) - hoursSinceScan;

                    if (remainingHours < 24) {
                        scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #ffffff;"></i>${currentScanCount}/${maxScans} <small class="text-warning">(${remainingHours}h)</small>`;
                    } else {
                        scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #ffffff; font-size: 1.3em;"></i>${currentScanCount}/${maxScans} <small class="text-warning">(${remainingDays}d)</small>`;
                    }
                } else {
                    // Đủ điều kiện quét tiếp - QR xanh
                    scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #07c160; font-size: 1.3em;"></i>${currentScanCount}/${maxScans}`;
                }
            } else {
                // Chưa quét lần nào
                if (diffDays < 90) {
                    scanCountdown = `Còn ${90 - diffDays} ngày`;
                } else {
                    // Đủ điều kiện quét lần đầu - QR xanh
                    scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #07c160; font-size: 1.3em;"></i>${currentScanCount}/${maxScans}`;
                }
            }
        }

        // Determine status icon
        let statusIcon = '';
        if (account.status === 'die') {
            statusIcon = '<i class="bi bi-x-circle-fill status-icon" style="color: #dc3545;"></i>';
        } else if (account.status === 'disabled') {
            statusIcon = '<i class="bi bi-slash-circle status-icon" style="color: #ff8c00;"></i>';
        }

        // === Thông báo logic (từ MXH OLD) ===
        let noticeHtml = '';
        let extraClass = '';
        let tipHtml = '';
        
        try {
            const noticeObj = typeof account.notice === 'string' ? JSON.parse(account.notice || '{}') : (account.notice || {});
            const hasNotice = noticeObj && (noticeObj.enabled === true || noticeObj.enabled === 1 || Number(noticeObj.days) > 0);

            // Debug: log notice object
            if (noticeObj && Object.keys(noticeObj).length > 0) {
                console.log('Notice for account', account.id, ':', noticeObj, 'hasNotice:', hasNotice);
            }

            if (hasNotice) {
                const dueDate = new Date(noticeObj.due_date || noticeObj.dueDate);
                if (dueDate instanceof Date && !isNaN(dueDate)) {
                    const today = new Date();
                    const remainTime = dueDate - today;
                    
                    if (remainTime > 0) {
                        const remainDays = Math.ceil(remainTime / (1000 * 60 * 60 * 24));
                        let timeDisplay = '';
                        if (remainDays >= 30) {
                            const remainMonths = Math.floor(remainDays / 30);
                            timeDisplay = `${remainMonths}m`;
                        } else {
                            timeDisplay = `${remainDays}d`;
                        }
                        noticeHtml = `<div class="notice-line" style="font-size: 0.75rem; color: #ff9500; margin-top: 4px;">${escapeHtml(noticeObj.title || 'Thông báo')}: ${timeDisplay}</div>`;
                    } else {
                        noticeHtml = `<div class="notice-line expired" style="font-size: 0.75rem; color: #ff4d4f; margin-top: 4px;">${escapeHtml(noticeObj.title || 'Thông báo')}: đã đến hạn</div>`;
                        extraClass = 'notice-expired-blink';
                    }

                    // Tooltip
                    let tooltipTime;
                    if (remainDays >= 30) {
                        const months = Math.floor(remainDays / 30);
                        tooltipTime = `${months}m`;
                    } else {
                        tooltipTime = `${remainDays}d`;
                    }
                    tipHtml = `<div class="notice-tooltip"><div class="notice-tooltip-title">${escapeHtml(noticeObj.title || 'Thông báo')} – ${tooltipTime}</div><div class="notice-tooltip-note">${escapeHtml(noticeObj.note || '')}</div></div>`;
                }
            }
        } catch (e) {
            console.error('Error parsing notice:', e);
        }

        // ===== Hiển thị khi disabled ======
        let disabledInfo = '';
        const isDisabled = account.status === 'disabled';
        if (isDisabled && account.die_date && platform === 'wechat') {
            const disableDays = Math.ceil((now - new Date(account.die_date)) / (1000 * 60 * 60 * 24));
            disabledInfo = `
                <div style="font-size: 0.75rem; margin-top: 4px;">
                    <div class="d-flex align-items-center justify-content-between">
                        <small class="text-danger">Ngày: ${disableDays}</small>
                        <small>Lượt cứu: <span class="text-danger">${account.rescue_count || 0}</span>-<span class="text-success">${account.rescue_success_count || 0}</span></small>
                    </div>
                </div>
            `;
        }

        return `
            <div class="mxh-card-face ${side}">
                <div class="card tool-card mxh-card ${borderClass} ${extraClass}"
                     oncontextmenu="handleCardContextMenu(event, ${cardId}, ${account.id}, '${platform}'); return false;"
                     style="height: 100%; margin: 0;">
                    <div class="card-body" style="display: flex; flex-direction: column; justify-content: space-between; height: 100%;">
                        <div>
                            <div class="d-flex align-items-center justify-content-between mb-1">
                                <div class="d-flex align-items-center gap-1">
                                    <h6 class="card-title mb-0 card-number" 
                                        onclick="event.stopPropagation(); flipCardToAccount(${cardId}, ${account.id}); return false;"
                                        style="font-size: 1.26rem; font-weight: 600;"
                                        title="Click để flip card">
                                        ${account.card_name}
                                    </h6>
                                    <i class="bi ${iconClass}" title="${platform}" style="font-size: 0.9rem; color: ${getPlatformColor(platform)};"></i>
                                    ${totalAccounts > 1 ? `<span class="badge bg-secondary" style="font-size: 0.65rem;">${accountIndex}/${totalAccounts}</span>` : ''}
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    ${accountAgeDisplay ? `<small style="color: ${ageColor}; font-size: 0.7rem; font-weight: 500;">${accountAgeDisplay}</small>` : ''}
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <div>
                                    <small 
                                        contenteditable="true" 
                                        class="editable-field" 
                                        data-field="username" 
                                        data-account-id="${account.id}"
                                        style="font-size: 0.84rem; cursor: text; border-bottom: 1px dashed transparent; display: inline;"
                                        onblur="saveInlineEdit(this, ${account.id}, 'username')"
                                        onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}"
                                        onfocus="this.style.borderBottom='1px dashed #007bff'"
                                        title="Click để chỉnh sửa">${account.username || '...'}</small>${statusIcon}
                                </div>
                                <small 
                                    contenteditable="true" 
                                    class="editable-field text-muted" 
                                    data-field="phone" 
                                    data-account-id="${account.id}"
                                    style="font-size: 0.84rem; display: block; cursor: text; border-bottom: 1px dashed transparent;"
                                    onblur="saveInlineEdit(this, ${account.id}, 'phone')"
                                    onkeydown="if(event.key==='Enter'){event.preventDefault();this.blur();}"
                                    onfocus="this.style.borderBottom='1px dashed #007bff'"
                                    title="Click để chỉnh sửa">📞 ${account.phone || '...'}</small>
                            </div>
                        </div>
                        
                        <div>
                            ${platform === 'wechat' ? `
                                <div class="text-center mt-1">
                                    ${isDisabled ? disabledInfo : `<small style="font-size: 0.75rem;">${scanCountdown}</small>`}
                                </div>
                            ` : ''}
                            ${noticeHtml}
                            ${tipHtml}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ===== OPTIMIZED RENDERING WITH SCROLL PRESERVATION =====
    // Render MXH Accounts with performance optimizations and scroll position preservation
    function renderMXHAccounts() {
        if (isRendering) {
            pendingUpdates = true;
            return;
        }

        isRendering = true;
        const container = document.getElementById('mxh-accounts-container');

        // 💾 SAVE SCROLL POSITION BEFORE RENDER
        const scrollY = window.scrollY || window.pageYOffset;
        const scrollX = window.scrollX || window.pageXOffset;

        // Filter by active group
        const filteredAccounts = activeGroupId
            ? mxhAccounts.filter(acc => String(acc.group_id) === String(activeGroupId))
            : mxhAccounts;

        if (filteredAccounts.length === 0) {
            container.innerHTML = `
            <div class="card">
                <div class="card-body text-center text-muted">
                    <i class="bi bi-share-fill" style="font-size: 3rem; opacity: 0.3;"></i>
                    <h5 class="mt-3">Chưa có tài khoản MXH nào</h5>
                    <p>Nhấn "Thêm Tài Khoản MXH" để bắt đầu.</p>
                </div>
            </div>
        `;
            isRendering = false;
            return;
        }

        // === NEW: Group accounts by card_id (1 card → N accounts) ===
        const cardGroups = {};
        filteredAccounts.forEach(acc => {
            const cardId = acc.card_id;
            if (!cardGroups[cardId]) {
                cardGroups[cardId] = [];
            }
            cardGroups[cardId].push(acc);
        });

        // Sort accounts within each card (primary first)
        Object.values(cardGroups).forEach(accounts => {
            accounts.sort((a, b) => {
                if (a.is_primary && !b.is_primary) return -1;
                if (!a.is_primary && b.is_primary) return 1;
                return a.id - b.id;
            });
        });

        // Sort cards by card_name numerically
        const sortedCards = Object.entries(cardGroups).sort(([, accountsA], [, accountsB]) => {
            const nameA = parseInt(accountsA[0].card_name, 10) || Infinity;
            const nameB = parseInt(accountsB[0].card_name, 10) || Infinity;
            return nameA - nameB;
        });

        // === Render Cards (1 card per card_id) ===
        let html = '<div class="row g-2">';

        sortedCards.forEach(([cardId, accounts]) => {
            const state = getCardState(cardId);
            const primaryAccount = accounts.find(acc => acc.is_primary) || accounts[0];
            
            // Determine active account (mặt hiện tại đang hiển thị)
            let activeAccount = primaryAccount;
            if (state.activeAccountId) {
                const found = accounts.find(acc => acc.id === state.activeAccountId);
                if (found) activeAccount = found;
            } else {
                // Initialize state with primary account
                state.activeAccountId = primaryAccount.id;
            }

            // Determine border color based on active account
            const borderClass = getAccountBorderClass(activeAccount);

            html += `
                <div class="col" style="padding: 2px;" data-card-id="${cardId}">
                    <div class="mxh-card-wrapper ${state.isFlipped ? 'flipped' : ''}" id="card-wrapper-${cardId}">
                        <div class="mxh-card-inner">
                            ${renderCardFace(activeAccount, accounts, 'front')}
                            <!-- Mặt sau được cập nhật khi click chuyển account -->
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;

        // Restore scroll position
        window.scrollTo(scrollX, scrollY);

        isRendering = false;

        if (pendingUpdates) {
            pendingUpdates = false;
            setTimeout(() => renderMXHAccounts(), 100);
        }
    }

    // Helper: Get border class based on account status
    function getAccountBorderClass(account) {
        const isDie = ['disabled', 'die'].includes(String(account.status || '').toLowerCase()) || !!account.die_date;
        
        if (isDie) {
            return 'mxh-border-red';
        }

        // Check > 1 year (WeChat)
        if (account.platform === 'wechat' && account.wechat_created_year) {
            const now = new Date();
            const createdDate = new Date(
                account.wechat_created_year,
                (account.wechat_created_month || 1) - 1,
                account.wechat_created_day || 1
            );
            const diffDays = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));
            if (diffDays >= 365) {
                const isHK = /^\+?852/.test(account.phone || '');
                return isHK ? 'mxh-border-green' : 'mxh-border-white';
            }
        }

        return ''; // Default - no special border
    }

    // === NEW: Flip Card Function ===
    function flipCardToAccount(cardId, accountId) {
        const state = getCardState(cardId);
        const wrapper = document.getElementById(`card-wrapper-${cardId}`);
        
        if (!wrapper) return;

        // Update state immediately (không toggle!)
        state.isFlipped = true;  // Luôn flip (không toggle)
        state.activeAccountId = accountId;

        // Apply flip class ngay lập tức
        wrapper.classList.add('flipped');

        // Render mặt sau (back) với account mới **TRƯỚC KHI FLIP**
        setTimeout(() => {
            const accounts = mxhAccounts.filter(acc => acc.card_id === cardId);
            const newActiveAccount = accounts.find(acc => acc.id === accountId);
            
            if (newActiveAccount) {
                const cardInner = wrapper.querySelector('.mxh-card-inner');
                
                // Xóa mặt sau cũ
                const oldBack = cardInner.querySelector('.mxh-card-face.back');
                if (oldBack) oldBack.remove();
                
                // Thêm mặt sau mới với account được chọn
                cardInner.insertAdjacentHTML('beforeend', renderCardFace(newActiveAccount, accounts, 'back'));
                
                // Update border color
                const cardCol = wrapper.closest('[data-card-id]');
                if (cardCol) {
                    const newBorderClass = getAccountBorderClass(newActiveAccount);
                    cardCol.querySelectorAll('.mxh-card').forEach(card => {
                        card.className = card.className.replace(/mxh-border-\w+/g, '');
                        if (newBorderClass) card.classList.add(newBorderClass);
                    });
                }
            }
        }, 150); // Render trước flip animation hoàn thành

        // Sau khi flip animation xong, swap front & back, set isFlipped = false
        setTimeout(() => {
            const cardInner = wrapper.querySelector('.mxh-card-inner');
            const frontFace = cardInner.querySelector('.mxh-card-face.front');
            const backFace = cardInner.querySelector('.mxh-card-face.back');
            
            if (frontFace && backFace) {
                // Swap classes
                frontFace.classList.remove('front');
                frontFace.classList.add('back');
                backFace.classList.remove('back');
                backFace.classList.add('front');
                
                // Reset flip state
                state.isFlipped = false;
                wrapper.classList.remove('flipped');
            }
        }, 300); // Wait for flip animation
    }

    // === OLD CODE CONTINUES BELOW (for compatibility) ===
    function renderMXHAccounts_OLD() {
        // DEPRECATED - kept for reference
        // Group accounts by group_id
        const accountsByGroup = {};
        mxhAccounts.forEach(account => {
            const groupId = account.group_id || 'no-group';

            // Filter by active group if one is selected
            if (activeGroupId !== null && groupId != activeGroupId) {
                return; // Skip this account
            }

            if (!accountsByGroup[groupId]) {
                accountsByGroup[groupId] = [];
            }
            accountsByGroup[groupId].push(account);
        });

        // Use DocumentFragment for better performance
        const fragment = document.createDocumentFragment();
        const tempDiv = document.createElement('div');
        let html = '';

        Object.keys(accountsByGroup).forEach(groupId => {
            const accounts = accountsByGroup[groupId];
            const group = mxhGroups.find(g => g.id == groupId);

            // Sort by card_name numerically
            accounts.sort((a, b) => {
                const numA = parseInt(a.card_name) || 0;
                const numB = parseInt(b.card_name) || 0;
                return numA === numB ? (b.id - a.id) : (numA - numB);
            });

            if (group) {
                const cardsContainerId = `cards-${groupId}`;

                // Render cards container (always visible now, filtering done at account level)
                html += `
                <div class="mb-4">
                    <div class="row g-2" id="${cardsContainerId}">
            `;

                accounts.forEach(account => {
                    const now = new Date(); // Dùng chung cho mọi platform
                    const isDisabled = account.status === 'disabled';
                    let isAnniversary = false;



                    // Calculate age for WeChat primary with color
                    let accountAgeDisplay = '';
                    let ageColor = '#fff';
                    let scanCountdown = '';

                    if (account.platform === 'wechat' && account.wechat_created_year) {
                        const createdDate = new Date(account.wechat_created_year, account.wechat_created_month - 1, account.wechat_created_day);
                        const diffDays = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));

                        if (diffDays >= 365) {
                            const years = Math.floor(diffDays / 365);
                            const months = Math.floor((diffDays % 365) / 30);
                            accountAgeDisplay = `${years}năm ${months}th`;
                            ageColor = '#07c160';
                            isAnniversary = true;
                        } else if (diffDays >= 30) {
                            const months = Math.floor(diffDays / 30);
                            accountAgeDisplay = `${months}th ${diffDays % 30}d`;
                        } else {
                            accountAgeDisplay = `${diffDays}d`;
                        }

                        // Calculate scan countdown with QR icon
                        const currentScanCount = account.wechat_scan_count || 0;
                        const maxScans = 3;

                        if (currentScanCount >= maxScans) {
                            // Đã hết lượt - QR đỏ
                            scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #dc3545;"></i>${maxScans}/${maxScans}`;
                        } else if (account.wechat_last_scan_date) {
                            // Có lịch sử quét - kiểm tra thời gian
                            const lastScanDate = new Date(account.wechat_last_scan_date);
                            const daysSinceScan = Math.floor((now - lastScanDate) / (1000 * 60 * 60 * 24));
                            const remainingDays = 30 - daysSinceScan;

                            if (remainingDays > 0) {
                                // Còn thời gian chờ - hiển thị countdown
                                const hoursSinceScan = Math.floor((now - lastScanDate) / (1000 * 60 * 60));
                                const remainingHours = (30 * 24) - hoursSinceScan;

                                if (remainingHours < 24) {
                                    scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #ffffff;"></i>${currentScanCount}/${maxScans} <small class="text-warning">(${remainingHours}h)</small>`;
                                } else {
                                    scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #ffffff; font-size: 1.3em;"></i>${currentScanCount}/${maxScans} <small class="text-warning">(${remainingDays}d)</small>`;
                                }
                            } else {
                                // Đủ điều kiện quét tiếp - QR xanh
                                scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #07c160; font-size: 1.3em;"></i>${currentScanCount}/${maxScans}`;
                            }
                        } else {
                            // Chưa quét lần nào
                            if (diffDays < 90) {
                                scanCountdown = `Còn ${90 - diffDays} ngày`;
                            } else {
                                // Đủ điều kiện quét lần đầu - QR xanh
                                scanCountdown = `<i class="bi bi-qr-code me-1" style="color: #07c160; font-size: 1.3em;"></i>${currentScanCount}/${maxScans}`;
                            }
                        }

                    }

                    const contextMenuFunction = account.platform === 'wechat' ? 'showWeChatContextMenu' : 'showGenericContextMenu';

                    // Notice countdown logic
                    let noticeHtml = '';
                    let extraClass = '';
                    let tipHtml = '';
                    const n = ensureNoticeParsed(account.notice);

                    // Debug log
                    if (account.id === noticeTargetId) {
                        // console.log('Notice debug for account', account.id, ':', n);
                    }

                    if (n.enabled && n.start_at && n.days > 0) {
                        const start = new Date(n.start_at);
                        const end = new Date(start.getTime() + n.days * 86400000);
                        const remainMs = end - now;
                        const remainDays = Math.ceil(remainMs / 86400000);

                        if (remainMs > 0) {
                            // Format display: hours (h) if less than 1 day, days (d), or months (m)
                            let timeDisplay;
                            if (remainMs < 86400000) {
                                // Less than 24 hours remaining, show hours
                                const remainHours = Math.ceil(remainMs / (1000 * 60 * 60));
                                timeDisplay = `${remainHours}h`;
                            } else if (remainDays >= 30) {
                                const remainMonths = Math.floor(remainDays / 30);
                                timeDisplay = `${remainMonths}m`;
                            } else {
                                timeDisplay = `${remainDays}d`;
                            }
                            noticeHtml = `<div class="notice-line">${escapeHtml(n.title)}: ${timeDisplay}</div>`;
                        } else {
                            noticeHtml = `<div class="notice-line expired">${escapeHtml(n.title)}: đã đến hạn</div>`;
                            extraClass = 'notice-expired-blink';
                        }

                        // Tooltip also uses short format
                        let tooltipTime;
                        if (n.days >= 30) {
                            const months = Math.floor(n.days / 30);
                            tooltipTime = `${months}m`;
                        } else {
                            tooltipTime = `${n.days}d`;
                        }
                        tipHtml = `<div class="notice-tooltip"><div class="notice-tooltip-title">${escapeHtml(n.title)} – ${tooltipTime}</div><div class="notice-tooltip-note">${escapeHtml(n.note || '')}</div></div>`;
                    }

                    // Determine account status and styling
                    let statusClass = 'account-status-available';
                    let statusIcon = '';
                    let accountStatus = account.status || 'active';

                    if (accountStatus === 'die') {
                        statusClass = 'account-status-die';
                        statusIcon = '<i class="bi bi-x-circle-fill status-icon" style="color: #dc3545;"></i>';
                    } else if (accountStatus === 'disabled') {
                        statusClass = 'account-status-disabled';
                        statusIcon = '<i class="bi bi-slash-circle status-icon" style="color: #ff8c00;"></i>';
                    }


                    // ==== State flags (áp dụng cho mọi MXH) ====
                    const isDie = ['disabled', 'die', 'banned', 'blocked']
                        .includes(String(account.status || '').toLowerCase()) || !!account.die_date;

                    const noticeObj = ensureNoticeParsed(account.notice);
                    const hasNotice = !!(noticeObj && (noticeObj.enabled === true || noticeObj.enabled === 1 || Number(noticeObj.days) > 0));

                    // ==== Logic viền mới cho WeChat ====
                    const isWechat = String(account.platform || '').toLowerCase() === 'wechat';
                    const isHK = /^\+?852/.test(account.phone || '');
                    const y = +account.wechat_created_year || 0;
                    const m = (+account.wechat_created_month || 1) - 1;
                    const d = +account.wechat_created_day || 1;
                    const ageDays = isFinite(new Date(y, m, d)) ? Math.floor((Date.now() - new Date(y, m, d).getTime()) / 86400000) : 0;

                    // ==== Gán class viền theo ưu tiên: Đỏ > Cam > Xanh > Trắng ====
                    let borderClass = '';
                    if (isDie) {
                        borderClass = 'mxh-border-red';
                    } else if (hasNotice) {
                        borderClass = 'mxh-border-orange';
                    } else if (isWechat && ageDays >= 365 && isHK) {
                        borderClass = 'mxh-border-green';
                    } else if (isWechat && ageDays >= 365 && !isHK) {
                        borderClass = 'mxh-border-white';
                    }


                    html += `
                    <div class="col" style="padding: 2px;" data-account-id="${account.id}">
                        <div class="card tool-card mxh-card ${borderClass} ${extraClass}" oncontextmenu="handleCardContextMenu(event, ${account.id}, '${account.platform}'); return false;">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between mb-1">
                                    <div class="d-flex align-items-center gap-1">
                                        <h6 class="card-title mb-0 card-number" style="font-size: 1.26rem; font-weight: 600;">${account.card_name}</h6>
                                        <i class="bi ${getPlatformIconClass(account.platform)}" title="${account.platform}" style="font-size: 0.9rem; color: ${getPlatformColor(account.platform)};"></i>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        ${accountAgeDisplay ? `<small style="color: ${ageColor}; font-size: 0.7rem; font-weight: 500;">${accountAgeDisplay}</small>` : ''}
                                    </div>
                                </div>
                                
                                <div class="text-center mb-0">
                                    <small 
                                        class="${statusClass} editable-field" 
                                        contenteditable="true" 
                                        data-account-id="${account.id}" 
                                        data-field="username" 
                                        data-is-secondary="false"
                                        style="font-size: 0.84rem; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: inline-block;"
                                        onmouseenter="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                                        onmouseleave="this.style.backgroundColor='transparent'"
                                        onclick="event.stopPropagation()"
                                    >${account.username || 'Click để nhập'}${statusIcon}</small>
                                    <small 
                                        class="text-muted editable-field" 
                                        contenteditable="true" 
                                        data-account-id="${account.id}" 
                                        data-field="phone" 
                                        data-is-secondary="false"
                                        style="font-size: 0.84rem; cursor: text; padding: 2px 4px; border-radius: 4px; transition: background-color 0.2s; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"
                                        onmouseenter="this.style.backgroundColor='rgba(255,255,255,0.1)'"
                                        onmouseleave="this.style.backgroundColor='transparent'"
                                        onclick="event.stopPropagation()"
                                    >📞 ${account.phone || 'Click để nhập'}</small>
                                </div>
                                
                                ${account.platform === 'wechat' ? `
                                    <div class="mt-auto">
                                        ${isDisabled ?
                                            `<div class="d-flex align-items-center justify-content-between">
                                                <small class="text-danger" style="font-size: 0.77rem;">Ngày: ${account.die_date ? Math.ceil((new Date() - new Date(account.die_date)) / (1000 * 60 * 60 * 24)) : 0}</small>
                                                <small style="font-size: 0.77rem;">Lượt cứu: <span class="text-danger">${account.rescue_count || 0}</span>-<span class="text-success">${account.rescue_success_count || 0}</span></small>
                                            </div>` :
                                            `<div class="text-center mt-1">
                                                ${scanCountdown ? `<small style="font-size: 0.7rem;">${scanCountdown}</small>` : ''}
                                            </div>`
                                        }
                                    </div>
                                ` : ''}
                                
                                ${noticeHtml}
                                ${tipHtml}
                            </div>
                        </div>
                    </div>
                `;
                });

                html += `
                    </div>
                </div>
            `;
            }
        });

        tempDiv.innerHTML = html;
        container.innerHTML = '';
        container.appendChild(tempDiv);

        // Enable tooltip on hover for notice with smart positioning
        requestAnimationFrame(() => {
            document.querySelectorAll('.mxh-card-container').forEach(card => {
                const tip = card.querySelector('.notice-tooltip');
                if (tip) {
                    card.addEventListener('mouseenter', () => {
                        // Smart positioning based on card center
                        const rect = card.getBoundingClientRect();
                        const viewportWidth = window.innerWidth;
                        const cardCenter = rect.left + rect.width / 2;

                        // Debug log
                        // console.log('Tooltip positioning debug:', {
                        //     cardLeft: rect.left,
                        //     cardRight: rect.right,
                        //     viewportWidth: viewportWidth,
                        //     leftThird: viewportWidth / 3,
                        //     rightThird: (viewportWidth * 2) / 3,
                        //     cardCenter: cardCenter
                        // });

                        // Remove previous positioning classes
                        tip.classList.remove('tooltip-left', 'tooltip-right', 'tooltip-center');

                        // TEST: Always center tooltip to verify CSS works
                        tip.classList.add('tooltip-center');
                        // console.log('Applied: tooltip-center (TEST MODE)');

                        tip.classList.add('show');
                    });
                    card.addEventListener('mouseleave', () => tip.classList.remove('show'));
                }
            });
        });

        // Restore visibility states efficiently
        requestAnimationFrame(() => {
            Object.keys(accountsByGroup).forEach(groupId => {
                const isVisible = localStorage.getItem(`group_${groupId}_visible`) !== 'false';
                const cardsContainerId = `cards-${groupId}`;
                const toggleButtonId = `toggle-${groupId}`;
                const cardsContainer = document.getElementById(cardsContainerId);
                const toggleButton = document.getElementById(toggleButtonId);

                if (cardsContainer && toggleButton) {
                    const eyeIcon = toggleButton.querySelector('.bi-eye-fill, .bi-eye-slash-fill');

                    if (isVisible) {
                        // Show cards
                        cardsContainer.style.display = 'flex';
                        if (eyeIcon) {
                            eyeIcon.classList.remove('bi-eye-slash-fill');
                            eyeIcon.classList.add('bi-eye-fill');
                        }
                    } else {
                        // Hide cards
                        cardsContainer.style.display = 'none';
                        if (eyeIcon) {
                            eyeIcon.classList.remove('bi-eye-fill');
                            eyeIcon.classList.add('bi-eye-slash-fill');
                        }
                    }
                }
            });

            // 🔄 RESTORE SCROLL POSITION AFTER RENDER
            window.scrollTo(scrollX, scrollY);

            // Setup inline editing after render
            setupEditableFields();

            // Update accounts submenu if context menu is open
            if (currentContextAccountId) {
                generateAccountsSubmenu(currentContextAccountId);
            }

            isRendering = false;

            // Process pending updates if any
            if (pendingUpdates) {
                pendingUpdates = false;
                setTimeout(() => renderMXHAccounts(), 100);
            }
        });
    }

    // Context Menu Functions with auto-refresh pause
    function showWeChatContextMenu(event, accountId) {
        event.preventDefault();
        event.stopPropagation();
        currentContextAccountId = accountId;
        currentEditingIsSecondary = false; // Always false now
        pauseAutoRefresh();

        const contextMenu = document.getElementById('wechat-context-menu');
        contextMenu.style.display = 'block';
        
        // Smart positioning to avoid overflow
        contextMenu.style.left = event.pageX + 'px';
        contextMenu.style.top = event.pageY + 'px';
        
        // Calculate menu size and viewport
        let menuRect = contextMenu.getBoundingClientRect();
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const margin = 8;
        
        let left = event.pageX;
        let top = event.pageY;
        
        // Horizontal positioning: Smart left/right positioning
        if (menuRect.right > viewportWidth - margin) {
            // Menu will overflow right side of screen
            // Show menu to the left of mouse
            left = event.pageX - menuRect.width;
            // console.log('Context menu positioned LEFT - would overflow right');
            
            // If still overflows left, clamp to left margin
            if (left < margin) {
                left = margin;
                // console.log('Context menu clamped to left margin');
            }
        } else {
            // console.log('Context menu positioned RIGHT - fits in viewport');
        }
        
        // Vertical positioning
        if (menuRect.bottom > viewportHeight) {
            // Nếu đủ chỗ phía trên chuột thì show lên trên
            if (event.pageY - menuRect.height > margin) {
                top = event.pageY - menuRect.height;
            } else {
                // Nếu không đủ chỗ trên, thì dán sát đáy viewport
                top = viewportHeight - menuRect.height - margin + window.scrollY;
                if (top < margin + window.scrollY) top = margin + window.scrollY;
            }
        }
        
        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';

        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (account) {
            const toggleStatusItem = document.getElementById('toggle-status-item');
            const rescueItem = document.getElementById('rescue-options-item');
            const copyPhoneItem = document.getElementById('copy-phone-item');

            const statusToCheck = isSecondary ? account.secondary_status : account.status;
            const phoneToCopy = isSecondary ? account.secondary_phone : account.phone;

            if (statusToCheck === 'disabled') {
                toggleStatusItem.style.display = 'none';
                rescueItem.style.display = 'block';
            } else {
                toggleStatusItem.style.display = 'block';
                toggleStatusItem.innerHTML = '<i class="bi bi-x-circle-fill me-2"></i> Vô hiệu hóa';
                rescueItem.style.display = 'none';
            }

            copyPhoneItem.style.display = phoneToCopy ? 'block' : 'none';

            // Configure notice toggle
            configureNoticeToggleFor('wechat-context-menu', account);
        }

        setTimeout(() => {
            document.addEventListener('click', hideWeChatContextMenu, { once: true });
        }, 100);
    }

    function configureNoticeToggleFor(menuId, account) {
        const el = document.querySelector(`#${menuId} [id$="-notice-toggle"]`);
        if (!el) return;
        const noticeObj = ensureNoticeParsed(account.notice);
        const hasNotice = !!(noticeObj && noticeObj.enabled);
        // set action + icon + text
        el.dataset.action = hasNotice ? 'clear-notice' : 'set-notice';
        el.innerHTML = hasNotice
            ? '<i class="bi bi-bell-slash-fill me-2"></i> Hủy thông báo'
            : '<i class="bi bi-bell-fill me-2"></i> Thông báo';
    }

    function hideWeChatContextMenu() {
        document.getElementById('wechat-context-menu').style.display = 'none';
        resumeAutoRefresh();
    }

    function showGenericContextMenu(event, accountId) {
        event.preventDefault();
        currentContextAccountId = accountId;
        pauseAutoRefresh();

        const contextMenu = document.getElementById('generic-context-menu');
        contextMenu.style.display = 'block';
        
        // Smart positioning to avoid overflow
        contextMenu.style.left = event.pageX + 'px';
        contextMenu.style.top = event.pageY + 'px';
        
        // Calculate menu size and viewport
        let menuRect = contextMenu.getBoundingClientRect();
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const margin = 8;
        
        let left = event.pageX;
        let top = event.pageY;
        
        // Horizontal positioning: Smart left/right positioning
        if (menuRect.right > viewportWidth - margin) {
            // Menu will overflow right side of screen
            // Show menu to the left of mouse
            left = event.pageX - menuRect.width;
            // console.log('Context menu positioned LEFT - would overflow right');
            
            // If still overflows left, clamp to left margin
            if (left < margin) {
                left = margin;
                // console.log('Context menu clamped to left margin');
            }
        } else {
            // console.log('Context menu positioned RIGHT - fits in viewport');
        }
        
        // Vertical positioning
        if (menuRect.bottom > viewportHeight) {
            // Nếu đủ chỗ phía trên chuột thì show lên trên
            if (event.pageY - menuRect.height > margin) {
                top = event.pageY - menuRect.height;
            } else {
                // Nếu không đủ chỗ trên, thì dán sát đáy viewport
                top = viewportHeight - menuRect.height - margin + window.scrollY;
                if (top < margin + window.scrollY) top = margin + window.scrollY;
            }
        }
        
        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';

        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (account) {
            // Configure notice toggle
            configureNoticeToggleFor('generic-context-menu', account);
        }

        setTimeout(() => {
            document.addEventListener('click', hideGenericContextMenu, { once: true });
        }, 100);
    }

    function hideGenericContextMenu() {
        document.getElementById('generic-context-menu').style.display = 'none';
        resumeAutoRefresh();
    }

    // ===== UNIFIED CONTEXT MENU (New) =====
    function showUnifiedContextMenu(event, accountId, platform) {
        event.preventDefault();
        event.stopPropagation();
        currentContextAccountId = accountId;
        currentEditingIsSecondary = false; // Always false now
        pauseAutoRefresh();

        const contextMenu = document.getElementById('unified-context-menu');
        const account = mxhAccounts.find(acc => acc.id === accountId);

        if (!account) return;

        // Show/hide WeChat-specific items
        const wechatOnlyItems = contextMenu.querySelectorAll('.wechat-only');
        wechatOnlyItems.forEach(item => {
            item.style.display = platform === 'wechat' ? 'block' : 'none';
        });

        // Show/hide phone item if phone exists
        const copyPhoneItem = contextMenu.querySelector('#copy-phone-item');
        const phone = account.phone;
        if (copyPhoneItem) {
            copyPhoneItem.style.display = phone ? 'block' : 'none';
        }

        // Show/hide email item if email exists (for Telegram, etc.)
        const copyEmailItem = contextMenu.querySelector('#copy-email-item');
        if (copyEmailItem) {
            // Add logic to show email if account has email field
            copyEmailItem.style.display = account.email ? 'block' : 'none';
        }

        // Configure notice toggle
        const noticeToggle = contextMenu.querySelector('#unified-notice-toggle');
        if (noticeToggle) {
            const noticeObj = ensureNoticeParsed(account.notice);
            const hasNotice = !!(noticeObj && noticeObj.enabled);
            noticeToggle.dataset.action = hasNotice ? 'clear-notice' : 'set-notice';
            noticeToggle.innerHTML = hasNotice
                ? '<i class="bi bi-bell-slash-fill me-2"></i> Hủy thông báo'
                : '<i class="bi bi-bell-fill me-2"></i> Thông báo';
        }

        // Configure status submenu based on current status
        const currentStatus = account.status;
        const statusNormalItems = contextMenu.querySelectorAll('.status-normal');
        const statusRescueItems = contextMenu.querySelectorAll('.status-rescue');

        if (currentStatus === 'disabled') {
            // Hide normal options, show rescue options
            statusNormalItems.forEach(item => item.style.display = 'none');
            statusRescueItems.forEach(item => item.style.display = 'block');
        } else {
            // Show normal options, hide rescue options
            statusNormalItems.forEach(item => item.style.display = 'block');
            statusRescueItems.forEach(item => item.style.display = 'none');
        }

        // Position and show menu (auto reposition if overflow)
        contextMenu.style.display = 'block';
        // Temporarily set left/top for measurement
        contextMenu.style.left = event.pageX + 'px';
        contextMenu.style.top = event.pageY + 'px';

        // Calculate menu size and viewport
        let menuRect = contextMenu.getBoundingClientRect();
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const margin = 8;

        let left = event.pageX;
        let top = event.pageY;

        // Horizontal positioning: Smart left/right positioning
        if (menuRect.right > viewportWidth - margin) {
            // Menu will overflow right side of screen
            // Show menu to the left of mouse
            left = event.pageX - menuRect.width;
            // console.log('Context menu positioned LEFT - would overflow right');
            
            // If still overflows left, clamp to left margin
            if (left < margin) {
                left = margin;
                // console.log('Context menu clamped to left margin');
            }
        } else {
            // console.log('Context menu positioned RIGHT - fits in viewport');
        }

        // If menu overflows bottom, shift menu lên trên (hoặc sát đáy)
        if (menuRect.bottom > viewportHeight) {
            // Nếu đủ chỗ phía trên chuột thì show lên trên
            if (event.pageY - menuRect.height > margin) {
                top = event.pageY - menuRect.height;
            } else {
                // Nếu không đủ chỗ trên, thì dán sát đáy viewport
                top = viewportHeight - menuRect.height - margin + window.scrollY;
                if (top < margin + window.scrollY) top = margin + window.scrollY;
            }
        }

        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';

        // Đo lại lần nữa nếu cần (menu có thể thay đổi kích thước sau khi set lại top/left)
        // (Không cần lặp lại nhiều lần, vì đã clamp sát đáy)

        setTimeout(() => {
            document.addEventListener('click', hideUnifiedContextMenu, { once: true });
        }, 100);
    }

    function hideUnifiedContextMenu() {
        document.getElementById('unified-context-menu').style.display = 'none';
        resumeAutoRefresh();
    }

    // Handle Card Context Menu - Use Unified Menu
    // === NEW: Card-based Context Menu với Submenu ===
    window.handleCardContextMenu = function (event, cardId, accountId, platform) {
        event.preventDefault();
        event.stopPropagation();
        
        currentContextCardId = cardId;
        currentContextAccountId = accountId;
        pauseAutoRefresh();

        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (!account) return;

        // Get all accounts on this card
        const cardAccounts = mxhAccounts.filter(acc => acc.card_id === cardId);
        const state = getCardState(cardId);
        const isPrimary = account.is_primary;
        const currentStatus = (account.status || 'active').toLowerCase();

        // Parse notice if it's a string
        let noticeObj = null;
        try {
            noticeObj = typeof account.notice === 'string' ? JSON.parse(account.notice || '{}') : (account.notice || {});
        } catch (e) {
            noticeObj = {};
        }
        const hasNotice = noticeObj && (noticeObj.enabled === true || noticeObj.enabled === 1 || Number(noticeObj.days) > 0);

        // Create context menu dynamically
        const menuHtml = `
            <div class="mxh-context-menu" id="card-context-menu">
                <!-- 1. Tài Khoản -->
                <div class="mxh-menu-item has-submenu">
                    <span>Tài Khoản (${cardAccounts.length})</span>
                    <div class="mxh-submenu">
                        ${cardAccounts.map((acc, idx) => {
                            const isActive = acc.id === state.activeAccountId;
                            const isPrimary = acc.is_primary;
                            return `
                            <div class="mxh-menu-item" data-action="switch-account" data-account-id="${acc.id}">
                                ${isActive ? '✓ ' : ''}${idx + 1}. ${acc.username || '...'} ${isPrimary ? '👑' : ''}
                            </div>
                        `;
                        }).join('')}
                        <div class="mxh-menu-item" data-action="add-sub-account" style="border-top: 1px solid #444a59; margin-top: 4px; padding-top: 4px;">
                            <i class="bi bi-plus-circle me-2"></i>Thêm Tài Khoản
                        </div>
                    </div>
                </div>

                <!-- 2. Thông tin -->
                <div class="mxh-menu-item" data-action="edit">
                    <i class="bi bi-pencil me-2"></i>Thông Tin
                </div>

                <!-- 3. Trạng Thái (WeChat only) -->
                ${platform === 'wechat' ? `
                <div class="mxh-menu-item has-submenu wechat-only">
                    <span>Trạng Thái</span>
                    <div class="mxh-submenu">
                        <div class="mxh-menu-item" data-action="status-active">${currentStatus === 'active' ? '✓ ' : ''}Active</div>
                        <div class="mxh-menu-item has-submenu" data-action="status-disabled">${currentStatus === 'disabled' ? '✓ ' : ''}Disabled
                            <div class="mxh-submenu">
                                <div class="mxh-menu-item" data-action="rescue-success">Được Cứu</div>
                                <div class="mxh-menu-item" data-action="rescue-failed">Thất Bại</div>
                            </div>
                        </div>
                        <div class="mxh-menu-item" data-action="status-die">${currentStatus === 'die' ? '✓ ' : ''}Die</div>
                    </div>
                </div>
                ` : ''}

                <!-- 4. Copy SĐT -->
                ${account.phone ? `
                <div class="mxh-menu-item" data-action="copy-phone">
                    <i class="bi bi-phone me-2"></i>Copy SĐT
                </div>
                ` : ''}

                <!-- 5. Quét WeChat (WeChat only) -->
                ${platform === 'wechat' ? `
                <div class="mxh-menu-item" data-action="scan-wechat">
                    <i class="bi bi-qr-code me-2"></i>Quét WeChat
                </div>
                ` : ''}

                <!-- 6. Thông báo -->
                <div class="mxh-menu-item" data-action="${hasNotice ? 'cancel-notice' : 'toggle-notice'}">
                    ${hasNotice 
                        ? '<i class="bi bi-bell-slash-fill me-2"></i>Hủy Thông Báo' 
                        : '<i class="bi bi-bell me-2"></i>Thông Báo'}
                </div>

                <!-- Xóa -->
                <div class="mxh-menu-item" data-action="delete" style="color: #ff4d4f; border-top: 1px solid #444a59; margin-top: 4px; padding-top: 4px;">
                    <i class="bi bi-trash me-2"></i>${isPrimary ? 'Xóa Card' : 'Xóa Acc'}
                </div>
            </div>
        `;

        // Remove existing menu
        const existingMenu = document.getElementById('card-context-menu');
        if (existingMenu) existingMenu.remove();

        // Add new menu
        document.body.insertAdjacentHTML('beforeend', menuHtml);
        
        // Smart positioning
        const menu = document.getElementById('card-context-menu');
        positionContextMenuSmart(menu, event.pageX, event.pageY);

        // Position submenus
        setTimeout(() => positionAllSubmenusForMenu(menu), 50);

        // Add click handler
        setTimeout(() => {
            document.addEventListener('click', hideCardContextMenu, { once: true });
        }, 100);
    }
    
    // Smart positioning function
    function positionContextMenuSmart(menu, x, y) {
        if (!menu) return;
        
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Default position
        let left = x;
        let top = y;
        
        // Check right overflow
        if (x + menuRect.width > viewportWidth) {
            left = viewportWidth - menuRect.width - 10;
        }
        
        // Check bottom overflow
        if (y + menuRect.height > viewportHeight) {
            top = viewportHeight - menuRect.height - 10;
        }
        
        // Check left overflow
        if (left < 0) left = 10;
        
        // Check top overflow
        if (top < 0) top = 10;
        
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
    }
    
    // Position all submenus for a menu
    function positionAllSubmenusForMenu(menu) {
        if (!menu) return;
        
        const submenuItems = menu.querySelectorAll('.mxh-menu-item.has-submenu');
        submenuItems.forEach(item => {
            const submenu = item.querySelector('.mxh-submenu');
            if (!submenu) return;
            
            const itemRect = item.getBoundingClientRect();
            const submenuRect = submenu.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Default: right side
            submenu.style.left = '100%';
            submenu.style.right = 'auto';
            submenu.style.top = '0';
            submenu.style.bottom = 'auto';
            
            // Check right overflow - show on left
            if (itemRect.right + submenuRect.width > viewportWidth) {
                submenu.style.left = 'auto';
                submenu.style.right = '100%';
            }
            
            // Check bottom overflow - show upward
            if (itemRect.top + submenuRect.height > viewportHeight) {
                submenu.style.top = 'auto';
                submenu.style.bottom = '0';
            }
        });
    }

    function hideCardContextMenu() {
        const menu = document.getElementById('card-context-menu');
        if (menu) menu.remove();
        resumeAutoRefresh();
    }

    // Context menu click handler
    document.addEventListener('click', async function(e) {
        const menuItem = e.target.closest('.mxh-menu-item[data-action]');
        if (!menuItem) return;

        e.preventDefault();
        e.stopPropagation();

        const action = menuItem.getAttribute('data-action');

        if (action === 'switch-account') {
            const accountId = parseInt(menuItem.getAttribute('data-account-id'));
            if (currentContextCardId && accountId) {
                flipCardToAccount(currentContextCardId, accountId);
                hideCardContextMenu();
            }
        } else if (action === 'add-sub-account') {
            if (currentContextCardId) {
                await createSubAccount(currentContextCardId);
                hideCardContextMenu();
            }
        } else if (action === 'status-active' || action === 'status-die') {
            const newStatus = action.replace('status-', '');
            if (currentContextAccountId) {
                await updateAccountStatusNew(currentContextAccountId, newStatus);
                hideCardContextMenu();
            }
        } else if (action === 'status-disabled') {
            // Chỉ đổi sang disabled, không hide menu (để hiển thị submenu)
            if (currentContextAccountId) {
                await updateAccountStatusNew(currentContextAccountId, 'disabled');
                hideCardContextMenu();
            }
        } else if (action === 'rescue-success' || action === 'rescue-failed') {
            const result = action === 'rescue-success' ? 'success' : 'failed';
            if (currentContextAccountId) {
                await rescueAccountAction(currentContextAccountId, result);
                hideCardContextMenu();
            }
        } else if (action === 'scan-wechat') {
            if (currentContextAccountId) {
                await scanWeChatAccount(currentContextAccountId);
                hideCardContextMenu();
            }
        } else if (action === 'delete') {
            // Check if it's primary account
            const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
            if (account && account.is_primary) {
                // Delete entire card
                if (currentContextCardId) {
                    await deleteCard(currentContextCardId);
                    hideCardContextMenu();
                }
            } else {
                // Delete only this account
                if (currentContextAccountId) {
                    await deleteSubAccount(currentContextAccountId);
                    hideCardContextMenu();
                }
            }
        } else if (action === 'edit') {
            if (currentContextAccountId) {
                openAccountModalForEdit(currentContextAccountId);
                hideCardContextMenu();
            }
        } else if (action === 'copy-phone') {
            const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
            if (account && account.phone) {
                navigator.clipboard.writeText(account.phone);
                if (typeof showToast === 'function') {
                    showToast(`Đã copy: ${account.phone}`, 'success');
                }
            }
            hideCardContextMenu();
        } else if (action === 'toggle-notice') {
            if (currentContextAccountId) {
                openNoticeModal(null); // Sử dụng function có sẵn
                hideCardContextMenu();
            }
        } else if (action === 'cancel-notice') {
            if (currentContextAccountId) {
                await cancelNotice(currentContextAccountId);
                hideCardContextMenu();
            }
        }
    });

    // === NEW: Create Sub-Account ===
    async function createSubAccount(cardId) {
        try {
            const response = await fetch(`/mxh/api/cards/${cardId}/accounts`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.ok) {
                const newAccount = await response.json();
                mxhAccounts.push(newAccount);
                
                // Flip to new account
                flipCardToAccount(cardId, newAccount.id);
                
                // Force re-render sau khi flip
                setTimeout(() => renderMXHAccounts(), 600);
                
                if (typeof showToast === 'function') {
                    showToast('Đã tạo tài khoản phụ!', 'success');
                }
            } else {
                throw new Error('Failed to create sub-account');
            }
        } catch (error) {
            console.error('Error creating sub-account:', error);
            if (typeof showToast === 'function') {
                showToast('Lỗi tạo tài khoản phụ!', 'error');
            }
        }
    }

    // === NEW: Delete Card (và tất cả accounts) ===
    async function deleteCard(cardId) {
        if (!confirm('Xóa card này và tất cả tài khoản trên card?')) return;

        try {
            const response = await fetch(`/mxh/api/cards/${cardId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remove from local state
                mxhAccounts = mxhAccounts.filter(acc => acc.card_id !== cardId);
                cardStates.delete(cardId);
                renderMXHAccounts();
                if (typeof showToast === 'function') {
                    showToast('Đã xóa card!', 'success');
                }
            } else {
                throw new Error('Failed to delete card');
            }
        } catch (error) {
            console.error('Error deleting card:', error);
            if (typeof showToast === 'function') {
                showToast('Lỗi xóa card!', 'error');
            }
        }
    }

    // === NEW: Delete Sub-Account ===
    async function deleteSubAccount(accountId) {
        if (!confirm('Xóa tài khoản phụ này?')) return;

        try {
            const response = await fetch(`/mxh/api/sub_accounts/${accountId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // Remove from local state
                mxhAccounts = mxhAccounts.filter(acc => acc.id !== accountId);
                renderMXHAccounts();
                if (typeof showToast === 'function') {
                    showToast('Đã xóa tài khoản phụ!', 'success');
                }
            } else {
                throw new Error('Failed to delete sub-account');
            }
        } catch (error) {
            console.error('Error deleting sub-account:', error);
            if (typeof showToast === 'function') {
                showToast('Lỗi xóa tài khoản phụ!', 'error');
            }
        }
    }

    // === NEW: Rescue Account Action ===
    async function rescueAccountAction(accountId, result) {
        try {
            const response = await fetch(`/mxh/api/accounts/${accountId}/rescue`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ result })
            });

            if (response.ok) {
                // Update local state
                const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
                if (accountIndex !== -1) {
                    if (result === 'success') {
                        mxhAccounts[accountIndex].status = 'active';
                        mxhAccounts[accountIndex].die_date = null;
                        mxhAccounts[accountIndex].rescue_success_count = (mxhAccounts[accountIndex].rescue_success_count || 0) + 1;
                    } else {
                        mxhAccounts[accountIndex].rescue_count = (mxhAccounts[accountIndex].rescue_count || 0) + 1;
                    }
                }
                
                renderMXHAccounts();
                const message = result === 'success' ? '✅ Cứu thành công!' : '📝 Đã ghi nhận cứu thất bại!';
                if (typeof showToast === 'function') {
                    showToast(message, 'success');
                }
            } else {
                throw new Error('Failed to rescue account');
            }
        } catch (error) {
            console.error('Error rescuing account:', error);
            if (typeof showToast === 'function') {
                showToast('Lỗi khi cứu tài khoản!', 'error');
            }
        }
    }

    // === NEW: Scan WeChat Account ===
    async function scanWeChatAccount(accountId) {
        try {
            const response = await fetch(`/mxh/api/accounts/${accountId}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                // Update local state
                const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
                if (accountIndex !== -1) {
                    mxhAccounts[accountIndex].wechat_scan_count = (mxhAccounts[accountIndex].wechat_scan_count || 0) + 1;
                    mxhAccounts[accountIndex].wechat_last_scan_date = new Date().toISOString();
                }
                
                renderMXHAccounts();
                
                // Show scan QR modal
                showScanQRModal(accountId);
                
                if (typeof showToast === 'function') {
                    showToast('✅ Đã ghi nhận quét WeChat!', 'success');
                }
            } else {
                throw new Error('Failed to record scan');
            }
        } catch (error) {
            console.error('Error scanning WeChat:', error);
            if (typeof showToast === 'function') {
                showToast('Lỗi khi quét WeChat!', 'error');
            }
        }
    }

    // Show Scan QR Modal with WeChat icon
    function showScanQRModal(accountId) {
        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (!account) return;

        // Create modal HTML
        const modalHtml = `
            <div class="modal fade" id="scan-qr-modal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-wechat me-2" style="color: #07c160;"></i>Quét WeChat
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div style="font-size: 5rem; color: #07c160;">
                                <i class="bi bi-qr-code"></i>
                            </div>
                            <h4 class="mt-3">${account.card_name}</h4>
                            <p class="text-muted">${account.username || '...'}</p>
                            <p class="text-muted">📞 ${account.phone || '...'}</p>
                            <div class="mt-3">
                                <p><strong>Lượt quét:</strong> ${account.wechat_scan_count || 0}</p>
                                ${account.wechat_last_scan_date ? `<p class="text-muted small">Lần cuối: ${new Date(account.wechat_last_scan_date).toLocaleString('vi-VN')}</p>` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('scan-qr-modal');
        if (existingModal) existingModal.remove();

        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('scan-qr-modal'));
        modal.show();

        // Remove modal from DOM when hidden
        document.getElementById('scan-qr-modal').addEventListener('hidden.bs.modal', function () {
            this.remove();
        });
    }

    // === NEW: Update Account Status với die_date persist ===
    async function updateAccountStatusNew(accountId, status) {
        try {
            const payload = { status };
            
            // If status is die, set die_date
            if (status === 'die') {
                payload.die_date = new Date().toISOString().split('T')[0];
            } else {
                payload.die_date = null;
            }

            const response = await fetch(`/mxh/api/accounts/${accountId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                const updatedAccount = await response.json();
                
                // Update local state
                const index = mxhAccounts.findIndex(acc => acc.id === accountId);
                if (index !== -1) {
                    mxhAccounts[index] = updatedAccount;
                }
                
                renderMXHAccounts();
                if (typeof showToast === 'function') {
                    showToast(`Đã cập nhật trạng thái: ${status}`, 'success');
                }
            } else {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to update status');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            if (typeof showToast === 'function') {
                showToast(`Lỗi cập nhật trạng thái: ${error.message}`, 'error');
            }
        }
    }

    window.showTelegramContextMenu = function (event, accountId) {
        event.preventDefault();
        event.stopPropagation(); // CRITICAL: Stop event from bubbling to dashboard menu
        currentContextAccountId = accountId;
        pauseAutoRefresh();

        // console.log('Telegram context menu opened for account:', accountId);

        // Hide all other context menus first
        document.getElementById('wechat-context-menu').style.display = 'none';
        document.getElementById('generic-context-menu').style.display = 'none';

        const contextMenu = document.getElementById('telegram-context-menu');
        if (!contextMenu) {
            console.error('Telegram context menu element not found!');
            return;
        }

        contextMenu.style.display = 'block';
        
        // Smart positioning to avoid overflow
        contextMenu.style.left = event.pageX + 'px';
        contextMenu.style.top = event.pageY + 'px';
        
        // Calculate menu size and viewport
        let menuRect = contextMenu.getBoundingClientRect();
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
        const margin = 8;
        
        let left = event.pageX;
        let top = event.pageY;
        
        // Horizontal positioning: Smart left/right positioning
        if (menuRect.right > viewportWidth - margin) {
            // Menu will overflow right side of screen
            // Show menu to the left of mouse
            left = event.pageX - menuRect.width;
            // console.log('Context menu positioned LEFT - would overflow right');
            
            // If still overflows left, clamp to left margin
            if (left < margin) {
                left = margin;
                // console.log('Context menu clamped to left margin');
            }
        } else {
            // console.log('Context menu positioned RIGHT - fits in viewport');
        }
        
        // Vertical positioning
        if (menuRect.bottom > viewportHeight) {
            // Nếu đủ chỗ phía trên chuột thì show lên trên
            if (event.pageY - menuRect.height > margin) {
                top = event.pageY - menuRect.height;
            } else {
                // Nếu không đủ chỗ trên, thì dán sát đáy viewport
                top = viewportHeight - menuRect.height - margin + window.scrollY;
                if (top < margin + window.scrollY) top = margin + window.scrollY;
            }
        }
        
        contextMenu.style.left = left + 'px';
        contextMenu.style.top = top + 'px';

        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (account) {
            // Configure notice toggle
            configureNoticeToggleFor('telegram-context-menu', account);
        }

        setTimeout(() => {
            document.addEventListener('click', hideTelegramContextMenu, { once: true });
        }, 100);
    }

    function hideTelegramContextMenu() {
        const contextMenu = document.getElementById('telegram-context-menu');
        if (contextMenu) {
            contextMenu.style.display = 'none';
        }
        resumeAutoRefresh();
    }

    // ===== Submenu cho "Tài khoản" trong context menu =====
    function generateAccountsSubmenu(currentId) {
        const submenu = document.getElementById('accounts-submenu');
        if (!submenu || !Array.isArray(mxhAccounts)) return;

        const me = mxhAccounts.find(a => a.id === currentId);
        if (!me) { submenu.innerHTML = '<div class="menu-item disabled">Không có dữ liệu</div>'; return; }

        const items = mxhAccounts
            .filter(a => a.card_id === me.card_id)   // cùng card
            .map(a => `
                <div class="menu-item ${a.id===currentId ? 'active' : ''}" data-account-id="${a.id}">
                    <i class="bi bi-person me-2"></i>
                    ${escapeHtml(a.username || a.account_name || a.phone || ('ID ' + a.id))}
                </div>
            `).join('');

        submenu.innerHTML = items || '<div class="menu-item disabled">Chưa có tài khoản khác</div>';

        // (Tùy chọn) chuyển nhanh context sang account khác
        submenu.querySelectorAll('.menu-item[data-account-id]').forEach(el => {
            el.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const id = parseInt(el.dataset.accountId, 10);
                currentContextAccountId = id;
                // Cập nhật lại menu theo account mới
                const acc = mxhAccounts.find(x => x.id === id);
                if (acc) {
                    // Gọi lại unified context menu để sync hiển thị
                    showUnifiedContextMenu({pageX: ev.pageX, pageY: ev.pageY, preventDefault(){}, stopPropagation(){}}, id, (acc.platform||'wechat'));
                }
            });
        });
    }

    // WeChat Context Actions with instant feedback
    async function editCurrentContextAccount(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;
        // Use the global variable that was set when context menu was opened
        const isSecondary = currentEditingIsSecondary || false;
        openWeChatModal(currentContextAccountId, isSecondary);
        hideWeChatContextMenu();
    }

    async function markAccountAsScanned(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        const contextMenu = document.getElementById('wechat-context-menu');
        const isSecondary = contextMenu.dataset.isSecondary === 'true';

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            const scanCountKey = isSecondary ? 'secondary_wechat_scan_count' : 'wechat_scan_count';
            const lastScanKey = isSecondary ? 'secondary_wechat_last_scan_date' : 'wechat_last_scan_date';
            mxhAccounts[accountIndex][scanCountKey] = (mxhAccounts[accountIndex][scanCountKey] || 0) + 1;
            mxhAccounts[accountIndex][lastScanKey] = new Date().toISOString();
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_secondary: isSecondary })
            });

            if (response.ok) {
                showToast('✅ Đã đánh dấu quét!', 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
        hideWeChatContextMenu();
    }

    // Notice modal functions
    let noticeTargetId = null;
    function openNoticeModal(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        noticeTargetId = currentContextAccountId;
        document.getElementById('noticeTitle').value = 'Reg';
        document.getElementById('noticeDays').value = 7;
        document.getElementById('noticeNote').value = '';

        const modal = new bootstrap.Modal(document.getElementById('noticeModal'));
        modal.show();

        hideWeChatContextMenu();
        hideGenericContextMenu();
        hideTelegramContextMenu();
    }

    async function submitNotice() {
        const title = document.getElementById('noticeTitle').value.trim();
        const days = parseInt(document.getElementById('noticeDays').value, 10) || 0;
        const note = document.getElementById('noticeNote').value.trim();

        if (!noticeTargetId || !title || days <= 0) {
            showToast('Vui lòng điền đầy đủ thông tin!', 'error');
            return;
        }

        try {
            // Pause auto-refresh to prevent race condition
            stopAutoRefresh();

            const response = await fetch(`/mxh/api/accounts/${noticeTargetId}/notice`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, days, note })
            });

            if (response.ok) {
                showToast('✅ Đã đặt thông báo!', 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('noticeModal'));
                modal.hide();

                // Update local data immediately to trigger render
                const account = mxhAccounts.find(a => a.id === noticeTargetId);
                if (account) {
                    const startDate = new Date();
                    const dueDate = new Date(startDate);
                    dueDate.setDate(dueDate.getDate() + days);
                    
                    account.notice = {
                        enabled: true,
                        title: title,
                        days: days,
                        note: note,
                        start_at: startDate.toISOString(),
                        due_date: dueDate.toISOString()
                    };
                    // console.log('✅ Updated local notice for account', noticeTargetId, account.notice);
                }

                // Force re-render with updated data
                renderMXHAccounts();

                // Resume auto-refresh after render
                setTimeout(() => startAutoRefresh(), 100);
            } else {
                showToast('Lỗi khi đặt thông báo!', 'error');
                startAutoRefresh(); // Resume even on error
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            startAutoRefresh(); // Resume even on error
        }
        noticeTargetId = null;
    }

    async function clearNotice(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        try {
            // Pause auto-refresh to prevent race condition
            stopAutoRefresh();

            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/notice`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('✅ Đã tắt thông báo!', 'success');

                // Update local data immediately to trigger render
                const account = mxhAccounts.find(a => a.id === currentContextAccountId);
                if (account) {
                    account.notice = null; // Set to null instead of empty object
                    // console.log('✅ Cleared local notice for account', currentContextAccountId);
                }

                // Force re-render with updated data
                renderMXHAccounts();

                // Resume auto-refresh after render
                setTimeout(() => startAutoRefresh(), 100);
            } else {
                showToast('Lỗi khi xóa thông báo!', 'error');
                startAutoRefresh(); // Resume even on error
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            startAutoRefresh(); // Resume even on error
        }

        hideWeChatContextMenu();
        hideGenericContextMenu();
        hideTelegramContextMenu();
    }
    
    // Alias for cancel notice from context menu
    async function cancelNotice(accountId) {
        currentContextAccountId = accountId;
        await clearNotice(null);
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        };
        return String(text).replace(/[&<>"']/g, m => map[m]);
    }

    function copyPhoneNumber(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
        if (account && account.phone) {
            navigator.clipboard.writeText(account.phone);
            showToast('Đã copy SĐT!', 'success');
        }
        hideWeChatContextMenu();
    }

    function copyEmail(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
        if (account && account.email) {
            navigator.clipboard.writeText(account.email);
            showToast('Đã copy Email!', 'success');
        }
        hideUnifiedContextMenu();
    }

    async function resetScanCount(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            mxhAccounts[accountIndex].wechat_scan_count = 0;
            mxhAccounts[accountIndex].wechat_last_scan_date = null;
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/scan`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reset: true })
            });

            if (response.ok) {
                showToast('✅ Đã reset lượt quét!', 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
        hideWeChatContextMenu();
    }

    function changeCardNumber(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;
        const modal = new bootstrap.Modal(document.getElementById('change-card-number-modal'));
        modal.show();
        hideWeChatContextMenu();
    }

    async function toggleAccountStatus(event, accountId = null) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        // If called from card click (with accountId parameter)
        if (accountId !== null) {
            currentContextAccountId = accountId;
        }

        if (!currentContextAccountId) return;

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            const currentStatus = mxhAccounts[accountIndex].status;
            mxhAccounts[accountIndex].status = currentStatus === 'disabled' ? 'active' : 'disabled';
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/toggle-status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.ok) {
                showToast('✅ Đã thay đổi trạng thái!', 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }

        // Only hide context menu if it exists and is visible
        const contextMenu = document.getElementById('wechat-context-menu');
        if (contextMenu && contextMenu.style.display === 'block') {
            hideWeChatContextMenu();
        }
    }

    // ===== UPDATE ACCOUNT STATUS (Unified Menu) =====
    async function updateAccountStatus(newStatus) {
        if (!currentContextAccountId) return;

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            mxhAccounts[accountIndex].status = newStatus;
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    status: newStatus
                })
            });

            if (response.ok) {
                const statusText = newStatus === 'active' ? 'Available' :
                    newStatus === 'die' ? 'Die' : 'Vô hiệu hóa';
                showToast(`✅ Đã đổi sang ${statusText}!`, 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    }

    // ===== RESCUE ACCOUNT (Unified Menu) =====
    async function rescueAccountUnified(result) {
        if (!currentContextAccountId) return;

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            if (result === 'success') {
                // Cứu thành công - chuyển về active
                mxhAccounts[accountIndex].status = 'active';
                mxhAccounts[accountIndex].die_date = null;
                mxhAccounts[accountIndex].rescue_success_count = (mxhAccounts[accountIndex].rescue_success_count || 0) + 1;
            } else {
                // Cứu thất bại - giữ disabled, tăng rescue_count
                mxhAccounts[accountIndex].rescue_count = (mxhAccounts[accountIndex].rescue_count || 0) + 1;
            }
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/rescue`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    result: result
                })
            });

            if (response.ok) {
                const message = result === 'success' ? '✅ Đã cứu thành công!' : '📝 Đã ghi nhận cứu thất bại!';
                showToast(message, 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    }

    async function rescueAccount(result, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            if (result === 'success') {
                mxhAccounts[accountIndex].status = 'active';
                mxhAccounts[accountIndex].die_date = null;
                mxhAccounts[accountIndex].rescue_success_count = (mxhAccounts[accountIndex].rescue_success_count || 0) + 1;
            } else {
                mxhAccounts[accountIndex].rescue_count = (mxhAccounts[accountIndex].rescue_count || 0) + 1;
            }
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}/rescue`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ result: result })
            });

            if (response.ok) {
                showToast(result === 'success' ? '✅ Cứu thành công!' : '✅ Đã ghi nhận!', 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
        hideWeChatContextMenu();
    }

    function showDeleteConfirm(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        const modal = new bootstrap.Modal(document.getElementById('delete-card-modal'));
        modal.show();
        hideWeChatContextMenu();
    }

    // Generic Account Actions
    function editGenericAccount(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;
        const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
        if (!account) return;

        document.getElementById('generic-username').value = account.login_username || '';
        document.getElementById('generic-password').value = account.login_password || '';
        document.getElementById('generic-display-name').value = account.username || '';
        document.getElementById('generic-phone').value = account.phone || '';
        document.getElementById('generic-url').value = account.url || '';

        const modal = new bootstrap.Modal(document.getElementById('generic-account-modal'));
        modal.show();
        hideGenericContextMenu();
    }

    // Alias for new context menu
    function openAccountModalForEdit(accountId) {
        currentContextAccountId = accountId;
        const account = mxhAccounts.find(acc => acc.id === accountId);
        
        if (!account) return;
        
        // Nếu là WeChat → mở WeChat modal, không thì mở generic modal
        if (account.platform === 'wechat') {
            openWeChatModal(accountId);
        } else {
            editGenericAccount(null);
        }
    }

    function showGenericDeleteConfirm(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (confirm('Bạn có chắc muốn xóa card này?')) {
            deleteAccount(currentContextAccountId);
        }
        hideGenericContextMenu();
    }

    async function deleteAccount(accountId) {
        // Instant local update - remove from array
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
        if (accountIndex !== -1) {
            mxhAccounts.splice(accountIndex, 1);
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${accountId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                showToast('✅ Đã xóa card!', 'success');
                
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    }

    async function resetAccount(accountId) {
        // Instant local update - reset all data
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
        if (accountIndex !== -1) {
            // Keep only basic structure, reset everything else
            const account = mxhAccounts[accountIndex];
            mxhAccounts[accountIndex] = {
                id: account.id,
                platform: account.platform,
                group_id: account.group_id,
                card_name: account.card_name,
                // Reset all other fields
                username: '',
                phone: '',
                status: 'active',
                wechat_created_day: null,
                wechat_created_month: null,
                wechat_created_year: null,
                wechat_scan_count: 0,
                wechat_last_scan_date: null,
                die_date: null,
                rescue_count: 0,
                rescue_success_count: 0,
                notice: null,
                muted_until: null
            };
        }
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${accountId}/reset`, {
                method: 'POST'
            });

            if (response.ok) {
                showToast('✅ Đã reset card!', 'success');
                
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    }

    // Telegram Context Menu Actions
    async function copyTelegramPhone(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        if (!currentContextAccountId) return;

        const account = mxhAccounts.find(acc => acc.id === currentContextAccountId);
        if (!account || !account.phone) {
            showToast('⚠️ Không có số điện thoại!', 'warning');
            hideTelegramContextMenu();
            return;
        }

        try {
            await navigator.clipboard.writeText(account.phone);
            showToast('📋 Đã copy số điện thoại!', 'success');
        } catch (error) {
            // Fallback method
            const textArea = document.createElement('textarea');
            textArea.value = account.phone;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showToast('📋 Đã copy số điện thoại!', 'success');
        }

        hideTelegramContextMenu();
    }

    // Modal Button Handlers with instant updates
    document.getElementById('mxh-save-account-btn').addEventListener('click', async () => {
        const platform = document.getElementById('mxh-platform').value;
        const username = (document.getElementById('mxh-username').value || '.').trim() || '.';
        const password = (document.getElementById('mxh-password')?.value || '.').trim() || '.';
        const phone = (document.getElementById('mxh-phone').value || '.').trim() || '.';
        const url = (document.getElementById('mxh-url').value || '.').trim() || '.';
        const day = parseInt(document.getElementById('mxh-day').value, 10);
        const month = parseInt(document.getElementById('mxh-month').value, 10);
        const year = parseInt(document.getElementById('mxh-year').value, 10);

        // Chỉ bắt buộc: NỀN TẢNG + NGÀY/THÁNG/NĂM (đã auto-fill)
        if (!platform || !day || !month || !year) {
            showToast('Chọn Nền tảng và Ngày tạo!', 'error');
            return;
        }

        try {
            const groupId = await ensurePlatformGroup(platform);
            const autoCardNumber = (await getNextCardNumber(groupId)).toString();

            const res = await fetch('/mxh/api/accounts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    card_name: autoCardNumber,
                    group_id: groupId,
                    platform,
                    username,             // nếu trống đã là "."
                    phone,
                    url,
                    login_username: ".",  // lưu cặp thông tin đăng nhập để hiện sau này
                    login_password: password,
                    wechat_created_day: day,
                    wechat_created_month: month,
                    wechat_created_year: year
                })
            });

            if (res.ok) {
                showToast('✅ Đã tạo card!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('mxh-addAccountModal')).hide();
                await loadMXHData(false);
            } else {
                const err = await res.json();
                showToast(err.error || 'Lỗi khi tạo tài khoản!', 'error');
            }
        } catch {
            showToast('Lỗi kết nối!', 'error');
        }
    });

    document.getElementById('wechat-apply-btn').addEventListener('click', async () => {
        if (!currentContextAccountId) return;

        const selectedStatus = document.getElementById('wechat-status').value;
        
        // Get date values from separate inputs
        const day = parseInt(document.getElementById('wechat-day').value) || 1;
        const month = parseInt(document.getElementById('wechat-month').value) || 1;
        const year = parseInt(document.getElementById('wechat-year').value) || 2024;
        
        const data = {
            card_name: document.getElementById('wechat-card-name').value,
            username: document.getElementById('wechat-username').value,
            phone: document.getElementById('wechat-phone').value,
            wechat_created_day: day,
            wechat_created_month: month,
            wechat_created_year: year,
            status: selectedStatus === 'muted' ? mxhAccounts.find(a=>a.id === currentContextAccountId).status : (selectedStatus === 'available' ? 'active' : (selectedStatus === 'die' ? 'disabled' : selectedStatus)), // Logic: 'available'->'active', 'die'->'disabled', 'muted' keeps previous status
            wechat_status: selectedStatus === 'muted' ? mxhAccounts.find(a=>a.id === currentContextAccountId).wechat_status : selectedStatus // Logic: Sets 'wechat_status' to the exact selected value, unless muted (then keep previous wechat_status)
        };

        // Add mute/unmute logic for the API call if status is 'muted'
        if(selectedStatus === 'muted') {
            await fetch(`/mxh/api/accounts/${currentContextAccountId}/mute`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({}) 
            });
        } else {
            // Unmute if previously muted and new status is not muted
            const account = mxhAccounts.find(a=>a.id === currentContextAccountId);
            const isMuted = account.muted_until && new Date(account.muted_until) > new Date();
            if(isMuted) {
                await fetch(`/mxh/api/accounts/${currentContextAccountId}/unmute`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({}) 
                });
            }
        }

        bootstrap.Modal.getInstance(document.getElementById('wechat-account-modal')).hide();
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast('✅ Đã cập nhật!', 'success');
                
            } else {
                const error = await response.json();
                showToast(error.error || 'Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    });

    document.getElementById('generic-account-edit-form').addEventListener('submit', async (e) => {
        e.preventDefault(); // Prevent default form submission (browser refresh)
        if (!currentContextAccountId) return;

        const data = {
            login_username: document.getElementById('generic-username').value,
            login_password: document.getElementById('generic-password').value,
            username: document.getElementById('generic-display-name').value,
            phone: document.getElementById('generic-phone').value,
            url: document.getElementById('generic-url').value
        };

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            Object.keys(data).forEach(key => {
                if (data[key] !== undefined && data[key] !== null) {
                    mxhAccounts[accountIndex][key] = data[key];
                }
            });
        }

        bootstrap.Modal.getInstance(document.getElementById('generic-account-modal')).hide();
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                showToast('✅ Đã cập nhật!', 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    });

    document.getElementById('apply-card-number-btn').addEventListener('click', async () => {
        if (!currentContextAccountId) return;

        const newNumber = document.getElementById('new-card-number').value;
        if (!newNumber) return;

        // Instant local update
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === currentContextAccountId);
        if (accountIndex !== -1) {
            mxhAccounts[accountIndex].card_name = newNumber;
        }

        bootstrap.Modal.getInstance(document.getElementById('change-card-number-modal')).hide();
        renderMXHAccounts();

        try {
            const response = await fetch(`/mxh/api/accounts/${currentContextAccountId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ card_name: newNumber })
            });

            if (response.ok) {
                showToast('✅ Đã đổi số hiệu!', 'success');
            } else {
                showToast('Lỗi!', 'error');
                await loadMXHData(false);
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false);
        }
    });

    document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        if (!currentContextAccountId) return;
        await deleteAccount(currentContextAccountId);
        bootstrap.Modal.getInstance(document.getElementById('delete-card-modal')).hide();
    });

    // Reset button handlers
    document.getElementById('wechat-reset-btn').addEventListener('click', () => {
        if (!currentContextAccountId) return;
        const modal = new bootstrap.Modal(document.getElementById('reset-card-modal'));
        modal.show();
    });

    document.getElementById('generic-reset-btn').addEventListener('click', () => {
        if (!currentContextAccountId) return;
        const modal = new bootstrap.Modal(document.getElementById('reset-card-modal'));
        modal.show();
    });

    document.getElementById('confirm-reset-btn').addEventListener('click', async () => {
        if (!currentContextAccountId) return;
        await resetAccount(currentContextAccountId);
        bootstrap.Modal.getInstance(document.getElementById('reset-card-modal')).hide();
        bootstrap.Modal.getInstance(document.getElementById('wechat-account-modal')).hide();
        bootstrap.Modal.getInstance(document.getElementById('generic-account-modal')).hide();
    });

    document.getElementById('mxh-apply-view-mode-btn').addEventListener('click', () => {
        const cardsPerRow = document.getElementById('mxh-cards-per-row').value;
        localStorage.setItem('mxh_cards_per_row', cardsPerRow);

        const style = document.getElementById('mxh-dynamic-style') || document.createElement('style');
        style.id = 'mxh-dynamic-style';
        style.innerHTML = `
        #mxh-accounts-container .row > .col {
            flex: 0 0 calc(100% / ${cardsPerRow});
            max-width: calc(100% / ${cardsPerRow});
        }
    `;
        if (!document.getElementById('mxh-dynamic-style')) {
            document.head.appendChild(style);
        }

        showToast(`Đã áp dụng ${cardsPerRow} cards/hàng!`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('mxh-view-mode-modal')).hide();
    });

    // Initialize cards per row setting
    (function initializeCardsPerRow() {
        const savedCardsPerRow = localStorage.getItem('mxh_cards_per_row') || 12;
        const cardsPerRowInput = document.getElementById('mxh-cards-per-row');
        if (cardsPerRowInput) {
            cardsPerRowInput.value = savedCardsPerRow;
        }
        const style = document.createElement('style');
        style.id = 'mxh-dynamic-style';
        style.innerHTML = `
        #mxh-accounts-container .row > .col {
            flex: 0 0 calc(100% / ${savedCardsPerRow});
            max-width: calc(100% / ${savedCardsPerRow});
        }
    `;
        document.head.appendChild(style);
    })();


    // Initialize - Load data and start auto-refresh
    document.addEventListener('DOMContentLoaded', async () => {
        // console.log('🚀 MXH Tab Initializing...');

        // Initial load
        await loadMXHData(true);

        // Start auto-refresh
        startAutoRefresh();

        // Pause auto-refresh when modal is opened
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('show.bs.modal', () => {
                pauseAutoRefresh();
            });
            modal.addEventListener('hide.bs.modal', () => {
                resumeAutoRefresh();
            });
        });

        // Handle page visibility changes (pause when tab not visible)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopAutoRefresh();
                // console.log('⏸️ MXH Auto-refresh paused (tab hidden)');
            } else {
                startAutoRefresh();
                loadMXHData(true); // Immediate refresh when tab becomes visible
                // console.log('▶️ MXH Auto-refresh resumed (tab visible)');
            }
        });

        // console.log('✅ MXH Tab Ready - Real-time mode enabled!');

        // Event delegation for WeChat context menu
        document.getElementById('wechat-context-menu').addEventListener('click', (e) => {
            const menuItem = e.target.closest('.menu-item');
            if (!menuItem) return;

            e.preventDefault();
            e.stopPropagation();

            const action = menuItem.dataset.action;
            if (!action) return;

            switch (action) {
                case 'edit':
                    openWeChatModal(currentContextAccountId);
                    break;
                case 'mark-scanned':
                    markAccountAsScanned(e);
                    break;
                case 'set-notice':
                    openNoticeModal(e);
                    break;
                case 'clear-notice':
                    clearNotice(e);
                    break;
                case 'copy-phone':
                    copyPhoneNumber(e);
                    break;
                case 'reset-scan':
                    resetScanCount(e);
                    break;
                case 'change-number':
                    changeCardNumber(e);
                    break;
                case 'toggle-status':
                    toggleAccountStatus(e);
                    break;
                case 'rescue-success':
                    rescueAccount('success', e);
                    break;
                case 'rescue-failed':
                    rescueAccount('failed', e);
                    break;
                case 'delete':
                    showDeleteConfirm(e);
                    break;
            }
        });

        // Event delegation for Generic context menu
        document.getElementById('generic-context-menu').addEventListener('click', (e) => {
            const menuItem = e.target.closest('.menu-item');
            if (!menuItem) return;

            e.preventDefault();
            e.stopPropagation();

            const action = menuItem.dataset.action;
            if (!action) return;

            switch (action) {
                case 'set-notice':
                    openNoticeModal(e);
                    break;
                case 'clear-notice':
                    clearNotice(e);
                    break;
                case 'edit-generic':
                    openGenericModal(e);
                    break;
                case 'delete-generic':
                    showDeleteConfirm(e);
                    break;
            }
        });

        // Event delegation for Telegram context menu
        document.getElementById('telegram-context-menu').addEventListener('click', (e) => {
            const menuItem = e.target.closest('.menu-item');
            if (!menuItem) return;

            e.preventDefault();
            e.stopPropagation();

            const action = menuItem.dataset.action;
            if (!action) return;

            switch (action) {
                case 'set-notice':
                    openNoticeModal(e);
                    break;
                case 'clear-notice':
                    clearNotice(e);
                    break;
                case 'copy-phone-telegram':
                    copyTelegramPhone(e);
                    break;
                case 'edit-generic':
                    openGenericModal(e);
                    break;
                case 'delete-generic':
                    showDeleteConfirm(e);
                    break;
            }
        });


        // ===== UNIFIED CONTEXT MENU EVENT LISTENER =====
        document.getElementById('unified-context-menu').addEventListener('click', async (e) => {
            const menuItem = e.target.closest('.menu-item');
            if (!menuItem) return;

            e.preventDefault();
            e.stopPropagation();

            const action = menuItem.dataset.action;
            if (!action) return;

            // console.log('Unified menu action:', action);

            switch (action) {
                case 'edit':
                    openWeChatModal(currentContextAccountId);
                    break;
                case 'status-available':
                    await updateAccountStatus('active');
                    break;
                case 'status-die':
                    await updateAccountStatus('die');
                    break;
                case 'status-disabled':
                    await updateAccountStatus('disabled');
                    break;
                case 'rescue-success':
                    await rescueAccountUnified('success');
                    break;
                case 'rescue-failed':
                    await rescueAccountUnified('failed');
                    break;
                case 'mark-scanned':
                    markAccountAsScanned(e);
                    break;
                case 'set-notice':
                    openNoticeModal(e);
                    break;
                case 'clear-notice':
                    clearNotice(e);
                    break;
                case 'copy-phone':
                    copyPhoneNumber(e);
                    break;
                case 'copy-email':
                    copyEmail(e);
                    break;
                case 'reset-scan':
                    resetScanCount(e);
                    break;
                case 'change-number':
                    changeCardNumber(e);
                    break;
                case 'delete':
                    showDeleteConfirm(e);
                    break;
                // NOTE: 'switch-account' và 'add-new-account' đã bị xóa
                // vì unified-context-menu không được dùng cho card mới
                // Card mới sử dụng handleCardContextMenu() với card-context-menu
            }

            // Hide menu after action
            hideUnifiedContextMenu();
        });
    });


    // Open WeChat Modal Function
    let currentEditingIsSecondary = false;
    let _openWeChatModalLock = false;
    window.openWeChatModal = function (accountId) {
        if (_openWeChatModalLock) return;
        _openWeChatModalLock = true;
        
        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (!account) {
            _openWeChatModalLock = false;
            return;
        }

        currentContextAccountId = accountId;
        currentEditingIsSecondary = false; // Always false now

        const modalTitle = document.querySelector('#wechat-account-modal .modal-title');
        modalTitle.innerHTML = '<i class="bi bi-wechat me-2"></i>Thông Tin Tài Khoản';

        document.getElementById('wechat-card-name').value = account.card_name || '';
        document.getElementById('wechat-username').value = account.username || '';
        document.getElementById('wechat-phone').value = account.phone || '';
        document.getElementById('wechat-day').value = account.wechat_created_day || 1;
        document.getElementById('wechat-month').value = account.wechat_created_month || 1;
        document.getElementById('wechat-year').value = account.wechat_created_year || 2024;
        
        let primaryStatus = account.status || 'active';
        if (account.muted_until && new Date(account.muted_until) > new Date()) {
            primaryStatus = 'muted';
        }
        document.getElementById('wechat-status').value = primaryStatus;
        
        const modal = new bootstrap.Modal(document.getElementById('wechat-account-modal'));
        modal.show();
        
        setTimeout(() => { _openWeChatModalLock = false; }, 300);
    };

    // ===== INLINE EDITING FUNCTIONS WITH INSTANT UPDATES =====
    
    // Save inline edit when user clicks away or presses Enter
    window.saveInlineEdit = async function(element, accountId, field) {
        const newValue = element.textContent.trim();
        
        // Remove emoji and extra characters for phone field
        let cleanValue = newValue;
        if (field === 'phone') {
            cleanValue = newValue.replace(/[📞\s]/g, '');
        }
        
        // Get original value from account data
        const account = mxhAccounts.find(acc => acc.id === accountId);
        if (!account) return;
        
        const originalValue = account[field] || '.';
        
        // If empty or just "...", set to "."
        if (!cleanValue || cleanValue === '...' || cleanValue === '...') {
            cleanValue = '.';
        }
        
        // If unchanged, do nothing
        if (cleanValue === originalValue) {
            element.style.borderBottom = '1px dashed transparent';
            return;
        }
        
        // Update via API
        const success = await quickUpdateField(accountId, field, cleanValue);
        
        if (success) {
            // Update display with proper format
            if (field === 'phone') {
                element.textContent = `📞 ${cleanValue}`;
            } else {
                element.textContent = cleanValue;
            }
            // Re-render to update all cards showing this account
            renderMXHAccounts();
        } else {
            // Restore original on failure
            if (field === 'phone') {
                element.textContent = `📞 ${originalValue}`;
            } else {
                element.textContent = originalValue;
            }
        }
        
        element.style.borderBottom = '1px dashed transparent';
    };
    
    // Quick update field (instant local update, debounced API call)
    async function quickUpdateField(accountId, field, value) {
        try {
            // INSTANT LOCAL UPDATE - Update UI immediately
            const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
            if (accountIndex !== -1) {
                mxhAccounts[accountIndex][field] = value;
            }

            // API call in background
            const response = await fetch(`/mxh/api/accounts/${accountId}/quick-update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    field: field,
                    value: value
                })
            });

            if (response.ok) {
                showToast(`✅ Đã lưu ${field === 'username' ? 'tên' : 'SĐT'}!`, 'success');
                return true;
            } else {
                // Revert on error
                const error = await response.json();
                showToast(error.error || 'Lỗi khi cập nhật!', 'error');
                await loadMXHData(false); // Reload to get correct data
                return false;
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false); // Reload to get correct data
            return false;
        }
    }

    // Setup contenteditable fields
    function setupEditableFields() {
        const editableFields = document.querySelectorAll('.editable-field');

        editableFields.forEach(field => {
            // Store original value
            field.dataset.originalValue = field.textContent.trim();

            // Handle Enter key - save and blur
            field.addEventListener('keydown', async (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    field.blur();
                }
            });

            // Handle Escape key - cancel and restore
            field.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    field.textContent = field.dataset.originalValue;
                    field.blur();
                }
            });

            // Handle blur - save changes
            field.addEventListener('blur', async (e) => {
                let newValue = e.target.textContent.trim();
                const accountId = parseInt(e.target.dataset.accountId);
                const fieldName = e.target.dataset.field;

                // Remove emoji prefix for phone
                if (fieldName === 'phone') {
                    newValue = newValue.replace(/^📞\s*/, '').trim();
                }
                
                // Check if value is the same or if it's just the placeholder being edited (and not real data)
                const isNoChange = newValue === field.dataset.originalValue || 
                                    (newValue === '' && field.dataset.originalValue === '.') || 
                                    (newValue === 'Click để nhập' && field.dataset.originalValue === ''); // NEW CHECK
                                    
                if (isNoChange) {
                    // Restore the visual placeholder if needed
                    if (fieldName === 'phone') {
                        e.target.textContent = field.dataset.originalValue ? `📞 ${field.dataset.originalValue}` : '📞 Click để nhập';
                    } else {
                        e.target.textContent = field.dataset.originalValue || 'Click để nhập';
                    }
                    return;
                }
                
                // If the value is a placeholder 'Click để nhập', treat as empty string '.'
                if (newValue === 'Click để nhập') {
                    newValue = '.'; // Use '.' as the internal empty value marker, as seen in POST requests
                }

                // Save to backend
                const success = await quickUpdateField(accountId, fieldName, newValue);

                if (success) {
                    field.dataset.originalValue = newValue;
                    // Update display with emoji if phone
                    if (fieldName === 'phone') {
                        e.target.textContent = `📞 ${newValue}`;
                    }
                } else {
                    // Restore original value on failure
                    if (fieldName === 'phone') {
                        e.target.textContent = field.dataset.originalValue ? `📞 ${field.dataset.originalValue}` : '📞 Click để nhập';
                    } else {
                        e.target.textContent = field.dataset.originalValue || 'Click để nhập';
                    }
                }
            });

            // Select all text on focus
            field.addEventListener('focus', (e) => {
                // Remove emoji prefix for easier editing
                if (e.target.dataset.field === 'phone') {
                    const phone = e.target.textContent.replace(/^📞\s*/, '').replace('Click để nhập', '').trim();
                    e.target.textContent = phone;
                } else if (e.target.textContent.trim() === 'Click để nhập') {
                    e.target.textContent = '';
                }

                // Select all text
                setTimeout(() => {
                    const range = document.createRange();
                    range.selectNodeContents(e.target);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);
                }, 0);
            });
        });
    }

    // Toggle account status (click on status to change) - INSTANT UPDATE NO RELOAD
    window.toggleAccountStatus = async function (event, accountId) {
        event.stopPropagation();
        event.preventDefault();

        // Find the account and update locally FIRST (instant UI update)
        const accountIndex = mxhAccounts.findIndex(acc => acc.id === accountId);
        if (accountIndex === -1) return;

        const currentStatus = mxhAccounts[accountIndex].status;

        // Toggle status locally
        const newStatus = currentStatus === 'disabled' ? 'active' : 'disabled';
        mxhAccounts[accountIndex].status = newStatus;

        // Update die_date
        if (newStatus === 'disabled') {
            mxhAccounts[accountIndex].die_date = new Date().toISOString();
        } else {
            mxhAccounts[accountIndex].die_date = null;
        }

        // Re-render immediately (no API call wait)
        renderMXHAccounts();

        // Then update backend in background
        try {
            const response = await fetch(`/mxh/api/accounts/${accountId}/toggle-status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });

            if (response.ok) {
                showToast('✅ Đã thay đổi trạng thái!', 'success');
            } else {
                // Revert on error
                const error = await response.json();
                showToast(error.error || 'Lỗi khi thay đổi trạng thái!', 'error');
                await loadMXHData(false); // Reload to get correct data
            }
        } catch (error) {
            showToast('Lỗi kết nối!', 'error');
            await loadMXHData(false); // Reload to get correct data
        }
    };

    // ===== MXH BACKGROUND CONTEXT MENU =====
    document.getElementById('mxh-accounts-container').addEventListener('contextmenu', function (event) {
        // Only show if clicked on the container itself, not on cards
        if (event.target.id === 'mxh-accounts-container' || event.target.closest('.row')) {
            event.preventDefault();

            // Hide all other context menus
            document.querySelectorAll('.custom-context-menu').forEach(menu => {
                menu.style.display = 'none';
            });

            // Show background context menu
            const contextMenu = document.getElementById('mxh-background-context-menu');
            contextMenu.style.display = 'block';
            
            // Smart positioning to avoid overflow
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            // Calculate menu size and viewport
            let menuRect = contextMenu.getBoundingClientRect();
            const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            const viewportHeight = window.innerHeight || document.documentElement.clientHeight;
            const margin = 8;
            
            let left = event.pageX;
            let top = event.pageY;
            
            // Horizontal positioning: Smart left/right positioning
            if (menuRect.right > viewportWidth - margin) {
                // Menu will overflow right side of screen
                // Show menu to the left of mouse
                left = event.pageX - menuRect.width;
                
                // If still overflows left, clamp to left margin
                if (left < margin) {
                    left = margin;
                }
            }
            
            // Vertical positioning
            if (menuRect.bottom > viewportHeight) {
                // Nếu đủ chỗ phía trên chuột thì show lên trên
                if (event.pageY - menuRect.height > margin) {
                    top = event.pageY - menuRect.height;
                } else {
                    // Nếu không đủ chỗ trên, thì dán sát đáy viewport
                    top = viewportHeight - menuRect.height - margin + window.scrollY;
                    if (top < margin + window.scrollY) top = margin + window.scrollY;
                }
            }
            
            contextMenu.style.left = left + 'px';
            contextMenu.style.top = top + 'px';
        }
    });

    // Handle background context menu actions
    document.getElementById('mxh-background-context-menu').addEventListener('click', function (event) {
        const action = event.target.closest('.menu-item')?.dataset.action;

        if (action === 'view-mode') {
            // Open view mode modal
            const modal = new bootstrap.Modal(document.getElementById('view-mode-modal'));
            modal.show();
        } else if (action === 'add-account') {
            // Open add account modal
            const modal = new bootstrap.Modal(document.getElementById('mxh-addAccountModal'));
            modal.show();
        }

        // Hide menu
        this.style.display = 'none';
    });

    // Hide all context menus on regular click
    document.addEventListener('click', function (event) {
        // Don't hide if clicking inside a context menu
        if (!event.target.closest('.custom-context-menu')) {
            document.querySelectorAll('.custom-context-menu').forEach(menu => {
                menu.style.display = 'none';
            });
            
            // Hide all submenus and clear state
            document.querySelectorAll('.submenu').forEach(submenu => {
                submenu.classList.remove('show');
            });
            currentSubmenu = null;
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
        }
    });

    // ===== SMART SUBMENU POSITIONING =====
    // Function to position submenu smartly
    function positionSubmenu(menuItem) {
        const submenu = menuItem.querySelector('.submenu');
        if (!submenu) return;
        
        // Temporarily show submenu to measure it
        submenu.style.display = 'block';
        submenu.style.visibility = 'hidden';
        
        const submenuRect = submenu.getBoundingClientRect();
        const parentMenu = menuItem.closest('.custom-context-menu');
        const parentMenuRect = parentMenu.getBoundingClientRect();
        const viewportWidth = window.innerWidth || document.documentElement.clientWidth;
        const margin = 8;
        
        // Calculate where submenu would appear if positioned normally (right side)
        const normalSubmenuRight = parentMenuRect.right + submenuRect.width;
        
        // Check if submenu would overflow right side of viewport
        if (normalSubmenuRight > viewportWidth - margin) {
            // Show submenu on the left side
            submenu.classList.add('submenu-left');
            // console.log('Submenu positioned LEFT - would overflow right');
        } else {
            // Show submenu on the right side (default)
            submenu.classList.remove('submenu-left');
            // console.log('Submenu positioned RIGHT - fits in viewport');
        }
        
        // Hide submenu again (CSS hover will show it)
        submenu.style.display = '';
        submenu.style.visibility = '';
    }
    
    // Enhanced submenu hover handling with bridge support
    let currentSubmenu = null;
    let hideTimeout = null;
    
    // Function to create bridge element
    function createSubmenuBridge(submenu, isLeft = false) {
        // Remove existing bridge
        const existingBridge = submenu.querySelector('.submenu-bridge');
        if (existingBridge) {
            existingBridge.remove();
        }
        
        // Create new bridge
        const bridge = document.createElement('div');
        bridge.className = 'submenu-bridge';
        if (isLeft) {
            bridge.style.left = '-5px';
            bridge.style.right = 'auto';
        }
        submenu.appendChild(bridge);
        return bridge;
    }
    
    // Function to show submenu
    function showSubmenu(menuItem) {
        // Hide previous submenu
        if (currentSubmenu && currentSubmenu !== menuItem) {
            const prevSubmenu = currentSubmenu.querySelector('.submenu');
            if (prevSubmenu) {
                prevSubmenu.classList.remove('show');
            }
        }
        
        // Show new submenu
        const submenuEl = menuItem.querySelector('.submenu');
        if (submenuEl) {
            positionSubmenu(menuItem);
            submenuEl.classList.add('show');
            currentSubmenu = menuItem;
            
            // Create bridge based on position
            const isLeft = submenuEl.classList.contains('submenu-left');
            createSubmenuBridge(submenuEl, isLeft);
        }
        
        // Clear any pending hide timeout
        if (hideTimeout) {
            clearTimeout(hideTimeout);
            hideTimeout = null;
        }
    }
    
    // Function to hide submenu with delay
    function hideSubmenu(delay = 100) {
        if (hideTimeout) {
            clearTimeout(hideTimeout);
        }
        hideTimeout = setTimeout(() => {
            if (currentSubmenu) {
                const submenuEl = currentSubmenu.querySelector('.submenu');
                if (submenuEl) {
                    submenuEl.classList.remove('show');
                }
                currentSubmenu = null;
            }
        }, delay);
    }
    
    // Event listeners
    document.addEventListener('mouseover', function(event) {
        const menuItem = event.target.closest('.menu-item.has-submenu');
        const submenu = event.target.closest('.submenu');
        const bridge = event.target.closest('.submenu-bridge');
        
        if (menuItem) {
            showSubmenu(menuItem);
        } else if (submenu || bridge) {
            // Keep submenu open when hovering over submenu or bridge
            if (currentSubmenu) {
                const submenuEl = currentSubmenu.querySelector('.submenu');
                if (submenuEl) {
                    submenuEl.classList.add('show');
                }
                if (hideTimeout) {
                    clearTimeout(hideTimeout);
                    hideTimeout = null;
                }
            }
        }
    });
    
    document.addEventListener('mouseout', function(event) {
        const menuItem = event.target.closest('.menu-item.has-submenu');
        const submenu = event.target.closest('.submenu');
        const bridge = event.target.closest('.submenu-bridge');
        
        if (!menuItem && !submenu && !bridge) {
            // Hide submenu when leaving all related elements
            hideSubmenu();
        }
    });
    
    // Also position submenus when context menu is shown
    function positionAllSubmenus(menuId) {
        setTimeout(() => {
            const menu = document.getElementById(menuId);
            if (menu) {
                const submenuItems = menu.querySelectorAll('.menu-item.has-submenu');
                submenuItems.forEach(positionSubmenu);
            }
        }, 10);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Override all context menu functions to position submenus
        const originalShowUnified = showUnifiedContextMenu;
        showUnifiedContextMenu = function(event, accountId, platform, isSecondary = false) {
            originalShowUnified(event, accountId, platform, isSecondary);
            positionAllSubmenus('unified-context-menu');
        };
        
        const originalShowWeChat = showWeChatContextMenu;
        showWeChatContextMenu = function(event, accountId, isSecondary = false) {
            originalShowWeChat(event, accountId, isSecondary);
            positionAllSubmenus('wechat-context-menu');
        };
        
        const originalShowGeneric = showGenericContextMenu;
        showGenericContextMenu = function(event, accountId) {
            originalShowGeneric(event, accountId);
            positionAllSubmenus('generic-context-menu');
        };
        
        const originalShowTelegram = showTelegramContextMenu;
        showTelegramContextMenu = function(event, accountId) {
            originalShowTelegram(event, accountId);
            positionAllSubmenus('telegram-context-menu');
        };
    });

    // ===== AUTO-FILL DATE WHEN OPENING ADD ACCOUNT MODAL =====
    const mxhAddAccountModal = document.getElementById('mxh-addAccountModal');
    if (mxhAddAccountModal) {
        mxhAddAccountModal.addEventListener('shown.bs.modal', function () {
            // Get current date
            const today = new Date();
            const day = today.getDate();
            const month = today.getMonth() + 1; // JavaScript months are 0-indexed
            const year = today.getFullYear();

            // Auto-fill date inputs
            document.getElementById('mxh-day').value = day;
            document.getElementById('mxh-month').value = month;
            document.getElementById('mxh-year').value = year;

            // Clear other fields
            document.getElementById('mxh-username').value = '';
            document.getElementById('mxh-platform').value = '';
            document.getElementById('mxh-password').value = '';
            document.getElementById('mxh-phone').value = '';
            document.getElementById('mxh-url').value = '';
        });
    }

    // ===== AUTO-FILL DATE WHEN OPENING WECHAT MODAL (for adding new) =====
    const wechatAccountModal = document.getElementById('wechat-account-modal');
    if (wechatAccountModal) {
        wechatAccountModal.addEventListener('shown.bs.modal', function () {
            // Only auto-fill if it's a new account (all fields empty)
            const cardName = document.getElementById('wechat-card-name').value;
            const username = document.getElementById('wechat-username').value;

            // If both are empty, it's likely a new account
            if (!cardName && !username) {
                const today = new Date();
                const day = today.getDate();
                const month = today.getMonth() + 1;
                const year = today.getFullYear();

                // Auto-fill date inputs only if they're empty
                if (!document.getElementById('wechat-day').value) {
                    document.getElementById('wechat-day').value = day;
                }
                if (!document.getElementById('wechat-month').value) {
                    document.getElementById('wechat-month').value = month;
                }
                if (!document.getElementById('wechat-year').value) {
                    document.getElementById('wechat-year').value = year;
                }
            }
        });
    }

    // ===== AUTO-TAB FOR DATE INPUTS =====
    // Auto-tab when reaching maxlength for date inputs
    document.addEventListener('DOMContentLoaded', function() {
        const dayInput = document.getElementById('wechat-day');
        const monthInput = document.getElementById('wechat-month');
        const yearInput = document.getElementById('wechat-year');

        if (dayInput && monthInput && yearInput) {
            // Auto-tab from day to month
            dayInput.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    monthInput.focus();
                }
            });

            // Auto-tab from month to year
            monthInput.addEventListener('input', function() {
                if (this.value.length >= 2) {
                    yearInput.focus();
                }
            });

            // Prevent going back to previous field if current field has value
            dayInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value.length === 0) {
                    e.preventDefault();
                }
            });

            monthInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value.length === 0) {
                    dayInput.focus();
                    e.preventDefault();
                }
            });

            yearInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value.length === 0) {
                    monthInput.focus();
                    e.preventDefault();
                }
            });
        }
    });

</script>
{% endblock %}