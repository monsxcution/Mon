{% extends "layouts/base.html" %}

{% block content %}
<div class="tab-pane fade show active" id="notes-tool-pane" role="tabpanel">
    <div class="notes-layout-container">

        <div id="notes-list-wrapper">
            <div class="d-flex justify-content-center align-items-center mb-2">
                <button class="btn btn-primary" onclick="window.prepareAddNoteModal()"><i class="bi bi-plus-lg"></i> Tạo
                    Ghi Chú Mới</button>
            </div>
            <div id="notes-container" class="row g-0 notes-grid-view" spellcheck="false">
            </div>
        </div>

        <div id="notes-detail-wrapper">
            <div id="notes-detail-panel" class="card h-100">
                <div class="card-header">
                </div>
                <div class="card-body" id="notes-detail-content-wrapper">
                    <div class="text-center text-muted p-3 h-100 d-flex flex-column justify-content-center align-items-center"
                        id="notes-detail-placeholder">
                        <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Chọn một ghi chú để xem</h6>
                    </div>
                    <div id="notes-detail-content" class="d-none">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="notes-addEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="notes-addEditForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="notes-modalTitle">Thêm Ghi Chú Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <input type="hidden" id="notes-editId">
                <div class="modal-body">
                    <div class="mb-3">
                        <div id="notes-title-input" contenteditable="true" class="form-control" spellcheck="false"
                            placeholder="Nhập tiêu đề..." style="min-height: 40px;"></div>
                    </div>
                    <div class="mb-3">
                        <div id="notes-content-editor" contenteditable="true" class="form-control" spellcheck="false"
                            style="height: 200px; overflow-y: auto;" placeholder="Nhập nội dung..."></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="note-card-context-menu" class="custom-context-menu">
    <div class="menu-item" id="context-mark-note-btn"><i class="bi bi-star-fill me-2"></i> Đánh Dấu / Bỏ Đánh Dấu</div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const notesPane = document.getElementById('notes-tool-pane');
        if (!notesPane) return;

        const container = document.getElementById('notes-container');
        const listWrapper = document.getElementById('notes-list-wrapper');
        const detailWrapper = document.getElementById('notes-detail-wrapper');
        const modalEl = document.getElementById('notes-addEditModal');
        const notesModal = new bootstrap.Modal(modalEl);
        const form = document.getElementById('notes-addEditForm');
        const noteCardMenu = document.getElementById('note-card-context-menu');

        let activeNoteId = null;
        let autoSaveTimer = null;
        window.notesData = [];

        async function fetchAndRenderNotes(scrollToNoteId = null) {
            try {
                const response = await fetch("{{ url_for('notes_feature.api_get_notes') }}");
                if (!response.ok) throw new Error(`Lỗi Server: ${response.status}`);
                const notes = await response.json();
                window.notesData = notes.sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at));
                renderNotes(window.notesData);
                if (activeNoteId) {
                    const activeCard = document.querySelector(`.card[data-note-id="${activeNoteId}"]`);
                    if (activeCard) activeCard.classList.add('note-card-active');
                }
            } catch (error) {
                showToast(`Tải ghi chú thất bại: ${error.message}`, 'error');
            }
        }

        function renderNotes(notesToRender) {
            container.innerHTML = '';
            if (notesToRender.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted p-5"><h6>Không có ghi chú nào.</h6><button class="btn btn-primary mt-3" onclick="window.prepareAddNoteModal()"><i class="bi bi-plus-lg"></i> Tạo ghi chú đầu tiên</button></div>`;
                return;
            }
            notesToRender.forEach(note => container.appendChild(createNoteCard(note)));
        }

        function formatTimeAgo(isoString) {
            if (!isoString) return '';
            const seconds = Math.round((new Date() - new Date(isoString)) / 1000);
            if (seconds < 60) return "vài giây trước";
            const intervals = { năm: 31536000, tháng: 2592000, ngày: 86400, giờ: 3600, phút: 60 };
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const value = Math.floor(seconds / secondsInUnit);
                if (value >= 1) return `${value} ${unit} trước`;
            }
            return "vài giây trước";
        }

        function createNoteCard(note) {
            const col = document.createElement('div');
            col.className = 'note-card-wrapper';

            const title = note.title_html || 'Ghi chú không tiêu đề';
            const content = note.content_html || '...';

            col.innerHTML = `
                <div class="card h-100" data-note-id="${note.id}">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-truncate">${title}</h5>
                        <div class="card-text card-note-body flex-grow-1">${content}</div>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <small class="text-muted">${formatTimeAgo(note.modified_at)}</small>
                            <button class="btn btn-sm btn-outline-danger" onclick="window.deleteNoteWrapper('${note.id}', event)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>`;

            const cardElement = col.querySelector('.card');
            cardElement.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                openDetailPanel();
                showNoteDetail(note);
            });

            cardElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.querySelectorAll('.custom-context-menu').forEach(menu => menu.style.display = 'none');
                const markBtn = noteCardMenu.querySelector('#context-mark-note-btn');
                markBtn.innerHTML = note.is_marked
                    ? '<i class="bi bi-star me-2"></i> Bỏ Đánh Dấu'
                    : '<i class="bi bi-star-fill me-2"></i> Đánh Dấu';
                noteCardMenu.dataset.noteId = note.id;
                noteCardMenu.style.top = `${e.clientY}px`;
                noteCardMenu.style.left = `${e.clientX}px`;
                noteCardMenu.style.display = 'block';
            });
            return col;
        }

        function openDetailPanel() {
            listWrapper.classList.add('shrunk');
            detailWrapper.classList.add('visible');
            container.classList.remove('notes-grid-view');
            container.classList.add('notes-list-view');
        }

        function showNoteDetail(note) {
            activeNoteId = note.id;
            const detailHeader = document.querySelector('#notes-detail-panel .card-header');
            const detailContent = document.getElementById('notes-detail-content');
            const detailPlaceholder = document.getElementById('notes-detail-placeholder');

            document.querySelectorAll('.card.note-card-active').forEach(c => c.classList.remove('note-card-active'));
            document.querySelector(`.card[data-note-id="${note.id}"]`)?.classList.add('note-card-active');

            detailHeader.innerHTML = `
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                         <button class="btn btn-sm btn-primary" onclick="window.prepareAddNoteModal()" title="Thêm ghi chú mới"><i class="bi bi-plus-lg"></i></button>
                         <button class="btn btn-sm btn-outline-danger" onclick="window.deleteNoteWrapper('${note.id}', event)" title="Xóa ghi chú"><i class="bi bi-trash-fill"></i></button>
                    </div>
                    <small class="text-muted d-flex align-items-center gap-1" title="${new Date(note.modified_at).toLocaleString('vi-VN')}">
                        <i class="bi bi-clock-history"></i>
                        <span>${formatTimeAgo(note.modified_at)}</span>
                    </small>
                    <div>
                        <button class="btn-close btn-close-white" onclick="window.closeDetailPanel()" title="Đóng chi tiết" style="font-size: 0.8rem;"></button>
                    </div>
                </div>`;

            detailContent.innerHTML = `<div id="detail-editable-full" contenteditable="true" spellcheck="false" data-placeholder="Dòng đầu là tiêu đề...">${note.title_html || ''}<br>${note.content_html || ''}</div>`;

            const editorEl = document.getElementById('detail-editable-full');
            editorEl.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => saveNoteChanges(note.id), 1500);
            });

            detailPlaceholder.classList.add('d-none');
            detailContent.classList.remove('d-none');
        }

        async function saveNoteChanges(noteId) {
            if (!noteId) return;
            const editorEl = document.getElementById('detail-editable-full');
            if (!editorEl) return;
            const fullContent = editorEl.innerHTML;
            const parts = fullContent.split('<br>');
            const payload = { title_html: parts.shift() || '', content_html: parts.join('<br>') };
            try {
                const response = await fetch(`{{ url_for('notes_feature.api_update_note', note_id='') }}${noteId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Lỗi khi lưu trên server');
                showToast('Đã tự động lưu!', 'success');
                await fetchAndRenderNotes();
            } catch (error) {
                showToast('Lỗi khi tự động lưu!', 'error');
            }
        }

        window.prepareAddNoteModal = () => {
            form.reset();
            document.getElementById('notes-modalTitle').textContent = 'Thêm Ghi Chú Mới';
            document.getElementById('notes-editId').value = '';
            document.getElementById('notes-title-input').innerHTML = '';
            document.getElementById('notes-content-editor').innerHTML = '';
            notesModal.show();
        };

        window.deleteNoteWrapper = async (id, event) => {
            event.stopPropagation();
            if (!confirm('Bạn có chắc muốn xóa ghi chú này?')) return;
            try {
                const response = await fetch(`{{ url_for('notes_feature.api_delete_note', note_id='') }}${id}`, { method: 'POST' });
                if (!response.ok) throw new Error('Lỗi khi xóa trên server');
                if (id === activeNoteId) window.closeDetailPanel();
                await fetchAndRenderNotes();
                showToast('Đã xóa ghi chú.', 'info');
            } catch (error) {
                showToast('Lỗi: Không thể xóa ghi chú.', 'error');
            }
        };

        window.closeDetailPanel = () => {
            listWrapper.classList.remove('shrunk');
            detailWrapper.classList.remove('visible');
            container.classList.remove('notes-list-view');
            container.classList.add('notes-grid-view');
            document.querySelector('.note-card-active')?.classList.remove('note-card-active');
            activeNoteId = null;
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('notes-editId').value;
            const url = id
                ? `{{ url_for('notes_feature.api_update_note', note_id='') }}${id}`
                : "{{ url_for('notes_feature.api_add_note') }}";

            const payload = {
                title_html: document.getElementById('notes-title-input').innerHTML,
                content_html: document.getElementById('notes-content-editor').innerHTML,
            };

            if (!payload.title_html && !payload.content_html) {
                alert('Ghi chú không được để trống.');
                return;
            }

            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Lỗi khi lưu trên server');
                notesModal.hide();
                await fetchAndRenderNotes();
                showToast(id ? 'Đã cập nhật ghi chú!' : 'Đã tạo ghi chú mới!', 'success');
            } catch (error) {
                showToast('Lỗi: Không thể lưu ghi chú.', 'error');
            }
        });

        noteCardMenu.addEventListener('click', async (e) => {
            const noteId = noteCardMenu.dataset.noteId;
            if (!noteId) return;
            try {
                const response = await fetch(`{{ url_for('notes_feature.api_toggle_mark', note_id='') }}${noteId}`, { method: 'POST' });
                if (!response.ok) throw new Error('Server error');
                await fetchAndRenderNotes();
                showToast('Đã cập nhật đánh dấu!', 'success');
            } catch (error) {
                showToast('Lỗi khi đánh dấu.', 'error');
            } finally {
                noteCardMenu.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-context-menu')) {
                document.querySelectorAll('.custom-context-menu').forEach(menu => menu.style.display = 'none');
            }
        });

        fetchAndRenderNotes();
    });
</script>
{% endblock %}