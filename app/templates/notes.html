{% extends "layouts/base.html" %}

{% block content %}
{# --- PHẦN HTML CHO CÁC CONTEXT MENU (ĐANG BỊ THIẾU) --- #}
<div id="notes-tab-context-menu" class="custom-context-menu">
    <div class="menu-item" onclick="window.prepareAddNoteModal()">
        <i class="bi bi-plus-lg me-2"></i> Thêm Ghi Chú Mới
    </div>
</div>

<div id="note-card-context-menu" class="custom-context-menu">
    <div class="menu-item" id="context-mark-note">
        <i class="bi bi-star-fill me-2"></i> Đánh Dấu / Bỏ Đánh Dấu
    </div>
</div>

<div id="notes-context-menu" class="custom-context-menu">
    <div class="menu-item" id="context-copy"><i class="bi bi-clipboard me-2"></i> Sao chép</div>
    <div class="menu-item" id="context-bold"><i class="bi bi-type-bold me-2"></i> In đậm</div>
    <div class="menu-item" id="context-color"><i class="bi bi-palette-fill me-2"></i> Đổi màu chữ
        <div class="color-palette">
            <span style="background-color: #FFFFFF;" data-color="#FFFFFF"></span>
            <span style="background-color: #EF5350;" data-color="#EF5350"></span>
            <span style="background-color: #EC407A;" data-color="#EC407A"></span>
            <span style="background-color: #AB47BC;" data-color="#AB47BC"></span>
            <span style="background-color: #7E57C2;" data-color="#7E57C2"></span>
            <span style="background-color: #5C6BC0;" data-color="#5C6BC0"></span>
            <span style="background-color: #42A5F5;" data-color="#42A5F5"></span>
            <span style="background-color: #26C6DA;" data-color="#26C6DA"></span>
            <span style="background-color: #26A69A;" data-color="#26A69A"></span>
            <span style="background-color: #66BB6A;" data-color="#66BB6A"></span>
            <span style="background-color: #FFCA28;" data-color="#FFCA28"></span>
            <span style="background-color: #FF7043;" data-color="#FF7043"></span>
        </div>
    </div>
    <div class="menu-item" id="context-link"><i class="bi bi-link-45deg me-2"></i> Gán Link</div>
</div>

{# --- PHẦN GIAO DIỆN CHÍNH (ĐÃ SỬA LẠI CHO ĐÚNG) --- #}
<div class="tab-pane fade show active" id="notes-tool-pane" role="tabpanel">
    <div class="notes-layout-container">

        <div id="notes-list-wrapper">
            <div class="d-flex justify-content-start align-items-center mb-2">
                <div class="position-relative notes-search-container" style="width: 50%;">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3" style="z-index: 10;"></i>
                    <input type="text" class="form-control ps-5" id="notes-search-input" spellcheck="false"
                        placeholder="Tìm kiếm ghi chú..." style="border-radius: 25px;">
                </div>
            </div>
            <div id="notes-container" class="row" spellcheck="false">
                {# Ghi chú sẽ được render ở đây bằng JavaScript #}
            </div>
        </div>

        <div id="notes-detail-wrapper">
            <div id="notes-detail-panel" class="card h-100">
                <div class="card-header">
                    {# Header sẽ được cập nhật bằng JavaScript #}
                </div>
                <div class="card-body" id="notes-detail-content-wrapper">
                    <div class="text-center text-muted p-3 h-100 d-flex flex-column justify-content-center align-items-center"
                        id="notes-detail-placeholder">
                        <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Chọn một ghi chú để xem</h6>
                    </div>
                    <div id="notes-detail-content" class="d-none">
                        {# Nội dung chi tiết sẽ được render ở đây #}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# --- CÁC MODAL LIÊN QUAN ĐẾN GHI CHÚ --- #}
<div class="modal fade" id="notes-addEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="notes-addEditForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="notes-modalTitle">Thêm Ghi Chú Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <input type="hidden" id="notes-editId">
                <div class="modal-body">
                    <div class="mb-3">
                        <div id="notes-title-input" contenteditable="true" class="form-control" spellcheck="false"
                            placeholder="Nhập tiêu đề..." style="min-height: 40px;"></div>
                    </div>
                    <div class="mb-3">
                        <div id="notes-content-editor" contenteditable="true" class="form-control" spellcheck="false"
                            style="height: 200px; overflow-y: auto;" placeholder="Nhập nội dung..."></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="notes-addLinkModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gán Link vào chữ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="notes-link-url" class="form-label">Nhập URL</label>
                <input type="url" class="form-control" id="notes-link-url" placeholder="https://...">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="notes-save-link-btn">Lưu</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const notesPane = document.getElementById('notes-tool-pane');
    if (!notesPane) return;

    // --- DOM Elements ---
    const container = document.getElementById('notes-container');
    const searchInput = document.getElementById('notes-search-input');
    const listWrapper = document.getElementById('notes-list-wrapper');
    const detailWrapper = document.getElementById('notes-detail-wrapper');
    
    // Modal Elements
    const modalEl = document.getElementById('notes-addEditModal');
    const notesModal = new bootstrap.Modal(modalEl);
    const form = document.getElementById('notes-addEditForm');
    const modalTitle = document.getElementById('notes-modalTitle');
    const editIdInput = document.getElementById('notes-editId');
    const titleInput = document.getElementById('notes-title-input');
    const contentEditor = document.getElementById('notes-content-editor');

    // Context Menu Elements
    const noteCardMenu = document.getElementById('note-card-context-menu');
    const editorContextMenu = document.getElementById('notes-context-menu');
    const notesTabMenu = document.getElementById('notes-tab-context-menu');
    const addLinkModal = new bootstrap.Modal(document.getElementById('notes-addLinkModal'));
    const linkUrlInput = document.getElementById('notes-link-url');
    const saveLinkBtn = document.getElementById('notes-save-link-btn');

    // --- State Variables ---
    let activeNoteId = null;
    let autoSaveTimer = null;
    let savedSelection = null;
    window.notesData = [];
    window.filteredNotes = [];

    // --- Core Functions ---
    function formatTimeAgo(isoString) {
        if (!isoString) return '';
        const seconds = Math.round((new Date() - new Date(isoString)) / 1000);
        if (seconds < 60) return "vài giây trước";
        const intervals = { 'năm': 31536000, 'tháng': 2592000, 'ngày': 86400, 'giờ': 3600, 'phút': 60 };
        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const value = Math.floor(seconds / secondsInUnit);
            if (value >= 1) return `${value} ${unit} trước`;
        }
        return "vài giây trước";
    }

    async function fetchAndRenderNotes(searchTerm = '') {
        try {
            const response = await fetch("{{ url_for('notes_feature.api_get_notes') }}");
            if (!response.ok) throw new Error(`Lỗi Server: ${response.status}`);
            
            const notes = await response.json();
            window.notesData = notes.sort((a, b) => new Date(b.modified_at) - new Date(a.modified_at));
            
            window.filteredNotes = searchTerm
                ? window.notesData.filter(note => 
                    ((note.title_html || '').toLowerCase().includes(searchTerm) || 
                     (note.content_html || '').toLowerCase().includes(searchTerm)))
                : [...window.notesData];

            renderNotes(window.filteredNotes);

        } catch (error) {
            showToast(`Tải ghi chú thất bại: ${error.message}`, 'error');
        }
    }
    
    function renderNotes(notesToRender) {
        container.innerHTML = '';
        
        let displayList = [...notesToRender];
        if (activeNoteId) {
            const activeNoteIndex = displayList.findIndex(n => n.id === activeNoteId);
            if (activeNoteIndex > -1) {
                const [activeNote] = displayList.splice(activeNoteIndex, 1);
                displayList.unshift(activeNote);
            }
        }

        if (displayList.length === 0) {
            const emptyMessage = searchInput.value 
                ? `<div class="col-12 text-center text-muted p-5"><h6>Không tìm thấy ghi chú nào.</h6></div>`
                : `<div class="col-12 text-center text-muted p-5"><h6>Không có ghi chú nào.</h6><button class="btn btn-primary mt-3" onclick="window.prepareAddNoteModal()"><i class="bi bi-plus-lg"></i> Tạo ghi chú đầu tiên</button></div>`;
            container.innerHTML = emptyMessage;
            return;
        }
        
        displayList.forEach(note => container.appendChild(createNoteCard(note)));
        
        // Re-apply active class after rendering
        if (activeNoteId) {
            const activeCard = document.querySelector(`.card[data-note-id="${activeNoteId}"]`);
            if (activeCard) activeCard.classList.add('note-card-active');
        }
    }

    function createNoteCard(note) {
        const col = document.createElement('div');
        col.className = 'note-card-wrapper';
        
        const markedIconHTML = note.is_marked ? `<i class="bi bi-star-fill text-warning position-absolute top-0 start-0 m-2"></i>` : '';
        const title = note.title_html || 'Ghi chú không tiêu đề';
        const content = note.content_html || '...';

        col.innerHTML = `
            <div class="card h-100" data-note-id="${note.id}">
                ${markedIconHTML}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title text-truncate">${title}</h5>
                    <div class="card-text card-note-body flex-grow-1">${content}</div>
                    <div class="mt-auto d-flex justify-content-between align-items-center">
                        <small class="text-muted">${formatTimeAgo(note.modified_at)}</small>
                    </div>
                </div>
            </div>`;

        const cardElement = col.querySelector('.card');
        cardElement.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            showNoteDetail(note);
        });

        cardElement.addEventListener('contextmenu', (e) => handleNoteCardContextMenu(e, note));
        return col;
    }

    function openDetailPanel() {
        listWrapper.classList.add('shrunk');
        detailWrapper.classList.add('visible');
        container.classList.remove('notes-grid-view');
        container.classList.add('notes-list-view');
    }

    function showNoteDetail(note) {
        activeNoteId = note.id;

        document.querySelectorAll('#notes-container .card').forEach(card => card.classList.remove('note-card-active'));
        const clickedCard = document.querySelector(`.card[data-note-id="${note.id}"]`);
        if (clickedCard) clickedCard.classList.add('note-card-active');
        
        openDetailPanel();

        const detailHeader = detailWrapper.querySelector('.card-header');
        const detailContent = detailWrapper.querySelector('#notes-detail-content');
        const detailPlaceholder = detailWrapper.querySelector('#notes-detail-placeholder');
        
        detailHeader.innerHTML = `
            <div class="d-flex justify-content-between align-items-center w-100">
                <small class="text-muted" title="${new Date(note.modified_at).toLocaleString('vi-VN')}">
                    <i class="bi bi-clock-history"></i> ${formatTimeAgo(note.modified_at)}
                </small>
                <div>
                    <button class="btn btn-sm btn-primary" onclick="window.prepareAddNoteModal()" title="Thêm ghi chú mới"><i class="bi bi-plus-lg"></i></button>
                    <button class="btn btn-sm btn-outline-danger" onclick="window.deleteNoteWrapper('${note.id}', event)" title="Xóa ghi chú"><i class="bi bi-trash-fill"></i></button>
                    <button class="btn-close btn-close-white" onclick="window.closeDetailPanel()" title="Đóng chi tiết" style="font-size: 0.8rem;"></button>
                </div>
            </div>`;

        detailContent.innerHTML = `<div id="detail-editable-full" contenteditable="true" spellcheck="false" data-placeholder="Dòng đầu là tiêu đề...">${note.title_html || ''}<br>${note.content_html || ''}</div>`;
        const editorEl = document.getElementById('detail-editable-full');
        
        editorEl.addEventListener('input', () => {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => saveNoteChanges(note.id), 1500);
        });

        editorEl.addEventListener('contextmenu', handleEditorContextMenu);
        
        detailPlaceholder.classList.add('d-none');
        detailContent.classList.remove('d-none');
    }

    async function saveNoteChanges(noteId) {
        if (!noteId) return;
        const editorEl = document.getElementById('detail-editable-full');
        if (!editorEl) return;
        const fullContent = editorEl.innerHTML;
        const parts = fullContent.split('<br>');
        const payload = { title_html: parts.shift() || '', content_html: parts.join('<br>') };
        try {
            const response = await fetch(`{{ url_for('notes_feature.api_update_note', note_id='') }}${noteId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Lỗi khi lưu trên server');
            const updatedNote = await response.json();
            
            // Update local data
            const index = window.notesData.findIndex(n => n.id === noteId);
            if (index !== -1) window.notesData[index] = updatedNote;

            showToast('Đã tự động lưu!', 'success');
            fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
        } catch (error) {
            showToast('Lỗi khi tự động lưu!', 'error');
        }
    }

    window.prepareAddNoteModal = () => {
        form.reset();
        modalTitle.textContent = 'Thêm Ghi Chú Mới';
        editIdInput.value = '';
        titleInput.innerHTML = '';
        contentEditor.innerHTML = '';
        notesModal.show();
    };

    window.deleteNoteWrapper = async (id, event) => {
        event.stopPropagation();
        if (!confirm('Bạn có chắc muốn xóa ghi chú này?')) return;
        try {
            const response = await fetch(`{{ url_for('notes_feature.api_delete_note', note_id='') }}${id}`, { method: 'POST' });
            if (!response.ok) throw new Error('Lỗi khi xóa trên server');
            
            if (id === activeNoteId) window.closeDetailPanel();
            
            await fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
            showToast('Đã xóa ghi chú.', 'info');
        } catch (error) {
            showToast('Lỗi: Không thể xóa ghi chú.', 'error');
        }
    };

    window.closeDetailPanel = () => {
        listWrapper.classList.remove('shrunk');
        detailWrapper.classList.remove('visible');
        container.classList.add('notes-grid-view');
        container.classList.remove('notes-list-view');
        document.querySelector('.note-card-active')?.classList.remove('note-card-active');
        activeNoteId = null;
    };
    
    // --- Context Menu Logic ---
    function restoreSelection() {
        if (savedSelection) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedSelection);
        }
    }

    function handleNoteCardContextMenu(e, note) {
        console.log('handleNoteCardContextMenu triggered for note:', note.id);
        e.preventDefault();
        e.stopPropagation();
        hideAllContextMenus();
        
        const markBtn = noteCardMenu.querySelector('#context-mark-note');
        markBtn.innerHTML = note.is_marked ? '<i class="bi bi-star me-2"></i> Bỏ Đánh Dấu' : '<i class="bi bi-star-fill me-2"></i> Đánh Dấu';
        
        noteCardMenu.dataset.noteId = note.id;
        showMenu(noteCardMenu, e.clientX, e.clientY);
    }
    
    function handleEditorContextMenu(e) {
        console.log('handleEditorContextMenu triggered');
        e.preventDefault();
        e.stopPropagation();
        hideAllContextMenus();

        const selection = window.getSelection();
        if (selection.toString().length > 0) {
            savedSelection = selection.getRangeAt(0).cloneRange();
            showMenu(editorContextMenu, e.clientX, e.clientY);
        }
    }

    function handleTabContextMenu(e) {
        console.log('handleTabContextMenu triggered at:', e.clientX, e.clientY);
        if (!e.target.closest('.card') && !e.target.closest('#notes-detail-wrapper')) {
            console.log('Condition met: showing notesTabMenu');
            e.preventDefault();
            e.stopPropagation();
            hideAllContextMenus();
            showMenu(notesTabMenu, e.clientX, e.clientY);
        } else {
            console.log('Condition not met: click was on a card or detail panel');
        }
    }

    function hideAllContextMenus() {
        console.log('hideAllContextMenus called');
        document.querySelectorAll('.custom-context-menu').forEach(menu => menu.style.display = 'none');
    }

    function showMenu(menu, x, y) {
        console.log('showMenu called for menu:', menu.id, 'at', x, y);
        menu.style.left = `${x}px`;
        menu.style.top = `${y}px`;
        menu.style.display = 'block';
    }

    // --- Event Listeners ---
    
    // Prevent default behavior on mousedown for context menu items to avoid losing selection
    editorContextMenu.addEventListener('mousedown', (e) => {
        if (e.target.closest('.menu-item')) {
            e.preventDefault();
        }
    });

    // Main form submission
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = editIdInput.value;
        const url = id
            ? `{{ url_for('notes_feature.api_update_note', note_id='') }}${id}`
            : "{{ url_for('notes_feature.api_add_note') }}";

        const payload = {
            title_html: titleInput.innerHTML,
            content_html: contentEditor.innerHTML,
        };

        if (!payload.title_html && !payload.content_html) {
            alert('Ghi chú không được để trống.');
            return;
        }

        try {
            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error('Lỗi khi lưu trên server');
            const savedNote = await response.json();
            notesModal.hide();
            await fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
            showToast(id ? 'Đã cập nhật ghi chú!' : 'Đã tạo ghi chú mới!', 'success');
            showNoteDetail(savedNote); // Show the newly created/updated note
        } catch (error) {
            showToast('Lỗi: Không thể lưu ghi chú.', 'error');
        }
    });

    // Search input
    searchInput.addEventListener('input', () => {
        fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
    });

    // Context menu actions
    noteCardMenu.addEventListener('click', async (e) => {
        e.stopPropagation();
        const noteId = noteCardMenu.dataset.noteId;
        if (!noteId) return;
        try {
            const response = await fetch(`{{ url_for('notes_feature.api_toggle_mark', note_id='') }}${noteId}`, { method: 'POST' });
            if (!response.ok) throw new Error('Server error');
            await fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
            showToast('Đã cập nhật đánh dấu!', 'success');
        } catch (error) {
            showToast('Lỗi khi đánh dấu.', 'error');
        } finally {
            hideAllContextMenus();
        }
    });

    document.querySelector('#context-copy').addEventListener('click', () => {
        restoreSelection();
        document.execCommand('copy');
        hideAllContextMenus();
    });
    document.querySelector('#context-bold').addEventListener('click', () => {
        restoreSelection();
        document.execCommand('bold');
        hideAllContextMenus();
        setTimeout(() => saveNoteChanges(activeNoteId), 100);
    });
    
    document.querySelector('#context-color .color-palette').addEventListener('click', (e) => {
        if (e.target.matches('span[data-color]')) {
            restoreSelection();
            const color = e.target.dataset.color;
            document.execCommand('foreColor', false, color);
            hideAllContextMenus();
            setTimeout(() => saveNoteChanges(activeNoteId), 100);
        }
    });

    document.querySelector('#context-link').addEventListener('click', () => {
        // The selection is already saved, just show the modal
        linkUrlInput.value = 'https://';
        addLinkModal.show();
    });
    saveLinkBtn.addEventListener('click', () => {
        const url = linkUrlInput.value.trim();
        if (url) {
            restoreSelection(); // Restore selection before creating link
            document.execCommand('createLink', false, url);
            addLinkModal.hide();
            savedSelection = null; // Clear saved selection
            setTimeout(() => saveNoteChanges(activeNoteId), 100);
        }
    });
    
    // Global clicks
    document.addEventListener('click', hideAllContextMenus);
    notesPane.addEventListener('contextmenu', handleTabContextMenu);

    // --- Initial Setup ---
    async function initializeNotesView() {
        await fetchAndRenderNotes();
        if (window.notesData.length > 0) {
            showNoteDetail(window.notesData[0]);
        }
    }

    initializeNotesView();
});
</script>
{% endblock %}