{% extends "layouts/base.html" %}

{% block content %}
{# --- PHẦN HTML CHO CÁC CONTEXT MENU (ĐANG BỊ THIẾU) --- #}
<div id="notes-tab-context-menu" class="custom-context-menu">
    <div class="menu-item" onclick="addNewNoteFromContextMenu()">
        <i class="bi bi-plus-lg"></i> Thêm Ghi Chú Mới
    </div>
</div>

<div id="note-card-context-menu" class="custom-context-menu">
    <div class="menu-item" id="context-mark-note">
        <i class="bi bi-star-fill me-2"></i> Đánh Dấu / Bỏ Đánh Dấu
    </div>
</div>

<div id="notes-context-menu" class="custom-context-menu">
    <div class="menu-item" id="context-copy"><i class="bi bi-clipboard me-2"></i> Sao chép</div>
    <div class="menu-item" id="context-bold"><i class="bi bi-type-bold me-2"></i> In đậm</div>
    <div class="menu-item" id="context-link"><i class="bi bi-link-45deg me-2"></i> Gán Link</div>
</div>

{# --- PHẦN GIAO DIỆN CHÍNH (ĐÃ SỬA LẠI CHO ĐÚNG) --- #}
<div class="tab-pane fade show active" id="notes-tool-pane" role="tabpanel">
    <div class="notes-layout-container">

        <div id="notes-list-wrapper">
            <div class="d-flex justify-content-start align-items-center mb-2">
                <div class="position-relative notes-search-container" style="width: 50%;">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3"
                        style="z-index: 10;"></i>
                    <input type="text" class="form-control ps-5" id="notes-search-input" spellcheck="false"
                        placeholder="Tìm kiếm ghi chú..." style="border-radius: 25px;">
                </div>
            </div>
            <div id="notes-container" class="row" spellcheck="false">
                {# Ghi chú sẽ được render ở đây bằng JavaScript #}
            </div>
        </div>

        <div id="notes-detail-wrapper">
            <div id="notes-detail-panel" class="card h-100">
                <div class="card-header">
                    {# Header sẽ được cập nhật bằng JavaScript #}
                </div>
                <div class="card-body" id="notes-detail-content-wrapper">
                    <div class="text-center text-muted p-3 h-100 d-flex flex-column justify-content-center align-items-center"
                        id="notes-detail-placeholder">
                        <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Chọn một ghi chú để xem</h6>
                    </div>
                    <div id="notes-detail-content" class="d-none">
                        {# Nội dung chi tiết sẽ được render ở đây #}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# --- CÁC MODAL LIÊN QUAN ĐẾN GHI CHÚ --- #}
<div class="modal fade" id="notes-addEditModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="notes-addEditForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="notes-modalTitle">Thêm Ghi Chú Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <input type="hidden" id="notes-editId">
                <div class="modal-body">
                    <div class="mb-3">
                        <div id="notes-title-input" contenteditable="true" class="form-control" spellcheck="false"
                            placeholder="Nhập tiêu đề..." style="min-height: 40px;"></div>
                    </div>
                    <div class="mb-3">
                        <div id="notes-content-editor" contenteditable="true" class="form-control" spellcheck="false"
                            style="height: 200px; overflow-y: auto;" placeholder="Nhập nội dung..."></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="notes-addLinkModal" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gán Link vào chữ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label for="notes-link-url" class="form-label">Nhập URL</label>
                <input type="url" class="form-control" id="notes-link-url" placeholder="https://...">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="notes-save-link-btn">Lưu</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
    // --- TOÀN BỘ SCRIPT CHO GHI CHÚ ---
    // ĐOẠN SCRIPT NÀY LÀ PHIÊN BẢN ĐẦY ĐỦ TỪ FILE GỐC, ĐÃ BAO GỒM TẤT CẢ LOGIC BỊ THIẾU
    (() => {
        const notesTab = document.querySelector('a[href*="notes"]');
        if (!notesTab) return;

        // Element Selectors
        const container = document.getElementById('notes-container');
        const searchInput = document.getElementById('notes-search-input');
        const modalEl = document.getElementById('notes-addEditModal');
        const notesModal = new bootstrap.Modal(modalEl);
        const form = document.getElementById('notes-addEditForm');
        const modalTitle = document.getElementById('notes-modalTitle');
        const editIdInput = document.getElementById('notes-editId');
        const titleInput = document.getElementById('notes-title-input');
        const contentEditor = document.getElementById('notes-content-editor');
        const listWrapper = document.getElementById('notes-list-wrapper');
        const detailWrapper = document.getElementById('notes-detail-wrapper');

        // Context Menu Elements
        const notesTabMenu = document.getElementById('notes-tab-context-menu');
        const noteCardMenu = document.getElementById('note-card-context-menu');
        const editorContextMenu = document.getElementById('notes-context-menu');

        const addLinkModalEl = document.getElementById('notes-addLinkModal');
        const addLinkModal = new bootstrap.Modal(addLinkModalEl);
        const linkUrlInput = document.getElementById('notes-link-url');
        const saveLinkBtn = document.getElementById('notes-save-link-btn');

        let activeNoteId = null;
        let autoSaveTimer = null;
        let savedSelection = null;
        window.notesData = [];
        window.filteredNotes = [];

        function formatTimeAgo(isoString) {
            if (!isoString) return '';
            const seconds = Math.round((new Date() - new Date(isoString)) / 1000);
            if (seconds < 60) return "vài giây trước";
            const intervals = { năm: 31536000, tháng: 2592000, ngày: 86400, giờ: 3600, phút: 60 };
            for (const [unit, secondsInUnit] of Object.entries(intervals)) {
                const value = Math.floor(seconds / secondsInUnit);
                if (value >= 1) return `${value} ${unit} trước`;
            }
            return "vài giây trước";
        }

        async function fetchAndRenderNotes(searchTerm = '') {
            try {
                const response = await fetch("{{ url_for('notes_feature.api_get_notes') }}");
                if (!response.ok) throw new Error(`Server Error: ${response.status}`);

                const notes = await response.json();
                window.notesData = notes;

                const notesToRender = searchTerm
                    ? notes.filter(note =>
                    ((note.title_html || '').toLowerCase().includes(searchTerm) ||
                        (note.content_html || '').toLowerCase().includes(searchTerm)))
                    : notes;

                window.filteredNotes = notesToRender;
                renderNotes(notesToRender);

            } catch (error) {
                showToast(`Failed to load notes: ${error.message}`, 'error');
            }
        }

        function renderNotes(notesToRender) {
            container.innerHTML = '';

            // Logic "Ghim": Nếu có ghi chú đang active, đưa nó lên đầu danh sách
            if (activeNoteId) {
                const activeNoteIndex = notesToRender.findIndex(n => n.id === activeNoteId);
                if (activeNoteIndex > -1) {
                    const [activeNote] = notesToRender.splice(activeNoteIndex, 1);
                    notesToRender.unshift(activeNote);
                }
            }

            if (notesToRender.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted p-5"><h6>Không có ghi chú nào.</h6></div>`;
            } else {
                notesToRender.forEach(note => container.appendChild(createNoteCard(note)));
            }
        }

        function createNoteCard(note) {
            const col = document.createElement('div');
            col.className = 'note-card-wrapper col-12'; // Full width for list view
            col.dataset.noteId = note.id;

            const markedIconHTML = note.is_marked ? `<i class="bi bi-star-fill text-warning me-2" title="Đã đánh dấu"></i>` : '';
            const titleHTML = note.title_html || "Ghi chú không tiêu đề";
            const contentHTML = note.content_html || '...';

            col.innerHTML = `
                <div class="card h-100 w-100 m-0" data-note-id="${note.id}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title text-truncate mb-1">${titleHTML}</h5>
                            <small class="text-muted flex-shrink-0 ms-2">${formatTimeAgo(note.modified_at)}</small>
                        </div>
                        <div class="card-text card-note-body text-muted">${contentHTML}</div>
                         <div class="mt-auto d-flex justify-content-between align-items-center">
                            <div>${markedIconHTML}</div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteNoteWrapper('${note.id}', event)">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>`;

            const cardElement = col.querySelector('.card');
            cardElement.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                openDetailPanel();
                showNoteDetail(note);
            });

            cardElement.addEventListener('contextmenu', handleNoteCardContextMenu);

            return col;
        }

        function openDetailPanel() {
            listWrapper.classList.add('shrunk');
            detailWrapper.classList.add('visible');
        }

        function showNoteDetail(note) {
            activeNoteId = note.id;

            // Logic Ghim: Render lại list để đưa ghi chú được chọn lên đầu
            renderNotes(window.filteredNotes);

            // Highlight card vừa được click
            document.querySelectorAll('#notes-container .card').forEach(card => card.classList.remove('note-card-active'));
            const clickedCard = document.querySelector(`.card[data-note-id="${note.id}"]`);
            if (clickedCard) clickedCard.classList.add('note-card-active');

            const detailHeader = detailWrapper.querySelector('.card-header');
            const detailContent = detailWrapper.querySelector('#notes-detail-content');
            const detailPlaceholder = detailWrapper.querySelector('#notes-detail-placeholder');

            detailHeader.innerHTML = `
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div><small class="text-muted">${formatTimeAgo(note.modified_at)}</small></div>
                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary" onclick="prepareAddNoteModal()" title="Thêm ghi chú mới"><i class="bi bi-plus-lg"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNoteWrapper('${note.id}', event)" title="Xóa ghi chú"><i class="bi bi-trash-fill"></i></button>
                        <button class="btn-close btn-close-white" onclick="closeDetailPanel()" title="Đóng chi tiết" style="font-size: 0.8rem;"></button>
                    </div>
                </div>`;

            detailContent.innerHTML = `<div id="detail-editable-full" contenteditable="true" spellcheck="false" data-placeholder="Dòng đầu là tiêu đề...">${note.title_html || ''}<br>${note.content_html || ''}</div>`;
            const editorEl = document.getElementById('detail-editable-full');

            editorEl.addEventListener('input', () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => saveNoteChanges(note.id), 1500);
            });

            editorEl.addEventListener('contextmenu', handleEditorContextMenu);

            detailPlaceholder.classList.add('d-none');
            detailContent.classList.remove('d-none');
        }

        async function saveNoteChanges(noteId) {
            if (!noteId) return;
            const editorEl = document.getElementById('detail-editable-full');
            if (!editorEl) return;

            const fullContent = editorEl.innerHTML;
            const parts = fullContent.split('<br>');
            const payload = {
                title_html: parts.shift() || '',
                content_html: parts.join('<br>')
            };

            try {
                const response = await fetch(`{{ url_for('notes_feature.api_update_note', note_id='') }}${noteId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error('Server save failed');
                showToast('Đã tự động lưu!', 'success');
                fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
            } catch (error) {
                showToast('Lỗi khi tự động lưu!', 'error');
            }
        }

        window.prepareAddNoteModal = () => {
            form.reset();
            modalTitle.textContent = 'Thêm Ghi Chú Mới';
            editIdInput.value = '';
            titleInput.innerHTML = '';
            contentEditor.innerHTML = '';
            notesModal.show();
        };

        window.deleteNoteWrapper = async (id, event) => {
            event.stopPropagation();
            if (!confirm('Bạn có chắc muốn xóa ghi chú này?')) return;
            try {
                const response = await fetch(`{{ url_for('notes_feature.api_delete_note', note_id='') }}${id}`, { method: 'POST' });
                if (!response.ok) throw new Error('Server delete failed');
                if (id === activeNoteId) closeDetailPanel();
                fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
                showToast('Đã xóa ghi chú.', 'info');
            } catch (error) {
                showToast('Lỗi: Không thể xóa ghi chú.', 'error');
            }
        };

        window.closeDetailPanel = () => {
            listWrapper.classList.remove('shrunk');
            detailWrapper.classList.remove('visible');
            document.querySelector('.note-card-active')?.classList.remove('note-card-active');
            activeNoteId = null;
            renderNotes(window.filteredNotes); // Re-render to unpin
        };

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = editIdInput.value;
            const url = id ? `{{ url_for('notes_feature.api_update_note', note_id='') }}${id}` : "{{ url_for('notes_feature.api_add_note') }}";
            const payload = {
                title_html: titleInput.innerHTML,
                content_html: contentEditor.innerHTML,
            };
            if (!payload.title_html && !payload.content_html) {
                alert('Ghi chú không được để trống.');
                return;
            }
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error('Server save failed');
                notesModal.hide();
                fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
                showToast(id ? 'Đã cập nhật!' : 'Đã tạo mới!', 'success');
            } catch (error) {
                showToast('Lỗi: Không thể lưu.', 'error');
            }
        });

        // --- Context Menu Logic ---
        function handleNoteCardContextMenu(e) {
            e.preventDefault();
            e.stopPropagation();
            hideAllContextMenus();

            const noteId = e.currentTarget.dataset.noteId;
            const note = window.notesData.find(n => n.id === noteId);
            if (!note) return;

            const markBtn = noteCardMenu.querySelector('#context-mark-note');
            markBtn.innerHTML = note.is_marked ? '<i class="bi bi-star me-2"></i> Bỏ Đánh Dấu' : '<i class="bi bi-star-fill me-2"></i> Đánh Dấu';

            noteCardMenu.dataset.noteId = noteId;
            showMenu(noteCardMenu, e.clientX, e.clientY);
        }

        function handleEditorContextMenu(e) {
            e.preventDefault();
            e.stopPropagation();
            hideAllContextMenus();

            if (window.getSelection().toString().length > 0) {
                savedSelection = window.getSelection().getRangeAt(0).cloneRange();
                showMenu(editorContextMenu, e.clientX, e.clientY);
            }
        }

        function hideAllContextMenus() {
            document.querySelectorAll('.custom-context-menu').forEach(menu => menu.style.display = 'none');
        }

        function showMenu(menu, x, y) {
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';
        }

        document.addEventListener('click', hideAllContextMenus);

        // --- Context Menu Actions ---
        noteCardMenu.querySelector('#context-mark-note').addEventListener('click', async () => {
            const noteId = noteCardMenu.dataset.noteId;
            if (!noteId) return;
            try {
                const response = await fetch(`{{ url_for('notes_feature.api_toggle_mark', note_id='') }}${noteId}`, { method: 'POST' });
                if (!response.ok) throw new Error('Server error');
                fetchAndRenderNotes(searchInput.value.toLowerCase().trim());
            } catch (error) {
                showToast('Lỗi khi đánh dấu.', 'error');
            }
        });

        editorContextMenu.querySelector('#context-copy').addEventListener('click', () => document.execCommand('copy'));
        editorContextMenu.querySelector('#context-bold').addEventListener('click', () => document.execCommand('bold'));
        editorContextMenu.querySelector('#context-link').addEventListener('click', () => {
            if (savedSelection) {
                linkUrlInput.value = 'https://';
                addLinkModal.show();
            }
        });

        saveLinkBtn.addEventListener('click', () => {
            const url = linkUrlInput.value.trim();
            if (url && savedSelection) {
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(savedSelection);
                document.execCommand('createLink', false, url);
                addLinkModal.hide();
                savedSelection = null;
                setTimeout(() => saveNoteChanges(activeNoteId), 0);
            }
        });

        // --- Init ---
        searchInput.addEventListener('input', (e) => fetchAndRenderNotes(e.target.value.toLowerCase().trim()));

        // Load notes when the tab is shown
        notesTab.addEventListener('shown.bs.tab', () => fetchAndRenderNotes());

        // Also load notes if the tab is already active on page load
        if (notesTab.classList.contains('active')) {
            fetchAndRenderNotes();
        }
    })();
</script>
{% endblock %}