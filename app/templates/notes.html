{% extends "layouts/base.html" %}

{% block content %}
<div class="tab-pane fade show active" id="notes-tool-pane" role="tabpanel">
    <div class="notes-layout-container">
        
        <div id="notes-list-wrapper">
            <div class="d-flex justify-content-start align-items-center mb-2">
                <div class="position-relative notes-search-container" style="width: 50%;">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3" style="z-index: 10;"></i>
                    <input type="text" class="form-control ps-5" id="notes-search-input" spellcheck="false" placeholder="Tìm kiếm ghi chú..." style="border-radius: 25px;">
                </div>
            </div>
            <div id="notes-container" class="row notes-grid-view" spellcheck="false">
                </div>
        </div>

        <div id="notes-detail-wrapper">
            <div id="notes-detail-panel" class="card h-100">
                <div class="card-header">
                    </div>
                <div class="card-body" id="notes-detail-content-wrapper">
                    <div class="text-center text-muted p-3 h-100 d-flex flex-column justify-content-center align-items-center" id="notes-detail-placeholder">
                        <i class="bi bi-arrow-left-circle" style="font-size: 2rem;"></i>
                        <h6 class="mt-2">Chọn ghi chú</h6>
                        <small>Click để xem</small>
                    </div>
                    <div id="notes-detail-content" class="d-none">
                        </div>
                </div>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="notes-addEditModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
          <form id="notes-addEditForm">
              <div class="modal-header">
                  <h5 class="modal-title" id="notes-modalTitle">Thêm Ghi Chú Mới</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <input type="hidden" id="notes-editId">
              <div class="modal-body">
                  <div class="mb-3">
                      <label for="notes-title-input" class="form-label">Tiêu đề (tùy chọn)</label>
                      <div id="notes-title-input" contenteditable="true" class="form-control" spellcheck="false" placeholder="Nhập tiêu đề ghi chú..." style="min-height: 40px;"></div>
                  </div>
                <div class="mb-3">
                      <div id="notes-content-editor" contenteditable="true" class="form-control" spellcheck="false" style="height: 200px; overflow-y: auto;" placeholder="Nhập nội dung ghi chú..."></div>
                </div>
                  <div class="form-check form-switch mb-3">
                      <input class="form-check-input" type="checkbox" role="switch" id="notes-enableAlarmCheck">
                      <label class="form-check-label" for="notes-enableAlarmCheck">Đặt báo thức</label>
                  </div>
                  <div id="notes-alarm-container" class="d-none">
                      </div>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                  <button type="submit" class="btn btn-primary">Lưu</button>
              </div>
          </form>
      </div>
  </div>
</div>

<div class="modal fade" id="notes-notificationModal" tabindex="-1">...</div>
<div id="notes-context-menu" class="custom-context-menu">...</div>
<div id="note-card-context-menu" class="custom-context-menu">...</div>
<div id="profile-span-context-menu" class="custom-context-menu">...</div>
<div class="modal fade" id="notes-addLinkModal" tabindex="-1">...</div>
<div class="modal fade" id="notes-addProfileModal" tabindex="-1">...</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- NOTES MANAGER SCRIPT ---
        const notesTab = document.getElementById('notes-tool-tab');
        if (!notesTab) return;

        const container = document.getElementById('notes-container');
        const searchInput = document.getElementById('notes-search-input');
        const modalEl = document.getElementById('notes-addEditModal');
        const form = document.getElementById('notes-addEditForm');
        
        let activeNoteId = null;

        // --- Core Functions ---
        async function fetchAndRenderNotes() {
            try {
                const response = await fetch("{{ url_for('notes_feature.api_get_notes') }}");
                const notes = await response.json();
                window.notesData = notes;
                renderNotes(notes);
            } catch (error) {
                console.error('Error fetching notes:', error);
            }
        }

        function renderNotes(notesToRender) {
            container.innerHTML = '';
            if (notesToRender.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted p-5"><h6>Không có ghi chú nào.</h6></div>`;
            } else {
                notesToRender.forEach(note => container.appendChild(createNoteCard(note)));
            }
        }

        function createNoteCard(note) {
            const col = document.createElement('div');
            col.className = 'note-card-wrapper col-lg-4 col-md-6 mb-3'; // Default grid classes
            col.dataset.noteId = note.id;

            col.innerHTML = `
                <div class="card h-100" data-note-id="${note.id}">
                    <div class="card-body">
                        <h5 class="card-title">${note.title_html || 'Ghi chú không tiêu đề'}</h5>
                        <div class="card-text card-note-body">${note.content_html || '...'}</div>
                        <div class="mt-auto d-flex justify-content-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${note.id}', event)"><i class="bi bi-trash-fill"></i></button>
                        </div>
                    </div>
                </div>`;

            const cardElement = col.querySelector('.card');
            cardElement.addEventListener('click', (e) => {
                if (e.target.closest('button')) return;
                openDetailPanel();
                showNoteDetail(note);
            });
            
            // Add right-click listener
            cardElement.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Logic to show note-card-context-menu
            });

            return col;
        }

        function openDetailPanel() {
            document.getElementById('notes-list-wrapper').classList.add('shrunk');
            document.getElementById('notes-detail-wrapper').classList.add('visible');
            container.classList.remove('notes-grid-view');
            container.classList.add('notes-list-view');
            // Adjust column classes for list view
            container.querySelectorAll('.note-card-wrapper').forEach(col => {
                col.className = 'note-card-wrapper col-12 mb-2';
            });
        }

        function showNoteDetail(note) {
            activeNoteId = note.id;
            const detailHeader = document.querySelector('#notes-detail-panel .card-header');
            const detailContent = document.getElementById('notes-detail-content');
            const detailPlaceholder = document.getElementById('notes-detail-placeholder');

            // Highlight active card
            document.querySelectorAll('#notes-container .card').forEach(c => c.classList.remove('note-card-active'));
            document.querySelector(`.card[data-note-id="${note.id}"]`)?.classList.add('note-card-active');

            detailHeader.innerHTML = `
                <div class="d-flex justify-content-between align-items-center w-100">
                    <small class="text-muted"><i class="bi bi-clock-history me-1"></i>${new Date(note.modified_at).toLocaleString()}</small>
                    <div class="d-flex align-items-center" style="gap: 0.5rem;">
                        <button class="btn btn-sm btn-primary" onclick="prepareAddNoteModal()"><i class="bi bi-plus-lg"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNote('${note.id}', event)"><i class="bi bi-trash-fill"></i></button>
                        <button class="btn-close btn-close-white" onclick="closeDetailPanel()" style="font-size: 0.8rem;"></button>
                    </div>
                </div>`;
            
            detailContent.innerHTML = `<div id="detail-editable-full" contenteditable="true" spellcheck="false">${note.title_html}<br>${note.content_html}</div>`;
            
            detailPlaceholder.classList.add('d-none');
            detailContent.classList.remove('d-none');
        }

        window.closeDetailPanel = function () {
            document.getElementById('notes-list-wrapper').classList.remove('shrunk');
            document.getElementById('notes-detail-wrapper').classList.remove('visible');
            container.classList.remove('notes-list-view');
            container.classList.add('notes-grid-view');
            document.querySelector('.note-card-active')?.classList.remove('note-card-active');
            activeNoteId = null;
            // Adjust column classes back to grid view
            container.querySelectorAll('.note-card-wrapper').forEach(col => {
                col.className = 'note-card-wrapper col-lg-4 col-md-6 mb-3';
            });
        };

        window.deleteNote = async function(id, event) {
            event.stopPropagation();
            if (!confirm('Bạn có chắc muốn xóa ghi chú này?')) return;
            try {
                await fetch(`/notes/api/delete/${id}`, { method: 'POST' });
                if (id === activeNoteId) {
                    closeDetailPanel();
                }
                fetchAndRenderNotes();
            } catch (error) {
                console.error("Error deleting note:", error);
            }
        };

        // --- Initial Load ---
        fetchAndRenderNotes();
    });
</script>
{% endblock %}
