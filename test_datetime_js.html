<!DOCTYPE html>
<html>
<head>
    <title>Test DateTime Normalization</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
    </style>
</head>
<body>
    <h2>üß™ Test DateTime Normalization for JavaScript</h2>
    <div id="results"></div>
    
    <script>
        // Helper functions from mxh.html
        function normalizeISOForJS(iso) {
            if (!iso) return null;
            let s = String(iso).trim();
            s = s.replace(' ', 'T');
            if (!/[zZ]|[+\-]\d{2}:\d{2}$/.test(s)) s += 'Z';
            s = s.replace(/(\.\d{3})\d+/, '$1');
            return s;
        }

        function ensureNoticeParsed(notice) {
            let n = (typeof notice === 'string') ? (()=>{ try{return JSON.parse(notice)}catch{return {}} })() : (notice || {});
            if (n && n.start_at) n.start_at = normalizeISOForJS(n.start_at);
            return n;
        }

        // Test cases
        const tests = [
            {
                name: "Old format (6 digits microseconds, no Z)",
                input: "2025-10-11T22:04:17.402626",
                expected: "2025-10-11T22:04:17.402Z"
            },
            {
                name: "New format (3 digits, with Z)",
                input: "2025-10-11T15:33:32.516Z",
                expected: "2025-10-11T15:33:32.516Z"
            },
            {
                name: "Space instead of T",
                input: "2025-10-11 15:33:32.516",
                expected: "2025-10-11T15:33:32.516Z"
            },
            {
                name: "No milliseconds",
                input: "2025-10-11T15:33:32",
                expected: "2025-10-11T15:33:32Z"
            },
            {
                name: "Notice object with old format",
                input: {enabled: true, title: "Reg", days: 5, start_at: "2025-10-11T22:04:17.402626"},
                expected: "2025-10-11T22:04:17.402Z"
            }
        ];

        const resultsDiv = document.getElementById('results');
        let passCount = 0;
        let failCount = 0;

        tests.forEach((test, idx) => {
            const testDiv = document.createElement('div');
            testDiv.className = 'test';
            
            let result, isValid, dateObj;
            
            if (typeof test.input === 'object') {
                const parsed = ensureNoticeParsed(test.input);
                result = parsed.start_at;
                dateObj = new Date(result);
            } else {
                result = normalizeISOForJS(test.input);
                dateObj = new Date(result);
            }
            
            isValid = !isNaN(dateObj.getTime());
            const pass = (result === test.expected) && isValid;
            
            if (pass) {
                passCount++;
                testDiv.classList.add('pass');
            } else {
                failCount++;
                testDiv.classList.add('fail');
            }
            
            testDiv.innerHTML = `
                <strong>Test ${idx + 1}: ${test.name}</strong><br>
                Input: <code>${typeof test.input === 'object' ? JSON.stringify(test.input) : test.input}</code><br>
                Expected: <code>${test.expected}</code><br>
                Result: <code>${result}</code><br>
                Date Valid: ${isValid ? '‚úÖ' : '‚ùå'} (${dateObj})<br>
                Status: ${pass ? '‚úÖ PASS' : '‚ùå FAIL'}
            `;
            
            resultsDiv.appendChild(testDiv);
        });

        // Summary
        const summaryDiv = document.createElement('div');
        summaryDiv.style.marginTop = '20px';
        summaryDiv.style.padding = '15px';
        summaryDiv.style.background = passCount === tests.length ? '#d4edda' : '#fff3cd';
        summaryDiv.style.border = '2px solid ' + (passCount === tests.length ? '#28a745' : '#ffc107');
        summaryDiv.innerHTML = `
            <h3>Summary</h3>
            ‚úÖ Passed: ${passCount} / ${tests.length}<br>
            ${failCount > 0 ? `‚ùå Failed: ${failCount}` : 'üéâ All tests passed!'}
        `;
        resultsDiv.appendChild(summaryDiv);
    </script>
</body>
</html>
